
======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\config.dart
======================================

class Config {
  static const String baseUrl = 'https://huni-cms.ionvop.com/api/';
  // static const String baseUrl = 'http://localhost:8000/api/';
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\global.dart
======================================

class Global{
  static Map<String, dynamic> userData = {};
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\main.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'screen/home_screen.dart';
import 'global.dart';

// Import your QR scanner screen files based on actual structure
import 'screen/mandaya_detail_screen.dart';
import 'screen/mansaka_detail_screen.dart';
import 'screen/kagan_detail_screen.dart';

// Custom input formatter to allow only letters, spaces, hyphens, apostrophes, and periods
class NameInputFormatter extends TextInputFormatter {
  @override
  TextEditingValue formatEditUpdate(
    TextEditingValue oldValue,
    TextEditingValue newValue,
  ) {
    final RegExp regExp = RegExp(r"^[a-zA-Z\s\-'.]*$");
    
    if (newValue.text.isEmpty) {
      return newValue;
    }
    
    if (regExp.hasMatch(newValue.text)) {
      if (!newValue.text.contains(RegExp(r'[\s\-''.]{2,}')) &&
          !newValue.text.startsWith(RegExp(r'[\s\-''.]+')) &&
          !newValue.text.endsWith('  ')) {
        return newValue;
      }
    }
    
    return oldValue;
  }
}

void main() {
  runApp(const MyApp());
}

class GlobalData {
  static dynamic userData;
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Huni sa Tribu',
      theme: ThemeData(
        primarySwatch: Colors.green,
        fontFamily: 'Regular',
      ),
      initialRoute: '/',
      routes: {
        '/': (context) => const WelcomeScreen(),
        '/home': (context) {
          final args = ModalRoute.of(context)?.settings.arguments as Map<String, dynamic>?;
          return HomeScreen(userData: args ?? {});
        },
        '/mandaya_detail': (context) {
          final args = ModalRoute.of(context)?.settings.arguments as Map<String, dynamic>?;
          return MandayaCulturalDetailScreen(contentData: args);
        },
        '/mansaka_detail': (context) {
          final args = ModalRoute.of(context)?.settings.arguments as Map<String, dynamic>?;
          return MansakaCulturalDetailScreen(contentData: args);
        },
        '/kagan_detail': (context) {
          final args = ModalRoute.of(context)?.settings.arguments as Map<String, dynamic>?;
          return KaganCulturalDetailScreen(contentData: args);
        },
       },
      debugShowCheckedModeBanner: false,
    );
  }
}

class WelcomeScreen extends StatefulWidget {
  const WelcomeScreen({super.key});

  @override
  State<WelcomeScreen> createState() => _WelcomeScreenState();
}

class _WelcomeScreenState extends State<WelcomeScreen> {
  final TextEditingController _nameController = TextEditingController();
  final TextEditingController _customSchoolController = TextEditingController();
  final FocusNode _nameFocusNode = FocusNode();
  final FocusNode _customSchoolFocusNode = FocusNode();
  String _selectedRole = 'Visitor';
  String? _selectedSchool;
  bool _showSchoolField = false;
  bool _showCustomSchoolField = false;

  final List<String> _schoolOptions = [
    'Aces Polytechnic College',
    'Arriesgado College Foundation, Inc',
    'Assumpta School of Tagum',
    'CARD-MRI Development Institute Inc.',
    'La Filipina National Highschool',
    'Laureta National Highschool',
    'Letran De Davao Inc.',
    'Liceo De Davao',
    'Magdum National Highschool',
    'Max Mirafuentes Academy',
    'NDC Tagum Foundation Inc.',
    'Rizal Memorial Colleges, Inc.',
    'Saint Lorenzo Ruiz Academy',
    'Saint Marys College of Tagum',
    'St. Thomas More School of Law and Business',
    'STI College Tagum',
    'Tagum City College of Science and Technology Foundation Incorporated',
    'Tagum City National Highschool (City High)',
    'Tagum Doctors College, Inc.',
    'Tagum National Trade School (Trade)',
    'UM Tagum College',
    'University of Southeastern Philippines',
    'Others'
  ];

  @override
  void initState() {
    super.initState();
    
    // Add listeners to handle keyboard interactions
    _nameFocusNode.addListener(() {
      if (_nameFocusNode.hasFocus) {
        setState(() {});
      }
    });
    
    _customSchoolFocusNode.addListener(() {
      if (_customSchoolFocusNode.hasFocus) {
        setState(() {});
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;
    final isKeyboardVisible = keyboardHeight > 0;
    
    // Calculate available height
    final topPadding = MediaQuery.of(context).padding.top;
    final bottomPadding = MediaQuery.of(context).padding.bottom;
    final availableHeight = screenHeight - topPadding - bottomPadding - keyboardHeight;
    
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: GestureDetector(
        onTap: () {
          FocusScope.of(context).unfocus();
        },
        child: Container(
          width: double.infinity,
          height: double.infinity,
          decoration: const BoxDecoration(
            image: DecorationImage(
              image: AssetImage('assets/images/login.jpg'),
              fit: BoxFit.cover,
              opacity: 4.0,
            ),
          ),
          child: Container(
            color: Colors.black.withOpacity(0.5),
            child: SafeArea(
              child: LayoutBuilder(
                builder: (context, constraints) {
                  return SingleChildScrollView(
                    physics: const ClampingScrollPhysics(),
                    keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
                    child: ConstrainedBox(
                      constraints: BoxConstraints(
                        minHeight: constraints.maxHeight,
                        maxWidth: screenWidth,
                      ),
                  child: IntrinsicHeight(
                    child: Padding(
                      padding: EdgeInsets.symmetric(
                        horizontal: (screenWidth * 0.05).clamp(16.0, 40.0),
                        vertical: (screenHeight * 0.02).clamp(12.0, 24.0),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          SizedBox(
                            height: isKeyboardVisible 
                              ? (screenHeight * 0.02).clamp(8.0, 16.0)
                              : (screenHeight * 0.05).clamp(20.0, 40.0)
                          ),
                          
                          // Logo/Title Box - centered and responsive
                          Center(
                            child: ConstrainedBox(
                              constraints: BoxConstraints(
                                maxWidth: screenWidth * 0.85,
                                minHeight: (screenHeight * 0.06).clamp(40.0, 60.0),
                              ),
                              child: Container(
                                padding: EdgeInsets.symmetric(
                                  horizontal: (screenWidth * 0.08).clamp(20.0, 50.0),
                                  vertical: (screenHeight * 0.018).clamp(12.0, 20.0),
                                ),
                                decoration: BoxDecoration(
                                  border: Border.all(color: Colors.white, width: 2),
                                  borderRadius: BorderRadius.circular(8),
                                ),
                                child: FittedBox(
                                  fit: BoxFit.scaleDown,
                                  child: Text(
                                    'HUNI SA TRIBU',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: (screenWidth * 0.06).clamp(18.0, 30.0),
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 2,
                                    ),
                                  ),
                                ),
                              ),
                            ),
                          ),
                          
                          SizedBox(
                            height: isKeyboardVisible 
                              ? (screenHeight * 0.02).clamp(8.0, 16.0)
                              : (screenHeight * 0.04).clamp(16.0, 32.0)
                          ),
                          
                          // Welcome Text - responsive
                          Align(
                            alignment: Alignment.centerLeft,
                            child: FittedBox(
                              fit: BoxFit.scaleDown,
                              alignment: Alignment.centerLeft,
                              child: Text(
                                'Welcome!',
                                style: TextStyle(
                                  color: Colors.white,
                                  fontSize: (screenWidth * 0.07).clamp(20.0, 32.0),
                                  fontWeight: FontWeight.w300,
                                ),
                              ),
                            ),
                          ),
                          
                          SizedBox(
                            height: isKeyboardVisible 
                              ? (screenHeight * 0.02).clamp(8.0, 16.0)
                              : (screenHeight * 0.04).clamp(16.0, 32.0)
                          ),
                          
                          // Transparent container with form inputs
                          Container(
                            constraints: BoxConstraints(
                              minHeight: (availableHeight * 0.3).clamp(200.0, 400.0),
                              maxWidth: screenWidth,
                            ),
                            padding: EdgeInsets.all((screenWidth * 0.05).clamp(16.0, 30.0)),
                            decoration: BoxDecoration(
                              color: Colors.black.withOpacity(0.3),
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Column(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                // Name Input Field
                                _buildInputField(
                                  label: 'Name',
                                  controller: _nameController,
                                  focusNode: _nameFocusNode,
                                  hintText: '',
                                  screenWidth: screenWidth,
                                  screenHeight: screenHeight,
                                  inputFormatters: [
                                    NameInputFormatter(),
                                    LengthLimitingTextInputFormatter(50),
                                  ],
                                  textInputAction: TextInputAction.next,
                                  textCapitalization: TextCapitalization.words,
                                  onSubmitted: (value) {
                                    FocusScope.of(context).unfocus();
                                  },
                                ),
                                
                                SizedBox(height: (screenHeight * 0.02).clamp(12.0, 20.0)),
                                
                                // Role Selection Dropdown
                                _buildRoleDropdown(screenWidth, screenHeight),
                                
                                // School Selection Dropdown
                                if (_showSchoolField) ...[
                                  SizedBox(height: (screenHeight * 0.02).clamp(12.0, 20.0)),
                                  _buildSchoolDropdown(screenWidth, screenHeight),
                                ],
                                
                                // Custom School Input Field
                                if (_showSchoolField && _showCustomSchoolField) ...[
                                  SizedBox(height: (screenHeight * 0.02).clamp(12.0, 20.0)),
                                  _buildInputField(
                                    label: 'Please specify your school',
                                    controller: _customSchoolController,
                                    focusNode: _customSchoolFocusNode,
                                    hintText: 'Enter your school name',
                                    screenWidth: screenWidth,
                                    screenHeight: screenHeight,
                                    inputFormatters: [
                                      LengthLimitingTextInputFormatter(100),
                                      FilteringTextInputFormatter.allow(RegExp(r"[a-zA-Z0-9\s\-'.()#&,]")),
                                    ],
                                    textInputAction: TextInputAction.done,
                                    textCapitalization: TextCapitalization.words,
                                    onSubmitted: (value) {
                                      FocusScope.of(context).unfocus();
                                      _proceedToNext();
                                    },
                                  ),
                                ],
                              ],
                            ),
                          ),
                          
                          SizedBox(
                            height: isKeyboardVisible 
                              ? (screenHeight * 0.02).clamp(8.0, 16.0)
                              : (screenHeight * 0.04).clamp(16.0, 32.0)
                          ),
                          
                          // Proceed Button - responsive
                          Center(
                            child: ConstrainedBox(
                              constraints: BoxConstraints(
                                minWidth: (screenWidth * 0.4).clamp(120.0, 200.0),
                                maxWidth: (screenWidth * 0.7).clamp(200.0, 300.0),
                                minHeight: (screenHeight * 0.06).clamp(40.0, 60.0),
                              ),
                              child: ElevatedButton(
                                onPressed: () {
                                  FocusScope.of(context).unfocus();
                                  _proceedToNext();
                                },
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: const Color(0xFFFDF8D7),
                                  foregroundColor: Colors.black,
                                  padding: EdgeInsets.symmetric(
                                    horizontal: (screenWidth * 0.1).clamp(24.0, 48.0),
                                    vertical: (screenHeight * 0.018).clamp(12.0, 20.0),
                                  ),
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(8),
                                  ),
                                ),
                                child: FittedBox(
                                  fit: BoxFit.scaleDown,
                                  child: Text(
                                    'PROCEED',
                                    style: TextStyle(
                                      fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                              ),
                            ),
                          ),
                          
                          const Expanded(child: SizedBox()),
                          
                          SizedBox(
                            height: isKeyboardVisible 
                              ? (screenHeight * 0.02).clamp(8.0, 16.0)
                              : 0
                          ),
                        ],
                      ),
                    ),
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildInputField({
    required String label,
    required TextEditingController controller,
    required FocusNode focusNode,
    required String hintText,
    required double screenWidth,
    required double screenHeight,
    required List<TextInputFormatter> inputFormatters,
    required TextInputAction textInputAction,
    required TextCapitalization textCapitalization,
    required Function(String) onSubmitted,
  }) {
    return ConstrainedBox(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.08).clamp(50.0, 80.0),
        maxWidth: screenWidth,
      ),
      child: Container(
        decoration: BoxDecoration(
          color: Colors.grey.withOpacity(0.4),
          borderRadius: BorderRadius.circular(8),
        ),
        child: Stack(
          children: [
            Positioned(
              top: (screenHeight * 0.01).clamp(6.0, 12.0),
              left: (screenWidth * 0.04).clamp(12.0, 20.0),
              child: Text(
                label,
                style: TextStyle(
                  color: Colors.white70,
                  fontSize: (screenWidth * 0.03).clamp(10.0, 14.0),
                  fontWeight: FontWeight.w300,
                ),
                overflow: TextOverflow.ellipsis,
                maxLines: 1,
              ),
            ),
            TextField(
              controller: controller,
              focusNode: focusNode,
              style: TextStyle(
                color: Colors.white,
                fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
                fontWeight: FontWeight.w500,
              ),
              textAlign: TextAlign.center,
              keyboardType: TextInputType.name,
              textInputAction: textInputAction,
              textCapitalization: textCapitalization,
              inputFormatters: inputFormatters,
              onTap: () {
                focusNode.requestFocus();
              },
              onSubmitted: onSubmitted,
              onTapOutside: (event) {
                // Dismiss keyboard when tapping outside
                FocusScope.of(context).unfocus();
              },
              decoration: InputDecoration(
                hintText: hintText,
                hintStyle: TextStyle(
                  color: Colors.white54,
                  fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                ),
                border: InputBorder.none,
                contentPadding: EdgeInsets.only(
                  left: (screenWidth * 0.05).clamp(16.0, 30.0),
                  right: (screenWidth * 0.05).clamp(16.0, 30.0),
                  top: (screenHeight * 0.04).clamp(24.0, 36.0),
                  bottom: (screenHeight * 0.018).clamp(12.0, 20.0),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildRoleDropdown(double screenWidth, double screenHeight) {
    return ConstrainedBox(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.08).clamp(50.0, 80.0),
        maxWidth: screenWidth,
      ),
      child: Container(
        width: double.infinity,
        decoration: BoxDecoration(
          color: Colors.grey.withOpacity(0.4),
          borderRadius: BorderRadius.circular(8),
        ),
        child: Stack(
          children: [
            Positioned(
              top: (screenHeight * 0.01).clamp(6.0, 12.0),
              left: (screenWidth * 0.04).clamp(12.0, 20.0),
              child: Text(
                'Role',
                style: TextStyle(
                  color: Colors.white70,
                  fontSize: (screenWidth * 0.03).clamp(10.0, 14.0),
                  fontWeight: FontWeight.w300,
                ),
                overflow: TextOverflow.ellipsis,
              ),
            ),
            Padding(
              padding: EdgeInsets.only(
                top: (screenHeight * 0.03).clamp(20.0, 30.0),
                bottom: (screenHeight * 0.01).clamp(6.0, 12.0),
              ),
              child: DropdownButtonHideUnderline(
                child: DropdownButton<String>(
                  value: _selectedRole,
                  isExpanded: true,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: (screenWidth * 0.045).clamp(14.0, 18.0),
                    fontWeight: FontWeight.w500,
                  ),
                  dropdownColor: Colors.white,
                  items: <String>['Visitor', 'Student'].map((String value) {
                    return DropdownMenuItem<String>(
                      value: value,
                      child: Center(
                        child: FittedBox(
                          fit: BoxFit.scaleDown,
                          child: Text(
                            value,
                            style: TextStyle(
                              color: Colors.black,
                              fontSize: (screenWidth * 0.045).clamp(14.0, 18.0),
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                        ),
                      ),
                    );
                  }).toList(),
                  onChanged: (String? newValue) {
                    // Dismiss keyboard first
                    FocusScope.of(context).unfocus();
                    
                    // Then update state
                    setState(() {
                      _selectedRole = newValue!;
                      _showSchoolField = (_selectedRole == 'Student');
                      if (!_showSchoolField) {
                        _selectedSchool = null;
                        _showCustomSchoolField = false;
                        _customSchoolController.clear();
                      }
                    });
                  },
                  selectedItemBuilder: (BuildContext context) {
                    return <String>['Visitor', 'Student'].map((String value) {
                      return Center(
                        child: Padding(
                          padding: EdgeInsets.symmetric(
                            vertical: (screenHeight * 0.005).clamp(4.0, 8.0)
                          ),
                          child: FittedBox(
                            fit: BoxFit.scaleDown,
                            child: Text(
                              value,
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.045).clamp(14.0, 18.0),
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ),
                        ),
                      );
                    }).toList();
                  },
                  icon: Padding(
                    padding: EdgeInsets.only(right: (screenWidth * 0.05).clamp(12.0, 20.0)),
                    child: Icon(
                      Icons.arrow_drop_down,
                      color: Colors.white,
                      size: (screenWidth * 0.07).clamp(24.0, 32.0),
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSchoolDropdown(double screenWidth, double screenHeight) {
    return ConstrainedBox(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.08).clamp(50.0, 80.0),
        maxWidth: screenWidth,
      ),
      child: Container(
        width: double.infinity,
        decoration: BoxDecoration(
          color: Colors.grey.withOpacity(0.4),
          borderRadius: BorderRadius.circular(8),
        ),
        child: Stack(
          children: [
            Positioned(
              top: (screenHeight * 0.01).clamp(6.0, 12.0),
              left: (screenWidth * 0.04).clamp(12.0, 20.0),
              child: Text(
                'What School?',
                style: TextStyle(
                  color: Colors.white70,
                  fontSize: (screenWidth * 0.03).clamp(10.0, 14.0),
                  fontWeight: FontWeight.w300,
                ),
                overflow: TextOverflow.ellipsis,
              ),
            ),
            Padding(
              padding: EdgeInsets.only(
                top: (screenHeight * 0.03).clamp(20.0, 30.0),
                bottom: (screenHeight * 0.01).clamp(6.0, 12.0),
              ),
              child: DropdownButtonHideUnderline(
                child: DropdownButton<String>(
                  value: _selectedSchool,
                  hint: Center(
                    child: FittedBox(
                      fit: BoxFit.scaleDown,
                      child: Text(
                        'Select your school',
                        style: TextStyle(
                          color: Colors.white54,
                          fontSize: (screenWidth * 0.04).clamp(12.0, 16.0),
                          fontWeight: FontWeight.w400,
                        ),
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ),
                  isExpanded: true,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: (screenWidth * 0.04).clamp(12.0, 16.0),
                    fontWeight: FontWeight.w500,
                  ),
                  dropdownColor: Colors.white,
                  menuMaxHeight: (screenHeight * 0.4).clamp(200.0, 350.0),
                  items: _schoolOptions.map((String school) {
                    return DropdownMenuItem<String>(
                      value: school,
                      child: Padding(
                        padding: EdgeInsets.symmetric(
                          horizontal: (screenWidth * 0.02).clamp(6.0, 12.0)
                        ),
                        child: Text(
                          school,
                          style: TextStyle(
                            color: Colors.black,
                            fontSize: (screenWidth * 0.035).clamp(11.0, 14.0),
                            fontWeight: FontWeight.w500,
                          ),
                          overflow: TextOverflow.ellipsis,
                          maxLines: 2,
                        ),
                      ),
                    );
                  }).toList(),
                  onChanged: (String? newValue) {
                    // Dismiss keyboard first
                    FocusScope.of(context).unfocus();
                    
                    // Then update state
                    setState(() {
                      _selectedSchool = newValue;
                      _showCustomSchoolField = (newValue == 'Others');
                      if (!_showCustomSchoolField) {
                        _customSchoolController.clear();
                      } else {
                        // Auto-focus custom school field after dropdown closes
                        Future.delayed(const Duration(milliseconds: 300), () {
                          if (mounted) {
                            _customSchoolFocusNode.requestFocus();
                          }
                        });
                      }
                    });
                  },
                  selectedItemBuilder: (BuildContext context) {
                    return _schoolOptions.map((String school) {
                      return Center(
                        child: Padding(
                          padding: EdgeInsets.symmetric(
                            vertical: (screenHeight * 0.005).clamp(4.0, 8.0),
                            horizontal: (screenWidth * 0.02).clamp(6.0, 12.0),
                          ),
                          child: Text(
                            school,
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: (screenWidth * 0.04).clamp(12.0, 16.0),
                              fontWeight: FontWeight.w500,
                            ),
                            overflow: TextOverflow.ellipsis,
                            maxLines: 1,
                            textAlign: TextAlign.center,
                          ),
                        ),
                      );
                    }).toList();
                  },
                  icon: Padding(
                    padding: EdgeInsets.only(right: (screenWidth * 0.05).clamp(12.0, 20.0)),
                    child: Icon(
                      Icons.arrow_drop_down,
                      color: Colors.white,
                      size: (screenWidth * 0.07).clamp(24.0, 32.0),
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _proceedToNext() {
    final String trimmedName = _nameController.text.trim();
    
    if (trimmedName.isEmpty) {
      _showCustomErrorDialog(
        'Name Required',
        'Please enter your name to continue.',
        Icons.person_outline,
      );
      return;
    }
    
    if (!RegExp(r'[a-zA-Z]').hasMatch(trimmedName)) {
      _showCustomErrorDialog(
        'Invalid Name',
        'Please enter a valid name with letters.',
        Icons.person_outline,
      );
      return;
    }
    
    if (_selectedRole == 'Student' && _selectedSchool == null) {
      _showCustomErrorDialog(
        'School Selection Required',
        'Please select your school to continue.',
        Icons.school_outlined,
      );
      return;
    }
    
    if (_selectedRole == 'Student' && _selectedSchool == 'Others' && _customSchoolController.text.trim().isEmpty) {
      _showCustomErrorDialog(
        'Custom School Required',
        'Please enter your school name.',
        Icons.school_outlined,
      );
      return;
    }
    
    if (_selectedRole == 'Student' && _selectedSchool == 'Others' && !RegExp(r'[a-zA-Z]').hasMatch(_customSchoolController.text.trim())) {
      _showCustomErrorDialog(
        'Invalid School Name',
        'Please enter a valid school name with letters.',
        Icons.school_outlined,
      );
      return;
    }

    String finalSchoolName = '';
    if (_selectedRole == 'Student') {
      if (_selectedSchool == 'Others') {
        finalSchoolName = _customSchoolController.text.trim();
      } else {
        finalSchoolName = _selectedSchool!;
      }
    }

    Map<String, dynamic> userData = {
      'name': trimmedName,
      'role': _selectedRole,
      if (_selectedRole == 'Student') 'school': finalSchoolName,
    };

    try {
      GlobalData.userData = userData;
      Global.userData = userData;
    } catch (e) {
      debugPrint('Error setting global data: $e');
    }
    
    Navigator.pushReplacementNamed(
      context,
      '/home',
      arguments: userData,
    );
  }

  void _showCustomErrorDialog(String title, String message, IconData icon) {
    HapticFeedback.lightImpact();
    
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return Dialog(
          backgroundColor: Colors.transparent,
          child: ConstrainedBox(
            constraints: BoxConstraints(
              maxWidth: (screenWidth * 0.9).clamp(280.0, 400.0),
              maxHeight: (screenHeight * 0.5).clamp(250.0, 400.0),
            ),
            child: Container(
              margin: EdgeInsets.symmetric(
                horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)
              ),
              padding: EdgeInsets.all((screenWidth * 0.06).clamp(16.0, 32.0)),
              decoration: BoxDecoration(
                gradient: const LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    Color(0xFF2a2a2a),
                    Color(0xFF1a1a1a),
                    Color(0xFF0d0d0d),
                  ],
                ),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(
                  color: Colors.red.withOpacity(0.5),
                  width: 1,
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.8),
                    blurRadius: 20,
                    offset: const Offset(0, 10),
                  ),
                ],
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Container(
                    width: (screenWidth * 0.18).clamp(50.0, 80.0),
                    height: (screenWidth * 0.18).clamp(50.0, 80.0),
                    decoration: BoxDecoration(
                      color: Colors.red.withOpacity(0.1),
                      borderRadius: BorderRadius.circular((screenWidth * 0.09).clamp(25.0, 40.0)),
                      border: Border.all(
                        color: Colors.red.withOpacity(0.3),
                        width: 2,
                      ),
                    ),
                    child: Icon(
                      icon,
                      color: Colors.red,
                      size: (screenWidth * 0.09).clamp(28.0, 40.0),
                    ),
                  ),
                  
                  SizedBox(height: (screenHeight * 0.025).clamp(12.0, 20.0)),
                  
                  Flexible(
                    child: FittedBox(
                      fit: BoxFit.scaleDown,
                      child: Text(
                        title,
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: (screenWidth * 0.05).clamp(16.0, 22.0),
                          fontWeight: FontWeight.bold,
                          letterSpacing: 0.5,
                        ),
                        textAlign: TextAlign.center,
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ),
                  
                  SizedBox(height: (screenHeight * 0.015).clamp(8.0, 16.0)),
                  
                  Flexible(
                    child: Text(
                      message,
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.8),
                        fontSize: (screenWidth * 0.04).clamp(12.0, 16.0),
                        fontWeight: FontWeight.w300,
                        height: 1.4,
                      ),
                      textAlign: TextAlign.center,
                      maxLines: 3,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                  
                  SizedBox(height: (screenHeight * 0.03).clamp(16.0, 24.0)),
                  
                  ConstrainedBox(
                    constraints: BoxConstraints(
                      minHeight: (screenHeight * 0.06).clamp(40.0, 60.0),
                      maxWidth: double.infinity,
                    ),
                    child: SizedBox(
                      width: double.infinity,
                      child: ElevatedButton(
                        onPressed: () {
                          HapticFeedback.lightImpact();
                          Navigator.of(context).pop();
                          
                          if (title.contains('Name')) {
                            Future.delayed(const Duration(milliseconds: 100), () {
                              _nameFocusNode.requestFocus();
                            });
                          } else if (title.contains('Custom School') || (title.contains('School') && _selectedSchool == 'Others')) {
                            Future.delayed(const Duration(milliseconds: 100), () {
                              _customSchoolFocusNode.requestFocus();
                            });
                          }
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFFDF8D7),
                          foregroundColor: Colors.black,
                          padding: EdgeInsets.symmetric(
                            vertical: (screenHeight * 0.018).clamp(12.0, 18.0)
                          ),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          elevation: 2,
                        ),
                        child: FittedBox(
                          fit: BoxFit.scaleDown,
                          child: Text(
                            'GOT IT',
                            style: TextStyle(
                              fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
                              fontWeight: FontWeight.bold,
                              letterSpacing: 1,
                            ),
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  @override
  void dispose() {
    _nameController.dispose();
    _customSchoolController.dispose();
    _nameFocusNode.dispose();
    _customSchoolFocusNode.dispose();
    super.dispose();
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\home_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'qr_scanner_screen.dart';
import 'translation_screen.dart';
import 'tribes_screen.dart';

class HomeScreen extends StatefulWidget {
  final Map<String, dynamic> userData;

  const HomeScreen({super.key, required this.userData});

  @override
  _HomeScreenState createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> with TickerProviderStateMixin {
  int _currentIndex = 0;
  final ScrollController _scrollController = ScrollController();
  
  late AnimationController _fadeController;
  late AnimationController _pulseController;
  late Animation<double> _fadeAnimation;
  late Animation<double> _pulseAnimation;
  late AnimationController _backButtonFadeController;
  late Animation<double> _backButtonFadeAnimation;
  
  bool _showScrollIndicator = true;
  bool _userHasScrolled = false;

  @override
  void initState() {
    super.initState();
    
    _fadeController = AnimationController(
      duration: const Duration(milliseconds: 500),
      vsync: this,
    );
    
    _pulseController = AnimationController(
      duration: const Duration(milliseconds: 1500),
      vsync: this,
    );
    
    _backButtonFadeController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    
    _fadeAnimation = Tween<double>(
      begin: 1.0,
      end: 0.0,
    ).animate(CurvedAnimation(
      parent: _fadeController,
      curve: Curves.easeOut,
    ));
    
    _pulseAnimation = Tween<double>(
      begin: 0.8,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: _pulseController,
      curve: Curves.easeInOut,
    ));
    
    _backButtonFadeAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: _backButtonFadeController,
      curve: Curves.easeInOut,
    ));
    
    _startInitialAnimations();
    _scrollController.addListener(_onScroll);
  }
  
  void _startInitialAnimations() {
    _fadeController.reset();
    _backButtonFadeController.forward();
    _pulseController.repeat(reverse: true);
  }
  
  void _hideScrollIndicator() {
    if (_showScrollIndicator && mounted) {
      setState(() {
        _showScrollIndicator = false;
      });
      _pulseController.stop();
      _fadeController.forward();
    }
  }

  void _onScroll() {
    if (_currentIndex == 0 && _scrollController.offset > 10 && _showScrollIndicator && !_userHasScrolled) {
      _userHasScrolled = true;
      _hideScrollIndicator();
    }
    
    if (_currentIndex == 0) {
      if (_scrollController.offset <= 5) {
        if (_backButtonFadeController.status != AnimationStatus.forward && 
            _backButtonFadeController.status != AnimationStatus.completed) {
          _backButtonFadeController.forward();
        }
      } else {
        if (_backButtonFadeController.status != AnimationStatus.reverse && 
            _backButtonFadeController.status != AnimationStatus.dismissed) {
          _backButtonFadeController.reverse();
        }
      }
    }
  }

  void _showScrollIndicatorForCurrentTab() {
    if (mounted) {
      setState(() {
        _showScrollIndicator = true;
        _userHasScrolled = false;
      });
      _fadeController.reset();
      _backButtonFadeController.forward();
      _pulseController.repeat(reverse: true);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: SafeArea(
        child: Stack(
          children: [
            _currentIndex == 0 
              ? _buildWelcomeScreenWithScrollingBackgrounds() 
              : _currentIndex == 1 
                ? const TribesScreen()
                : const TranslationScreen(),
            
            if (_currentIndex == 0)
              Positioned(
                top: 16,
                right: 16,
                child: AnimatedBuilder(
                  animation: _backButtonFadeAnimation,
                  builder: (context, child) {
                    return Opacity(
                      opacity: _backButtonFadeAnimation.value,
                      child: _buildBackButton(),
                    );
                  },
                ),
              ),
            
            if (_currentIndex == 0 && _showScrollIndicator)
              Positioned(
                bottom: 8,
                left: 0,
                right: 0,
                child: IgnorePointer(
                  child: AnimatedBuilder(
                    animation: _fadeAnimation,
                    builder: (context, child) {
                      return Opacity(
                        opacity: _fadeAnimation.value,
                        child: AnimatedBuilder(
                          animation: _pulseAnimation,
                          builder: (context, child) {
                            return Transform.scale(
                              scale: _pulseAnimation.value,
                              child: Column(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Container(
                                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
                                    decoration: BoxDecoration(
                                      color: Colors.black.withOpacity(0.8),
                                      borderRadius: BorderRadius.circular(20),
                                      border: Border.all(
                                        color: const Color.fromARGB(255, 230, 223, 200).withOpacity(0.6),
                                        width: 1,
                                      ),
                                    ),
                                    child: const Text(
                                      'Scroll down to explore',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: 14,
                                        fontWeight: FontWeight.w500,
                                      ),
                                    ),
                                  ),
                                  const SizedBox(height: 12),
                                  Row(
                                    mainAxisAlignment: MainAxisAlignment.center,
                                    children: [
                                      _buildAnimatedArrow(0),
                                      const SizedBox(width: 16),
                                      _buildAnimatedArrow(200),
                                      const SizedBox(width: 16),
                                      _buildAnimatedArrow(400),
                                    ],
                                  ),
                                ],
                              ),
                            );
                          },
                        ),
                      );
                    },
                  ),
                ),
              ),
          ],
        ),
      ),
      bottomNavigationBar: _buildBottomNavigationBar(),
    );
  }

  Widget _buildBackButton() {
    return GestureDetector(
      onTap: () {
        HapticFeedback.lightImpact();
        _showReturnToLoginDialog();
      },
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: Colors.black.withOpacity(0.7),
          borderRadius: BorderRadius.circular(18),
          border: Border.all(
            color: const Color.fromARGB(255, 223, 216, 188).withOpacity(0.6),
            width: 1.5,
          ),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.5),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: const Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              Icons.arrow_back_ios,
              color: Colors.white,
              size: 8,
            ),
            SizedBox(width: 2),
            Text(
              'Back',
              style: TextStyle(
                color: Colors.white,
                fontSize: 8,
                fontWeight: FontWeight.w600,
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _showReturnToLoginDialog() {
    HapticFeedback.lightImpact();
    
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (BuildContext context) {
        return Dialog(
          backgroundColor: Colors.transparent,
          child: Container(
            margin: const EdgeInsets.symmetric(horizontal: 20),
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              gradient: const LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  Color(0xFF2a2a2a),
                  Color(0xFF1a1a1a),
                  Color(0xFF0d0d0d),
                ],
              ),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: const Color(0xFFD4AF37).withOpacity(0.5),
                width: 1,
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.8),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  width: 70,
                  height: 70,
                  decoration: BoxDecoration(
                    color: const Color(0xFFD4AF37).withOpacity(0.1),
                    borderRadius: BorderRadius.circular(35),
                    border: Border.all(
                      color: const Color(0xFFD4AF37).withOpacity(0.3),
                      width: 2,
                    ),
                  ),
                  child: const Icon(
                    Icons.info_outline,
                    color: Color(0xFFD4AF37),
                    size: 35,
                  ),
                ),
                
                const SizedBox(height: 20),
                
                const Text(
                  'Return to Login?',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 0.5,
                  ),
                  textAlign: TextAlign.center,
                ),
                
                const SizedBox(height: 12),
                
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(0.3),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(
                      color: Colors.white.withOpacity(0.1),
                      width: 1,
                    ),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text(
                        'Current Information:',
                        style: TextStyle(
                          color: Color(0xFFD4AF37),
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Name: ',
                            style: TextStyle(
                              color: Colors.white70,
                              fontSize: 14,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          Expanded(
                            child: Text(
                              widget.userData['name'] ?? 'Unknown',
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 14,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 4),
                      Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Role: ',
                            style: TextStyle(
                              color: Colors.white70,
                              fontSize: 14,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          Expanded(
                            child: Text(
                              widget.userData['role'] ?? 'Unknown',
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 14,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                          ),
                        ],
                      ),
                      if (widget.userData['school'] != null) ...[
                        const SizedBox(height: 4),
                        Row(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              'School: ',
                              style: TextStyle(
                                color: Colors.white70,
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            Expanded(
                              child: Text(
                                widget.userData['school'],
                                style: const TextStyle(
                                  color: Colors.white,
                                  fontSize: 14,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ],
                  ),
                ),
                
                const SizedBox(height: 16),
                
                Text(
                  'Going back will allow you to change your name, role, or school information. Are you sure you want to return to the login screen?',
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.8),
                    fontSize: 16,
                    fontWeight: FontWeight.w300,
                    height: 1.4,
                  ),
                  textAlign: TextAlign.center,
                ),
                
                const SizedBox(height: 24),
                
                Row(
                  children: [
                    Expanded(
                      child: TextButton(
                        onPressed: () {
                          HapticFeedback.lightImpact();
                          Navigator.of(context).pop();
                        },
                        style: TextButton.styleFrom(
                          backgroundColor: Colors.transparent,
                          padding: const EdgeInsets.symmetric(vertical: 14),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                            side: BorderSide(
                              color: Colors.white.withOpacity(0.3),
                              width: 1,
                            ),
                          ),
                        ),
                        child: const Text(
                          'Stay Here',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () {
                          HapticFeedback.lightImpact();
                          Navigator.of(context).pop();
                          _returnToLogin();
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFFDF8D7),
                          foregroundColor: Colors.black,
                          padding: const EdgeInsets.symmetric(vertical: 14),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          elevation: 2,
                        ),
                        child: const Text(
                          'Go Back',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  void _returnToLogin() {
    HapticFeedback.mediumImpact();
    Navigator.of(context).pushNamedAndRemoveUntil(
      '/',
      (route) => false,
    );
  }

  Widget _buildWelcomeScreenWithScrollingBackgrounds() {
    final screenHeight = MediaQuery.of(context).size.height;
    final screenWidth = MediaQuery.of(context).size.width;
    final isLandscape = screenWidth > screenHeight;
    
    // Adaptive zone heights based on orientation
    final zone1Height = isLandscape 
        ? (screenHeight * 0.50).clamp(250.0, double.infinity)
        : (screenHeight * 0.35).clamp(200.0, double.infinity);
    
    final zone2Height = isLandscape
        ? (screenHeight * 0.90).clamp(500.0, double.infinity)
        : (screenHeight * 0.65).clamp(400.0, double.infinity);
    
    final zone3Height = isLandscape
        ? (screenHeight * 0.20).clamp(100.0, 200.0)
        : (screenHeight * 0.15).clamp(80.0, 150.0);
    
    return SingleChildScrollView(
      controller: _scrollController,
      physics: const BouncingScrollPhysics(
        parent: AlwaysScrollableScrollPhysics(),
      ),
      clipBehavior: Clip.none,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          // ZONE 1 - Top content section
          Container(
            width: double.infinity,
            constraints: BoxConstraints(
              minHeight: zone1Height,
            ),
            decoration: const BoxDecoration(
              color: Colors.black,
            ),
            child: Padding(
              padding: EdgeInsets.symmetric(
                horizontal: (screenWidth * 0.06).clamp(16.0, 30.0),
                vertical: (screenHeight * 0.015).clamp(8.0, 20.0),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                mainAxisSize: MainAxisSize.min,
                children: [
                  SizedBox(height: (screenHeight * 0.015).clamp(8.0, 20.0)),
                  
                  Align(
                    alignment: Alignment.centerLeft,
                    child: Container(
                      padding: EdgeInsets.symmetric(
                        horizontal: (screenWidth * 0.08).clamp(20.0, 40.0),
                        vertical: (screenHeight * 0.02).clamp(12.0, 25.0),
                      ),
                      decoration: BoxDecoration(
                        border: Border.all(color: Colors.white, width: 2),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          FittedBox(
                            fit: BoxFit.scaleDown,
                            alignment: Alignment.centerLeft,
                            child: Text(
                              'HUNI SA TRIBU',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.06).clamp(16.0, 28.0),
                                fontWeight: FontWeight.bold,
                                letterSpacing: 2,
                              ),
                            ),
                          ),
                          SizedBox(height: (screenHeight * 0.01).clamp(4.0, 12.0)),
                          Padding(
                            padding: EdgeInsets.only(left: (screenWidth * 0.07).clamp(12.0, 30.0)),
                            child: FittedBox(
                              fit: BoxFit.scaleDown,
                              alignment: Alignment.centerLeft,
                              child: Text(
                                'Cultural Heritage Museum',
                                style: TextStyle(
                                  color: Colors.white70,
                                  fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                                  letterSpacing: 1,
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  
                  SizedBox(height: (screenHeight * 0.02).clamp(12.0, 25.0)),
                  
                  Align(
                    alignment: Alignment.centerLeft,
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        FittedBox(
                          fit: BoxFit.scaleDown,
                          alignment: Alignment.centerLeft,
                          child: Text(
                            'Your Portal to a',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: (screenWidth * 0.05).clamp(14.0, 22.0),
                              fontWeight: FontWeight.w300,
                            ),
                          ),
                        ),
                        FittedBox(
                          fit: BoxFit.scaleDown,
                          alignment: Alignment.centerLeft,
                          child: Text(
                            'Rich Heritage.',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: (screenWidth * 0.06).clamp(16.0, 26.0),
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  
                  SizedBox(height: (screenHeight * 0.015).clamp(8.0, 20.0)),
                ],
              ),
            ),
          ),
          
          Container(
            width: double.infinity,
            height: 3,
            color: Colors.white.withOpacity(0.3),
          ),
          
          // ZONE 2 - Journey begins section
          Container(
            constraints: BoxConstraints(
              minHeight: zone2Height,
            ),
            width: double.infinity,
            decoration: const BoxDecoration(
              image: DecorationImage(
                image: AssetImage('assets/images/cultural_background.jpg'),
                fit: BoxFit.cover,
                opacity: 0.6,
              ),
            ),
            child: Container(
              decoration: BoxDecoration(
                color: Colors.black.withOpacity(0.2),
              ),
              child: Padding(
                padding: EdgeInsets.all((screenWidth * 0.06).clamp(16.0, 30.0)),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    SizedBox(height: (screenHeight * 0.01).clamp(8.0, 15.0)),
                    
                    Align(
                      alignment: Alignment.centerLeft,
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          FittedBox(
                            fit: BoxFit.scaleDown,
                            alignment: Alignment.centerLeft,
                            child: Text(
                              'Your journey',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.045).clamp(14.0, 20.0),
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ),
                          FittedBox(
                            fit: BoxFit.scaleDown,
                            alignment: Alignment.centerLeft,
                            child: Text(
                              'begins with a scan.',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.045).clamp(14.0, 20.0),
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                          SizedBox(height: (screenHeight * 0.01).clamp(6.0, 12.0)),
                          LayoutBuilder(
                            builder: (context, constraints) {
                              return RichText(
                                text: TextSpan(
                                  style: TextStyle(
                                    color: Colors.white70,
                                    fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                                  ),
                                  children: [
                                    const TextSpan(
                                      text: 'Scan QR codes on museum exhibits to ',
                                    ),
                                    TextSpan(
                                      text: 'explore',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                                        fontWeight: FontWeight.bold,
                                      ),
                                    ),
                                    const TextSpan(
                                      text: ' the rich culture of indigenous tribes',
                                    ),
                                  ],
                                ),
                              );
                            },
                          ),
                        ],
                      ),
                    ),
                    
                    SizedBox(height: (screenHeight * 0.04).clamp(20.0, 50.0)),
                    
                    // QR Scanner Card - Responsive with constraints
                    LayoutBuilder(
                      builder: (context, constraints) {
                        final maxSize = isLandscape 
                            ? screenHeight * 0.5 
                            : constraints.maxWidth * 0.7;
                        final containerSize = maxSize.clamp(200.0, 300.0);
                        
                        return Container(
                          width: containerSize,
                          height: containerSize,
                          decoration: BoxDecoration(
                            color: Colors.transparent,
                            border: Border.all(
                              color: const Color(0xFFE0D4BE),
                              width: 3,
                            ),
                            borderRadius: BorderRadius.circular(8),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.white.withOpacity(0.2),
                                blurRadius: 2,
                                offset: const Offset(0, 4),
                              ),
                            ],
                          ),
                          child: Container(
                            decoration: BoxDecoration(
                              borderRadius: BorderRadius.circular(5),
                              color: Colors.black.withOpacity(0.6),
                            ),
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              crossAxisAlignment: CrossAxisAlignment.center,
                              children: [
                                Center(
                                  child: GestureDetector(
                                    onTap: () {
                                      HapticFeedback.lightImpact();
                                      _openQRScanner();
                                    },
                                    child: _buildQRScanButton(containerSize),
                                  ),
                                ),
                                
                                SizedBox(height: (screenHeight * 0.03).clamp(15.0, 30.0)),
                                
                                Center(
                                  child: GestureDetector(
                                    onTap: () {
                                      HapticFeedback.lightImpact();
                                      _openQRScanner();
                                    },
                                    child: Container(
                                      padding: EdgeInsets.symmetric(
                                        horizontal: (screenWidth * 0.04).clamp(12.0, 20.0),
                                        vertical: (screenHeight * 0.01).clamp(6.0, 12.0),
                                      ),
                                      decoration: BoxDecoration(
                                        color: Colors.black.withOpacity(0.4),
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                      child: FittedBox(
                                        fit: BoxFit.scaleDown,
                                        child: Text(
                                          'SCAN HERE',
                                          textAlign: TextAlign.center,
                                          style: TextStyle(
                                            color: const Color(0xFFE0D4BE),
                                            fontSize: (screenWidth * 0.045).clamp(14.0, 20.0),
                                            fontWeight: FontWeight.bold,
                                            letterSpacing: 2,
                                            shadows: [
                                              Shadow(
                                                blurRadius: 4,
                                                color: Colors.black.withOpacity(0.8),
                                                offset: const Offset(0, 2),
                                              ),
                                            ],
                                          ),
                                        ),
                                      ),
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        );
                      },
                    ),
                    
                    SizedBox(height: (screenHeight * 0.03).clamp(15.0, 40.0)),
                  ],
                ),
              ),
            ),
          ),
          
          // ZONE 3 - About the Tribes header
          Container(
            constraints: BoxConstraints(
              minHeight: zone3Height,
            ),
            width: double.infinity,
            decoration: const BoxDecoration(
              image: DecorationImage(
                image: AssetImage('assets/images/cultural_section_bg.jpg'),
                fit: BoxFit.cover,
                opacity: 0.4,
              ),
              border: Border(
                top: BorderSide(color: Colors.white, width: 1.0),
                bottom: BorderSide(color: Colors.white, width: 1.0),
              ),
            ),
            child: Container(
              decoration: BoxDecoration(
                color: Colors.black.withOpacity(0.5),
              ),
              child: Center(
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16.0),
                  child: FittedBox(
                    fit: BoxFit.scaleDown,
                    child: Text(
                      'ABOUT THE TRIBES',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: (screenWidth * 0.08).clamp(20.0, 36.0),
                        fontWeight: FontWeight.bold,
                        letterSpacing: 2.0,
                        shadows: const [
                          Shadow(
                            blurRadius: 8,
                            color: Colors.black,
                            offset: Offset(0, 2),
                          ),
                          Shadow(
                            blurRadius: 4,
                            color: Colors.black,
                            offset: Offset(0, 1),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            ),
          ),
          
          // ZONE 4 - Tribe Cards Section
          Container(
            width: double.infinity,
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Colors.black,
                  Colors.black,
                  Colors.black,
                ],
              ),
            ),
            child: Container(
              decoration: const BoxDecoration(
                image: DecorationImage(
                  image: AssetImage('assets/images/mandaya_main.jpg'),
                  fit: BoxFit.cover,
                  opacity: 0.5,
                ),
              ),
              child: Padding(
                padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.06).clamp(16.0, 30.0)),
                child: Column(
                  children: [
                    SizedBox(height: (screenHeight * 0.05).clamp(20.0, 50.0)),
                    _buildTribeCard(
                      title: "KAGAN",
                      description: "The Kagan people are known for their rich cultural heritage and traditional practices. They are masters of traditional music and dance ceremonies.",
                      imagePath: "assets/images/kagan.jpg",
                      screenWidth: screenWidth,
                      screenHeight: screenHeight,
                      isLandscape: isLandscape,
                    ),
                    SizedBox(height: (screenHeight * 0.03).clamp(15.0, 30.0)),
                    _buildTribeCard(
                      title: "MANDAYA",
                      description: "The Mandaya tribe is one of the major indigenous groups in Mindanao, primarily found in Davao Oriental. They are masters of traditional music and dance ceremonies.",
                      imagePath: "assets/images/mandaya.jpg",
                      screenWidth: screenWidth,
                      screenHeight: screenHeight,
                      isLandscape: isLandscape,
                    ),
                    SizedBox(height: (screenHeight * 0.03).clamp(15.0, 30.0)),
                    _buildTribeCard(
                      title: "MANSAKA",
                      description: "The Mansaka people are skilled in various traditional crafts and have a deep connection with nature. They are masters of traditional music and dance ceremonies.",
                      imagePath: "assets/images/mansaka.jpg",
                      screenWidth: screenWidth,
                      screenHeight: screenHeight,
                      isLandscape: isLandscape,
                    ),
                    SizedBox(height: (screenHeight * 0.1).clamp(40.0, 100.0)),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildQRScanButton(double containerSize) {
    final buttonSize = (containerSize * 0.35).clamp(60.0, 120.0);
    final innerSize = buttonSize * 0.9;
    final gridSize = buttonSize * 0.35;
    
    return SizedBox(
      width: buttonSize,
      height: buttonSize,
      child: Stack(
        alignment: Alignment.center,
        children: [
          Container(
            width: buttonSize,
            height: buttonSize,
            decoration: const BoxDecoration(
              color: Color(0xCC010100),
              shape: BoxShape.circle,
            ),
          ),
          Container(
            width: innerSize,
            height: innerSize,
            decoration: BoxDecoration(
              color: const Color(0xDD8E714B),
              shape: BoxShape.circle,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.3),
                  blurRadius: 6,
                  offset: const Offset(0, 3),
                ),
              ],
            ),
            child: Center(
              child: SizedBox(
                width: gridSize,
                height: gridSize,
                child: GridView.builder(
                  physics: const NeverScrollableScrollPhysics(),
                  shrinkWrap: true,
                  gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                    crossAxisCount: 4,
                    mainAxisSpacing: 3,
                    crossAxisSpacing: 3,
                  ),
                  itemCount: 16,
                  itemBuilder: (context, index) {
                    bool shouldFill = [0, 1, 2, 4, 5, 7, 8, 9, 10, 12, 14, 15].contains(index);
                    return Container(
                      decoration: BoxDecoration(
                        color: shouldFill ? const Color(0xFFEADCB6) : Colors.transparent,
                        borderRadius: BorderRadius.circular(1),
                      ),
                    );
                  },
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
  
  Widget _buildAnimatedArrow(int delay) {
    return AnimatedBuilder(
      animation: _pulseController,
      builder: (context, child) {
        return TweenAnimationBuilder(
          duration: const Duration(milliseconds: 1500),
          tween: Tween<double>(
            begin: 0.0,
            end: _pulseController.isAnimating ? 1.0 : 0.0,
          ),
          builder: (context, double value, child) {
            return Transform.translate(
              offset: Offset(0, 4 * value),
              child: Opacity(
                opacity: 1.0 - (value * 0.3),
                child: const Icon(
                  Icons.keyboard_arrow_down,
                  color: Colors.white,
                  size: 24,
                ),
              ),
            );
          },
        );
      },
    );
  }

  Widget _buildTribeCard({
    required String title,
    required String description,
    required String imagePath,
    required double screenWidth,
    required double screenHeight,
    required bool isLandscape,
  }) {
    // Adaptive image height for landscape - increased for better visibility
    final imageHeight = isLandscape 
        ? (screenHeight * 0.50).clamp(250.0, 450.0)
        : (screenHeight * 0.25).clamp(150.0, 300.0);
    
    // Use contain in landscape to show full image, cover in portrait
    final imageFit = isLandscape ? BoxFit.contain : BoxFit.cover;
    
    return Container(
      margin: EdgeInsets.symmetric(
        vertical: (screenHeight * 0.01).clamp(6.0, 15.0),
        horizontal: (screenWidth * 0.01).clamp(4.0, 10.0),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Padding(
            padding: EdgeInsets.only(bottom: (screenHeight * 0.015).clamp(8.0, 20.0)),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                FittedBox(
                  fit: BoxFit.scaleDown,
                  alignment: Alignment.centerLeft,
                  child: Text(
                    title,
                    style: TextStyle(
                      color: const Color(0xFFDBCCB5),
                      fontSize: (screenWidth * 0.07).clamp(20.0, 32.0),
                      fontWeight: FontWeight.bold,
                      fontFamily: 'Poppins',
                      letterSpacing: 1.2,
                    ),
                  ),
                ),
                SizedBox(height: (screenHeight * 0.008).clamp(4.0, 10.0)),
                Container(
                  width: (screenWidth * 0.2).clamp(60.0, 100.0),
                  height: 3,
                  color: const Color(0xFFEADCB6),
                ),
              ],
            ),
          ),
          
          Container(
            decoration: BoxDecoration(
              color: const Color(0xFF4A4A4A),
              borderRadius: BorderRadius.circular(16),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.4),
                  blurRadius: 12,
                  offset: const Offset(0, 6),
                ),
              ],
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(16),
              child: Column(
                children: [
                  Container(
                    height: imageHeight,
                    width: double.infinity,
                    color: Colors.black,
                    child: Stack(
                      children: [
                        Center(
                          child: Image.asset(
                            imagePath,
                            fit: imageFit,
                            width: double.infinity,
                            height: double.infinity,
                            alignment: Alignment.center,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: const BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      Color(0xFF8B4513),
                                      Color(0xFF654321),
                                      Color(0xFF2F1B14),
                                    ],
                                  ),
                                ),
                                child: Center(
                                  child: Icon(
                                    Icons.image,
                                    size: 60,
                                    color: Colors.white.withOpacity(0.5),
                                  ),
                                ),
                              );
                            },
                          ),
                        ),
                        if (!isLandscape)
                          Container(
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topCenter,
                                end: Alignment.bottomCenter,
                                colors: [
                                  Colors.transparent,
                                  Colors.black.withOpacity(0.6),
                                ],
                              ),
                            ),
                          ),
                      ],
                    ),
                  ),
                  
                  Container(
                    width: double.infinity,
                    padding: EdgeInsets.all((screenWidth * 0.05).clamp(12.0, 24.0)),
                    child: Text(
                      description,
                      style: TextStyle(
                        color: const Color(0xFFC5C6C7),
                        fontSize: (screenWidth * 0.04).clamp(13.0, 18.0),
                        fontFamily: 'Regular',
                        height: 1.6,
                        letterSpacing: 0.3,
                      ),
                      textAlign: TextAlign.left,
                    ),
                  ),
                ],
              ),
            ),
          ),
          
          Padding(
            padding: EdgeInsets.only(top: (screenHeight * 0.02).clamp(12.0, 25.0)),
            child: Align(
              alignment: Alignment.centerRight,
              child: _buildExploreButton(title, screenWidth, screenHeight),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildExploreButton(String title, double screenWidth, double screenHeight) {
    final buttonWidth = (screenWidth * 0.3).clamp(90.0, 130.0);
    final buttonHeight = (screenHeight * 0.045).clamp(35.0, 55.0);
    
    return LayoutBuilder(
      builder: (context, constraints) {
        return SizedBox(
          height: buttonHeight * 1.5,
          width: constraints.maxWidth,
          child: Stack(
            children: [
              Positioned(
                right: buttonWidth * 1.4,
                top: 0,
                child: Container(
                  width: buttonWidth * 1.3,
                  height: buttonHeight,
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color.fromARGB(200, 96, 95, 91),
                        Color.fromARGB(200, 96, 95, 91),
                      ],
                    ),
                    borderRadius: BorderRadius.circular(15),
                  ),
                ),
              ),
              
              Positioned(
                right: buttonWidth * 0.7,
                top: 0,
                child: Container(
                  width: buttonWidth * 1.15,
                  height: buttonHeight,
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color.fromARGB(255, 148, 147, 145),
                        Color.fromARGB(255, 148, 147, 145),
                      ],
                    ),
                    borderRadius: BorderRadius.circular(15),
                  ),
                ),
              ),

              Positioned(
                right: (screenWidth * 0.02).clamp(6.0, 15.0),
                top: 0,
                child: Container(
                  width: buttonWidth,
                  height: buttonHeight,
                  decoration: BoxDecoration(
                    color: const Color(0xFFFDF8D7),
                    borderRadius: BorderRadius.circular(15),
                    border: Border.all(
                      color: const Color(0xFF8B6F47),
                      width: 1,
                    ),
                  ),
                  child: Material(
                    color: Colors.transparent,
                    child: InkWell(
                      onTap: () {
                        HapticFeedback.lightImpact();
                        _exploreMore(title);
                      },
                      borderRadius: BorderRadius.circular(15),
                      child: Container(
                        alignment: Alignment.center,
                        padding: const EdgeInsets.symmetric(horizontal: 8.0),
                        child: FittedBox(
                          fit: BoxFit.scaleDown,
                          child: Text(
                            'Explore more',
                            style: TextStyle(
                              color: Colors.black,
                              fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                              fontWeight: FontWeight.bold,
                              letterSpacing: 0.8,
                            ),
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildBottomNavigationBar() {
    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFF000A00),
        border: Border(
          top: BorderSide(color: Colors.white.withOpacity(0.2), width: 1),
        ),
      ),
      child: BottomNavigationBar(
        currentIndex: _currentIndex,
        onTap: (index) {
          setState(() {
            _currentIndex = index;
          });
          if (index == 0) {
            _showScrollIndicatorForCurrentTab();
          }
        },
        backgroundColor: Colors.transparent,
        selectedItemColor: const Color(0xFFF4EBAF),
        unselectedItemColor: const Color(0xFFF4EBAF),
        elevation: 0,
        type: BottomNavigationBarType.fixed,
        selectedLabelStyle: const TextStyle(
          fontWeight: FontWeight.w600,
          color: Color(0xFFFBFFE6),
        ),
        unselectedLabelStyle: const TextStyle(
          color: Color(0xFFFBFFE6),
        ),
        items: [
          BottomNavigationBarItem(
            icon: Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: _currentIndex == 0 ? const Color(0xFFF4EBAF).withOpacity(0.2) : Colors.transparent,
                borderRadius: BorderRadius.circular(12),
              ),
              child: const Icon(Icons.home),
            ),
            label: 'Home',
          ),
          BottomNavigationBarItem(
            icon: Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: _currentIndex == 1 ? const Color(0xFFF4EBAF).withOpacity(0.2) : Colors.transparent,
                borderRadius: BorderRadius.circular(12),
              ),
              child: const Icon(Icons.groups),
            ),
            label: 'Tribes',
          ),
          BottomNavigationBarItem(
            icon: Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: _currentIndex == 2 ? const Color(0xFFF4EBAF).withOpacity(0.2) : Colors.transparent,
                borderRadius: BorderRadius.circular(12),
              ),
              child: const Icon(Icons.translate),
            ),
            label: 'Translate',
          ),
        ],
      ),
    );
  }

  void _exploreMore(String tribeName) {
    HapticFeedback.lightImpact();
    setState(() {
      _currentIndex = 1;
    });
    Future.delayed(const Duration(milliseconds: 300), () {
      // Add logic here to scroll to specific tribe if needed
    });
  }

  void _openQRScanner() {
    HapticFeedback.mediumImpact();
    Navigator.push(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) => 
          const QRScannerScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          const begin = Offset(0.0, 1.0);
          const end = Offset.zero;
          const curve = Curves.easeInOutCubic;

          var tween = Tween(begin: begin, end: end).chain(
            CurveTween(curve: curve),
          );

          return SlideTransition(
            position: animation.drive(tween),
            child: child,
          );
        },
        transitionDuration: const Duration(milliseconds: 400),
      ),
    );
  }

  @override
  void dispose() {
    _scrollController.removeListener(_onScroll);
    _scrollController.dispose();
    _fadeController.dispose();
    _pulseController.dispose();
    _backButtonFadeController.dispose();
    super.dispose();
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\kagan_detail_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'learn_more_screen/kagan_learn_more_screen.dart';
import 'kagan_category_screens/kagan_music_screen.dart';
import 'kagan_category_screens/kagan_video_screen.dart';
import 'kagan_category_screens/kagan_artifacts_screen.dart';
import 'kagan_category_screens/kagan_event_screen.dart';

class KaganCulturalDetailScreen extends StatelessWidget {
  final Map<String, dynamic>? contentData;
  
  const KaganCulturalDetailScreen({super.key, this.contentData});

  void _navigateToLearnMore(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const KaganCulturalLearnMoreScreen(),
      ),
    );
  }

  void _navigateToMusic(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const KaganMusicScreen(),
      ),
    );
  }

  void _navigateToVideo(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const KaganVideoScreen(),
      ),
    );
  }
  
  void _navigateToArtifacts(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const KaganArtifactsScreen(),
      ),
    );
  }

  void _navigateToImages(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const KaganEventScreen(),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    final data = contentData ?? 
        ModalRoute.of(context)?.settings.arguments as Map<String, dynamic>?;
    
    final bool hasQRContent = data != null && data.isNotEmpty;
    
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SingleChildScrollView(
          physics: const BouncingScrollPhysics(),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              hasQRContent 
                ? _buildQRContentSection(context, data, screenWidth, screenHeight)
                : _buildHeaderSection(context, screenWidth, screenHeight),
              SizedBox(height: (screenHeight * 0.03).clamp(12.0, 30.0)),
              if (!hasQRContent) _buildInfoSection(screenWidth, screenHeight),
              if (!hasQRContent) SizedBox(height: (screenHeight * 0.04).clamp(16.0, 40.0)),
              _buildCategoriesSection(context, screenWidth, screenHeight),
              SizedBox(height: (screenHeight * 0.05).clamp(20.0, 50.0)),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildQRContentSection(BuildContext context, Map<String, dynamic> data, double screenWidth, double screenHeight) {
    String? fileUrl;
    if (data['file'] != null) {
      fileUrl = 'https://huni-cms.ionvop.com/uploads/${data['file']}';
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        SafeArea(
          child: Padding(
            padding: EdgeInsets.symmetric(
              horizontal: (screenWidth * 0.05).clamp(12.0, 24.0),
              vertical: (screenHeight * 0.02).clamp(8.0, 20.0),
            ),
            child: Row(
              children: [
                Container(
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(0.3),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: IconButton(
                    onPressed: () {
                      HapticFeedback.lightImpact();
                      Navigator.pop(context);
                    },
                    icon: Icon(
                      Icons.arrow_back_ios,
                      color: Colors.white,
                      size: (screenWidth * 0.05).clamp(18.0, 24.0),
                    ),
                  ),
                ),
                SizedBox(width: (screenWidth * 0.04).clamp(12.0, 20.0)),
                Expanded(
                  child: Container(
                    padding: EdgeInsets.symmetric(
                      horizontal: (screenWidth * 0.03).clamp(8.0, 16.0),
                      vertical: (screenHeight * 0.008).clamp(4.0, 10.0),
                    ),
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: FittedBox(
                      fit: BoxFit.scaleDown,
                      alignment: Alignment.centerLeft,
                      child: Text(
                        'KAGAN CONTENT',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: (screenWidth * 0.05).clamp(16.0, 22.0),
                          fontWeight: FontWeight.bold,
                          letterSpacing: 1.5,
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),

        Padding(
          padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)),
          child: Container(
            width: double.infinity,
            constraints: BoxConstraints(
              minHeight: (screenHeight * 0.3).clamp(200.0, 400.0),
            ),
            decoration: BoxDecoration(
              color: const Color(0xFF2A2A2A),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: const Color(0xFFE0D4BE).withOpacity(0.3),
                width: 2,
              ),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (fileUrl != null)
                  ClipRRect(
                    borderRadius: const BorderRadius.only(
                      topLeft: Radius.circular(14),
                      topRight: Radius.circular(14),
                    ),
                    child: ConstrainedBox(
                      constraints: BoxConstraints(
                        minHeight: (screenHeight * 0.2).clamp(150.0, 250.0),
                        maxHeight: (screenHeight * 0.3).clamp(200.0, 300.0),
                      ),
                      child: SizedBox(
                        width: double.infinity,
                        child: Image.network(
                          fileUrl,
                          fit: BoxFit.cover,
                          loadingBuilder: (context, child, loadingProgress) {
                            if (loadingProgress == null) return child;
                            return Container(
                              height: (screenHeight * 0.25).clamp(150.0, 250.0),
                              color: Colors.grey[800],
                              child: const Center(
                                child: CircularProgressIndicator(
                                  color: Color(0xFFE0D4BE),
                                ),
                              ),
                            );
                          },
                          errorBuilder: (context, error, stackTrace) {
                            return Container(
                              height: (screenHeight * 0.25).clamp(150.0, 250.0),
                              decoration: const BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                  colors: [
                                    Color(0xFF8B4513),
                                    Color(0xFF654321),
                                  ],
                                ),
                              ),
                              child: Center(
                                child: Icon(
                                  Icons.image_not_supported,
                                  size: (screenWidth * 0.15).clamp(40.0, 60.0),
                                  color: Colors.white54,
                                ),
                              ),
                            );
                          },
                        ),
                      ),
                    ),
                  ),

                Padding(
                  padding: EdgeInsets.all((screenWidth * 0.05).clamp(12.0, 24.0)),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        data['title'] ?? 'Kagan Cultural Content',
                        style: TextStyle(
                          color: const Color(0xFFE0D4BE),
                          fontSize: (screenWidth * 0.06).clamp(18.0, 28.0),
                          fontWeight: FontWeight.bold,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),

                      SizedBox(height: (screenHeight * 0.015).clamp(8.0, 16.0)),

                      Wrap(
                        spacing: (screenWidth * 0.02).clamp(6.0, 12.0),
                        runSpacing: (screenHeight * 0.01).clamp(4.0, 8.0),
                        children: [
                          _buildMetadataChip(
                            label: 'Category',
                            value: data['category']?.toString().toUpperCase() ?? 'ARTIFACT',
                            color: const Color(0xFF8B7355),
                            screenWidth: screenWidth,
                          ),
                          _buildMetadataChip(
                            label: 'Tribe',
                            value: data['tribe']?.toString().toUpperCase() ?? 'KAGAN',
                            color: const Color(0xFF654321),
                            screenWidth: screenWidth,
                          ),
                        ],
                      ),

                      SizedBox(height: (screenHeight * 0.02).clamp(10.0, 20.0)),

                      if (data['description'] != null && 
                          data['description'].toString().trim().isNotEmpty)
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Description',
                              style: TextStyle(
                                color: const Color(0xFFE0D4BE),
                                fontSize: (screenWidth * 0.04).clamp(14.0, 20.0),
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                            SizedBox(height: (screenHeight * 0.01).clamp(6.0, 12.0)),
                            Text(
                              data['description'],
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                                height: 1.5,
                              ),
                              maxLines: 10,
                              overflow: TextOverflow.ellipsis,
                            ),
                          ],
                        ),

                      SizedBox(height: (screenHeight * 0.025).clamp(12.0, 24.0)),

                      Container(
                        padding: EdgeInsets.all((screenWidth * 0.03).clamp(8.0, 16.0)),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.3),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              Icons.qr_code,
                              color: const Color(0xFFE0D4BE),
                              size: (screenWidth * 0.04).clamp(14.0, 20.0),
                            ),
                            SizedBox(width: (screenWidth * 0.02).clamp(6.0, 12.0)),
                            Expanded(
                              child: FittedBox(
                                fit: BoxFit.scaleDown,
                                alignment: Alignment.centerLeft,
                                child: Text(
                                  'Content ID: ${data['id']}',
                                  style: TextStyle(
                                    color: const Color(0xFFE0D4BE),
                                    fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                                    fontWeight: FontWeight.w500,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildMetadataChip({
    required String label,
    required String value,
    required Color color,
    required double screenWidth,
  }) {
    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: (screenWidth * 0.02).clamp(6.0, 12.0),
        vertical: (screenWidth * 0.01).clamp(4.0, 8.0),
      ),
      decoration: BoxDecoration(
        color: color.withOpacity(0.2),
        borderRadius: BorderRadius.circular(6),
        border: Border.all(
          color: color.withOpacity(0.5),
          width: 1,
        ),
      ),
      child: FittedBox(
        fit: BoxFit.scaleDown,
        child: Text(
          value,
          style: TextStyle(
            color: color,
            fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
            fontWeight: FontWeight.w600,
          ),
        ),
      ),
    );
  }

  Widget _buildHeaderSection(BuildContext context, double screenWidth, double screenHeight) {
    return ConstrainedBox(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.35).clamp(250.0, 400.0),
        maxHeight: (screenHeight * 0.45).clamp(300.0, 500.0),
      ),
      child: Stack(
        children: [
          SizedBox(
            width: double.infinity,
            child: Container(
              decoration: const BoxDecoration(
                border: Border(
                  bottom: BorderSide(
                    color: Color(0xFFE0D4BE),
                    width: 2,
                  ),
                ),
              ),
              child: Image.asset(
                'assets/images/kagan_sd.jpg',
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    decoration: const BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Color(0xFF8B4513),
                          Color(0xFF654321),
                          Color(0xFF2F1B14),
                        ],
                      ),
                      border: Border(
                        bottom: BorderSide(
                          color: Color(0xFFE0D4BE),
                          width: 2,
                        ),
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
          
          Container(
            width: double.infinity,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Colors.black.withOpacity(0.4),
                  Colors.black.withOpacity(0.7),
                ],
              ),
            ),
          ),
          
          SafeArea(
            child: Padding(
              padding: EdgeInsets.symmetric(
                horizontal: (screenWidth * 0.05).clamp(12.0, 24.0),
                vertical: (screenHeight * 0.02).clamp(8.0, 20.0),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: (screenWidth * 0.05).clamp(18.0, 24.0),
                      ),
                    ),
                  ),
                  
                  const Spacer(),
                  
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(
                        padding: EdgeInsets.symmetric(
                          horizontal: (screenWidth * 0.03).clamp(8.0, 16.0),
                          vertical: (screenHeight * 0.008).clamp(4.0, 10.0),
                        ),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: FittedBox(
                          fit: BoxFit.scaleDown,
                          alignment: Alignment.centerLeft,
                          child: Text(
                            'KAGAN',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: (screenWidth * 0.09).clamp(28.0, 42.0),
                              fontWeight: FontWeight.bold,
                              letterSpacing: 2,
                              shadows: const [
                                Shadow(
                                  offset: Offset(0, 2),
                                  blurRadius: 4,
                                  color: Colors.black54,
                                ),
                              ],
                            ),
                          ),
                        ),
                      ),
                      
                      SizedBox(height: (screenHeight * 0.02).clamp(10.0, 20.0)),
                      
                      GestureDetector(
                        onTap: () {
                          HapticFeedback.lightImpact();
                          _navigateToLearnMore(context);
                        },
                        child: Container(
                          padding: EdgeInsets.symmetric(
                            horizontal: (screenWidth * 0.005).clamp(2.0, 6.0),
                            vertical: (screenHeight * 0.001).clamp(1.0, 4.0),
                          ),
                          decoration: const BoxDecoration(
                            border: Border(
                              bottom: BorderSide(
                                color: Colors.white,
                                width: 1,
                              ),
                            ),
                          ),
                          child: FittedBox(
                            fit: BoxFit.scaleDown,
                            alignment: Alignment.centerLeft,
                            child: Text(
                              'Learn more',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
                                fontWeight: FontWeight.w400,
                                letterSpacing: 0.5,
                              ),
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                  
                  SizedBox(height: (screenHeight * 0.03).clamp(12.0, 30.0)),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoSection(double screenWidth, double screenHeight) {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)),
      child: Row(
        children: [
          Expanded(
            child: _buildInfoCard(
              icon: Icons.location_on,
              label: 'ORIGIN',
              value: 'Bukidnon,\nMisamis Oriental',
              screenWidth: screenWidth,
              screenHeight: screenHeight,
            ),
          ),
          SizedBox(width: (screenWidth * 0.03).clamp(8.0, 16.0)),
          Expanded(
            child: _buildInfoCard(
              icon: Icons.groups,
              label: 'POPULATION',
              value: '~50,000',
              screenWidth: screenWidth,
              screenHeight: screenHeight,
            ),
          ),
          SizedBox(width: (screenWidth * 0.03).clamp(8.0, 16.0)),
          Expanded(
            child: _buildInfoCard(
              icon: Icons.language,
              label: 'LANGUAGE',
              value: 'Kagan',
              screenWidth: screenWidth,
              screenHeight: screenHeight,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoCard({
    required IconData icon,
    required String label,
    required String value,
    required double screenWidth,
    required double screenHeight,
  }) {
    return Container(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.12).clamp(100.0, 150.0),
        maxHeight: (screenHeight * 0.18).clamp(120.0, 180.0),
      ),
      padding: EdgeInsets.all((screenWidth * 0.03).clamp(8.0, 16.0)),
      decoration: BoxDecoration(
        color: const Color(0xFF3A382F),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: const Color(0xFFE0D4BE).withOpacity(0.3),
          width: 1,
        ),
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        mainAxisSize: MainAxisSize.min,
        children: [
          Container(
            padding: EdgeInsets.all((screenWidth * 0.015).clamp(4.0, 8.0)),
            decoration: BoxDecoration(
              color: const Color(0xFFE0D4BE).withOpacity(0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              icon,
              color: const Color(0xFFE0D4BE),
              size: (screenWidth * 0.045).clamp(16.0, 22.0),
            ),
          ),
          
          SizedBox(height: (screenHeight * 0.01).clamp(4.0, 10.0)),
          
          FittedBox(
            fit: BoxFit.scaleDown,
            child: Text(
              label,
              style: TextStyle(
                color: const Color(0xFFE0D4BE),
                fontSize: (screenWidth * 0.02).clamp(9.0, 12.0),
                fontWeight: FontWeight.w600,
                letterSpacing: 1,
              ),
            ),
          ),
          
          SizedBox(height: (screenHeight * 0.005).clamp(2.0, 6.0)),
          
          Flexible(
            child: FittedBox(
              fit: BoxFit.scaleDown,
              child: Text(
                value,
                textAlign: TextAlign.center,
                style: TextStyle(
                  color: Colors.white,
                  fontSize: (screenWidth * 0.025).clamp(10.0, 14.0),
                  fontWeight: FontWeight.w500,
                  height: 1.2,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCategoriesSection(BuildContext context, double screenWidth, double screenHeight) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)),
          child: Row(
            children: [
              Icon(
                Icons.explore,
                color: const Color(0xFFE0D4BE),
                size: (screenWidth * 0.05).clamp(18.0, 24.0),
              ),
              SizedBox(width: (screenWidth * 0.02).clamp(6.0, 12.0)),
              Flexible(
                child: FittedBox(
                  fit: BoxFit.scaleDown,
                  alignment: Alignment.centerLeft,
                  child: Text(
                    'EXPLORE CATEGORIES',
                    style: TextStyle(
                      color: const Color(0xFFE0D4BE),
                      fontSize: (screenWidth * 0.04).clamp(14.0, 20.0),
                      fontWeight: FontWeight.bold,
                      letterSpacing: 1.5,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
        
        SizedBox(height: (screenHeight * 0.025).clamp(12.0, 24.0)),
        
        _buildCategoryCard(
          title: 'MUSIC',
          imagePath: 'assets/images/kagan_music.jpg',
          gradientColors: const [Color(0xFF8B7355), Color(0xFF654321)],
          onTap: () => _navigateToMusic(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
        
        _buildCategoryCard(
          title: 'VIDEO',
          imagePath: 'assets/images/kagan_video.jpg',
          gradientColors: const [Color(0xFF6B5B47), Color(0xFF4A3D2A)],
          onTap: () => _navigateToVideo(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
        
        _buildCategoryCard(
          title: 'ARTIFACTS',
          imagePath: 'assets/images/kagan_artifacts.jpg',
          gradientColors: const [Color(0xFF5D4A37), Color(0xFF3D2F1F)],
          onTap: () => _navigateToArtifacts(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
        
        _buildCategoryCard(
          title: 'EVENTS',
          imagePath: 'assets/images/kagan_images.jpg',
          gradientColors: const [Color(0xFF3D2F1F), Color(0xFF2A1F14)],
          onTap: () => _navigateToImages(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
      ],
    );
  }

  Widget _buildCategoryCard({
    required String title,
    required String imagePath,
    required List<Color> gradientColors,
    required VoidCallback onTap,
    required double screenWidth,
    required double screenHeight,
  }) {
    return Container(
      margin: EdgeInsets.only(
        bottom: (screenHeight * 0.02).clamp(10.0, 20.0),
        left: (screenWidth * 0.05).clamp(12.0, 24.0),
        right: (screenWidth * 0.05).clamp(12.0, 24.0),
      ),
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.12).clamp(100.0, 140.0),
        maxHeight: (screenHeight * 0.18).clamp(120.0, 180.0),
      ),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.4),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: () {
              HapticFeedback.mediumImpact();
              onTap();
            },
            child: Row(
              children: [
                SizedBox(
                  width: (screenWidth * 0.3).clamp(100.0, 150.0),
                  child: Image.asset(
                    imagePath,
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) {
                      return Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: gradientColors,
                          ),
                        ),
                        child: Center(
                          child: Icon(
                            _getCategoryIcon(title),
                            color: Colors.white.withOpacity(0.7),
                            size: (screenWidth * 0.1).clamp(32.0, 48.0),
                          ),
                        ),
                      );
                    },
                  ),
                ),
                
                Expanded(
                  child: Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.centerLeft,
                        end: Alignment.centerRight,
                        colors: [
                          gradientColors[0].withOpacity(0.8),
                          gradientColors[1].withOpacity(0.9),
                        ],
                      ),
                    ),
                    child: Center(
                      child: Padding(
                        padding: EdgeInsets.symmetric(
                          horizontal: (screenWidth * 0.02).clamp(6.0, 12.0),
                        ),
                        child: FittedBox(
                          fit: BoxFit.scaleDown,
                          child: Text(
                            title,
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: (screenWidth * 0.06).clamp(18.0, 28.0),
                              fontWeight: FontWeight.bold,
                              letterSpacing: 2,
                            ),
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  IconData _getCategoryIcon(String title) {
    switch (title.toLowerCase()) {
      case 'music':
        return Icons.music_note;
      case 'video':
        return Icons.play_circle_outline;
      case 'artifacts':
        return Icons.museum;
      case 'events':
        return Icons.event;
      case 'images':
        return Icons.photo_library;
      default:
        return Icons.category;
    }
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mandaya_detail_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'learn_more_screen/mandaya_learn_more_screen.dart';
import 'mandaya_category_screens/mandaya_music_screen.dart';
import 'mandaya_category_screens/mandaya_video_screen.dart';
import 'mandaya_category_screens/mandaya_artifacts_screen.dart';
import 'mandaya_category_screens/mandaya_event_screen.dart';

class MandayaCulturalDetailScreen extends StatelessWidget {
  final Map<String, dynamic>? contentData;
  
  const MandayaCulturalDetailScreen({super.key, this.contentData});

  void _navigateToLearnMore(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MandayaCulturalLearnMoreScreen(),
      ),
    );
  }

  void _navigateToMusic(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MandayaMusicScreen(),
      ),
    );
  }

  void _navigateToVideo(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MandayaVideoScreen(),
      ),
    );
  }

  void _navigateToArtifacts(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MandayaArtifactsScreen(),
      ),
    );
  }

  void _navigateToImages(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MandayaEventScreen(),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    final data = contentData ?? 
        ModalRoute.of(context)?.settings.arguments as Map<String, dynamic>?;
    
    final bool hasQRContent = data != null && data.isNotEmpty;
    
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SingleChildScrollView(
          physics: const BouncingScrollPhysics(),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              hasQRContent 
                ? _buildQRContentSection(context, data, screenWidth, screenHeight)
                : _buildHeaderSection(context, screenWidth, screenHeight),
              SizedBox(height: (screenHeight * 0.03).clamp(12.0, 30.0)),
              if (!hasQRContent) _buildInfoSection(screenWidth, screenHeight),
              if (!hasQRContent) SizedBox(height: (screenHeight * 0.04).clamp(16.0, 40.0)),
              _buildCategoriesSection(context, screenWidth, screenHeight),
              SizedBox(height: (screenHeight * 0.05).clamp(20.0, 50.0)),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildQRContentSection(BuildContext context, Map<String, dynamic> data, double screenWidth, double screenHeight) {
    String? fileUrl;
    if (data['file'] != null) {
      fileUrl = 'https://huni-cms.ionvop.com/uploads/${data['file']}';
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        SafeArea(
          child: Padding(
            padding: EdgeInsets.symmetric(
              horizontal: (screenWidth * 0.05).clamp(12.0, 24.0),
              vertical: (screenHeight * 0.02).clamp(8.0, 20.0),
            ),
            child: Row(
              children: [
                Container(
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(0.3),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: IconButton(
                    onPressed: () {
                      HapticFeedback.lightImpact();
                      Navigator.pop(context);
                    },
                    icon: Icon(
                      Icons.arrow_back_ios,
                      color: Colors.white,
                      size: (screenWidth * 0.05).clamp(18.0, 24.0),
                    ),
                  ),
                ),
                SizedBox(width: (screenWidth * 0.04).clamp(12.0, 20.0)),
                Expanded(
                  child: Container(
                    padding: EdgeInsets.symmetric(
                      horizontal: (screenWidth * 0.03).clamp(8.0, 16.0),
                      vertical: (screenHeight * 0.008).clamp(4.0, 10.0),
                    ),
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: FittedBox(
                      fit: BoxFit.scaleDown,
                      alignment: Alignment.centerLeft,
                      child: Text(
                        'MANDAYA CONTENT',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: (screenWidth * 0.05).clamp(16.0, 22.0),
                          fontWeight: FontWeight.bold,
                          letterSpacing: 1.5,
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),

        Padding(
          padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)),
          child: Container(
            width: double.infinity,
            constraints: BoxConstraints(
              minHeight: (screenHeight * 0.3).clamp(200.0, 400.0),
            ),
            decoration: BoxDecoration(
              color: const Color(0xFF2A2A2A),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: const Color(0xFF8FC475).withOpacity(0.3),
                width: 2,
              ),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (fileUrl != null)
                  ClipRRect(
                    borderRadius: const BorderRadius.only(
                      topLeft: Radius.circular(14),
                      topRight: Radius.circular(14),
                    ),
                    child: ConstrainedBox(
                      constraints: BoxConstraints(
                        minHeight: (screenHeight * 0.2).clamp(150.0, 250.0),
                        maxHeight: (screenHeight * 0.3).clamp(200.0, 300.0),
                      ),
                      child: SizedBox(
                        width: double.infinity,
                        child: Image.network(
                          fileUrl,
                          fit: BoxFit.cover,
                          loadingBuilder: (context, child, loadingProgress) {
                            if (loadingProgress == null) return child;
                            return Container(
                              height: (screenHeight * 0.25).clamp(150.0, 250.0),
                              color: Colors.grey[800],
                              child: const Center(
                                child: CircularProgressIndicator(
                                  color: Color(0xFF8FC475),
                                ),
                              ),
                            );
                          },
                          errorBuilder: (context, error, stackTrace) {
                            return Container(
                              height: (screenHeight * 0.25).clamp(150.0, 250.0),
                              decoration: const BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                  colors: [
                                    Color(0xFF4A5D23),
                                    Color(0xFF2F3E15),
                                  ],
                                ),
                              ),
                              child: Center(
                                child: Icon(
                                  Icons.image_not_supported,
                                  size: (screenWidth * 0.15).clamp(40.0, 60.0),
                                  color: Colors.white54,
                                ),
                              ),
                            );
                          },
                        ),
                      ),
                    ),
                  ),

                Padding(
                  padding: EdgeInsets.all((screenWidth * 0.05).clamp(12.0, 24.0)),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        data['title'] ?? 'Mandaya Cultural Content',
                        style: TextStyle(
                          color: const Color(0xFF8FC475),
                          fontSize: (screenWidth * 0.06).clamp(18.0, 28.0),
                          fontWeight: FontWeight.bold,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),

                      SizedBox(height: (screenHeight * 0.015).clamp(8.0, 16.0)),

                      Wrap(
                        spacing: (screenWidth * 0.02).clamp(6.0, 12.0),
                        runSpacing: (screenHeight * 0.01).clamp(4.0, 8.0),
                        children: [
                          _buildMetadataChip(
                            label: 'Category',
                            value: data['category']?.toString().toUpperCase() ?? 'ARTIFACT',
                            color: const Color(0xFF7BB061),
                            screenWidth: screenWidth,
                          ),
                          _buildMetadataChip(
                            label: 'Tribe',
                            value: data['tribe']?.toString().toUpperCase() ?? 'MANDAYA',
                            color: const Color(0xFF689C4D),
                            screenWidth: screenWidth,
                          ),
                        ],
                      ),

                      SizedBox(height: (screenHeight * 0.02).clamp(10.0, 20.0)),

                      if (data['description'] != null && 
                          data['description'].toString().trim().isNotEmpty)
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Description',
                              style: TextStyle(
                                color: const Color(0xFF8FC475),
                                fontSize: (screenWidth * 0.04).clamp(14.0, 20.0),
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                            SizedBox(height: (screenHeight * 0.01).clamp(6.0, 12.0)),
                            Text(
                              data['description'],
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                                height: 1.5,
                              ),
                              maxLines: 10,
                              overflow: TextOverflow.ellipsis,
                            ),
                          ],
                        ),

                      SizedBox(height: (screenHeight * 0.025).clamp(12.0, 24.0)),

                      Container(
                        padding: EdgeInsets.all((screenWidth * 0.03).clamp(8.0, 16.0)),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.3),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              Icons.qr_code,
                              color: const Color(0xFF8FC475),
                              size: (screenWidth * 0.04).clamp(14.0, 20.0),
                            ),
                            SizedBox(width: (screenWidth * 0.02).clamp(6.0, 12.0)),
                            Expanded(
                              child: FittedBox(
                                fit: BoxFit.scaleDown,
                                alignment: Alignment.centerLeft,
                                child: Text(
                                  'Content ID: ${data['id']}',
                                  style: TextStyle(
                                    color: const Color(0xFF8FC475),
                                    fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                                    fontWeight: FontWeight.w500,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildMetadataChip({
    required String label,
    required String value,
    required Color color,
    required double screenWidth,
  }) {
    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: (screenWidth * 0.02).clamp(6.0, 12.0),
        vertical: (screenWidth * 0.01).clamp(4.0, 8.0),
      ),
      decoration: BoxDecoration(
        color: color.withOpacity(0.2),
        borderRadius: BorderRadius.circular(6),
        border: Border.all(
          color: color.withOpacity(0.5),
          width: 1,
        ),
      ),
      child: FittedBox(
        fit: BoxFit.scaleDown,
        child: Text(
          value,
          style: TextStyle(
            color: color,
            fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
            fontWeight: FontWeight.w600,
          ),
        ),
      ),
    );
  }

  Widget _buildHeaderSection(BuildContext context, double screenWidth, double screenHeight) {
    return ConstrainedBox(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.35).clamp(250.0, 400.0),
        maxHeight: (screenHeight * 0.45).clamp(300.0, 500.0),
      ),
      child: Stack(
        children: [
          SizedBox(
            width: double.infinity,
            child: Container(
              decoration: const BoxDecoration(
                border: Border(
                  bottom: BorderSide(
                    color: Color(0xFF8FC475),
                    width: 2,
                  ),
                ),
              ),
              child: Image.asset(
                'assets/images/mandaya.jpg',
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    decoration: const BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Color(0xFF4A5D23),
                          Color(0xFF2F3E15),
                          Color(0xFF1A2209),
                        ],
                      ),
                      border: Border(
                        bottom: BorderSide(
                          color: Color(0xFF8FC475),
                          width: 2,
                        ),
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
          
          Container(
            width: double.infinity,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Colors.black.withOpacity(0.4),
                  Colors.black.withOpacity(0.7),
                ],
              ),
            ),
          ),
          
          SafeArea(
            child: Padding(
              padding: EdgeInsets.symmetric(
                horizontal: (screenWidth * 0.05).clamp(12.0, 24.0),
                vertical: (screenHeight * 0.02).clamp(8.0, 20.0),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: (screenWidth * 0.05).clamp(18.0, 24.0),
                      ),
                    ),
                  ),
                  
                  const Spacer(),
                  
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(
                        padding: EdgeInsets.symmetric(
                          horizontal: (screenWidth * 0.03).clamp(8.0, 16.0),
                          vertical: (screenHeight * 0.008).clamp(4.0, 10.0),
                        ),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: FittedBox(
                          fit: BoxFit.scaleDown,
                          alignment: Alignment.centerLeft,
                          child: Text(
                            'MANDAYA',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: (screenWidth * 0.09).clamp(28.0, 42.0),
                              fontWeight: FontWeight.bold,
                              letterSpacing: 2,
                              shadows: const [
                                Shadow(
                                  offset: Offset(0, 2),
                                  blurRadius: 4,
                                  color: Colors.black54,
                                ),
                              ],
                            ),
                          ),
                        ),
                      ),
                      
                      SizedBox(height: (screenHeight * 0.02).clamp(10.0, 20.0)),
                      
                      GestureDetector(
                        onTap: () {
                          HapticFeedback.lightImpact();
                          _navigateToLearnMore(context);
                        },
                        child: Container(
                          padding: EdgeInsets.symmetric(
                            horizontal: (screenWidth * 0.005).clamp(2.0, 6.0),
                            vertical: (screenHeight * 0.001).clamp(1.0, 4.0),
                          ),
                          decoration: const BoxDecoration(
                            border: Border(
                              bottom: BorderSide(
                                color: Colors.white,
                                width: 1,
                              ),
                            ),
                          ),
                          child: FittedBox(
                            fit: BoxFit.scaleDown,
                            alignment: Alignment.centerLeft,
                            child: Text(
                              'Learn more',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
                                fontWeight: FontWeight.w400,
                                letterSpacing: 0.5,
                              ),
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                  
                  SizedBox(height: (screenHeight * 0.03).clamp(12.0, 30.0)),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoSection(double screenWidth, double screenHeight) {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)),
      child: Row(
        children: [
          Expanded(
            child: _buildInfoCard(
              icon: Icons.location_on,
              label: 'ORIGIN',
              value: 'Davao Oriental,\nCaraga Region',
              screenWidth: screenWidth,
              screenHeight: screenHeight,
            ),
          ),
          SizedBox(width: (screenWidth * 0.03).clamp(8.0, 16.0)),
          Expanded(
            child: _buildInfoCard(
              icon: Icons.groups,
              label: 'POPULATION',
              value: '~40,000',
              screenWidth: screenWidth,
              screenHeight: screenHeight,
            ),
          ),
          SizedBox(width: (screenWidth * 0.03).clamp(8.0, 16.0)),
          Expanded(
            child: _buildInfoCard(
              icon: Icons.language,
              label: 'LANGUAGE',
              value: 'Mandaya',
              screenWidth: screenWidth,
              screenHeight: screenHeight,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoCard({
    required IconData icon,
    required String label,
    required String value,
    required double screenWidth,
    required double screenHeight,
  }) {
    return Container(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.12).clamp(100.0, 150.0),
        maxHeight: (screenHeight * 0.18).clamp(120.0, 180.0),
      ),
      padding: EdgeInsets.all((screenWidth * 0.03).clamp(8.0, 16.0)),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: const Color(0xFF8FC475).withOpacity(0.3),
          width: 1,
        ),
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        mainAxisSize: MainAxisSize.min,
        children: [
          Container(
            padding: EdgeInsets.all((screenWidth * 0.015).clamp(4.0, 8.0)),
            decoration: BoxDecoration(
              color: const Color(0xFF8FC475).withOpacity(0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              icon,
              color: const Color(0xFF8FC475),
              size: (screenWidth * 0.045).clamp(16.0, 22.0),
            ),
          ),
          
          SizedBox(height: (screenHeight * 0.01).clamp(4.0, 10.0)),
          
          FittedBox(
            fit: BoxFit.scaleDown,
            child: Text(
              label,
              style: TextStyle(
                color: const Color(0xFF8FC475),
                fontSize: (screenWidth * 0.02).clamp(9.0, 12.0),
                fontWeight: FontWeight.w600,
                letterSpacing: 1,
              ),
            ),
          ),
          
          SizedBox(height: (screenHeight * 0.005).clamp(2.0, 6.0)),
          
          Flexible(
            child: FittedBox(
              fit: BoxFit.scaleDown,
              child: Text(
                value,
                textAlign: TextAlign.center,
                style: TextStyle(
                  color: Colors.white,
                  fontSize: (screenWidth * 0.025).clamp(10.0, 14.0),
                  fontWeight: FontWeight.w500,
                  height: 1.2,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCategoriesSection(BuildContext context, double screenWidth, double screenHeight) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)),
          child: Row(
            children: [
              Icon(
                Icons.explore,
                color: const Color(0xFF8FC475),
                size: (screenWidth * 0.05).clamp(18.0, 24.0),
              ),
              SizedBox(width: (screenWidth * 0.02).clamp(6.0, 12.0)),
              Flexible(
                child: FittedBox(
                  fit: BoxFit.scaleDown,
                  alignment: Alignment.centerLeft,
                  child: Text(
                    'EXPLORE CATEGORIES',
                    style: TextStyle(
                      color: const Color(0xFF8FC475),
                      fontSize: (screenWidth * 0.04).clamp(14.0, 20.0),
                      fontWeight: FontWeight.bold,
                      letterSpacing: 1.5,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
        
        SizedBox(height: (screenHeight * 0.025).clamp(12.0, 24.0)),
        
        _buildCategoryCard(
          title: 'MUSIC',
          imagePath: 'assets/images/mandaya_music.jpg',
          gradientColors: const [Color(0xFF8FC475), Color(0xFF7BB061)],
          onTap: () => _navigateToMusic(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
        
        _buildCategoryCard(
          title: 'VIDEO',
          imagePath: 'assets/images/mandaya_video.jpg',
          gradientColors: const [Color(0xFF7BB061), Color(0xFF689C4D)],
          onTap: () => _navigateToVideo(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
        
        _buildCategoryCard(
          title: 'ARTIFACTS',
          imagePath: 'assets/images/mandaya_artifacts.jpg',
          gradientColors: const [Color(0xFF689C4D), Color(0xFF558839)],
          onTap: () => _navigateToArtifacts(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
        
        _buildCategoryCard(
          title: 'EVENTS',
          imagePath: 'assets/images/mandaya_images.jpg',
          gradientColors: const [Color(0xFF558839), Color(0xFF427425)],
          onTap: () => _navigateToImages(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
      ],
    );
  }

  Widget _buildCategoryCard({
    required String title,
    required String imagePath,
    required List<Color> gradientColors,
    required VoidCallback onTap,
    required double screenWidth,
    required double screenHeight,
  }) {
    return Container(
      margin: EdgeInsets.only(
        bottom: (screenHeight * 0.02).clamp(10.0, 20.0),
        left: (screenWidth * 0.05).clamp(12.0, 24.0),
        right: (screenWidth * 0.05).clamp(12.0, 24.0),
      ),
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.12).clamp(100.0, 140.0),
        maxHeight: (screenHeight * 0.18).clamp(120.0, 180.0),
      ),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.4),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: () {
              HapticFeedback.mediumImpact();
              onTap();
            },
            child: Row(
              children: [
                SizedBox(
                  width: (screenWidth * 0.3).clamp(100.0, 150.0),
                  child: Image.asset(
                    imagePath,
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) {
                      return Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: gradientColors,
                          ),
                        ),
                        child: Center(
                          child: Icon(
                            _getCategoryIcon(title),
                            color: Colors.white.withOpacity(0.7),
                            size: (screenWidth * 0.1).clamp(32.0, 48.0),
                          ),
                        ),
                      );
                    },
                  ),
                ),
                
                Expanded(
                  child: Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.centerLeft,
                        end: Alignment.centerRight,
                        colors: [
                          gradientColors[0].withOpacity(0.8),
                          gradientColors[1].withOpacity(0.9),
                        ],
                      ),
                    ),
                    child: Center(
                      child: Padding(
                        padding: EdgeInsets.symmetric(
                          horizontal: (screenWidth * 0.02).clamp(6.0, 12.0),
                        ),
                        child: FittedBox(
                          fit: BoxFit.scaleDown,
                          child: Text(
                            title,
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: (screenWidth * 0.06).clamp(18.0, 28.0),
                              fontWeight: FontWeight.bold,
                              letterSpacing: 2,
                            ),
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  IconData _getCategoryIcon(String title) {
    switch (title.toLowerCase()) {
      case 'music':
        return Icons.music_note;
      case 'video':
        return Icons.play_circle_outline;
      case 'artifacts':
        return Icons.museum;
      case 'events':
        return Icons.event;
      case 'images':
        return Icons.photo_library;
      default:
        return Icons.category;
    }
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mansaka_detail_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'learn_more_screen/mansaka_learn_more_screen.dart';
import 'mansaka_category_screens/mansaka_music_screen.dart';
import 'mansaka_category_screens/mansaka_video_screen.dart';
import 'mansaka_category_screens/mansaka_artifacts_screen.dart';
import 'mansaka_category_screens/mansaka_event_screen.dart';

class MansakaCulturalDetailScreen extends StatelessWidget {
  final Map<String, dynamic>? contentData;
  
  const MansakaCulturalDetailScreen({super.key, this.contentData});

  void _navigateToLearnMore(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MansakaCulturalLearnMoreScreen(),
      ),
    );
  }

  void _navigateToMusic(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MansakaMusicScreen(),
      ),
    );
  }

  void _navigateToVideo(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MansakaVideoScreen(),
      ),
    );
  }

  void _navigateToArtifacts(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MansakaArtifactsScreen(),
      ),
    );
  }

  void _navigateToImages(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const MansakaEventScreen(),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    final data = contentData ?? 
        ModalRoute.of(context)?.settings.arguments as Map<String, dynamic>?;
    
    final bool hasQRContent = data != null && data.isNotEmpty;
    
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SingleChildScrollView(
          physics: const BouncingScrollPhysics(),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              hasQRContent 
                ? _buildQRContentSection(context, data, screenWidth, screenHeight)
                : _buildHeaderSection(context, screenWidth, screenHeight),
              SizedBox(height: (screenHeight * 0.03).clamp(12.0, 30.0)),
              if (!hasQRContent) _buildInfoSection(screenWidth, screenHeight),
              if (!hasQRContent) SizedBox(height: (screenHeight * 0.04).clamp(16.0, 40.0)),
              _buildCategoriesSection(context, screenWidth, screenHeight),
              SizedBox(height: (screenHeight * 0.05).clamp(20.0, 50.0)),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildQRContentSection(BuildContext context, Map<String, dynamic> data, double screenWidth, double screenHeight) {
    String? fileUrl;
    if (data['file'] != null) {
      fileUrl = 'https://huni-cms.ionvop.com/uploads/${data['file']}';
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        SafeArea(
          child: Padding(
            padding: EdgeInsets.symmetric(
              horizontal: (screenWidth * 0.05).clamp(12.0, 24.0),
              vertical: (screenHeight * 0.02).clamp(8.0, 20.0),
            ),
            child: Row(
              children: [
                Container(
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(0.3),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: IconButton(
                    onPressed: () {
                      HapticFeedback.lightImpact();
                      Navigator.pop(context);
                    },
                    icon: Icon(
                      Icons.arrow_back_ios,
                      color: Colors.white,
                      size: (screenWidth * 0.05).clamp(18.0, 24.0),
                    ),
                  ),
                ),
                SizedBox(width: (screenWidth * 0.04).clamp(12.0, 20.0)),
                Expanded(
                  child: Container(
                    padding: EdgeInsets.symmetric(
                      horizontal: (screenWidth * 0.03).clamp(8.0, 16.0),
                      vertical: (screenHeight * 0.008).clamp(4.0, 10.0),
                    ),
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: FittedBox(
                      fit: BoxFit.scaleDown,
                      alignment: Alignment.centerLeft,
                      child: Text(
                        'MANSAKA CONTENT',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: (screenWidth * 0.05).clamp(16.0, 22.0),
                          fontWeight: FontWeight.bold,
                          letterSpacing: 1.5,
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),

        Padding(
          padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)),
          child: Container(
            width: double.infinity,
            constraints: BoxConstraints(
              minHeight: (screenHeight * 0.3).clamp(200.0, 400.0),
            ),
            decoration: BoxDecoration(
              color: const Color(0xFF2A2A2A),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: const Color(0xFFC4A8E8).withOpacity(0.3),
                width: 2,
              ),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (fileUrl != null)
                  ClipRRect(
                    borderRadius: const BorderRadius.only(
                      topLeft: Radius.circular(14),
                      topRight: Radius.circular(14),
                    ),
                    child: ConstrainedBox(
                      constraints: BoxConstraints(
                        minHeight: (screenHeight * 0.2).clamp(150.0, 250.0),
                        maxHeight: (screenHeight * 0.3).clamp(200.0, 300.0),
                      ),
                      child: SizedBox(
                        width: double.infinity,
                        child: Image.network(
                          fileUrl,
                          fit: BoxFit.cover,
                          loadingBuilder: (context, child, loadingProgress) {
                            if (loadingProgress == null) return child;
                            return Container(
                              height: (screenHeight * 0.25).clamp(150.0, 250.0),
                              color: Colors.grey[800],
                              child: const Center(
                                child: CircularProgressIndicator(
                                  color: Color(0xFFC4A8E8),
                                ),
                              ),
                            );
                          },
                          errorBuilder: (context, error, stackTrace) {
                            return Container(
                              height: (screenHeight * 0.25).clamp(150.0, 250.0),
                              decoration: const BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                  colors: [
                                    Color(0xFF5D4E75),
                                    Color(0xFF3F325A),
                                  ],
                                ),
                              ),
                              child: Center(
                                child: Icon(
                                  Icons.image_not_supported,
                                  size: (screenWidth * 0.15).clamp(40.0, 60.0),
                                  color: Colors.white54,
                                ),
                              ),
                            );
                          },
                        ),
                      ),
                    ),
                  ),

                Padding(
                  padding: EdgeInsets.all((screenWidth * 0.05).clamp(12.0, 24.0)),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        data['title'] ?? 'Mansaka Cultural Content',
                        style: TextStyle(
                          color: const Color(0xFFC4A8E8),
                          fontSize: (screenWidth * 0.06).clamp(18.0, 28.0),
                          fontWeight: FontWeight.bold,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),

                      SizedBox(height: (screenHeight * 0.015).clamp(8.0, 16.0)),

                      Wrap(
                        spacing: (screenWidth * 0.02).clamp(6.0, 12.0),
                        runSpacing: (screenHeight * 0.01).clamp(4.0, 8.0),
                        children: [
                          _buildMetadataChip(
                            label: 'Category',
                            value: data['category']?.toString().toUpperCase() ?? 'ARTIFACT',
                            color: const Color(0xFFB19CD9),
                            screenWidth: screenWidth,
                          ),
                          _buildMetadataChip(
                            label: 'Tribe',
                            value: data['tribe']?.toString().toUpperCase() ?? 'MANSAKA',
                            color: const Color(0xFF9B59B6),
                            screenWidth: screenWidth,
                          ),
                        ],
                      ),

                      SizedBox(height: (screenHeight * 0.02).clamp(10.0, 20.0)),

                      if (data['description'] != null && 
                          data['description'].toString().trim().isNotEmpty)
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Description',
                              style: TextStyle(
                                color: const Color(0xFFC4A8E8),
                                fontSize: (screenWidth * 0.04).clamp(14.0, 20.0),
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                            SizedBox(height: (screenHeight * 0.01).clamp(6.0, 12.0)),
                            Text(
                              data['description'],
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                                height: 1.5,
                              ),
                              maxLines: 10,
                              overflow: TextOverflow.ellipsis,
                            ),
                          ],
                        ),

                      SizedBox(height: (screenHeight * 0.025).clamp(12.0, 24.0)),

                      Container(
                        padding: EdgeInsets.all((screenWidth * 0.03).clamp(8.0, 16.0)),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.3),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              Icons.qr_code,
                              color: const Color(0xFFC4A8E8),
                              size: (screenWidth * 0.04).clamp(14.0, 20.0),
                            ),
                            SizedBox(width: (screenWidth * 0.02).clamp(6.0, 12.0)),
                            Expanded(
                              child: FittedBox(
                                fit: BoxFit.scaleDown,
                                alignment: Alignment.centerLeft,
                                child: Text(
                                  'Content ID: ${data['id']}',
                                  style: TextStyle(
                                    color: const Color(0xFFC4A8E8),
                                    fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                                    fontWeight: FontWeight.w500,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildMetadataChip({
    required String label,
    required String value,
    required Color color,
    required double screenWidth,
  }) {
    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: (screenWidth * 0.02).clamp(6.0, 12.0),
        vertical: (screenWidth * 0.01).clamp(4.0, 8.0),
      ),
      decoration: BoxDecoration(
        color: color.withOpacity(0.2),
        borderRadius: BorderRadius.circular(6),
        border: Border.all(
          color: color.withOpacity(0.5),
          width: 1,
        ),
      ),
      child: FittedBox(
        fit: BoxFit.scaleDown,
        child: Text(
          value,
          style: TextStyle(
            color: color,
            fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
            fontWeight: FontWeight.w600,
          ),
        ),
      ),
    );
  }

  Widget _buildHeaderSection(BuildContext context, double screenWidth, double screenHeight) {
    return ConstrainedBox(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.35).clamp(250.0, 400.0),
        maxHeight: (screenHeight * 0.45).clamp(300.0, 500.0),
      ),
      child: Stack(
        children: [
          SizedBox(
            width: double.infinity,
            child: Container(
              decoration: const BoxDecoration(
                border: Border(
                  bottom: BorderSide(
                    color: Color(0xFFC4A8E8),
                    width: 2,
                  ),
                ),
              ),
              child: Image.asset(
                'assets/images/mansaka_h.jpg',
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    decoration: const BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Color(0xFF5D4E75),
                          Color(0xFF3F325A),
                          Color(0xFF2A1F3D),
                        ],
                      ),
                      border: Border(
                        bottom: BorderSide(
                          color: Color(0xFFC4A8E8),
                          width: 2,
                        ),
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
          
          Container(
            width: double.infinity,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Colors.black.withOpacity(0.4),
                  Colors.black.withOpacity(0.7),
                ],
              ),
            ),
          ),
          
          SafeArea(
            child: Padding(
              padding: EdgeInsets.symmetric(
                horizontal: (screenWidth * 0.05).clamp(12.0, 24.0),
                vertical: (screenHeight * 0.02).clamp(8.0, 20.0),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: (screenWidth * 0.05).clamp(18.0, 24.0),
                      ),
                    ),
                  ),
                  
                  const Spacer(),
                  
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(
                        padding: EdgeInsets.symmetric(
                          horizontal: (screenWidth * 0.03).clamp(8.0, 16.0),
                          vertical: (screenHeight * 0.008).clamp(4.0, 10.0),
                        ),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: FittedBox(
                          fit: BoxFit.scaleDown,
                          alignment: Alignment.centerLeft,
                          child: Text(
                            'MANSAKA',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: (screenWidth * 0.09).clamp(28.0, 42.0),
                              fontWeight: FontWeight.bold,
                              letterSpacing: 2,
                              shadows: const [
                                Shadow(
                                  offset: Offset(0, 2),
                                  blurRadius: 4,
                                  color: Colors.black54,
                                ),
                              ],
                            ),
                          ),
                        ),
                      ),
                      
                      SizedBox(height: (screenHeight * 0.02).clamp(10.0, 20.0)),
                      
                      GestureDetector(
                        onTap: () {
                          HapticFeedback.lightImpact();
                          _navigateToLearnMore(context);
                        },
                        child: Container(
                          padding: EdgeInsets.symmetric(
                            horizontal: (screenWidth * 0.005).clamp(2.0, 6.0),
                            vertical: (screenHeight * 0.001).clamp(1.0, 4.0),
                          ),
                          decoration: const BoxDecoration(
                            border: Border(
                              bottom: BorderSide(
                                color: Colors.white,
                                width: 1,
                              ),
                            ),
                          ),
                          child: FittedBox(
                            fit: BoxFit.scaleDown,
                            alignment: Alignment.centerLeft,
                            child: Text(
                              'Learn more',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
                                fontWeight: FontWeight.w400,
                                letterSpacing: 0.5,
                              ),
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                  
                  SizedBox(height: (screenHeight * 0.03).clamp(12.0, 30.0)),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoSection(double screenWidth, double screenHeight) {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)),
      child: Row(
        children: [
          Expanded(
            child: _buildInfoCard(
              icon: Icons.location_on,
              label: 'ORIGIN',
              value: 'Davao de Oro,\nCompostela Valley',
              screenWidth: screenWidth,
              screenHeight: screenHeight,
            ),
          ),
          SizedBox(width: (screenWidth * 0.03).clamp(8.0, 16.0)),
          Expanded(
            child: _buildInfoCard(
              icon: Icons.groups,
              label: 'POPULATION',
              value: '~60,000',
              screenWidth: screenWidth,
              screenHeight: screenHeight,
            ),
          ),
          SizedBox(width: (screenWidth * 0.03).clamp(8.0, 16.0)),
          Expanded(
            child: _buildInfoCard(
              icon: Icons.language,
              label: 'LANGUAGE',
              value: 'Mansaka',
              screenWidth: screenWidth,
              screenHeight: screenHeight,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoCard({
    required IconData icon,
    required String label,
    required String value,
    required double screenWidth,
    required double screenHeight,
  }) {
    return Container(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.12).clamp(100.0, 150.0),
        maxHeight: (screenHeight * 0.18).clamp(120.0, 180.0),
      ),
      padding: EdgeInsets.all((screenWidth * 0.03).clamp(8.0, 16.0)),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: const Color(0xFFC4A8E8).withOpacity(0.3),
          width: 1,
        ),
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        mainAxisSize: MainAxisSize.min,
        children: [
          Container(
            padding: EdgeInsets.all((screenWidth * 0.015).clamp(4.0, 8.0)),
            decoration: BoxDecoration(
              color: const Color(0xFFC4A8E8).withOpacity(0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              icon,
              color: const Color(0xFFC4A8E8),
              size: (screenWidth * 0.045).clamp(16.0, 22.0),
            ),
          ),
          
          SizedBox(height: (screenHeight * 0.01).clamp(4.0, 10.0)),
          
          FittedBox(
            fit: BoxFit.scaleDown,
            child: Text(
              label,
              style: TextStyle(
                color: const Color(0xFFC4A8E8),
                fontSize: (screenWidth * 0.02).clamp(9.0, 12.0),
                fontWeight: FontWeight.w600,
                letterSpacing: 1,
              ),
            ),
          ),
          
          SizedBox(height: (screenHeight * 0.005).clamp(2.0, 6.0)),
          
          Flexible(
            child: FittedBox(
              fit: BoxFit.scaleDown,
              child: Text(
                value,
                textAlign: TextAlign.center,
                style: TextStyle(
                  color: Colors.white,
                  fontSize: (screenWidth * 0.025).clamp(10.0, 14.0),
                  fontWeight: FontWeight.w500,
                  height: 1.2,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCategoriesSection(BuildContext context, double screenWidth, double screenHeight) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.05).clamp(12.0, 24.0)),
          child: Row(
            children: [
              Icon(
                Icons.explore,
                color: const Color(0xFFC4A8E8),
                size: (screenWidth * 0.05).clamp(18.0, 24.0),
              ),
              SizedBox(width: (screenWidth * 0.02).clamp(6.0, 12.0)),
              Flexible(
                child: FittedBox(
                  fit: BoxFit.scaleDown,
                  alignment: Alignment.centerLeft,
                  child: Text(
                    'EXPLORE CATEGORIES',
                    style: TextStyle(
                      color: const Color(0xFFC4A8E8),
                      fontSize: (screenWidth * 0.04).clamp(14.0, 20.0),
                      fontWeight: FontWeight.bold,
                      letterSpacing: 1.5,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
        
        SizedBox(height: (screenHeight * 0.025).clamp(12.0, 24.0)),
        
        _buildCategoryCard(
          title: 'MUSIC',
          imagePath: 'assets/images/mansaka_music.jpg',
          gradientColors: const [Color(0xFFB19CD9), Color(0xFF9B59B6)],
          onTap: () => _navigateToMusic(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
        
        _buildCategoryCard(
          title: 'VIDEO',
          imagePath: 'assets/images/mansaka_video.jpg',
          gradientColors: const [Color(0xFF9B59B6), Color(0xFF8E44AD)],
          onTap: () => _navigateToVideo(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
        
        _buildCategoryCard(
          title: 'ARTIFACTS',
          imagePath: 'assets/images/mansaka_artifacts_featured.jpg',
          gradientColors: const [Color(0xFF8E44AD), Color(0xFF663399)],
          onTap: () => _navigateToArtifacts(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
        
        _buildCategoryCard(
          title: 'EVENTS',
          imagePath: 'assets/images/mansaka_images.jpg',
          gradientColors: const [Color(0xFF663399), Color(0xFF4A1A4A)],
          onTap: () => _navigateToImages(context),
          screenWidth: screenWidth,
          screenHeight: screenHeight,
        ),
      ],
    );
  }

  Widget _buildCategoryCard({
    required String title,
    required String imagePath,
    required List<Color> gradientColors,
    required VoidCallback onTap,
    required double screenWidth,
    required double screenHeight,
  }) {
    return Container(
      margin: EdgeInsets.only(
        bottom: (screenHeight * 0.02).clamp(10.0, 20.0),
        left: (screenWidth * 0.05).clamp(12.0, 24.0),
        right: (screenWidth * 0.05).clamp(12.0, 24.0),
      ),
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.12).clamp(100.0, 140.0),
        maxHeight: (screenHeight * 0.18).clamp(120.0, 180.0),
      ),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.4),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: () {
              HapticFeedback.mediumImpact();
              onTap();
            },
            child: Row(
              children: [
                SizedBox(
                  width: (screenWidth * 0.3).clamp(100.0, 150.0),
                  child: Image.asset(
                    imagePath,
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) {
                      return Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: gradientColors,
                          ),
                        ),
                        child: Center(
                          child: Icon(
                            _getCategoryIcon(title),
                            color: Colors.white.withOpacity(0.7),
                            size: (screenWidth * 0.1).clamp(32.0, 48.0),
                          ),
                        ),
                      );
                    },
                  ),
                ),
                
                Expanded(
                  child: Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.centerLeft,
                        end: Alignment.centerRight,
                        colors: [
                          gradientColors[0].withOpacity(0.8),
                          gradientColors[1].withOpacity(0.9),
                        ],
                      ),
                    ),
                    child: Center(
                      child: Padding(
                        padding: EdgeInsets.symmetric(
                          horizontal: (screenWidth * 0.02).clamp(6.0, 12.0),
                        ),
                        child: FittedBox(
                          fit: BoxFit.scaleDown,
                          child: Text(
                            title,
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: (screenWidth * 0.06).clamp(18.0, 28.0),
                              fontWeight: FontWeight.bold,
                              letterSpacing: 2,
                            ),
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  IconData _getCategoryIcon(String title) {
    switch (title.toLowerCase()) {
      case 'music':
        return Icons.music_note;
      case 'video':
        return Icons.play_circle_outline;
      case 'artifacts':
        return Icons.museum;
      case 'events':
        return Icons.event;
      case 'images':
        return Icons.photo_library;
      default:
        return Icons.category;
    }
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\music_player_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'dart:async';

class MusicPlayerScreen extends StatefulWidget {
  final MusicTrack track;
  final Color themeColor;

  const MusicPlayerScreen({
    super.key,
    required this.track,
    this.themeColor = const Color(0xFFD4A574),
  });

  @override
  State<MusicPlayerScreen> createState() => _MusicPlayerScreenState();
}

class _MusicPlayerScreenState extends State<MusicPlayerScreen>
    with TickerProviderStateMixin {
  bool _isPlaying = false;
  bool _isFavorited = false;
  bool _isShuffled = false;
  bool _isRepeated = false;
  double _currentPosition = 0.0;
  final double _totalDuration = 240.0;
  Timer? _progressTimer;
  
  late AnimationController _playButtonController;
  late AnimationController _rotationController;
  late Animation<double> _rotationAnimation;

  @override
  void initState() {
    super.initState();
    _playButtonController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _rotationController = AnimationController(
      duration: const Duration(seconds: 20),
      vsync: this,
    );
    _rotationAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(
      parent: _rotationController,
      curve: Curves.linear,
    ));
  }

  @override
  void dispose() {
    _progressTimer?.cancel();
    _playButtonController.dispose();
    _rotationController.dispose();
    super.dispose();
  }

  void _togglePlayPause() {
    setState(() {
      _isPlaying = !_isPlaying;
    });

    if (_isPlaying) {
      _playButtonController.forward();
      _rotationController.repeat();
      _startProgressTimer();
    } else {
      _playButtonController.reverse();
      _rotationController.stop();
      _stopProgressTimer();
    }
  }

  void _startProgressTimer() {
    _progressTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (_currentPosition < _totalDuration) {
        setState(() {
          _currentPosition += 1;
        });
      } else {
        _stopProgressTimer();
        setState(() {
          _isPlaying = false;
          _currentPosition = 0;
        });
        _playButtonController.reverse();
        _rotationController.reset();
      }
    });
  }

  void _stopProgressTimer() {
    _progressTimer?.cancel();
  }

  void _seekTo(double position) {
    setState(() {
      _currentPosition = position;
    });
  }

  String _formatDuration(double seconds) {
    int minutes = (seconds / 60).floor();
    int remainingSeconds = (seconds % 60).floor();
    return '${minutes.toString().padLeft(1, '0')}:${remainingSeconds.toString().padLeft(2, '0')}';
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    final bottomPadding = MediaQuery.of(context).viewPadding.bottom;
    
    return Scaffold(
      backgroundColor: Colors.transparent,
      extendBodyBehindAppBar: true,
      resizeToAvoidBottomInset: false,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          bottom: false,
          child: SingleChildScrollView(
            physics: const BouncingScrollPhysics(),
            child: ConstrainedBox(
              constraints: BoxConstraints(
                minHeight: screenHeight - MediaQuery.of(context).viewPadding.top,
              ),
              child: IntrinsicHeight(
                child: Column(
                  children: [
                    _buildHeader(screenWidth, screenHeight),
                    SizedBox(height: (screenHeight * 0.025).clamp(15.0, 25.0)),
                    _buildAlbumArt(screenWidth, screenHeight),
                    SizedBox(height: (screenHeight * 0.04).clamp(20.0, 35.0)),
                    _buildTrackInfo(screenWidth, screenHeight),
                    SizedBox(height: (screenHeight * 0.05).clamp(25.0, 45.0)),
                    _buildProgressBar(screenWidth, screenHeight),
                    SizedBox(height: (screenHeight * 0.05).clamp(25.0, 45.0)),
                    _buildControlButtons(screenWidth, screenHeight),
                    const Spacer(),
                    _buildBottomControls(screenWidth, screenHeight),
                    SizedBox(height: ((bottomPadding > 0 ? bottomPadding + 20 : 40).toDouble()).clamp(30.0, 60.0)),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildHeader(double screenWidth, double screenHeight) {
    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: (screenWidth * 0.05).clamp(16.0, 24.0),
        vertical: (screenHeight * 0.015).clamp(8.0, 16.0),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          GestureDetector(
            onTap: () {
              HapticFeedback.lightImpact();
              Navigator.pop(context);
            },
            child: Container(
              padding: EdgeInsets.all((screenWidth * 0.02).clamp(6.0, 10.0)),
              decoration: BoxDecoration(
                color: Colors.black.withOpacity(0.3),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(
                Icons.keyboard_arrow_down,
                color: Colors.white,
                size: (screenWidth * 0.06).clamp(20.0, 28.0),
              ),
            ),
          ),
          Flexible(
            child: Column(
              children: [
                FittedBox(
                  fit: BoxFit.scaleDown,
                  child: Text(
                    'PLAYING FROM PLAYLIST',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.6),
                      fontSize: (screenWidth * 0.03).clamp(10.0, 13.0),
                      fontWeight: FontWeight.w500,
                      letterSpacing: 1,
                    ),
                  ),
                ),
                SizedBox(height: (screenHeight * 0.003).clamp(2.0, 4.0)),
                FittedBox(
                  fit: BoxFit.scaleDown,
                  child: Text(
                    widget.track.category,
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
          ),
          GestureDetector(
            onTap: () {
              HapticFeedback.lightImpact();
            },
            child: Container(
              padding: EdgeInsets.all((screenWidth * 0.02).clamp(6.0, 10.0)),
              decoration: BoxDecoration(
                color: Colors.black.withOpacity(0.3),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(
                Icons.more_vert,
                color: Colors.white,
                size: (screenWidth * 0.06).clamp(20.0, 28.0),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildAlbumArt(double screenWidth, double screenHeight) {
    return Container(
      margin: EdgeInsets.symmetric(
        horizontal: (screenWidth * 0.1).clamp(30.0, 50.0),
      ),
      child: AspectRatio(
        aspectRatio: 1,
        child: Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(20),
            boxShadow: [
              BoxShadow(
                color: widget.themeColor.withOpacity(0.3),
                blurRadius: (screenWidth * 0.075).clamp(20.0, 35.0),
                spreadRadius: 2,
                offset: const Offset(0, 10),
              ),
              BoxShadow(
                color: Colors.black.withOpacity(0.5),
                blurRadius: (screenWidth * 0.05).clamp(15.0, 25.0),
                offset: const Offset(0, 5),
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(20),
            child: AnimatedBuilder(
              animation: _rotationAnimation,
              builder: (context, child) {
                return Transform.rotate(
                  angle: _rotationAnimation.value * 2 * 3.14159,
                  child: Image.asset(
                    widget.track.imagePath,
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) {
                      return Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: [
                              widget.themeColor,
                              widget.themeColor.withOpacity(0.7),
                              widget.themeColor.withOpacity(0.5),
                            ],
                          ),
                        ),
                        child: Icon(
                          Icons.music_note,
                          color: Colors.white,
                          size: (screenWidth * 0.2).clamp(60.0, 90.0),
                        ),
                      );
                    },
                  ),
                );
              },
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildTrackInfo(double screenWidth, double screenHeight) {
    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: (screenWidth * 0.1).clamp(30.0, 50.0),
      ),
      child: Column(
        children: [
          Text(
            widget.track.title,
            style: TextStyle(
              color: Colors.white,
              fontSize: (screenWidth * 0.06).clamp(20.0, 28.0),
              fontWeight: FontWeight.bold,
            ),
            textAlign: TextAlign.center,
            maxLines: 3,
            overflow: TextOverflow.ellipsis,
          ),
          SizedBox(height: (screenHeight * 0.01).clamp(6.0, 10.0)),
          Text(
            widget.track.artist ?? 'Unknown Artist',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
              fontWeight: FontWeight.w500,
            ),
            textAlign: TextAlign.center,
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
          ),
        ],
      ),
    );
  }

  Widget _buildProgressBar(double screenWidth, double screenHeight) {
    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: (screenWidth * 0.1).clamp(30.0, 50.0),
      ),
      child: Column(
        children: [
          SliderTheme(
            data: SliderTheme.of(context).copyWith(
              activeTrackColor: widget.themeColor,
              inactiveTrackColor: Colors.white.withOpacity(0.2),
              thumbColor: widget.themeColor,
              overlayColor: widget.themeColor.withOpacity(0.2),
              thumbShape: RoundSliderThumbShape(
                enabledThumbRadius: (screenWidth * 0.015).clamp(5.0, 8.0),
              ),
              overlayShape: RoundSliderOverlayShape(
                overlayRadius: (screenWidth * 0.04).clamp(14.0, 18.0),
              ),
              trackHeight: (screenWidth * 0.01).clamp(3.0, 5.0),
            ),
            child: Slider(
              value: _currentPosition,
              max: _totalDuration,
              onChanged: _seekTo,
              onChangeStart: (value) {
                _stopProgressTimer();
              },
              onChangeEnd: (value) {
                if (_isPlaying) {
                  _startProgressTimer();
                }
              },
            ),
          ),
          SizedBox(height: (screenHeight * 0.01).clamp(6.0, 10.0)),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                _formatDuration(_currentPosition),
                style: TextStyle(
                  color: Colors.white.withOpacity(0.6),
                  fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                ),
              ),
              Text(
                _formatDuration(_totalDuration),
                style: TextStyle(
                  color: Colors.white.withOpacity(0.6),
                  fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildControlButtons(double screenWidth, double screenHeight) {
    return Container(
      padding: EdgeInsets.symmetric(
        vertical: (screenHeight * 0.015).clamp(8.0, 14.0),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
        children: [
          GestureDetector(
            onTap: () {
              HapticFeedback.lightImpact();
              setState(() {
                _isShuffled = !_isShuffled;
              });
            },
            child: Container(
              padding: EdgeInsets.all((screenWidth * 0.02).clamp(6.0, 10.0)),
              child: Icon(
                Icons.shuffle,
                color: _isShuffled ? widget.themeColor : Colors.white.withOpacity(0.6),
                size: (screenWidth * 0.06).clamp(20.0, 28.0),
              ),
            ),
          ),
          GestureDetector(
            onTap: () {
              HapticFeedback.mediumImpact();
            },
            child: Container(
              padding: EdgeInsets.all((screenWidth * 0.03).clamp(10.0, 14.0)),
              child: Icon(
                Icons.skip_previous,
                color: Colors.white.withOpacity(0.8),
                size: (screenWidth * 0.08).clamp(28.0, 36.0),
              ),
            ),
          ),
          GestureDetector(
            onTap: () {
              HapticFeedback.heavyImpact();
              _togglePlayPause();
            },
            child: Container(
              width: (screenWidth * 0.175).clamp(60.0, 80.0),
              height: (screenWidth * 0.175).clamp(60.0, 80.0),
              decoration: BoxDecoration(
                color: widget.themeColor,
                shape: BoxShape.circle,
                boxShadow: [
                  BoxShadow(
                    color: widget.themeColor.withOpacity(0.4),
                    blurRadius: (screenWidth * 0.0375).clamp(12.0, 18.0),
                    spreadRadius: 2,
                  ),
                ],
              ),
              child: AnimatedBuilder(
                animation: _playButtonController,
                builder: (context, child) {
                  return Icon(
                    _isPlaying ? Icons.pause : Icons.play_arrow,
                    color: Colors.white,
                    size: (screenWidth * 0.08).clamp(28.0, 36.0),
                  );
                },
              ),
            ),
          ),
          GestureDetector(
            onTap: () {
              HapticFeedback.mediumImpact();
            },
            child: Container(
              padding: EdgeInsets.all((screenWidth * 0.03).clamp(10.0, 14.0)),
              child: Icon(
                Icons.skip_next,
                color: Colors.white.withOpacity(0.8),
                size: (screenWidth * 0.08).clamp(28.0, 36.0),
              ),
            ),
          ),
          GestureDetector(
            onTap: () {
              HapticFeedback.lightImpact();
              setState(() {
                _isRepeated = !_isRepeated;
              });
            },
            child: Container(
              padding: EdgeInsets.all((screenWidth * 0.02).clamp(6.0, 10.0)),
              child: Icon(
                Icons.repeat,
                color: _isRepeated ? widget.themeColor : Colors.white.withOpacity(0.6),
                size: (screenWidth * 0.06).clamp(20.0, 28.0),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBottomControls(double screenWidth, double screenHeight) {
    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: (screenWidth * 0.1).clamp(30.0, 50.0),
        vertical: (screenHeight * 0.015).clamp(8.0, 14.0),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          GestureDetector(
            onTap: () {
              HapticFeedback.lightImpact();
            },
            child: Container(
              padding: EdgeInsets.all((screenWidth * 0.02).clamp(6.0, 10.0)),
              child: Icon(
                Icons.share_outlined,
                color: Colors.white.withOpacity(0.6),
                size: (screenWidth * 0.06).clamp(20.0, 28.0),
              ),
            ),
          ),
          GestureDetector(
            onTap: () {
              HapticFeedback.lightImpact();
              setState(() {
                _isFavorited = !_isFavorited;
              });
            },
            child: Container(
              padding: EdgeInsets.all((screenWidth * 0.02).clamp(6.0, 10.0)),
              child: Icon(
                _isFavorited ? Icons.favorite : Icons.favorite_border,
                color: _isFavorited ? widget.themeColor : Colors.white.withOpacity(0.6),
                size: (screenWidth * 0.07).clamp(24.0, 32.0),
              ),
            ),
          ),
          GestureDetector(
            onTap: () {
              HapticFeedback.lightImpact();
            },
            child: Container(
              padding: EdgeInsets.all((screenWidth * 0.02).clamp(6.0, 10.0)),
              child: Icon(
                Icons.playlist_add,
                color: Colors.white.withOpacity(0.6),
                size: (screenWidth * 0.06).clamp(20.0, 28.0),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class MusicTrack {
  final String title;
  final String description;
  final String category;
  final String imagePath;
  final String? artist;

  MusicTrack({
    required this.title,
    required this.description,
    required this.category,
    required this.imagePath,
    this.artist,
  });
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\qr_scanner_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:mobile_scanner/mobile_scanner.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import '../config.dart';
import '../global.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:cached_network_image/cached_network_image.dart';

class QRScannerScreen extends StatefulWidget {
  const QRScannerScreen({super.key});

  @override
  State<QRScannerScreen> createState() => _QRScannerScreenState();
}

class _QRScannerScreenState extends State<QRScannerScreen> with WidgetsBindingObserver {
  late MobileScannerController cameraController;
  
  String? barcodeResult;
  bool isScanning = true;
  String? errorMessage;
  bool torchEnabled = false;
  bool hasScannedAttendance = false;
  bool isProcessing = false;
  bool cameraPermissionGranted = false;
  bool isCheckingPermission = true;
  bool isPermanentlyDenied = false;
  
  DateTime? lastScanTime;
  final Set<String> _scannedCodesInSession = {};

  @override
  void initState() {
    super.initState();
    cameraController = MobileScannerController(
      detectionSpeed: DetectionSpeed.normal,
      facing: CameraFacing.back,
      torchEnabled: false,
    );
    WidgetsBinding.instance.addObserver(this);
    _checkCameraPermission();
  }

  Future<void> _checkCameraPermission() async {
    try {
      final status = await Permission.camera.status;
      
      if (status.isGranted) {
        await _updatePermissionState(true, false);
        await cameraController.start();
      } else if (status.isDenied) {
        // Show custom permission request dialog
        await _updatePermissionState(false, false);
        _requestCameraPermission();
      } else if (status.isPermanentlyDenied) {
        await _updatePermissionState(false, true);
      }
    } catch (e) {
      debugPrint('Error checking camera permission: $e');
      await _updatePermissionState(false, false);
    }
  }

  Future<void> _requestCameraPermission() async {
    if (!mounted) return;
    
    final result = await Permission.camera.request();
    
    if (result.isGranted) {
      await _updatePermissionState(true, false);
      await cameraController.start();
    } else if (result.isPermanentlyDenied) {
      await _updatePermissionState(false, true);
    } else {
      await _updatePermissionState(false, false);
    }
  }

  Future<void> _updatePermissionState(bool granted, bool permanentlyDenied) async {
    if (mounted) {
      setState(() {
        cameraPermissionGranted = granted;
        isCheckingPermission = false;
        isPermanentlyDenied = permanentlyDenied;
      });
    }
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    super.didChangeAppLifecycleState(state);
    
    if (!mounted || !cameraPermissionGranted) return;
    
    switch (state) {
      case AppLifecycleState.paused:
        _stopCamera();
        break;
      case AppLifecycleState.resumed:
        _startCamera();
        break;
      default:
        break;
    }
  }

  Future<void> _stopCamera() async {
    try {
      await cameraController.stop();
    } catch (e) {
      debugPrint('Error stopping camera: $e');
    }
  }

  Future<void> _startCamera() async {
    try {
      await cameraController.start();
    } catch (e) {
      debugPrint('Error starting camera: $e');
    }
  }

  @override
  Widget build(BuildContext context) {
    if (isCheckingPermission) {
      return _buildLoadingScreen();
    }

    if (!cameraPermissionGranted) {
      return _buildPermissionScreen();
    }

    return _buildScannerScreen();
  }

  Widget _buildLoadingScreen() {
    return Scaffold(
      appBar: AppBar(
        title: const Text('QR Code Scanner'),
        centerTitle: true,
      ),
      body: const Center(
        child: CircularProgressIndicator(),
      ),
    );
  }

  Widget _buildPermissionScreen() {
    return Scaffold(
      appBar: AppBar(
        title: const Text('QR Code Scanner'),
        centerTitle: true,
      ),
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(
                Icons.camera_alt_outlined,
                size: 80,
                color: Colors.grey,
              ),
              const SizedBox(height: 24),
              const Text(
                'Camera Permission Required',
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 16),
              Text(
                isPermanentlyDenied
                    ? 'Camera permission was denied. Please enable it in your device settings to scan QR codes.'
                    : 'This app needs camera access to scan QR codes.',
                style: const TextStyle(fontSize: 16),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 32),
              if (isPermanentlyDenied)
                ElevatedButton.icon(
                  onPressed: openAppSettings,
                  icon: const Icon(Icons.settings),
                  label: const Text('Open Settings'),
                  style: ElevatedButton.styleFrom(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 24,
                      vertical: 12,
                    ),
                  ),
                )
              else
                ElevatedButton.icon(
                  onPressed: _requestCameraPermission,
                  icon: const Icon(Icons.camera_alt),
                  label: const Text('Allow Camera Access'),
                  style: ElevatedButton.styleFrom(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 24,
                      vertical: 12,
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildScannerScreen() {
    return Scaffold(
      appBar: AppBar(
        title: const Text(
          'QR Code Scanner',
          overflow: TextOverflow.ellipsis,
        ),
        centerTitle: true,
        actions: [
          IconButton(
            icon: Icon(
              torchEnabled ? Icons.flash_on : Icons.flash_off,
              color: torchEnabled ? Colors.yellow : Colors.grey,
            ),
            onPressed: _toggleTorch,
          ),
          IconButton(
            icon: const Icon(Icons.camera_front),
            onPressed: _switchCamera,
          ),
        ],
      ),
      body: OrientationBuilder(
        builder: (context, orientation) {
          if (orientation == Orientation.landscape) {
            return _buildLandscapeLayout();
          }
          return _buildPortraitLayout();
        },
      ),
    );
  }

  Widget _buildPortraitLayout() {
    return LayoutBuilder(
      builder: (context, constraints) {
        final availableHeight = constraints.maxHeight;
        final availableWidth = constraints.maxWidth;
        
        final aspectRatio = availableWidth / availableHeight;
        final cameraHeight = aspectRatio > 0.75 
            ? (availableHeight * 0.6).clamp(280.0, availableHeight * 0.65)
            : (availableHeight * 0.65).clamp(300.0, availableHeight * 0.7);
        final bottomSectionHeight = (availableHeight * 0.35).clamp(120.0, 280.0);
        
        return Column(
          children: <Widget>[
            _buildCameraSection(availableWidth, cameraHeight),
            _buildBottomSection(availableWidth, availableHeight, bottomSectionHeight),
          ],
        );
      },
    );
  }

  Widget _buildLandscapeLayout() {
    return LayoutBuilder(
      builder: (context, constraints) {
        final availableHeight = constraints.maxHeight;
        final availableWidth = constraints.maxWidth;
        
        return Row(
          children: [
            // Camera section on the left
            Expanded(
              flex: 3,
              child: _buildCameraSection(availableWidth * 0.6, availableHeight),
            ),
            // Bottom section on the right
            Expanded(
              flex: 2,
              child: Container(
                height: availableHeight,
                padding: const EdgeInsets.all(16),
                child: Center(
                  child: SingleChildScrollView(
                    child: _buildBottomContent(availableWidth * 0.4, availableHeight),
                  ),
                ),
              ),
            ),
          ],
        );
      },
    );
  }

  Widget _buildCameraSection(double width, double height) {
    return SizedBox(
      width: width,
      height: height,
      child: Stack(
        children: [
          ClipRect(
            child: SizedBox(
              width: width,
              height: height,
              child: FittedBox(
                fit: BoxFit.cover,
                child: SizedBox(
                  width: width,
                  height: width,
                  child: MobileScanner(
                    controller: cameraController,
                    onDetect: _handleBarcodeDetection,
                  ),
                ),
              ),
            ),
          ),
          
          if (isScanning && !isProcessing) 
            _buildScanningOverlay(width, height),
          
          if (isProcessing)
            Container(
              color: Colors.black54,
              child: const Center(
                child: CircularProgressIndicator(
                  color: Colors.white,
                ),
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildBottomSection(double width, double height, double maxHeight) {
    return Expanded(
      child: Container(
        width: double.infinity,
        constraints: BoxConstraints(
          maxHeight: maxHeight,
          minHeight: 120.0,
        ),
        padding: EdgeInsets.symmetric(
          horizontal: (width * 0.04).clamp(12.0, 24.0),
          vertical: (height * 0.02).clamp(12.0, 20.0),
        ),
        decoration: const BoxDecoration(
          borderRadius: BorderRadius.only(
            topLeft: Radius.circular(20),
            topRight: Radius.circular(20),
          ),
        ),
        child: SingleChildScrollView(
          child: _buildBottomContent(width, height),
        ),
      ),
    );
  }

  Widget _buildBottomContent(double width, double height) {
    if (isProcessing) {
      return const SizedBox.shrink();
    }

    if (barcodeResult != null) {
      return _buildSuccessContent(width, height);
    }

    if (errorMessage != null) {
      return _buildErrorContent(width, height);
    }

    return _buildInstructionsContent(width, height);
  }

  Widget _buildSuccessContent(double width, double height) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      mainAxisSize: MainAxisSize.min,
      children: [
        Icon(
          Icons.check_circle,
          color: Colors.green,
          size: (width * 0.08).clamp(28.0, 40.0),
        ),
        SizedBox(height: (height * 0.01).clamp(6.0, 10.0)),
        Text(
          'QR Code Scanned Successfully!',
          style: Theme.of(context).textTheme.titleMedium?.copyWith(
            color: Colors.green,
            fontWeight: FontWeight.bold,
            fontSize: (width * 0.04).clamp(14.0, 18.0),
          ),
          textAlign: TextAlign.center,
          overflow: TextOverflow.ellipsis,
          maxLines: 2,
        ),
        SizedBox(height: (height * 0.015).clamp(8.0, 14.0)),
        ConstrainedBox(
          constraints: BoxConstraints(
            maxWidth: (width * 0.8).clamp(200.0, 400.0),
          ),
          child: SizedBox(
            width: double.infinity,
            child: ElevatedButton(
              onPressed: _resetScanner,
              style: ElevatedButton.styleFrom(
                padding: EdgeInsets.symmetric(
                  vertical: (height * 0.015).clamp(10.0, 14.0),
                ),
              ),
              child: Text(
                'Scan Another',
                style: TextStyle(
                  fontSize: (width * 0.04).clamp(14.0, 16.0),
                ),
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildErrorContent(double width, double height) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      mainAxisSize: MainAxisSize.min,
      children: [
        Icon(
          Icons.error_outline,
          color: Colors.red,
          size: (width * 0.08).clamp(28.0, 40.0),
        ),
        SizedBox(height: (height * 0.01).clamp(6.0, 10.0)),
        Text(
          errorMessage!,
          style: TextStyle(
            color: Colors.red,
            fontSize: (width * 0.035).clamp(13.0, 16.0),
          ),
          textAlign: TextAlign.center,
          maxLines: 3,
          overflow: TextOverflow.ellipsis,
        ),
      ],
    );
  }

  Widget _buildInstructionsContent(double width, double height) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      mainAxisSize: MainAxisSize.min,
      children: [
        Icon(
          Icons.qr_code_scanner,
          size: (width * 0.08).clamp(28.0, 40.0),
        ),
        SizedBox(height: (height * 0.01).clamp(6.0, 10.0)),
        Text(
          'Point your camera at a QR code',
          style: TextStyle(
            fontSize: (width * 0.038).clamp(13.0, 16.0),
          ),
          textAlign: TextAlign.center,
          overflow: TextOverflow.ellipsis,
          maxLines: 2,
        ),
        SizedBox(height: (height * 0.005).clamp(2.0, 6.0)),
        Text(
          'Make sure the QR code is well-lit and centered',
          style: TextStyle(
            fontSize: (width * 0.032).clamp(11.0, 14.0),
            color: Colors.grey,
          ),
          textAlign: TextAlign.center,
          overflow: TextOverflow.ellipsis,
          maxLines: 2,
        ),
      ],
    );
  }

  void _handleBarcodeDetection(BarcodeCapture capture) {
    if (!isScanning || isProcessing || !mounted) return;
    
    final barcodes = capture.barcodes;
    if (barcodes.isEmpty) return;
    
    final scannedCode = barcodes.first.rawValue;
    if (scannedCode == null || scannedCode.isEmpty) return;
    
    final normalizedCode = scannedCode.trim().toLowerCase();
    
    // Prevent rapid re-scanning of the same code
    if (_scannedCodesInSession.contains(normalizedCode)) {
      final now = DateTime.now();
      if (lastScanTime != null && now.difference(lastScanTime!).inSeconds < 5) {
        return;
      }
    }
    
    setState(() {
      barcodeResult = scannedCode;
      isScanning = false;
      isProcessing = true;
      errorMessage = null;
      lastScanTime = DateTime.now();
    });
    
    _processScannedCode(scannedCode, normalizedCode);
  }

  Widget _buildScanningOverlay(double width, double height) {
    // Calculate responsive cutout size for both orientations
    final smallerDimension = width < height ? width : height;
    final cutOutSize = (smallerDimension * 0.6).clamp(180.0, 300.0);
    final borderLength = (cutOutSize * 0.15).clamp(25.0, 45.0);
    final borderWidth = (smallerDimension * 0.02).clamp(6.0, 10.0);
    
    return Container(
      decoration: ShapeDecoration(
        shape: QrScannerOverlayShape(
          borderRadius: 12,
          borderLength: borderLength,
          borderWidth: borderWidth,
          cutOutSize: cutOutSize,
        ),
      ),
    );
  }

  Future<void> _processScannedCode(String originalCode, String normalizedCode) async {
    try {
      if (normalizedCode == "entrance") {
        await _handleEntranceScan(normalizedCode);
      } else {
        await _handleContentScan(originalCode, normalizedCode);
      }
    } on http.ClientException catch (e) {
      debugPrint('Network error: $e');
      _showError('Unable to connect to the server. Please check your internet connection and try again.');
    } catch (e) {
      debugPrint('Error processing scan: $e');
      String errorMsg = 'An unexpected error occurred. Please try again.';
      if (e.toString().contains('timeout')) {
        errorMsg = 'Connection timeout. Please check your internet connection and try again.';
      }
      _showError(errorMsg);
    }
  }

  Future<void> _handleEntranceScan(String normalizedCode) async {
    if (hasScannedAttendance) {
      _finishProcessing();
      _showDialog(
        title: 'Already Scanned',
        content: 'You have already scanned for attendance in this session. Please scan content QR codes to view information.',
      );
      return;
    }

    final response = await http.post(
      Uri.parse("${Config.baseUrl}visit/"),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({
        'name': Global.userData["name"],
        'school': Global.userData["school"],
      }),
    ).timeout(
      const Duration(seconds: 15),
      onTimeout: () => throw Exception('Connection timeout'),
    );

    if (!mounted) return;

    if (response.statusCode == 409) {
      setState(() {
        hasScannedAttendance = true;
      });
      _finishProcessing();
      _scannedCodesInSession.add(normalizedCode);
      
      _showDialog(
        title: 'Already Visited',
        content: 'You have already recorded your visit today!',
      );
      return;
    }

    if (response.statusCode >= 400) {
      _finishProcessing();
      final errorMsg = _extractErrorMessage(response);
      _showDialog(title: 'Error', content: errorMsg);
      return;
    }

    setState(() {
      hasScannedAttendance = true;
    });
    _finishProcessing();
    _scannedCodesInSession.add(normalizedCode);

    _showDialog(
      title: 'Success',
      content: 'Thank you for visiting! You can now scan content QR codes to view information.',
    );
  }

  Future<void> _handleContentScan(String originalCode, String normalizedCode) async {
    final scanResponse = await http.post(
      Uri.parse("${Config.baseUrl}scan/"),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({
        'code': originalCode,
        'name': Global.userData["name"],
        'school': Global.userData["school"],
      }),
    ).timeout(
      const Duration(seconds: 15),
      onTimeout: () => throw Exception('Connection timeout'),
    );

    if (!mounted) return;

    if (scanResponse.statusCode >= 400) {
      _finishProcessing();
      final errorMsg = _extractErrorMessage(scanResponse);
      _showDialog(title: 'Error', content: errorMsg);
      return;
    }

    final scanData = jsonDecode(scanResponse.body);
    final int contentId = scanData["data"]["id"];

    final contentResponse = await http.get(
      Uri.parse("${Config.baseUrl}content/?id=$contentId"),
    ).timeout(
      const Duration(seconds: 15),
      onTimeout: () => throw Exception('Connection timeout'),
    );

    if (!mounted) return;

    if (contentResponse.statusCode >= 400) {
      _finishProcessing();
      _showDialog(
        title: 'Error',
        content: 'Failed to load content details. Please try again.',
      );
      return;
    }

    final Map<String, dynamic> contentData = jsonDecode(contentResponse.body)["data"];
    
    _finishProcessing();
    _scannedCodesInSession.add(normalizedCode);
    _showContentDialog(contentData);
  }

  String _extractErrorMessage(http.Response response) {
    String errorMsg = 'An error occurred. Please try again.';
    try {
      final errorData = jsonDecode(response.body);
      errorMsg = errorData['message'] ?? errorMsg;
    } catch (e) {
      if (response.body.isNotEmpty) {
        errorMsg = response.body;
      }
    }
    return errorMsg;
  }

  void _finishProcessing() {
    if (mounted) {
      setState(() {
        isProcessing = false;
      });
    }
  }

  void _showError(String message) {
    _finishProcessing();
    _showDialog(title: 'Error', content: message);
  }

  void _showDialog({required String title, required String content}) {
    if (!mounted) return;
    
    showDialog(
      context: context,
      builder: (BuildContext dialogContext) {
        return AlertDialog(
          title: Text(
            title,
            overflow: TextOverflow.ellipsis,
            maxLines: 2,
          ),
          content: SingleChildScrollView(
            child: Text(
              content,
              style: const TextStyle(fontSize: 14),
            ),
          ),
          actions: [
            TextButton(
              child: const Text('OK'),
              onPressed: () => Navigator.of(dialogContext).pop(),
            ),
          ],
        );
      },
    );
  }

  void _showContentDialog(Map<String, dynamic> contentData) {
    if (!mounted) return;
    
    showDialog(
      context: context,
      builder: (BuildContext dialogContext) {
        return ExpandableContentDialog(contentData: contentData);
      },
    );
  }

  Future<void> _toggleTorch() async {
    try {
      await cameraController.toggleTorch();
      if (mounted) {
        setState(() {
          torchEnabled = !torchEnabled;
        });
      }
    } catch (e) {
      debugPrint('Error toggling torch: $e');
    }
  }

  Future<void> _switchCamera() async {
    try {
      await cameraController.switchCamera();
    } catch (e) {
      debugPrint('Error switching camera: $e');
    }
  }

  Future<void> _resetScanner() async {
    if (mounted) {
      setState(() {
        barcodeResult = null;
        isScanning = true;
        isProcessing = false;
        errorMessage = null;
      });
    }
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    cameraController.dispose();
    super.dispose();
  }
}

class ExpandableContentDialog extends StatefulWidget {
  final Map<String, dynamic> contentData;

  const ExpandableContentDialog({
    super.key,
    required this.contentData,
  });

  @override
  State<ExpandableContentDialog> createState() => _ExpandableContentDialogState();
}

class _ExpandableContentDialogState extends State<ExpandableContentDialog> {
  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    final String fileUrl = "https://huni-cms.ionvop.com/uploads/${widget.contentData['file']}";
    final DateTime contentTime = DateTime.fromMillisecondsSinceEpoch(widget.contentData['time'] * 1000);
    
    return Dialog(
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Container(
        constraints: BoxConstraints(
          maxHeight: screenHeight * 0.85,
          maxWidth: screenWidth * 0.92,
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildHeader(context),
            _buildContent(fileUrl, contentTime),
            _buildFooter(),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).primaryColor.withOpacity(0.1),
        borderRadius: const BorderRadius.only(
          topLeft: Radius.circular(16),
          topRight: Radius.circular(16),
        ),
      ),
      child: Text(
        widget.contentData['title'] ?? 'Content Details',
        style: const TextStyle(
          fontWeight: FontWeight.bold,
          fontSize: 18,
        ),
        textAlign: TextAlign.center,
      ),
    );
  }

  Widget _buildContent(String fileUrl, DateTime contentTime) {
    return Flexible(
      child: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            if (widget.contentData['file'] != null && widget.contentData['file'].isNotEmpty)
              _buildImageSection(fileUrl),
            
            if (widget.contentData['description'] != null && widget.contentData['description'].isNotEmpty)
              _buildDescriptionSection(),
            
            _buildMetadataSection(contentTime),
          ],
        ),
      ),
    );
  }

  Widget _buildImageSection(String fileUrl) {
    return GestureDetector(
      onTap: () => _showZoomableImage(context, fileUrl),
      child: Container(
        margin: const EdgeInsets.only(bottom: 16),
        constraints: const BoxConstraints(
          maxHeight: 300,
        ),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: Colors.grey.shade300),
        ),
        child: Stack(
          children: [
            ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: CachedNetworkImage(
                imageUrl: fileUrl,
                width: double.infinity,
                fit: BoxFit.cover,
                placeholder: (context, url) => Container(
                  height: 150,
                  padding: const EdgeInsets.all(32),
                  child: const Center(child: CircularProgressIndicator()),
                ),
                errorWidget: (context, url, error) => Container(
                  height: 150,
                  padding: const EdgeInsets.all(16),
                  child: const Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.broken_image, size: 50, color: Colors.grey),
                      SizedBox(height: 8),
                      Text('Failed to load image', style: TextStyle(color: Colors.grey)),
                    ],
                  ),
                ),
              ),
            ),
            Positioned(
              bottom: 8,
              right: 8,
              child: Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: Colors.black54,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: const Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.zoom_in, color: Colors.white, size: 18),
                    SizedBox(width: 4),
                    Text('Tap to zoom', style: TextStyle(color: Colors.white, fontSize: 11)),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDescriptionSection() {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.grey.shade50,
        borderRadius: BorderRadius.circular(8),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.description, size: 18, color: Colors.grey.shade700),
              const SizedBox(width: 8),
              const Text(
                'Description:',
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 15,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Text(
            widget.contentData['description'],
            style: const TextStyle(fontSize: 14, height: 1.5),
          ),
        ],
      ),
    );
  }

  Widget _buildMetadataSection(DateTime contentTime) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.blue.shade50,
        borderRadius: BorderRadius.circular(8),
      ),
      child: Column(
        children: [
          if (widget.contentData['tribe'] != null && widget.contentData['tribe'].isNotEmpty) ...[
            _buildInfoRow(
              icon: Icons.people,
              label: 'Tribe:',
              value: widget.contentData['tribe'],
              color: Colors.blue,
            ),
            const Divider(height: 20),
          ],
          
          if (widget.contentData['category'] != null && widget.contentData['category'].isNotEmpty) ...[
            _buildInfoRow(
              icon: Icons.category,
              label: 'Category:',
              value: widget.contentData['category'],
              color: Colors.orange,
            ),
            const Divider(height: 20),
          ],
          
          _buildInfoRow(
            icon: Icons.access_time,
            label: 'Date:',
            value: '${contentTime.day}/${contentTime.month}/${contentTime.year} ${contentTime.hour.toString().padLeft(2, '0')}:${contentTime.minute.toString().padLeft(2, '0')}',
            color: Colors.green,
          ),
        ],
      ),
    );
  }

  Widget _buildFooter() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        color: Colors.grey.shade100,
        borderRadius: const BorderRadius.only(
          bottomLeft: Radius.circular(16),
          bottomRight: Radius.circular(16),
        ),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.end,
        children: [
          TextButton.icon(
            icon: const Icon(Icons.close),
            label: const Text('Close'),
            onPressed: () => Navigator.of(context).pop(),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoRow({
    required IconData icon,
    required String label,
    required String value,
    required Color color,
  }) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Icon(icon, size: 20, color: color),
        const SizedBox(width: 10),
        Text(
          label,
          style: const TextStyle(
            fontWeight: FontWeight.bold,
            fontSize: 14,
          ),
        ),
        const SizedBox(width: 6),
        Expanded(
          child: Text(
            value,
            style: const TextStyle(fontSize: 14),
            overflow: TextOverflow.ellipsis,
            maxLines: 2,
          ),
        ),
      ],
    );
  }

  void _showZoomableImage(BuildContext context, String imageUrl) {
    showDialog(
      context: context,
      barrierColor: Colors.black87,
      builder: (BuildContext dialogContext) {
        return Dialog(
          backgroundColor: Colors.transparent,
          insetPadding: EdgeInsets.zero,
          child: GestureDetector(
            onTap: () => Navigator.of(dialogContext).pop(),
            child: Stack(
              children: [
                Center(
                  child: InteractiveViewer(
                    minScale: 0.5,
                    maxScale: 5.0,
                    boundaryMargin: const EdgeInsets.all(80),
                    child: CachedNetworkImage(
                      imageUrl: imageUrl,
                      fit: BoxFit.contain,
                      width: MediaQuery.of(context).size.width,
                      height: MediaQuery.of(context).size.height,
                      placeholder: (context, url) => SizedBox(
                        width: MediaQuery.of(context).size.width,
                        height: MediaQuery.of(context).size.height,
                        child: const Center(
                          child: CircularProgressIndicator(
                            color: Colors.white,
                          ),
                        ),
                      ),
                      errorWidget: (context, url, error) => SizedBox(
                        width: MediaQuery.of(context).size.width,
                        height: MediaQuery.of(context).size.height,
                        child: const Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Icons.broken_image, size: 60, color: Colors.white),
                            SizedBox(height: 16),
                            Text(
                              'Failed to load image',
                              style: TextStyle(color: Colors.white),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                ),
                Positioned(
                  top: 40,
                  right: 20,
                  child: Container(
                    decoration: const BoxDecoration(
                      color: Colors.black54,
                      shape: BoxShape.circle,
                    ),
                    child: IconButton(
                      icon: const Icon(Icons.close, color: Colors.white, size: 28),
                      onPressed: () => Navigator.of(dialogContext).pop(),
                    ),
                  ),
                ),
                Positioned(
                  bottom: 40,
                  left: 0,
                  right: 0,
                  child: Center(
                    child: Container(
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                      decoration: BoxDecoration(
                        color: Colors.black54,
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: const Text(
                        'Pinch to zoom  Drag to pan  Tap to close',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }
}

class QrScannerOverlayShape extends ShapeBorder {
  const QrScannerOverlayShape({
    this.borderColor = Colors.red,
    this.borderWidth = 3.0,
    this.overlayColor = const Color.fromRGBO(0, 0, 0, 80),
    this.borderRadius = 0,
    this.borderLength = 40,
    this.cutOutSize = 250,
  });

  final Color borderColor;
  final double borderWidth;
  final Color overlayColor;
  final double borderRadius;
  final double borderLength;
  final double cutOutSize;

  @override
  EdgeInsetsGeometry get dimensions => const EdgeInsets.all(10);

  @override
  Path getInnerPath(Rect rect, {TextDirection? textDirection}) {
    return Path()
      ..fillType = PathFillType.evenOdd
      ..addPath(getOuterPath(rect), Offset.zero);
  }

  @override
  Path getOuterPath(Rect rect, {TextDirection? textDirection}) {
    Path getLeftTopPath(Rect rect) {
      return Path()
        ..moveTo(rect.left, rect.bottom)
        ..lineTo(rect.left, rect.top + borderRadius)
        ..quadraticBezierTo(rect.left, rect.top, rect.left + borderRadius, rect.top)
        ..lineTo(rect.right, rect.top);
    }

    return getLeftTopPath(rect)
      ..lineTo(rect.right, rect.bottom)
      ..lineTo(rect.left, rect.bottom)
      ..lineTo(rect.left, rect.top);
  }

  @override
  void paint(Canvas canvas, Rect rect, {TextDirection? textDirection}) {
    final width = rect.width;
    final height = rect.height;
    final cutOutWidth = cutOutSize < width ? cutOutSize : width - borderWidth * 2;
    final cutOutHeight = cutOutSize < height ? cutOutSize : height - borderWidth * 2;

    final backgroundPath = Path()
      ..addRect(rect)
      ..addRRect(
        RRect.fromRectAndRadius(
          Rect.fromCenter(
            center: rect.center,
            width: cutOutWidth,
            height: cutOutHeight,
          ),
          Radius.circular(borderRadius),
        ),
      )
      ..fillType = PathFillType.evenOdd;
    
    final backgroundPaint = Paint()
      ..color = overlayColor
      ..style = PaintingStyle.fill;
    
    canvas.drawPath(backgroundPath, backgroundPaint);

    final borderPaint = Paint()
      ..color = borderColor
      ..style = PaintingStyle.stroke
      ..strokeWidth = borderWidth;

    final path = Path()
      // Top-left corner
      ..moveTo(rect.center.dx - cutOutWidth / 2, rect.center.dy - cutOutHeight / 2)
      ..lineTo(rect.center.dx - cutOutWidth / 2 + borderLength, rect.center.dy - cutOutHeight / 2)
      ..moveTo(rect.center.dx - cutOutWidth / 2, rect.center.dy - cutOutHeight / 2)
      ..lineTo(rect.center.dx - cutOutWidth / 2, rect.center.dy - cutOutHeight / 2 + borderLength)
      
      // Top-right corner
      ..moveTo(rect.center.dx + cutOutWidth / 2, rect.center.dy - cutOutHeight / 2)
      ..lineTo(rect.center.dx + cutOutWidth / 2 - borderLength, rect.center.dy - cutOutHeight / 2)
      ..moveTo(rect.center.dx + cutOutWidth / 2, rect.center.dy - cutOutHeight / 2)
      ..lineTo(rect.center.dx + cutOutWidth / 2, rect.center.dy - cutOutHeight / 2 + borderLength)
      
      // Bottom-left corner
      ..moveTo(rect.center.dx - cutOutWidth / 2, rect.center.dy + cutOutHeight / 2)
      ..lineTo(rect.center.dx - cutOutWidth / 2 + borderLength, rect.center.dy + cutOutHeight / 2)
      ..moveTo(rect.center.dx - cutOutWidth / 2, rect.center.dy + cutOutHeight / 2)
      ..lineTo(rect.center.dx - cutOutWidth / 2, rect.center.dy + cutOutHeight / 2 - borderLength)
      
      // Bottom-right corner
      ..moveTo(rect.center.dx + cutOutWidth / 2, rect.center.dy + cutOutHeight / 2)
      ..lineTo(rect.center.dx + cutOutWidth / 2 - borderLength, rect.center.dy + cutOutHeight / 2)
      ..moveTo(rect.center.dx + cutOutWidth / 2, rect.center.dy + cutOutHeight / 2)
      ..lineTo(rect.center.dx + cutOutWidth / 2, rect.center.dy + cutOutHeight / 2 - borderLength);

    canvas.drawPath(path, borderPaint);
  }

  @override
  ShapeBorder scale(double t) {
    return QrScannerOverlayShape(
      borderColor: borderColor,
      borderWidth: borderWidth,
      overlayColor: overlayColor,
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\translation_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import '../services/audio_service.dart';

class TranslationScreen extends StatefulWidget {
  const TranslationScreen({super.key});

  @override
  State<TranslationScreen> createState() => _TranslationScreenState();
}

class _TranslationScreenState extends State<TranslationScreen> {
  String _selectedSourceLanguage = 'English';
  String _selectedTargetLanguage = 'Kagan';
  
  late AudioService _audioService;
  String? currentlyPlayingPhrase;
  bool isPlaying = false;
  final ScrollController _scrollController = ScrollController();

  final List<String> _sourceLanguages = ['English', 'Cebuano'];
  final List<String> _targetLanguages = ['Kagan', 'Mansaka', 'Mandaya'];

  // Audio file paths for each phrase and language combination
  final Map<String, String> _audioFilePaths = {
    // Signature Phrase - standalone audio (no language suffix)
    'Mabuhay og Madayaw': 'assets/audio/sbom.mp3',
    
    // Greetings
    'Hello_English': 'assets/audio/english/ghe.mp3',
    'Hello_Cebuano': 'assets/audio/cebuano/ghc.mp3',
    'Hello_Kagan': 'assets/audio/kagan/ghk.m4a',
    'Hello_Mansaka': 'assets/audio/mansaka/ghms.m4a',
    'Hello_Mandaya': 'assets/audio/mandaya/ghmy.m4a',
    
    'Good morning_English': 'assets/audio/english/ggme.mp3',
    'Good morning_Cebuano': 'assets/audio/cebuano/gmbc.mp3',
    'Good morning_Kagan': 'assets/audio/kagan/ggmk.m4a',
    'Good morning_Mansaka': 'assets/audio/mansaka/ggmms.m4a',
    'Good morning_Mandaya': 'assets/audio/mandaya/ggmmy.m4a',
    
    'Good day_English': 'assets/audio/english/ggde.mp3',
    'Good day_Cebuano': 'assets/audio/cebuano/gmac.mp3',
    'Good day_Kagan': 'assets/audio/kagan/ggdk.m4a',
    'Good day_Mansaka': 'assets/audio/mansaka/ggdms.m4a',
    'Good day_Mandaya': 'assets/audio/mandaya/ggdmy.m4a',
    
    'How are you?_English': 'assets/audio/english/ghaye.mp3',
    'How are you?_Cebuano': 'assets/audio/cebuano/gkkc.mp3',
    'How are you?_Kagan': 'assets/audio/kagan/ghayk.m4a',
    'How are you?_Mansaka': 'assets/audio/mansaka/ghayms.m4a',
    'How are you?_Mandaya': 'assets/audio/mandaya/ghaymy.m4a',
    
    // Basic Phrases
    'Thank you_English': 'assets/audio/english/btye.mp3',
    'Thank you_Cebuano': 'assets/audio/cebuano/bsc.mp3',
    'Thank you_Kagan': 'assets/audio/kagan/btyk.m4a',
    'Thank you_Mansaka': 'assets/audio/mansaka/btyms.m4a',
    'Thank you_Mandaya': 'assets/audio/mandaya/btymy.m4a',
    
    'Thank you very much_English': 'assets/audio/english/btyvme.mp3',
    'Thank you very much_Cebuano': 'assets/audio/cebuano/bsalamatkc.mp3',
    'Thank you very much_Kagan': 'assets/audio/kagan/btyvmk.m4a',
    'Thank you very much_Mansaka': 'assets/audio/mansaka/btyvmms.m4a',
    'Thank you very much_Mandaya': 'assets/audio/mandaya/btyvmmy.m4a',
    
    'Please_English': 'assets/audio/english/bpe.mp3',
    'Please_Cebuano': 'assets/audio/cebuano/bpalihugc.mp3',
    'Please_Kagan': 'assets/audio/kagan/bpk.m4a',
    'Please_Mansaka': 'assets/audio/mansaka/bpms.m4a',
    'Please_Mandaya': 'assets/audio/mandaya/bpmy.m4a',
    
    'Excuse me_English': 'assets/audio/english/beme.mp3',
    'Excuse me_Cebuano': 'assets/audio/cebuano/bemc.mp3',
    'Excuse me_Kagan': 'assets/audio/kagan/bemk.m4a',
    'Excuse me_Mansaka': 'assets/audio/mansaka/bemms.m4a',
    'Excuse me_Mandaya': 'assets/audio/mandaya/bexmmy.m4a',
    
    // Questions
    'What is your name?_English': 'assets/audio/english/qwiyne.mp3',
    'What is your name?_Cebuano': 'assets/audio/cebuano/qunsainc.mp3',
    'What is your name?_Kagan': 'assets/audio/kagan/qwiynk.m4a',
    'What is your name?_Mansaka': 'assets/audio/mansaka/qwiynms.m4a',
    'What is your name?_Mandaya': 'assets/audio/mandaya/qwiynmy.m4a',
    
    'Where are you from?_English': 'assets/audio/english/qwayfe.mp3',
    'Where are you from?_Cebuano': 'assets/audio/cebuano/qtakc.mp3',
    'Where are you from?_Kagan': 'assets/audio/kagan/qwayfk.m4a',
    'Where are you from?_Mansaka': 'assets/audio/mansaka/qwayfms.m4a',
    'Where are you from?_Mandaya': 'assets/audio/mandaya/qwayfmy.m4a',
    
    // Numbers
    'One_English': 'assets/audio/english/noe.mp3',
    'One_Cebuano': 'assets/audio/cebuano/nic.mp3',
    'One_Kagan': 'assets/audio/kagan/nonek.m4a',
    'One_Mansaka': 'assets/audio/mansaka/nonems.m4a',
    'One_Mandaya': 'assets/audio/mandaya/nonemy.m4a',
    
    'Two_English': 'assets/audio/english/ntwoe.mp3',
    'Two_Cebuano': 'assets/audio/cebuano/nduhac.mp3',
    'Two_Kagan': 'assets/audio/kagan/ntwok.m4a',
    'Two_Mansaka': 'assets/audio/mansaka/ntwoms.m4a',
    'Two_Mandaya': 'assets/audio/mandaya/ntwomy.m4a',
    
    'Three_English': 'assets/audio/english/nthreee.mp3',
    'Three_Cebuano': 'assets/audio/cebuano/ntuloc.mp3',
    'Three_Kagan': 'assets/audio/kagan/nthreek.m4a',
    'Three_Mansaka': 'assets/audio/mansaka/nthreems.m4a',
    'Three_Mandaya': 'assets/audio/mandaya/nthreemy.m4a',
  };

  // Local phrase data - optimized for offline use
  final Map<String, Map<String, Map<String, String>>> _phrases = {
    'Signature Phrase': {
      'Mabuhay og Madayaw': {
        'English': 'Mabuhay og Madayaw',
        'Cebuano': 'Mabuhay og Madayaw',
        'Kagan': 'Mabuhay og Madayaw',
        'Mansaka': 'Mabuhay og Madayaw',
        'Mandaya': 'Mabuhay og Madayaw',
      },
    },
    'Greetings': {
      'Hello': {
        'English': 'Hello',
        'Cebuano': 'Hello',
        'Kagan': 'Salam',
        'Mansaka': 'Madayaw',
        'Mandaya': 'Anda',
      },
      'Good morning': {
        'English': 'Good morning',
        'Cebuano': 'Maayong buntag',
        'Kagan': 'Madyaw Na Kamdag',
        'Mansaka': 'Madyaw Na Masum',
        'Mandaya': 'Madyaw Na Kamdag',
      },
      'Good day': {
        'English': 'Good day',
        'Cebuano': 'Maayong adlaw',
        'Kagan': 'Madyaw Na Allaw',
        'Mansaka': 'Madyaw Na Allaw',
        'Mandaya': 'Madyaw Na Allaw',
      },
      'How are you?': {
        'English': 'How are you?',
        'Cebuano': 'Kumusta ka?',
        'Kagan': 'Kumusta Dakaw',
        'Mansaka': 'Kumusta kaw?',
        'Mandaya': 'Kuman Ka?',
      },
    },
    'Basic Phrases': {
      'Thank you': {
        'English': 'Thank you',
        'Cebuano': 'Salamat',
        'Kagan': 'Sukor',
        'Mansaka': 'Salamat',
        'Mandaya': 'Madaig Na Salamat',
      },
      'Thank you very much': {
        'English': 'Thank you very much',
        'Cebuano': 'Salamat kaayo',
        'Kagan': 'Sampu Samat',
        'Mansaka': 'Untung Salamat',
        'Mandaya': 'Madaig Na Salamat',
      },
      'Please': {
        'English': 'Please',
        'Cebuano': 'Palihog',
        'Kagan': 'Tabia',
        'Mansaka': 'Palihug',
        'Mandaya': 'Palihuga',
      },
      'Excuse me': {
        'English': 'Excuse me',
        'Cebuano': 'Excuse me',
        'Kagan': 'Tabia Pa',
        'Mansaka': 'Tabya/Tabi Kanmo ',
        'Mandaya': 'Tabi Pa Ansar',
      },
    },
    'Questions': {
      'What is your name?': {
        'English': 'What is your name?',
        'Cebuano': 'Unsa imo ngalan?',
        'Kagan': 'Unong Pangan Mo?',
        'Mansaka': 'Nanu Ngayan Nu?',
        'Mandaya': 'Uno Yang Ngan Mo?',
      },
      'Where are you from?': {
        'English': 'Where are you from?',
        'Cebuano': 'Taga asa ka?',
        'Kagan': 'Taga Ayn Kaw?',
        'Mansaka': 'Taga Hain Ka?',
        'Mandaya': 'A-in Ka Naga Uya?',
      },
    },
    'Numbers': {
      'One': {
        'English': 'One',
        'Cebuano': 'Isa',
        'Kagan': 'Isa',
        'Mansaka': 'Usa',
        'Mandaya': 'Usa',
      },
      'Two': {
        'English': 'Two',
        'Cebuano': 'Duha',
        'Kagan': 'Duwa',
        'Mansaka': 'Duwa',
        'Mandaya': 'Darwa',
      },
      'Three': {
        'English': 'Three',
        'Cebuano': 'Tulo',
        'Kagan': 'Tulo',
        'Mansaka': 'Tolu',
        'Mandaya': 'Talu',
      },
    },
  };

  @override
  void initState() {
    super.initState();
    _audioService = AudioService();
    _initializeAudio();
  }

  void _initializeAudio() async {
    await _audioService.initialize();
  }

  bool _hasAudioFile(String phraseKey, String language) {
    final audioKey = '${phraseKey}_$language';
    return _audioFilePaths.containsKey(audioKey);
  }

  String? _getAudioFilePath(String phraseKey, String language) {
    final audioKey = '${phraseKey}_$language';
    return _audioFilePaths[audioKey];
  }

  Future<void> _playLocalAudio(String phraseKey, String language) async {
    try {
      final audioPath = _getAudioFilePath(phraseKey, language);
      if (audioPath == null) {
        _showAudioNotAvailableMessage(phraseKey, language);
        return;
      }

      final currentPhraseKey = '${phraseKey}_$language';

      setState(() {
        currentlyPlayingPhrase = currentPhraseKey;
        isPlaying = true;
      });

      bool success = await _audioService.playLocalAudio(
        audioPath: audioPath,
        phraseKey: currentPhraseKey,
      );

      if (!success) {
        setState(() {
          currentlyPlayingPhrase = null;
          isPlaying = false;
        });
        
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Unable to play audio file'),
              backgroundColor: Colors.red,
              behavior: SnackBarBehavior.floating,
            ),
          );
        }
        return;
      }

      HapticFeedback.lightImpact();
      _startAudioStatusMonitoring(currentPhraseKey);
      
    } catch (e) {
      print('Error playing local audio: $e');
      setState(() {
        currentlyPlayingPhrase = null;
        isPlaying = false;
      });
    }
  }

  Future<void> _playStandaloneAudio(String phraseKey) async {
    try {
      final audioPath = _audioFilePaths[phraseKey];
      if (audioPath == null) {
        _showAudioNotAvailableMessage(phraseKey, 'standalone');
        return;
      }

      setState(() {
        currentlyPlayingPhrase = phraseKey;
        isPlaying = true;
      });

      bool success = await _audioService.playLocalAudio(
        audioPath: audioPath,
        phraseKey: phraseKey,
      );

      if (!success) {
        setState(() {
          currentlyPlayingPhrase = null;
          isPlaying = false;
        });
        
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Unable to play audio file'),
              backgroundColor: Colors.red,
              behavior: SnackBarBehavior.floating,
            ),
          );
        }
        return;
      }

      HapticFeedback.lightImpact();
      _startAudioStatusMonitoring(phraseKey);
      
    } catch (e) {
      print('Error playing standalone audio: $e');
      setState(() {
        currentlyPlayingPhrase = null;
        isPlaying = false;
      });
    }
  }

  void _startAudioStatusMonitoring(String expectedPhraseKey) {
    Future.delayed(const Duration(milliseconds: 100), () {
      if (!mounted) return;
      
      bool audioServiceIsPlaying = _audioService.isPlaying;
      String? audioServiceCurrentPhrase = _audioService.currentlyPlaying;
      
      if (!audioServiceIsPlaying || audioServiceCurrentPhrase != expectedPhraseKey) {
        if (currentlyPlayingPhrase == expectedPhraseKey) {
          setState(() {
            currentlyPlayingPhrase = null;
            isPlaying = false;
          });
        }
      } else {
        _startAudioStatusMonitoring(expectedPhraseKey);
      }
    });
  }

  void _showAudioNotAvailableMessage(String phraseKey, String language) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Audio not available for "$phraseKey" in $language'),
          backgroundColor: Colors.orange,
          behavior: SnackBarBehavior.floating,
          duration: const Duration(seconds: 2),
        ),
      );
    }
  }

  Future<void> _stopAudio() async {
    await _audioService.stopAudio();
    setState(() {
      currentlyPlayingPhrase = null;
      isPlaying = false;
    });
  }

  @override
  void dispose() {
    _scrollController.dispose();
    _audioService.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: SafeArea(
        child: Stack(
          children: [
            _buildScrollableContent(),
            if (!_isConnectedToInternet()) _buildOfflineIndicator(),
            if (isPlaying) _buildFixedAudioStatusIndicator(),
          ],
        ),
      ),
    );
  }

  Widget _buildSignatureWelcomeSection(
    MapEntry<String, Map<String, Map<String, String>>> categoryEntry,
    double screenWidth,
    double screenHeight,
  ) {
    final phraseEntry = categoryEntry.value.entries.first;
    final phraseKey = phraseEntry.key;
    
    return Column(
      children: [
        Container(
          margin: EdgeInsets.only(bottom: (screenHeight * 0.02).clamp(12.0, 25.0)),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                const Color(0xFFEADCB6).withOpacity(0.3),
                const Color(0xFFD4AF37).withOpacity(0.2),
                const Color(0xFFEADCB6).withOpacity(0.1),
              ],
            ),
            borderRadius: BorderRadius.circular(12),
            border: Border.all(
              color: const Color(0xFFEADCB6).withOpacity(0.6),
              width: 1.5,
            ),
            boxShadow: [
              BoxShadow(
                color: const Color(0xFFEADCB6).withOpacity(0.15),
                blurRadius: 8,
                spreadRadius: 1,
              ),
            ],
          ),
          child: Column(
            children: [
              Container(
                width: double.infinity,
                padding: EdgeInsets.symmetric(
                  vertical: (screenHeight * 0.015).clamp(8.0, 18.0),
                  horizontal: (screenWidth * 0.04).clamp(12.0, 20.0),
                ),
                decoration: BoxDecoration(
                  color: const Color(0xFFEADCB6).withOpacity(0.15),
                  borderRadius: const BorderRadius.vertical(top: Radius.circular(10.5)),
                ),
                child: Column(
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.celebration,
                          color: const Color(0xFFEADCB6),
                          size: (screenWidth * 0.04).clamp(14.0, 20.0),
                        ),
                        SizedBox(width: (screenWidth * 0.015).clamp(4.0, 8.0)),
                        Flexible(
                          child: FittedBox(
                            fit: BoxFit.scaleDown,
                            child: Text(
                              'Cultural Signature Phrase',
                              style: TextStyle(
                                color: const Color(0xFFEADCB6),
                                fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                                fontWeight: FontWeight.w600,
                                letterSpacing: 0.8,
                              ),
                            ),
                          ),
                        ),
                        SizedBox(width: (screenWidth * 0.015).clamp(4.0, 8.0)),
                        Icon(
                          Icons.celebration,
                          color: const Color(0xFFEADCB6),
                          size: (screenWidth * 0.04).clamp(14.0, 20.0),
                        ),
                      ],
                    ),
                    SizedBox(height: (screenHeight * 0.005).clamp(2.0, 6.0)),
                    Container(
                      width: (screenWidth * 0.15).clamp(40.0, 80.0),
                      height: 1.5,
                      decoration: const BoxDecoration(
                        gradient: LinearGradient(
                          colors: [
                            Colors.transparent,
                            Color(0xFFEADCB6),
                            Colors.transparent,
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              
              Container(
                padding: EdgeInsets.all((screenWidth * 0.05).clamp(12.0, 24.0)),
                decoration: BoxDecoration(
                  color: Colors.black.withOpacity(0.4),
                  borderRadius: const BorderRadius.vertical(bottom: Radius.circular(10.5)),
                ),
                child: _buildSingleSignaturePhrase(phraseKey, screenWidth, screenHeight),
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildSingleSignaturePhrase(String phraseKey, double screenWidth, double screenHeight) {
    bool hasStandaloneAudio = _audioFilePaths.containsKey(phraseKey);
    
    String? availableLanguage;
    if (!hasStandaloneAudio) {
      for (String lang in [..._sourceLanguages, ..._targetLanguages]) {
        if (_hasAudioFile(phraseKey, lang)) {
          availableLanguage = lang;
          break;
        }
      }
    }
    
    final isCurrentlyPlaying = hasStandaloneAudio
        ? currentlyPlayingPhrase == phraseKey
        : availableLanguage != null && currentlyPlayingPhrase == '${phraseKey}_$availableLanguage';
    
    return Row(
      children: [
        Expanded(
          child: Column(
            children: [
              FittedBox(
                fit: BoxFit.scaleDown,
                child: Text(
                  'FEATURED CULTURAL PHRASE',
                  style: TextStyle(
                    fontSize: (screenWidth * 0.025).clamp(10.0, 12.0),
                    color: const Color(0xFFEADCB6).withOpacity(0.8),
                    fontWeight: FontWeight.w600,
                    letterSpacing: 1.5,
                  ),
                ),
              ),
              SizedBox(height: (screenHeight * 0.015).clamp(8.0, 16.0)),
              FittedBox(
                fit: BoxFit.scaleDown,
                child: Text(
                  phraseKey,
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    fontSize: (screenWidth * 0.06).clamp(18.0, 28.0),
                    color: const Color(0xFFEADCB6),
                    fontWeight: FontWeight.bold,
                    height: 1.2,
                  ),
                ),
              ),
              SizedBox(height: (screenHeight * 0.01).clamp(6.0, 12.0)),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Icons.headphones,
                    size: (screenWidth * 0.035).clamp(12.0, 16.0),
                    color: Colors.white.withOpacity(0.6),
                  ),
                  SizedBox(width: (screenWidth * 0.01).clamp(4.0, 8.0)),
                  Flexible(
                    child: Text(
                      'Tap to hear pronunciation',
                      textAlign: TextAlign.center,
                      style: TextStyle(
                        fontSize: (screenWidth * 0.03).clamp(10.0, 14.0),
                        color: Colors.white.withOpacity(0.7),
                        fontStyle: FontStyle.italic,
                      ),
                      overflow: TextOverflow.ellipsis,
                      maxLines: 2,
                    ),
                  ),
                ],
              ),
              if (availableLanguage == null && !hasStandaloneAudio) ...[
                SizedBox(height: (screenHeight * 0.01).clamp(6.0, 12.0)),
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(
                      Icons.volume_off,
                      size: (screenWidth * 0.03).clamp(10.0, 14.0),
                      color: Colors.orange.withOpacity(0.7),
                    ),
                    SizedBox(width: (screenWidth * 0.01).clamp(4.0, 8.0)),
                    Flexible(
                      child: Text(
                        'Audio not available',
                        style: TextStyle(
                          fontSize: (screenWidth * 0.025).clamp(10.0, 12.0),
                          color: Colors.orange.withOpacity(0.7),
                        ),
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
              ],
            ],
          ),
        ),
        
        if (availableLanguage != null || hasStandaloneAudio) ...[
          SizedBox(width: (screenWidth * 0.04).clamp(12.0, 20.0)),
          
          GestureDetector(
            onTap: () {
              if (isCurrentlyPlaying) {
                _stopAudio();
              } else {
                if (hasStandaloneAudio) {
                  _playStandaloneAudio(phraseKey);
                } else {
                  _playLocalAudio(phraseKey, availableLanguage!);
                }
              }
            },
            child: AnimatedContainer(
              duration: const Duration(milliseconds: 300),
              padding: EdgeInsets.all((screenWidth * 0.04).clamp(12.0, 18.0)),
              decoration: BoxDecoration(
                color: isCurrentlyPlaying
                    ? Colors.red.withOpacity(0.2)
                    : const Color(0xFFEADCB6).withOpacity(0.2),
                borderRadius: BorderRadius.circular(50),
                border: Border.all(
                  color: isCurrentlyPlaying
                      ? Colors.red.withOpacity(0.5)
                      : const Color(0xFFEADCB6).withOpacity(0.6),
                  width: 2,
                ),
                boxShadow: [
                  BoxShadow(
                    color: isCurrentlyPlaying
                        ? Colors.red.withOpacity(0.3)
                        : const Color(0xFFEADCB6).withOpacity(0.3),
                    blurRadius: 12,
                    spreadRadius: 2,
                  ),
                ],
              ),
              child: AnimatedSwitcher(
                duration: const Duration(milliseconds: 300),
                child: isCurrentlyPlaying
                    ? Icon(
                        Icons.stop_rounded,
                        color: Colors.red,
                        size: (screenWidth * 0.08).clamp(24.0, 36.0),
                        key: const ValueKey('stop_signature'),
                      )
                    : Icon(
                        Icons.play_arrow_rounded,
                        color: const Color(0xFFEADCB6),
                        size: (screenWidth * 0.08).clamp(24.0, 36.0),
                        key: const ValueKey('play_signature'),
                      ),
              ),
            ),
          ),
        ],
      ],
    );
  }

  bool _isConnectedToInternet() {
    return false;
  }

  Widget _buildOfflineIndicator() {
    final screenWidth = MediaQuery.of(context).size.width;
    
    return Positioned(
      top: 10,
      right: 10,
      child: Container(
        padding: EdgeInsets.symmetric(
          horizontal: (screenWidth * 0.02).clamp(8.0, 12.0),
          vertical: (screenWidth * 0.01).clamp(4.0, 8.0),
        ),
        decoration: BoxDecoration(
          color: Colors.green.withOpacity(0.8),
          borderRadius: BorderRadius.circular(12),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              Icons.offline_bolt,
              color: Colors.white,
              size: (screenWidth * 0.04).clamp(14.0, 18.0),
            ),
            SizedBox(width: (screenWidth * 0.01).clamp(4.0, 6.0)),
            Text(
              'Offline',
              style: TextStyle(
                color: Colors.white,
                fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildScrollableContent() {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    return SingleChildScrollView(
      controller: _scrollController,
      physics: const BouncingScrollPhysics(
        parent: AlwaysScrollableScrollPhysics(),
      ),
      clipBehavior: Clip.none,
      child: Column(
        children: [
          Container(
            width: double.infinity,
            constraints: BoxConstraints(
              minHeight: screenHeight,
            ),
            decoration: const BoxDecoration(
              image: DecorationImage(
                image: AssetImage('assets/images/tribal_pattern.jpg'),
                fit: BoxFit.cover,
                opacity: 0.3,
              ),
            ),
            child: Container(
              decoration: BoxDecoration(
                color: Colors.black.withOpacity(0.4),
              ),
              child: Padding(
                padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.06).clamp(16.0, 30.0)),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    SizedBox(height: (screenHeight * 0.05).clamp(20.0, 50.0)),
                    
                    _buildTitleSection(screenWidth, screenHeight),
                    
                    SizedBox(height: (screenHeight * 0.04).clamp(16.0, 40.0)),
                    
                    _buildSignatureWelcomeSection(
                      _phrases.entries.firstWhere((entry) => entry.key == 'Signature Phrase'),
                      screenWidth,
                      screenHeight,
                    ),
                    
                    SizedBox(height: (screenHeight * 0.04).clamp(16.0, 40.0)),
                    
                    _buildLanguageSelectionSection(screenWidth, screenHeight),
                    
                    SizedBox(height: (screenHeight * 0.04).clamp(16.0, 40.0)),
                    
                    ..._phrases.entries.where((entry) => entry.key != 'Signature Phrase').map((categoryEntry) {
                      return _buildCategorySection(categoryEntry, screenWidth, screenHeight);
                    }),
                    
                    // Extra bottom padding to keep content above navigation bar and audio indicator
                    SizedBox(height: (screenHeight * 0.18).clamp(80.0, 140.0)),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTitleSection(double screenWidth, double screenHeight) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        FittedBox(
          fit: BoxFit.scaleDown,
          alignment: Alignment.centerLeft,
          child: Text(
            'Indigenous Language',
            style: TextStyle(
              color: Colors.white70,
              fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
              fontWeight: FontWeight.w300,
            ),
          ),
        ),
        FittedBox(
          fit: BoxFit.scaleDown,
          alignment: Alignment.centerLeft,
          child: Text(
            'Phrase Book',
            style: TextStyle(
              color: Colors.white,
              fontSize: (screenWidth * 0.07).clamp(20.0, 32.0),
              fontWeight: FontWeight.bold,
            ),
          ),
        ),
        SizedBox(height: (screenHeight * 0.01).clamp(6.0, 12.0)),
        Row(
          children: [
            Container(
              width: (screenWidth * 0.2).clamp(60.0, 100.0),
              height: 3,
              color: const Color(0xFFEADCB6),
            ),
            SizedBox(width: (screenWidth * 0.02).clamp(6.0, 10.0)),
            Icon(
              Icons.offline_bolt,
              color: const Color(0xFFEADCB6),
              size: (screenWidth * 0.04).clamp(14.0, 18.0),
            ),
            SizedBox(width: (screenWidth * 0.01).clamp(4.0, 6.0)),
            Flexible(
              child: Text(
                'Works Offline',
                style: TextStyle(
                  color: const Color(0xFFEADCB6),
                  fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                  fontWeight: FontWeight.w500,
                ),
                overflow: TextOverflow.ellipsis,
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildLanguageSelectionSection(double screenWidth, double screenHeight) {
    return Container(
      padding: EdgeInsets.all((screenWidth * 0.05).clamp(12.0, 24.0)),
      decoration: BoxDecoration(
        color: Colors.black.withOpacity(0.6),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFFEADCB6).withOpacity(0.3),
          width: 1,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          FittedBox(
            fit: BoxFit.scaleDown,
            alignment: Alignment.centerLeft,
            child: Text(
              'Language Selection',
              style: TextStyle(
                color: Colors.white,
                fontSize: (screenWidth * 0.045).clamp(16.0, 20.0),
                fontWeight: FontWeight.w600,
              ),
            ),
          ),
          SizedBox(height: (screenHeight * 0.02).clamp(10.0, 20.0)),
          
          _buildLanguageDropdown(
            value: _selectedSourceLanguage,
            items: _sourceLanguages,
            hint: 'Select source language',
            onChanged: (value) {
              setState(() {
                _selectedSourceLanguage = value!;
              });
            },
            screenWidth: screenWidth,
            screenHeight: screenHeight,
          ),
          
          SizedBox(height: (screenHeight * 0.02).clamp(10.0, 20.0)),
          
          Center(
            child: GestureDetector(
              onTap: () {
                HapticFeedback.mediumImpact();
                if (_sourceLanguages.contains(_selectedTargetLanguage)) {
                  setState(() {
                    String temp = _selectedSourceLanguage;
                    _selectedSourceLanguage = _selectedTargetLanguage;
                    _selectedTargetLanguage = temp;
                  });
                }
              },
              child: Container(
                padding: EdgeInsets.all((screenWidth * 0.03).clamp(10.0, 14.0)),
                decoration: BoxDecoration(
                  color: const Color(0xFFEADCB6).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: const Color(0xFFEADCB6).withOpacity(0.3),
                    width: 1,
                  ),
                ),
                child: Icon(
                  Icons.swap_vert,
                  color: const Color(0xFFEADCB6),
                  size: (screenWidth * 0.06).clamp(20.0, 28.0),
                ),
              ),
            ),
          ),
          
          SizedBox(height: (screenHeight * 0.02).clamp(10.0, 20.0)),
          
          _buildLanguageDropdown(
            value: _selectedTargetLanguage,
            items: _targetLanguages,
            hint: 'Select target language',
            onChanged: (value) {
              setState(() {
                _selectedTargetLanguage = value!;
              });
            },
            screenWidth: screenWidth,
            screenHeight: screenHeight,
          ),
        ],
      ),
    );
  }

  Widget _buildLanguageDropdown({
    required String value,
    required List<String> items,
    required String hint,
    required ValueChanged<String?> onChanged,
    required double screenWidth,
    required double screenHeight,
  }) {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.symmetric(horizontal: (screenWidth * 0.04).clamp(12.0, 18.0)),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.1),
        borderRadius: BorderRadius.circular(12.0),
        border: Border.all(
          color: Colors.white.withOpacity(0.2),
          width: 1.0,
        ),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          hint: Text(
            hint,
            style: TextStyle(
              color: Colors.white70,
              fontSize: (screenWidth * 0.035).clamp(13.0, 16.0),
            ),
            overflow: TextOverflow.ellipsis,
          ),
          isExpanded: true,
          dropdownColor: Colors.grey[800],
          style: TextStyle(
            color: Colors.white,
            fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
          ),
          items: items.map((String language) {
            return DropdownMenuItem<String>(
              value: language,
              child: Text(
                language,
                style: TextStyle(
                  color: Colors.white,
                  fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
                ),
                overflow: TextOverflow.ellipsis,
              ),
            );
          }).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildFixedAudioStatusIndicator() {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    return Positioned(
      bottom: (screenHeight * 0.012).clamp(10.0, 15.0), // Position just above the navigation bar
      left: (screenWidth * 0.06).clamp(16.0, 30.0),
      right: (screenWidth * 0.06).clamp(16.0, 30.0),
      child: Container(
        padding: EdgeInsets.symmetric(
          horizontal: (screenWidth * 0.04).clamp(12.0, 18.0),
          vertical: (screenHeight * 0.015).clamp(10.0, 16.0),
        ),
        decoration: BoxDecoration(
          color: Colors.black.withOpacity(0.9),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: const Color(0xFFEADCB6).withOpacity(0.5),
            width: 2,
          ),
          boxShadow: [
            BoxShadow(
              color: const Color(0xFFEADCB6).withOpacity(0.3),
              blurRadius: 12,
              spreadRadius: 2,
            ),
          ],
        ),
        child: Row(
          children: [
            SizedBox(
              width: (screenWidth * 0.05).clamp(18.0, 24.0),
              height: (screenWidth * 0.05).clamp(18.0, 24.0),
              child: const CircularProgressIndicator(
                strokeWidth: 2,
                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFEADCB6)),
              ),
            ),
            SizedBox(width: (screenWidth * 0.03).clamp(10.0, 14.0)),
            Expanded(
              child: Text(
                'Playing: ${currentlyPlayingPhrase?.replaceAll('_', ' - ') ?? 'Audio'}',
                style: TextStyle(
                  color: const Color(0xFFEADCB6),
                  fontWeight: FontWeight.w600,
                  fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                ),
                overflow: TextOverflow.ellipsis,
                maxLines: 1,
              ),
            ),
            SizedBox(width: (screenWidth * 0.02).clamp(8.0, 12.0)),
            GestureDetector(
              onTap: _stopAudio,
              child: Container(
                padding: EdgeInsets.all((screenWidth * 0.015).clamp(6.0, 10.0)),
                decoration: BoxDecoration(
                  color: Colors.red.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  Icons.stop,
                  color: Colors.red,
                  size: (screenWidth * 0.05).clamp(18.0, 24.0),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildAudioStatusIndicator(double screenWidth, double screenHeight) {
    return Container(
      margin: EdgeInsets.only(
        top: (screenHeight * 0.025).clamp(12.0, 30.0),
        bottom: (screenHeight * 0.025).clamp(12.0, 30.0),
      ),
      padding: EdgeInsets.symmetric(
        horizontal: (screenWidth * 0.04).clamp(12.0, 18.0),
        vertical: (screenHeight * 0.015).clamp(8.0, 16.0),
      ),
      decoration: BoxDecoration(
        color: const Color(0xFFEADCB6).withOpacity(0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: const Color(0xFFEADCB6).withOpacity(0.3),
          width: 1,
        ),
      ),
      child: Row(
        children: [
          SizedBox(
            width: (screenWidth * 0.05).clamp(18.0, 24.0),
            height: (screenWidth * 0.05).clamp(18.0, 24.0),
            child: const CircularProgressIndicator(
              strokeWidth: 2,
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFEADCB6)),
            ),
          ),
          SizedBox(width: (screenWidth * 0.03).clamp(10.0, 14.0)),
          Expanded(
            child: Text(
              'Playing: ${currentlyPlayingPhrase?.replaceAll('_', ' - ') ?? 'Audio'}',
              style: TextStyle(
                color: const Color(0xFFEADCB6),
                fontWeight: FontWeight.w500,
                fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
              ),
              overflow: TextOverflow.ellipsis,
              maxLines: 2,
            ),
          ),
          GestureDetector(
            onTap: _stopAudio,
            child: Icon(
              Icons.stop,
              color: const Color(0xFFEADCB6),
              size: (screenWidth * 0.05).clamp(18.0, 24.0),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCategorySection(
    MapEntry<String, Map<String, Map<String, String>>> categoryEntry,
    double screenWidth,
    double screenHeight,
  ) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: EdgeInsets.symmetric(vertical: (screenHeight * 0.015).clamp(8.0, 18.0)),
          child: Row(
            children: [
              Icon(
                _getCategoryIcon(categoryEntry.key),
                color: const Color(0xFFEADCB6),
                size: (screenWidth * 0.05).clamp(18.0, 24.0),
              ),
              SizedBox(width: (screenWidth * 0.02).clamp(6.0, 10.0)),
              Flexible(
                child: FittedBox(
                  fit: BoxFit.scaleDown,
                  alignment: Alignment.centerLeft,
                  child: Text(
                    categoryEntry.key,
                    style: TextStyle(
                      color: const Color(0xFFEADCB6),
                      fontSize: (screenWidth * 0.045).clamp(16.0, 20.0),
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
        
        ...categoryEntry.value.entries.map((phraseEntry) {
          return _buildPhraseCard(phraseEntry, screenWidth, screenHeight);
        }),
        
        SizedBox(height: (screenHeight * 0.025).clamp(12.0, 30.0)),
      ],
    );
  }

  Widget _buildPhraseCard(
    MapEntry<String, Map<String, String>> phraseEntry,
    double screenWidth,
    double screenHeight,
  ) {
    final sourceText = phraseEntry.value[_selectedSourceLanguage] ?? phraseEntry.key;
    final targetText = phraseEntry.value[_selectedTargetLanguage] ?? phraseEntry.key;
    final phraseKey = phraseEntry.key;
    
    return Container(
      margin: EdgeInsets.only(bottom: (screenHeight * 0.015).clamp(8.0, 18.0)),
      decoration: BoxDecoration(
        color: Colors.black.withOpacity(0.6),
        borderRadius: BorderRadius.circular(12.0),
        border: Border.all(
          color: Colors.white.withOpacity(0.1),
          width: 1.0,
        ),
      ),
      child: Column(
        children: [
          _buildPhraseRow(
            language: _selectedSourceLanguage,
            text: sourceText,
            phraseKey: phraseKey,
            isSource: true,
            textColor: Colors.white70,
            screenWidth: screenWidth,
            screenHeight: screenHeight,
          ),
          
          Divider(
            color: Colors.white.withOpacity(0.1),
            height: 1,
          ),
          
          _buildPhraseRow(
            language: _selectedTargetLanguage,
            text: targetText,
            phraseKey: phraseKey,
            isSource: false,
            textColor: const Color(0xFFEADCB6),
            screenWidth: screenWidth,
            screenHeight: screenHeight,
          ),
        ],
      ),
    );
  }

  Widget _buildPhraseRow({
    required String language,
    required String text,
    required String phraseKey,
    required bool isSource,
    required Color textColor,
    required double screenWidth,
    required double screenHeight,
  }) {
    final isCurrentlyPlaying = currentlyPlayingPhrase == '${phraseKey}_$language';
    final hasAudio = _hasAudioFile(phraseKey, language);
    
    return Padding(
      padding: EdgeInsets.all((screenWidth * 0.04).clamp(12.0, 18.0)),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Flexible(
                      child: Text(
                        language,
                        style: TextStyle(
                          fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                          color: Colors.white.withOpacity(0.6),
                          fontWeight: FontWeight.w500,
                        ),
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                    SizedBox(width: (screenWidth * 0.02).clamp(6.0, 10.0)),
                    if (!hasAudio)
                      Icon(
                        Icons.volume_off,
                        size: (screenWidth * 0.03).clamp(10.0, 14.0),
                        color: Colors.orange.withOpacity(0.7),
                      ),
                  ],
                ),
                SizedBox(height: (screenHeight * 0.005).clamp(2.0, 6.0)),
                Text(
                  text,
                  style: TextStyle(
                    fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
                    color: textColor,
                    fontWeight: isSource ? FontWeight.w500 : FontWeight.w600,
                  ),
                  overflow: TextOverflow.ellipsis,
                  maxLines: 3,
                ),
              ],
            ),
          ),
          
          SizedBox(width: (screenWidth * 0.03).clamp(10.0, 14.0)),
          
          GestureDetector(
            onTap: hasAudio ? () {
              if (isCurrentlyPlaying) {
                _stopAudio();
              } else {
                _playLocalAudio(phraseKey, language);
              }
            } : () {
              _showAudioNotAvailableMessage(phraseKey, language);
            },
            child: AnimatedContainer(
              duration: const Duration(milliseconds: 200),
              padding: EdgeInsets.all((screenWidth * 0.02).clamp(8.0, 12.0)),
              decoration: BoxDecoration(
                color: isCurrentlyPlaying 
                    ? Colors.red.withOpacity(0.2)
                    : hasAudio 
                        ? textColor.withOpacity(0.1)
                        : Colors.grey.withOpacity(0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: AnimatedSwitcher(
                duration: const Duration(milliseconds: 200),
                child: isCurrentlyPlaying
                    ? Icon(
                        Icons.stop,
                        color: Colors.red,
                        size: (screenWidth * 0.06).clamp(20.0, 28.0),
                        key: const ValueKey('stop'),
                      )
                    : hasAudio
                        ? Icon(
                            isSource ? Icons.play_circle_outline : Icons.play_circle_filled,
                            color: textColor,
                            size: (screenWidth * 0.06).clamp(20.0, 28.0),
                            key: const ValueKey('play'),
                          )
                        : Icon(
                            Icons.volume_off,
                            color: Colors.grey,
                            size: (screenWidth * 0.06).clamp(20.0, 28.0),
                            key: const ValueKey('no_audio'),
                          ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  IconData _getCategoryIcon(String category) {
    switch (category.toLowerCase()) {
      case 'cultural welcome':
        return Icons.celebration;
      case 'greetings':
        return Icons.waving_hand;
      case 'basic phrases':
        return Icons.chat_bubble_outline;
      case 'questions':
        return Icons.help_outline;
      case 'numbers':
        return Icons.numbers;
      case 'food':
        return Icons.restaurant;
      case 'directions':
        return Icons.directions;
      default:
        return Icons.translate;
    }
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\tribes_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'kagan_detail_screen.dart';
import 'mansaka_detail_screen.dart';
import 'mandaya_detail_screen.dart';

class TribesScreen extends StatefulWidget {
  const TribesScreen({super.key});

  @override
  State<TribesScreen> createState() => _TribesScreenState();
}

class _TribesScreenState extends State<TribesScreen> {
  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: SingleChildScrollView(
            physics: const BouncingScrollPhysics(),
            padding: EdgeInsets.symmetric(
              horizontal: (screenWidth * 0.05).clamp(16.0, 30.0),
              vertical: (screenHeight * 0.015).clamp(12.0, 20.0),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                SizedBox(height: (screenHeight * 0.015).clamp(8.0, 16.0)),
                
                // Header Section
                Container(
                  width: double.infinity,
                  constraints: BoxConstraints(
                    minHeight: (screenHeight * 0.15).clamp(100.0, 150.0),
                  ),
                  padding: EdgeInsets.all((screenWidth * 0.06).clamp(16.0, 30.0)),
                  decoration: BoxDecoration(
                    border: Border.all(
                      color: Colors.white.withOpacity(0.3),
                      width: 2,
                    ),
                    borderRadius: BorderRadius.circular(8),
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Colors.white.withOpacity(0.05),
                        Colors.transparent,
                      ],
                    ),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      FittedBox(
                        fit: BoxFit.scaleDown,
                        alignment: Alignment.centerLeft,
                        child: Text(
                          'INDIGENOUS TRIBES',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: (screenWidth * 0.065).clamp(20.0, 28.0),
                            fontWeight: FontWeight.bold,
                            letterSpacing: 2,
                          ),
                        ),
                      ),
                      SizedBox(height: (screenHeight * 0.02).clamp(8.0, 16.0)),
                      FittedBox(
                        fit: BoxFit.scaleDown,
                        alignment: Alignment.centerLeft,
                        child: Text(
                          'Explore Cultural\nHeritage',
                          style: TextStyle(
                            color: Colors.white70,
                            fontSize: (screenWidth * 0.045).clamp(14.0, 20.0),
                            fontWeight: FontWeight.w300,
                            height: 1.3,
                            letterSpacing: 1,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                
                SizedBox(height: (screenHeight * 0.04).clamp(20.0, 32.0)),
                
                // Tribe Cards
                _buildTribeCard(
                  tribeName: 'KAGAN',
                  description: 'Known for their rich oral tradition and intricate beadwork',
                  categories: '4 Categories',
                  imagePath: 'assets/images/kagan_d.jpg',
                  onTap: () => _navigateToKaganDetail(),
                  screenWidth: screenWidth,
                  screenHeight: screenHeight,
                ),
                
                SizedBox(height: (screenHeight * 0.025).clamp(16.0, 24.0)),
                
                _buildTribeCard(
                  tribeName: 'MANSAKA',
                  description: 'Renowned for their traditional weaving and agricultural practices',
                  categories: '4 Categories',
                  imagePath: 'assets/images/mansaka_main.jpg',
                  onTap: () => _navigateToMansakaDetail(),
                  screenWidth: screenWidth,
                  screenHeight: screenHeight,
                ),
                
                SizedBox(height: (screenHeight * 0.025).clamp(16.0, 24.0)),
                
                _buildTribeCard(
                  tribeName: 'MANDAYA',
                  description: 'Masters of traditional music and dance ceremonies',
                  categories: '4 Categories',
                  imagePath: 'assets/images/mandaya_main.jpg',
                  onTap: () => _navigateToMandayaDetail(),
                  screenWidth: screenWidth,
                  screenHeight: screenHeight,
                ),
                
                SizedBox(height: (screenHeight * 0.04).clamp(20.0, 32.0)),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildTribeCard({
    required String tribeName,
    required String description,
    required String categories,
    required String imagePath,
    required VoidCallback onTap,
    required double screenWidth,
    required double screenHeight,
  }) {
    return Container(
      constraints: BoxConstraints(
        minHeight: (screenHeight * 0.22).clamp(140.0, 200.0),
      ),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            const Color(0xFF433D34).withOpacity(0.8),
            const Color(0xFF836F50).withOpacity(0.8),
          ],
        ),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.6),
            blurRadius: 15,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: IntrinsicHeight(
          child: Stack(
            children: [
              Container(
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      const Color(0xFF433D34).withOpacity(0.8),
                      const Color(0xFF836F50).withOpacity(0.8),
                    ],
                  ),
                ),
              ),
              
              Row(
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  // Left side - Image
                  ConstrainedBox(
                    constraints: BoxConstraints(
                      minWidth: (screenWidth * 0.3).clamp(80.0, 140.0),
                      maxWidth: (screenWidth * 0.35).clamp(100.0, 160.0),
                    ),
                    child: ClipRRect(
                      borderRadius: const BorderRadius.only(
                        topLeft: Radius.circular(16),
                        bottomLeft: Radius.circular(16),
                      ),
                      child: Image.asset(
                        imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFF433D34),
                                  Color(0xFF836F50),
                                ],
                              ),
                            ),
                            child: Center(
                              child: Icon(
                                Icons.people,
                                size: (screenWidth * 0.1).clamp(32.0, 48.0),
                                color: Colors.white.withOpacity(0.3),
                              ),
                            ),
                          );
                        },
                      ),
                    ),
                  ),
                  
                  // Right side - Content
                  Expanded(
                    child: Padding(
                      padding: EdgeInsets.all((screenWidth * 0.05).clamp(12.0, 20.0)),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  FittedBox(
                                    fit: BoxFit.scaleDown,
                                    alignment: Alignment.centerLeft,
                                    child: Text(
                                      tribeName,
                                      style: TextStyle(
                                        color: const Color(0xFFF8F4E6),
                                        fontSize: (screenWidth * 0.045).clamp(14.0, 20.0),
                                        fontWeight: FontWeight.bold,
                                        letterSpacing: 1.2,
                                      ),
                                    ),
                                  ),
                                  SizedBox(height: (screenHeight * 0.005).clamp(4.0, 8.0)),
                                  Container(
                                    height: 2,
                                    width: (screenWidth * 0.15).clamp(40.0, 60.0),
                                    color: const Color(0xFFF8F4E6),
                                  ),
                                ],
                              ),
                              
                              SizedBox(height: (screenHeight * 0.015).clamp(8.0, 12.0)),
                              
                              Text(
                                description,
                                style: TextStyle(
                                  color: const Color(0xFFC5C6C7),
                                  fontSize: (screenWidth * 0.032).clamp(11.0, 14.0),
                                  fontWeight: FontWeight.w400,
                                  height: 1.3,
                                  letterSpacing: 0.3,
                                ),
                                maxLines: 3,
                                overflow: TextOverflow.ellipsis,
                              ),
                              
                              SizedBox(height: (screenHeight * 0.01).clamp(6.0, 10.0)),
                              
                              Text(
                                categories,
                                style: TextStyle(
                                  color: const Color(0xFFFBFFE6),
                                  fontSize: (screenWidth * 0.028).clamp(10.0, 12.0),
                                  fontWeight: FontWeight.w300,
                                  letterSpacing: 0.5,
                                ),
                                overflow: TextOverflow.ellipsis,
                              ),
                            ],
                          ),
                          
                          SizedBox(height: (screenHeight * 0.015).clamp(8.0, 12.0)),
                          
                          Align(
                            alignment: Alignment.centerRight,
                            child: GestureDetector(
                              onTap: () {
                                HapticFeedback.lightImpact();
                                onTap();
                              },
                              child: Container(
                                padding: EdgeInsets.symmetric(
                                  horizontal: (screenWidth * 0.04).clamp(12.0, 20.0),
                                  vertical: (screenHeight * 0.01).clamp(6.0, 12.0),
                                ),
                                decoration: BoxDecoration(
                                  color: const Color(0xFF94937C).withOpacity(0.3),
                                  borderRadius: BorderRadius.circular(20),
                                  border: Border.all(
                                    color: const Color(0xFF94937C),
                                    width: 1,
                                  ),
                                  boxShadow: [
                                    BoxShadow(
                                      color: Colors.black.withOpacity(0.4),
                                      blurRadius: 4,
                                      offset: const Offset(0, 2),
                                    ),
                                  ],
                                ),
                                child: FittedBox(
                                  fit: BoxFit.scaleDown,
                                  child: Text(
                                    'CLICK HERE',
                                    style: TextStyle(
                                      color: const Color(0xFFF8F4E6),
                                      fontSize: (screenWidth * 0.025).clamp(9.0, 12.0),
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1,
                                    ),
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
              
              Material(
                color: Colors.transparent,
                child: InkWell(
                  onTap: () {
                    HapticFeedback.mediumImpact();
                    onTap();
                  },
                  borderRadius: BorderRadius.circular(16),
                  splashColor: Colors.white.withOpacity(0.1),
                  highlightColor: Colors.white.withOpacity(0.05),
                  child: const SizedBox(
                    width: double.infinity,
                    height: double.infinity,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _navigateToKaganDetail() {
    Navigator.push(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) => 
          const KaganCulturalDetailScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          const begin = Offset(1.0, 0.0);
          const end = Offset.zero;
          const curve = Curves.easeInOutCubic;

          var tween = Tween(begin: begin, end: end).chain(
            CurveTween(curve: curve),
          );

          return SlideTransition(
            position: animation.drive(tween),
            child: child,
          );
        },
        transitionDuration: const Duration(milliseconds: 300),
      ),
    );
  }

  void _navigateToMansakaDetail() {
    Navigator.push(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) => 
          const MansakaCulturalDetailScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          const begin = Offset(1.0, 0.0);
          const end = Offset.zero;
          const curve = Curves.easeInOutCubic;

          var tween = Tween(begin: begin, end: end).chain(
            CurveTween(curve: curve),
          );

          return SlideTransition(
            position: animation.drive(tween),
            child: child,
          );
        },
        transitionDuration: const Duration(milliseconds: 300),
      ),
    );
  }

  void _navigateToMandayaDetail() {
    Navigator.push(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) => 
          const MandayaCulturalDetailScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          const begin = Offset(1.0, 0.0);
          const end = Offset.zero;
          const curve = Curves.easeInOutCubic;

          var tween = Tween(begin: begin, end: end).chain(
            CurveTween(curve: curve),
          );

          return SlideTransition(
            position: animation.drive(tween),
            child: child,
          );
        },
        transitionDuration: const Duration(milliseconds: 300),
      ),
    );
  }

  void _navigateToTribeDetail(String tribeName) {
    Navigator.push(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) => 
          TribeDetailScreen(tribeName: tribeName),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          const begin = Offset(1.0, 0.0);
          const end = Offset.zero;
          const curve = Curves.easeInOutCubic;

          var tween = Tween(begin: begin, end: end).chain(
            CurveTween(curve: curve),
          );

          return SlideTransition(
            position: animation.drive(tween),
            child: child,
          );
        },
        transitionDuration: const Duration(milliseconds: 300),
      ),
    );
  }
}

class TribeDetailScreen extends StatelessWidget {
  final String tribeName;

  const TribeDetailScreen({
    super.key,
    required this.tribeName,
  });

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    return Scaffold(
      backgroundColor: Colors.black,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: Icon(
            Icons.arrow_back,
            color: Colors.white,
            size: (screenWidth * 0.06).clamp(20.0, 28.0),
          ),
          onPressed: () => Navigator.pop(context),
        ),
        title: FittedBox(
          fit: BoxFit.scaleDown,
          child: Text(
            tribeName.toUpperCase(),
            style: TextStyle(
              color: Colors.white,
              fontSize: (screenWidth * 0.05).clamp(16.0, 22.0),
              fontWeight: FontWeight.bold,
              letterSpacing: 1.5,
            ),
          ),
        ),
        centerTitle: true,
      ),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SingleChildScrollView(
          physics: const BouncingScrollPhysics(),
          padding: EdgeInsets.all((screenWidth * 0.05).clamp(16.0, 30.0)),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Hero Image
              Container(
                height: (screenHeight * 0.3).clamp(180.0, 300.0),
                width: double.infinity,
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(16),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.6),
                      blurRadius: 15,
                      offset: const Offset(0, 8),
                    ),
                  ],
                ),
                child: ClipRRect(
                  borderRadius: BorderRadius.circular(16),
                  child: Image.asset(
                    'assets/images/${tribeName.toLowerCase().replaceAll(' ', '_')}_detail.jpg',
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) {
                      return Container(
                        decoration: const BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: [
                              Color(0xFF8B4513),
                              Color(0xFF654321),
                              Color(0xFF2F1B14),
                            ],
                          ),
                        ),
                        child: Center(
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(
                                Icons.people,
                                size: (screenWidth * 0.2).clamp(48.0, 80.0),
                                color: Colors.white.withOpacity(0.3),
                              ),
                              SizedBox(height: (screenHeight * 0.02).clamp(12.0, 20.0)),
                              FittedBox(
                                fit: BoxFit.scaleDown,
                                child: Padding(
                                  padding: EdgeInsets.symmetric(
                                    horizontal: (screenWidth * 0.05).clamp(16.0, 30.0)
                                  ),
                                  child: Text(
                                    tribeName.toUpperCase(),
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: (screenWidth * 0.06).clamp(18.0, 26.0),
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 2,
                                    ),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      );
                    },
                  ),
                ),
              ),
              
              SizedBox(height: (screenHeight * 0.04).clamp(20.0, 32.0)),
              
              FittedBox(
                fit: BoxFit.scaleDown,
                alignment: Alignment.centerLeft,
                child: Text(
                  'About $tribeName',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: (screenWidth * 0.06).clamp(18.0, 26.0),
                    fontWeight: FontWeight.bold,
                    letterSpacing: 1,
                  ),
                ),
              ),
              
              SizedBox(height: (screenHeight * 0.02).clamp(12.0, 20.0)),
              
              Text(
                _getTribeDescription(tribeName),
                style: TextStyle(
                  color: Colors.white.withOpacity(0.9),
                  fontSize: (screenWidth * 0.04).clamp(13.0, 16.0),
                  height: 1.6,
                  letterSpacing: 0.5,
                ),
              ),
              
              SizedBox(height: (screenHeight * 0.04).clamp(20.0, 32.0)),
              
              FittedBox(
                fit: BoxFit.scaleDown,
                alignment: Alignment.centerLeft,
                child: Text(
                  'Cultural Categories',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: (screenWidth * 0.05).clamp(16.0, 22.0),
                    fontWeight: FontWeight.bold,
                    letterSpacing: 1,
                  ),
                ),
              ),
              
              SizedBox(height: (screenHeight * 0.02).clamp(12.0, 20.0)),
              
              _buildCategoryGrid(screenWidth, screenHeight),
              
              SizedBox(height: (screenHeight * 0.05).clamp(24.0, 40.0)),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildCategoryGrid(double screenWidth, double screenHeight) {
    List<Map<String, dynamic>> categories = [
      {'name': 'Traditional Clothing', 'icon': Icons.checkroom, 'color': const Color(0xFF8B4513)},
      {'name': 'Music & Dance', 'icon': Icons.music_note, 'color': const Color(0xFF654321)},
      {'name': 'Arts & Crafts', 'icon': Icons.palette, 'color': const Color(0xFF2F4F4F)},
      {'name': 'Language', 'icon': Icons.translate, 'color': const Color(0xFF8B7355)},
    ];

    return GridView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 2,
        crossAxisSpacing: (screenWidth * 0.04).clamp(12.0, 20.0),
        mainAxisSpacing: (screenHeight * 0.02).clamp(12.0, 20.0),
        childAspectRatio: 1.2,
      ),
      itemCount: categories.length,
      itemBuilder: (context, index) {
        return _buildCategoryCard(categories[index], screenWidth, screenHeight);
      },
    );
  }

  Widget _buildCategoryCard(Map<String, dynamic> category, double screenWidth, double screenHeight) {
    return Container(
      decoration: BoxDecoration(
        color: category['color'].withOpacity(0.2),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: category['color'].withOpacity(0.5),
          width: 1,
        ),
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: () {
            HapticFeedback.lightImpact();
          },
          borderRadius: BorderRadius.circular(12),
          child: Padding(
            padding: EdgeInsets.all((screenWidth * 0.04).clamp(10.0, 20.0)),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(
                  category['icon'],
                  color: category['color'],
                  size: (screenWidth * 0.1).clamp(32.0, 48.0),
                ),
                SizedBox(height: (screenHeight * 0.015).clamp(8.0, 12.0)),
                Flexible(
                  child: FittedBox(
                    fit: BoxFit.scaleDown,
                    child: Text(
                      category['name'],
                      textAlign: TextAlign.center,
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: (screenWidth * 0.035).clamp(11.0, 14.0),
                        fontWeight: FontWeight.w600,
                        letterSpacing: 0.5,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  String _getTribeDescription(String tribeName) {
    switch (tribeName.toLowerCase()) {
      case 'kagan':
        return 'The Kagan people are an indigenous group found in the mountainous regions of Mindanao. They are known for their rich oral traditions, intricate beadwork, and deep spiritual connection with nature. Their culture emphasizes community cooperation, respect for elders, and sustainable living practices that have been passed down through generations.';
      case 'mansaka':
        return 'The Mansaka tribe is renowned for their exceptional weaving skills and agricultural practices. They inhabit the eastern part of Davao and are known for their colorful traditional clothing, particularly their beautifully woven fabrics. The Mansaka people maintain strong cultural traditions while adapting to modern life.';
      case 'mandaya':
        return 'The Mandaya people are masters of traditional music and dance ceremonies. They are one of the major indigenous groups in Mindanao, primarily found in Davao Oriental. Known for their dagmay (traditional cloth), musical instruments, and elaborate festivals that celebrate their rich cultural heritage and spiritual beliefs.';
      default:
        return 'This indigenous tribe has a rich cultural heritage that includes traditional practices, unique art forms, and deep spiritual connections to their ancestral lands. They continue to preserve their customs and traditions while navigating the challenges of the modern world.';
    }
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\kagan_category_screens\kagan_artifacts_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

class KaganArtifactsScreen extends StatefulWidget {
  const KaganArtifactsScreen({super.key});

  @override
  State<KaganArtifactsScreen> createState() => _KaganArtifactsScreenState();
}

class _KaganArtifactsScreenState extends State<KaganArtifactsScreen> {
  final TextEditingController _searchController = TextEditingController();
  String _searchQuery = '';

  // API and loading state
  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<ArtifactItem> _allArtifacts = [];
  bool _isLoading = true;
  String? _errorMessage;

  List<ArtifactItem> get _filteredArtifacts {
    if (_searchQuery.isEmpty) {
      return _allArtifacts;
    }
    return _allArtifacts.where((artifact) {
      return artifact.name.toLowerCase().contains(_searchQuery.toLowerCase()) ||
             artifact.description.toLowerCase().contains(_searchQuery.toLowerCase());
    }).toList();
  }

  // Responsive helper methods
  int _getCrossAxisCount(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 4; // Desktop large
    if (width > 900) return 3;  // Desktop/Tablet landscape
    if (width > 600) return 3;  // Tablet
    return 2;                    // Mobile
  }

  double _getHorizontalPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 40;
    if (width > 900) return 32;
    if (width > 600) return 24;
    return 20;
  }

  double _getFeaturedImageHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 900) return 300;
    if (width > 600) return 250;
    return 200;
  }

  double _getChildAspectRatio(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 900) return 0.9;
    return 0.85;
  }

  @override
  void initState() {
    super.initState();
    _fetchArtifacts();
  }

  Future<void> _fetchArtifacts() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching Kagan artifacts from: $_baseUrl');
      
      const String apiUrl = '$_baseUrl?tribe=kagan&category=artifact';
      debugPrint('API URL: $apiUrl');

      final response = await http.get(
        Uri.parse(apiUrl),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      ).timeout(const Duration(seconds: 15));
      
      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');
      
      if (response.statusCode != 200) {
        throw Exception('API returned status code: ${response.statusCode}');
      }

      final Map<String, dynamic> jsonData = json.decode(response.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      if (!jsonData.containsKey('data')) {
        throw Exception('API response missing "data" field');
      }

      final dynamic rawData = jsonData['data'];
      List<dynamic> contentItems = [];
      
      if (rawData is List) {
        contentItems = rawData;
      } else if (rawData is Map) {
        contentItems = [rawData];
      } else {
        throw Exception('Unexpected data format in API response');
      }

      debugPrint('Found ${contentItems.length} content items');

      final List<ArtifactItem> artifacts = [];

      for (var item in contentItems) {
        if (item == null || item is! Map<String, dynamic>) {
          debugPrint('Skipping invalid item: $item');
          continue;
        }
        
        debugPrint('Processing item: ${item.toString()}');
        
        final dynamic id = item['id'];
        final dynamic userId = item['user_id'];
        final String? title = item['title']?.toString();
        final String? category = item['category']?.toString();
        final String? tribe = item['tribe']?.toString();
        final String? description = item['description']?.toString();
        final String? file = item['file']?.toString();
        final dynamic isArchived = item['is_archived'];
        final String? time = item['time']?.toString();
        
        if (id == null || 
            userId == null || 
            title == null || title.isEmpty ||
            category == null || category.isEmpty ||
            tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty ||
            isArchived == null ||
            time == null || time.isEmpty) {
          debugPrint('Skipping item with missing required fields');
          continue;
        }
        
        if (tribe.toLowerCase() != 'kagan') {
          debugPrint('Skipping non-Kagan item: $tribe');
          continue;
        }

        if (isArchived != 0) {
          debugPrint('Skipping archived item: $title');
          continue;
        }

        if (category.toLowerCase() != 'artifact' && !_isImageContent(file)) {
          debugPrint('Skipping non-artifact content: $file (category: $category)');
          continue;
        }

        final artifact = ArtifactItem(
          id: id.toString(),
          name: title,
          description: description ?? 'No description available',
          imagePath: '$_uploadsBaseUrl$file',
          file: file,
          isNetworkSource: true,
        );
        
        debugPrint(' Added artifact: $title (ID: $id, Category: $category)');
        artifacts.add(artifact);
      }

      debugPrint('Final artifact count: ${artifacts.length}');

      setState(() {
        _allArtifacts = artifacts;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching artifacts: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load artifacts: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  bool _isImageContent(String filename) {
    final String lowerFilename = filename.toLowerCase();
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    return imageExtensions.any((ext) => lowerFilename.endsWith(ext));
  }

  Future<void> _refreshArtifacts() async {
    await _fetchArtifacts();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              _buildHeader(),
              Expanded(
                child: _isLoading 
                    ? _buildLoadingState()
                    : _errorMessage != null 
                        ? _buildErrorState()
                        : _allArtifacts.isEmpty
                            ? _buildEmptyState()
                            : _buildContent(),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildLoadingState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const CircularProgressIndicator(
            valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
          ),
          const SizedBox(height: 16),
          Text(
            'Loading Kagan artifacts...',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 14,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildErrorState() {
    final padding = _getHorizontalPadding(context);
    
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: padding),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            const SizedBox(height: 16),
            Text(
              'Failed to load artifacts',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              _errorMessage!,
              style: TextStyle(
                color: Colors.white.withOpacity(0.5),
                fontSize: 14,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: _refreshArtifacts,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFFD4A574),
                foregroundColor: Colors.white,
              ),
              child: const Text('Retry'),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.museum_outlined,
            size: 64,
            color: Colors.white.withOpacity(0.5),
          ),
          const SizedBox(height: 16),
          Text(
            'No Kagan artifacts available',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 18,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Check back later for new artifacts',
            style: TextStyle(
              color: Colors.white.withOpacity(0.5),
              fontSize: 14,
            ),
          ),
          const SizedBox(height: 24),
          ElevatedButton(
            onPressed: _refreshArtifacts,
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFFD4A574),
              foregroundColor: Colors.white,
            ),
            child: const Text('Refresh'),
          ),
        ],
      ),
    );
  }

  Widget _buildContent() {
    return RefreshIndicator(
      onRefresh: _refreshArtifacts,
      color: const Color(0xFFD4A574),
      child: LayoutBuilder(
        builder: (context, constraints) {
          return SingleChildScrollView(
            physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
            keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
            child: ConstrainedBox(
              constraints: const BoxConstraints(
                maxWidth: 1400,
              ),
              child: Center(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildSearchBar(),
                    const SizedBox(height: 20),
                    _buildFeaturedImage(),
                    const SizedBox(height: 24),
                    _buildDescription(),
                    const SizedBox(height: 32),
                    _buildBrowseSection(),
                    const SizedBox(height: 20),
                    _buildArtifactsGrid(),
                    SizedBox(height: 40 + MediaQuery.of(context).viewInsets.bottom),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildHeader() {
    final padding = _getHorizontalPadding(context);
    final width = MediaQuery.of(context).size.width;
    final fontSize = width > 600 ? 22.0 : 20.0;
    
    return Padding(
      padding: EdgeInsets.all(padding),
      child: Row(
        children: [
          Container(
            decoration: BoxDecoration(
              color: Colors.black.withOpacity(0.3),
              borderRadius: BorderRadius.circular(12),
            ),
            child: IconButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                Navigator.pop(context);
              },
              icon: const Icon(
                Icons.arrow_back_ios,
                color: Colors.white,
                size: 20,
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Text(
              'KAGAN ARTIFACTS',
              style: TextStyle(
                color: Colors.white,
                fontSize: fontSize,
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchBar() {
    final padding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Container(
        decoration: BoxDecoration(
          color: const Color(0xFF2A2A2A),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: const Color(0xFFD4A574).withOpacity(0.3),
            width: 1,
          ),
        ),
        child: TextField(
          controller: _searchController,
          onChanged: (value) {
            setState(() {
              _searchQuery = value;
            });
          },
          style: const TextStyle(color: Colors.white),
          decoration: InputDecoration(
            hintText: 'Search artifacts',
            hintStyle: TextStyle(
              color: Colors.white.withOpacity(0.6),
              fontSize: 16,
            ),
            prefixIcon: Icon(
              Icons.search,
              color: Colors.white.withOpacity(0.6),
            ),
            suffixIcon: _searchQuery.isNotEmpty
                ? IconButton(
                    onPressed: () {
                      setState(() {
                        _searchController.clear();
                        _searchQuery = '';
                      });
                    },
                    icon: Icon(
                      Icons.clear,
                      color: Colors.white.withOpacity(0.6),
                    ),
                  )
                : null,
            border: InputBorder.none,
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 16,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildFeaturedImage() {
    final padding = _getHorizontalPadding(context);
    final height = _getFeaturedImageHeight(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Container(
        height: height,
        width: double.infinity,
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Image.asset(
            'assets/images/kagan_arti.jpg',
            fit: BoxFit.cover,
            errorBuilder: (context, error, stackTrace) {
              return Container(
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      Color(0xFFD4A574),
                      Color(0xFF8B4513),
                      Color(0xFF654321),
                    ],
                  ),
                ),
                child: const Center(
                  child: Icon(
                    Icons.museum,
                    color: Colors.white,
                    size: 60,
                  ),
                ),
              );
            },
          ),
        ),
      ),
    );
  }

  Widget _buildDescription() {
    final padding = _getHorizontalPadding(context);
    final width = MediaQuery.of(context).size.width;
    final fontSize = width > 600 ? 17.0 : 16.0;
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Discover authentic Kagan artifacts - physical objects that tell the story of this indigenous tribe\'s rich cultural heritage, craftsmanship, and daily life.',
            style: TextStyle(
              color: Colors.white.withOpacity(0.9),
              fontSize: fontSize,
              height: 1.6,
              letterSpacing: 0.5,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBrowseSection() {
    final padding = _getHorizontalPadding(context);
    final width = MediaQuery.of(context).size.width;
    final fontSize = width > 600 ? 22.0 : 20.0;
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Text(
        'Browse artifacts (${_filteredArtifacts.length})',
        style: TextStyle(
          color: Colors.white,
          fontSize: fontSize,
          fontWeight: FontWeight.bold,
        ),
      ),
    );
  }

  Widget _buildArtifactsGrid() {
    if (_filteredArtifacts.isEmpty) {
      return _buildNoResults();
    }

    final padding = _getHorizontalPadding(context);
    final crossAxisCount = _getCrossAxisCount(context);
    final width = MediaQuery.of(context).size.width;
    final spacing = width > 900 ? 20.0 : 16.0;
    final aspectRatio = _getChildAspectRatio(context);

    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: GridView.builder(
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: crossAxisCount,
          crossAxisSpacing: spacing,
          mainAxisSpacing: spacing,
          childAspectRatio: aspectRatio,
        ),
        itemCount: _filteredArtifacts.length,
        itemBuilder: (context, index) {
          return _buildArtifactCard(_filteredArtifacts[index], index);
        },
      ),
    );
  }

  Widget _buildNoResults() {
    final padding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const SizedBox(height: 60),
            Icon(
              Icons.search_off,
              size: 64,
              color: Colors.white.withOpacity(0.3),
            ),
            const SizedBox(height: 16),
            Text(
              'No artifacts found',
              style: TextStyle(
                color: Colors.white.withOpacity(0.6),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'Try searching with different keywords',
              style: TextStyle(
                color: Colors.white.withOpacity(0.4),
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 60),
          ],
        ),
      ),
    );
  }

  Widget _buildArtifactCard(ArtifactItem artifact, int index) {
    return GestureDetector(
      onTap: () {
        HapticFeedback.mediumImpact();
        _showArtifactViewer(artifact, index);
      },
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              Expanded(
                flex: 3,
                child: artifact.isNetworkSource
                    ? Image.network(
                        artifact.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFFD4A574),
                                  Color(0xFF8B4513),
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 40,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            color: const Color(0xFF2A2A2A),
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
                                strokeWidth: 2,
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        artifact.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFFD4A574),
                                  Color(0xFF8B4513),
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 40,
                              ),
                            ),
                          );
                        },
                      ),
              ),
              Container(
                padding: const EdgeInsets.all(12),
                color: const Color(0xFF2A2A2A),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      artifact.name,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 4),
                    Text(
                      artifact.description,
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: 12,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showArtifactViewer(ArtifactItem artifact, int index) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => ArtifactViewerBottomSheet(
        artifacts: _filteredArtifacts,
        initialIndex: index,
        accentColor: const Color(0xFFD4A574),
      ),
    );
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }
}

class ArtifactItem {
  final String? id;
  final String name;
  final String description;
  final String imagePath;
  final String? file;
  final bool isNetworkSource;

  ArtifactItem({
    this.id,
    required this.name,
    required this.description,
    required this.imagePath,
    this.file,
    this.isNetworkSource = false,
  });
}

class ArtifactViewerBottomSheet extends StatefulWidget {
  final List<ArtifactItem> artifacts;
  final int initialIndex;
  final Color accentColor;

  const ArtifactViewerBottomSheet({
    super.key,
    required this.artifacts,
    required this.initialIndex,
    required this.accentColor,
  });

  @override
  State<ArtifactViewerBottomSheet> createState() => _ArtifactViewerBottomSheetState();
}

class _ArtifactViewerBottomSheetState extends State<ArtifactViewerBottomSheet> {
  late PageController _pageController;
  late int _currentIndex;

  @override
  void initState() {
    super.initState();
    _currentIndex = widget.initialIndex;
    _pageController = PageController(initialPage: widget.initialIndex);
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;
    final screenHeight = MediaQuery.of(context).size.height;
    final maxHeight = screenHeight * 0.9;
    
    return Container(
      constraints: BoxConstraints(
        maxHeight: maxHeight,
        maxWidth: 800,
      ),
      margin: EdgeInsets.symmetric(
        horizontal: MediaQuery.of(context).size.width > 800 
            ? (MediaQuery.of(context).size.width - 800) / 2 
            : 0,
      ),
      decoration: const BoxDecoration(
        color: Color(0xFF1a1a1a),
        borderRadius: BorderRadius.vertical(
          top: Radius.circular(20),
        ),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          _buildHandle(),
          _buildHeader(),
          Flexible(
            child: PageView.builder(
              controller: _pageController,
              onPageChanged: (index) {
                setState(() {
                  _currentIndex = index;
                });
                HapticFeedback.selectionClick();
              },
              itemCount: widget.artifacts.length,
              itemBuilder: (context, index) {
                return _buildArtifactCard(widget.artifacts[index]);
              },
            ),
          ),
          _buildPageIndicator(),
          SizedBox(height: 20 + keyboardHeight * 0.1),
        ],
      ),
    );
  }

  Widget _buildHandle() {
    return Container(
      margin: const EdgeInsets.only(top: 12, bottom: 8),
      width: 40,
      height: 4,
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.3),
        borderRadius: BorderRadius.circular(2),
      ),
    );
  }

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
      child: Row(
        children: [
          const Text(
            'Artifact Details',
            style: TextStyle(
              color: Colors.white,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.pop(context),
            icon: const Icon(
              Icons.close,
              color: Colors.white,
              size: 24,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildArtifactCard(ArtifactItem artifact) {
    final width = MediaQuery.of(context).size.width;
    final imageHeight = width > 600 ? 300.0 : 250.0;
    
    return SingleChildScrollView(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          GestureDetector(
            onTap: () => _showFullScreenImage(artifact),
            child: Container(
              height: imageHeight,
              width: double.infinity,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.4),
                    blurRadius: 8,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(16),
                child: Stack(
                  children: [
                    artifact.isNetworkSource
                        ? Image.network(
                            artifact.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: const Center(
                                  child: Icon(
                                    Icons.museum,
                                    color: Colors.white,
                                    size: 60,
                                  ),
                                ),
                              );
                            },
                            loadingBuilder: (context, child, loadingProgress) {
                              if (loadingProgress == null) return child;
                              return Container(
                                color: const Color(0xFF2A2A2A),
                                child: const Center(
                                  child: CircularProgressIndicator(
                                    valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
                                  ),
                                ),
                              );
                            },
                          )
                        : Image.asset(
                            artifact.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: const Center(
                                  child: Icon(
                                    Icons.museum,
                                    color: Colors.white,
                                    size: 60,
                                  ),
                                ),
                              );
                            },
                          ),
                    Positioned(
                      top: 8,
                      right: 8,
                      child: Container(
                        padding: const EdgeInsets.all(6),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.6),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: const Icon(
                          Icons.fullscreen,
                          color: Colors.white,
                          size: 16,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: const Color(0xFF2A2A2A),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  artifact.name,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    height: 1.4,
                  ),
                ),
                const SizedBox(height: 12),
                Text(
                  artifact.description,
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.9),
                    fontSize: 14,
                    height: 1.5,
                  ),
                ),
              ],
            ),
          ),
          SizedBox(height: 30 + MediaQuery.of(context).viewInsets.bottom * 0.1),
        ],
      ),
    );
  }

  void _showFullScreenImage(ArtifactItem artifact) {
    Navigator.of(context).push(
      PageRouteBuilder(
        opaque: false,
        barrierColor: Colors.black,
        pageBuilder: (BuildContext context, _, __) {
          return FullScreenImageViewer(
            artifact: artifact,
            accentColor: widget.accentColor,
          );
        },
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
      ),
    );
  }

  Widget _buildPageIndicator() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: List.generate(
        widget.artifacts.length,
        (index) => Container(
          margin: const EdgeInsets.symmetric(horizontal: 4),
          width: 8,
          height: 8,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: index == _currentIndex
                ? widget.accentColor
                : Colors.white.withOpacity(0.3),
          ),
        ),
      ),
    );
  }
}

class FullScreenImageViewer extends StatefulWidget {
  final ArtifactItem artifact;
  final Color accentColor;

  const FullScreenImageViewer({
    super.key,
    required this.artifact,
    required this.accentColor,
  });

  @override
  State<FullScreenImageViewer> createState() => _FullScreenImageViewerState();
}

class _FullScreenImageViewerState extends State<FullScreenImageViewer> {
  bool _showControls = true;

  @override
  void initState() {
    super.initState();
    _hideControlsAfterDelay();
  }

  void _hideControlsAfterDelay() {
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        setState(() {
          _showControls = false;
        });
      }
    });
  }

  void _toggleControls() {
    setState(() {
      _showControls = !_showControls;
    });
    if (_showControls) {
      _hideControlsAfterDelay();
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: GestureDetector(
        onTap: _toggleControls,
        child: Stack(
          children: [
            Center(
              child: InteractiveViewer(
                panEnabled: true,
                boundaryMargin: const EdgeInsets.all(20),
                minScale: 0.5,
                maxScale: 4.0,
                child: widget.artifact.isNetworkSource
                    ? Image.network(
                        widget.artifact.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            color: Colors.black,
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        widget.artifact.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                      ),
              ),
            ),
            AnimatedOpacity(
              opacity: _showControls ? 1.0 : 0.0,
              duration: const Duration(milliseconds: 300),
              child: SafeArea(
                child: Column(
                  children: [
                    Container(
                      width: double.infinity,
                      padding: const EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 16,
                      ),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Row(
                        children: [
                          IconButton(
                            onPressed: () => Navigator.pop(context),
                            icon: const Icon(
                              Icons.close,
                              color: Colors.white,
                              size: 28,
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  widget.artifact.name,
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                  ),
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                ),
                                Text(
                                  'Kagan Artifact',
                                  style: TextStyle(
                                    color: widget.accentColor,
                                    fontSize: 14,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                    const Spacer(),
                    Container(
                      width: double.infinity,
                      padding: const EdgeInsets.all(20),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.bottomCenter,
                          end: Alignment.topCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Text(
                        'Tap to zoom  Pinch to scale  Drag to pan',
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: 12,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\kagan_category_screens\kagan_event_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

class KaganEventScreen extends StatefulWidget {
  const KaganEventScreen({super.key});

  @override
  State<KaganEventScreen> createState() => _KaganEventScreenState();
}

class _KaganEventScreenState extends State<KaganEventScreen> {
  final TextEditingController _searchController = TextEditingController();
  String _searchQuery = '';

  // API and loading state
  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<EventItem> _allEvents = [];
  bool _isLoading = true;
  String? _errorMessage;

  List<EventItem> get _filteredEvents {
    if (_searchQuery.isEmpty) {
      return _allEvents;
    }
    return _allEvents.where((event) {
      return event.name.toLowerCase().contains(_searchQuery.toLowerCase()) ||
             event.description.toLowerCase().contains(_searchQuery.toLowerCase());
    }).toList();
  }

  // Responsive helper methods
  int _getCrossAxisCount(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 4; // Desktop large
    if (width > 900) return 3;  // Desktop/Tablet landscape
    if (width > 600) return 3;  // Tablet
    return 2;                    // Mobile
  }

  double _getHorizontalPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 40;
    if (width > 900) return 32;
    if (width > 600) return 24;
    return 20;
  }

  double _getFeaturedImageHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 900) return 300;
    if (width > 600) return 250;
    return 200;
  }

  double _getChildAspectRatio(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 900) return 0.9;
    return 0.85;
  }

  @override
  void initState() {
    super.initState();
    _fetchEvents();
  }

  Future<void> _fetchEvents() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching Kagan events from: $_baseUrl');
      
      const String apiUrl = '$_baseUrl?tribe=kagan&category=event';
      debugPrint('API URL: $apiUrl');

      final response = await http.get(
        Uri.parse(apiUrl),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      ).timeout(const Duration(seconds: 15));
      
      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');
      
      if (response.statusCode != 200) {
        throw Exception('API returned status code: ${response.statusCode}');
      }

      final Map<String, dynamic> jsonData = json.decode(response.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      if (!jsonData.containsKey('data')) {
        throw Exception('API response missing "data" field');
      }

      final dynamic rawData = jsonData['data'];
      List<dynamic> contentItems = [];
      
      if (rawData is List) {
        contentItems = rawData;
      } else if (rawData is Map) {
        contentItems = [rawData];
      } else {
        throw Exception('Unexpected data format in API response');
      }

      debugPrint('Found ${contentItems.length} content items');

      final List<EventItem> events = [];

      for (var item in contentItems) {
        if (item == null || item is! Map<String, dynamic>) {
          debugPrint('Skipping invalid item: $item');
          continue;
        }
        
        debugPrint('Processing item: ${item.toString()}');
        
        final dynamic id = item['id'];
        final dynamic userId = item['user_id'];
        final String? title = item['title']?.toString();
        final String? category = item['category']?.toString();
        final String? tribe = item['tribe']?.toString();
        final String? description = item['description']?.toString();
        final String? file = item['file']?.toString();
        final dynamic isArchived = item['is_archived'];
        
        if (id == null || 
            userId == null || 
            title == null || title.isEmpty ||
            category == null || category.isEmpty ||
            tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty ||
            isArchived == null) {
          debugPrint('Skipping item with missing required fields');
          continue;
        }
        
        if (tribe.toLowerCase() != 'kagan') {
          debugPrint('Skipping non-Kagan item: $tribe');
          continue;
        }

        if (isArchived != 0) {
          debugPrint('Skipping archived item: $title');
          continue;
        }

        if (category.toLowerCase() != 'event' && !_isImageContent(file)) {
          debugPrint('Skipping non-event content: $file (category: $category)');
          continue;
        }

        final event = EventItem(
          id: id.toString(),
          name: title,
          description: description ?? 'No description available',
          imagePath: '$_uploadsBaseUrl$file',
          file: file,
          isNetworkSource: true,
        );
        
        debugPrint(' Added event: $title (ID: $id, Category: $category)');
        events.add(event);
      }

      debugPrint('Final event count: ${events.length}');

      setState(() {
        _allEvents = events;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching events: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load events: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  bool _isImageContent(String filename) {
    final String lowerFilename = filename.toLowerCase();
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    return imageExtensions.any((ext) => lowerFilename.endsWith(ext));
  }

  Future<void> _refreshEvents() async {
    await _fetchEvents();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              _buildHeader(),
              Expanded(
                child: _isLoading 
                    ? _buildLoadingState()
                    : _errorMessage != null 
                        ? _buildErrorState()
                        : _allEvents.isEmpty
                            ? _buildEmptyState()
                            : _buildContent(),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildLoadingState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const CircularProgressIndicator(
            valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
          ),
          const SizedBox(height: 16),
          Text(
            'Loading Kagan events...',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 14,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildErrorState() {
    final padding = _getHorizontalPadding(context);
    
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: padding),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            const SizedBox(height: 16),
            Text(
              'Failed to load events',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              _errorMessage!,
              style: TextStyle(
                color: Colors.white.withOpacity(0.5),
                fontSize: 14,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: _refreshEvents,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFFD4A574),
                foregroundColor: Colors.white,
              ),
              child: const Text('Retry'),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.event_outlined,
            size: 64,
            color: Colors.white.withOpacity(0.5),
          ),
          const SizedBox(height: 16),
          Text(
            'No Kagan events available',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 18,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Check back later for new events',
            style: TextStyle(
              color: Colors.white.withOpacity(0.5),
              fontSize: 14,
            ),
          ),
          const SizedBox(height: 24),
          ElevatedButton(
            onPressed: _refreshEvents,
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFFD4A574),
              foregroundColor: Colors.white,
            ),
            child: const Text('Refresh'),
          ),
        ],
      ),
    );
  }

  Widget _buildContent() {
    return RefreshIndicator(
      onRefresh: _refreshEvents,
      color: const Color(0xFFD4A574),
      child: LayoutBuilder(
        builder: (context, constraints) {
          return SingleChildScrollView(
            physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
            keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
            child: ConstrainedBox(
              constraints: const BoxConstraints(
                maxWidth: 1400,
              ),
              child: Center(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildSearchBar(),
                    const SizedBox(height: 20),
                    _buildFeaturedImage(),
                    const SizedBox(height: 24),
                    _buildDescription(),
                    const SizedBox(height: 32),
                    _buildBrowseSection(),
                    const SizedBox(height: 20),
                    _buildEventsGrid(),
                    SizedBox(height: 40 + MediaQuery.of(context).viewInsets.bottom),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildHeader() {
    final padding = _getHorizontalPadding(context);
    final width = MediaQuery.of(context).size.width;
    final fontSize = width > 600 ? 22.0 : 20.0;
    
    return Padding(
      padding: EdgeInsets.all(padding),
      child: Row(
        children: [
          Container(
            decoration: BoxDecoration(
              color: Colors.black.withOpacity(0.3),
              borderRadius: BorderRadius.circular(12),
            ),
            child: IconButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                Navigator.pop(context);
              },
              icon: const Icon(
                Icons.arrow_back_ios,
                color: Colors.white,
                size: 20,
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Text(
              'KAGAN EVENTS',
              style: TextStyle(
                color: Colors.white,
                fontSize: fontSize,
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchBar() {
    final padding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Container(
        decoration: BoxDecoration(
          color: const Color(0xFF2A2A2A),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: const Color(0xFFD4A574).withOpacity(0.3),
            width: 1,
          ),
        ),
        child: TextField(
          controller: _searchController,
          onChanged: (value) {
            setState(() {
              _searchQuery = value;
            });
          },
          style: const TextStyle(color: Colors.white),
          decoration: InputDecoration(
            hintText: 'Search events',
            hintStyle: TextStyle(
              color: Colors.white.withOpacity(0.6),
              fontSize: 16,
            ),
            prefixIcon: Icon(
              Icons.search,
              color: Colors.white.withOpacity(0.6),
            ),
            suffixIcon: _searchQuery.isNotEmpty
                ? IconButton(
                    onPressed: () {
                      setState(() {
                        _searchController.clear();
                        _searchQuery = '';
                      });
                    },
                    icon: Icon(
                      Icons.clear,
                      color: Colors.white.withOpacity(0.6),
                    ),
                  )
                : null,
            border: InputBorder.none,
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 16,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildFeaturedImage() {
    final padding = _getHorizontalPadding(context);
    final height = _getFeaturedImageHeight(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Container(
        height: height,
        width: double.infinity,
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Image.asset(
            'assets/images/kagan_eve.jpg',
            fit: BoxFit.cover,
            errorBuilder: (context, error, stackTrace) {
              return Container(
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      Color(0xFFD4A574),
                      Color(0xFF8B4513),
                      Color(0xFF654321),
                    ],
                  ),
                ),
                child: const Center(
                  child: Icon(
                    Icons.event,
                    color: Colors.white,
                    size: 60,
                  ),
                ),
              );
            },
          ),
        ),
      ),
    );
  }

  Widget _buildDescription() {
    final padding = _getHorizontalPadding(context);
    final width = MediaQuery.of(context).size.width;
    final fontSize = width > 600 ? 17.0 : 16.0;
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Browse through a collection of historical and contemporary photographs showcasing Kagan events, ceremonies, and cultural celebrations that preserve their rich heritage.',
            style: TextStyle(
              color: Colors.white.withOpacity(0.9),
              fontSize: fontSize,
              height: 1.6,
              letterSpacing: 0.5,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBrowseSection() {
    final padding = _getHorizontalPadding(context);
    final width = MediaQuery.of(context).size.width;
    final fontSize = width > 600 ? 22.0 : 20.0;
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Text(
        'Browse events (${_filteredEvents.length})',
        style: TextStyle(
          color: Colors.white,
          fontSize: fontSize,
          fontWeight: FontWeight.bold,
        ),
      ),
    );
  }

  Widget _buildEventsGrid() {
    if (_filteredEvents.isEmpty) {
      return _buildNoResults();
    }

    final padding = _getHorizontalPadding(context);
    final crossAxisCount = _getCrossAxisCount(context);
    final width = MediaQuery.of(context).size.width;
    final spacing = width > 900 ? 20.0 : 16.0;
    final aspectRatio = _getChildAspectRatio(context);

    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: GridView.builder(
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: crossAxisCount,
          crossAxisSpacing: spacing,
          mainAxisSpacing: spacing,
          childAspectRatio: aspectRatio,
        ),
        itemCount: _filteredEvents.length,
        itemBuilder: (context, index) {
          return _buildEventCard(_filteredEvents[index], index);
        },
      ),
    );
  }

  Widget _buildNoResults() {
    final padding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: padding),
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const SizedBox(height: 60),
            Icon(
              Icons.search_off,
              size: 64,
              color: Colors.white.withOpacity(0.3),
            ),
            const SizedBox(height: 16),
            Text(
              'No events found',
              style: TextStyle(
                color: Colors.white.withOpacity(0.6),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'Try searching with different keywords',
              style: TextStyle(
                color: Colors.white.withOpacity(0.4),
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 60),
          ],
        ),
      ),
    );
  }

  Widget _buildEventCard(EventItem event, int index) {
    return GestureDetector(
      onTap: () {
        HapticFeedback.mediumImpact();
        _showEventViewer(event, index);
      },
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              Expanded(
                flex: 3,
                child: event.isNetworkSource
                    ? Image.network(
                        event.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFFD4A574),
                                  Color(0xFF8B4513),
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: 40,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            color: const Color(0xFF2A2A2A),
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
                                strokeWidth: 2,
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        event.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFFD4A574),
                                  Color(0xFF8B4513),
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: 40,
                              ),
                            ),
                          );
                        },
                      ),
              ),
              Container(
                padding: const EdgeInsets.all(12),
                color: const Color(0xFF2A2A2A),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      event.name,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 4),
                    Text(
                      event.description,
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: 12,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showEventViewer(EventItem event, int index) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => EventViewerBottomSheet(
        events: _filteredEvents,
        initialIndex: index,
        accentColor: const Color(0xFFD4A574),
      ),
    );
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }
}

class EventItem {
  final String? id;
  final String name;
  final String description;
  final String imagePath;
  final String? file;
  final bool isNetworkSource;

  EventItem({
    this.id,
    required this.name,
    required this.description,
    required this.imagePath,
    this.file,
    this.isNetworkSource = false,
  });
}

class EventViewerBottomSheet extends StatefulWidget {
  final List<EventItem> events;
  final int initialIndex;
  final Color accentColor;

  const EventViewerBottomSheet({
    super.key,
    required this.events,
    required this.initialIndex,
    required this.accentColor,
  });

  @override
  State<EventViewerBottomSheet> createState() => _EventViewerBottomSheetState();
}

class _EventViewerBottomSheetState extends State<EventViewerBottomSheet> {
  late PageController _pageController;
  late int _currentIndex;

  @override
  void initState() {
    super.initState();
    _currentIndex = widget.initialIndex;
    _pageController = PageController(initialPage: widget.initialIndex);
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;
    final screenHeight = MediaQuery.of(context).size.height;
    final maxHeight = screenHeight * 0.9;
    
    return Container(
      constraints: BoxConstraints(
        maxHeight: maxHeight,
        maxWidth: 800,
      ),
      margin: EdgeInsets.symmetric(
        horizontal: MediaQuery.of(context).size.width > 800 
            ? (MediaQuery.of(context).size.width - 800) / 2 
            : 0,
      ),
      decoration: const BoxDecoration(
        color: Color(0xFF1a1a1a),
        borderRadius: BorderRadius.vertical(
          top: Radius.circular(20),
        ),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          _buildHandle(),
          _buildHeader(),
          Flexible(
            child: PageView.builder(
              controller: _pageController,
              onPageChanged: (index) {
                setState(() {
                  _currentIndex = index;
                });
                HapticFeedback.selectionClick();
              },
              itemCount: widget.events.length,
              itemBuilder: (context, index) {
                return _buildEventCard(widget.events[index]);
              },
            ),
          ),
          _buildPageIndicator(),
          SizedBox(height: 20 + keyboardHeight * 0.1),
        ],
      ),
    );
  }

  Widget _buildHandle() {
    return Container(
      margin: const EdgeInsets.only(top: 12, bottom: 8),
      width: 40,
      height: 4,
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.3),
        borderRadius: BorderRadius.circular(2),
      ),
    );
  }

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
      child: Row(
        children: [
          const Text(
            'Event Details',
            style: TextStyle(
              color: Colors.white,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.pop(context),
            icon: const Icon(
              Icons.close,
              color: Colors.white,
              size: 24,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEventCard(EventItem event) {
    final width = MediaQuery.of(context).size.width;
    final imageHeight = width > 600 ? 300.0 : 250.0;
    
    return SingleChildScrollView(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          GestureDetector(
            onTap: () => _showFullScreenImage(event),
            child: Container(
              height: imageHeight,
              width: double.infinity,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.4),
                    blurRadius: 8,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(16),
                child: Stack(
                  children: [
                    event.isNetworkSource
                        ? Image.network(
                            event.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: const Center(
                                  child: Icon(
                                    Icons.event,
                                    color: Colors.white,
                                    size: 60,
                                  ),
                                ),
                              );
                            },
                            loadingBuilder: (context, child, loadingProgress) {
                              if (loadingProgress == null) return child;
                              return Container(
                                color: const Color(0xFF2A2A2A),
                                child: const Center(
                                  child: CircularProgressIndicator(
                                    valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
                                  ),
                                ),
                              );
                            },
                          )
                        : Image.asset(
                            event.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: const Center(
                                  child: Icon(
                                    Icons.event,
                                    color: Colors.white,
                                    size: 60,
                                  ),
                                ),
                              );
                            },
                          ),
                    Positioned(
                      top: 8,
                      right: 8,
                      child: Container(
                        padding: const EdgeInsets.all(6),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.6),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: const Icon(
                          Icons.fullscreen,
                          color: Colors.white,
                          size: 16,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: const Color(0xFF2A2A2A),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  event.name,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    height: 1.4,
                  ),
                ),
                const SizedBox(height: 12),
                Text(
                  event.description,
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.9),
                    fontSize: 14,
                    height: 1.5,
                  ),
                ),
              ],
            ),
          ),
          SizedBox(height: 30 + MediaQuery.of(context).viewInsets.bottom * 0.1),
        ],
      ),
    );
  }

  void _showFullScreenImage(EventItem event) {
    Navigator.of(context).push(
      PageRouteBuilder(
        opaque: false,
        barrierColor: Colors.black,
        pageBuilder: (BuildContext context, _, __) {
          return FullScreenImageViewer(
            event: event,
            accentColor: widget.accentColor,
          );
        },
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
      ),
    );
  }

  Widget _buildPageIndicator() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: List.generate(
        widget.events.length,
        (index) => Container(
          margin: const EdgeInsets.symmetric(horizontal: 4),
          width: 8,
          height: 8,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: index == _currentIndex
                ? widget.accentColor
                : Colors.white.withOpacity(0.3),
          ),
        ),
      ),
    );
  }
}

class FullScreenImageViewer extends StatefulWidget {
  final EventItem event;
  final Color accentColor;

  const FullScreenImageViewer({
    super.key,
    required this.event,
    required this.accentColor,
  });

  @override
  State<FullScreenImageViewer> createState() => _FullScreenImageViewerState();
}

class _FullScreenImageViewerState extends State<FullScreenImageViewer> {
  bool _showControls = true;

  @override
  void initState() {
    super.initState();
    _hideControlsAfterDelay();
  }

  void _hideControlsAfterDelay() {
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        setState(() {
          _showControls = false;
        });
      }
    });
  }

  void _toggleControls() {
    setState(() {
      _showControls = !_showControls;
    });
    if (_showControls) {
      _hideControlsAfterDelay();
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: GestureDetector(
        onTap: _toggleControls,
        child: Stack(
          children: [
            Center(
              child: InteractiveViewer(
                panEnabled: true,
                boundaryMargin: const EdgeInsets.all(20),
                minScale: 0.5,
                maxScale: 4.0,
                child: widget.event.isNetworkSource
                    ? Image.network(
                        widget.event.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            color: Colors.black,
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        widget.event.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                      ),
              ),
            ),
            AnimatedOpacity(
              opacity: _showControls ? 1.0 : 0.0,
              duration: const Duration(milliseconds: 300),
              child: SafeArea(
                child: Column(
                  children: [
                    Container(
                      width: double.infinity,
                      padding: const EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 16,
                      ),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Row(
                        children: [
                          IconButton(
                            onPressed: () => Navigator.pop(context),
                            icon: const Icon(
                              Icons.close,
                              color: Colors.white,
                              size: 28,
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  widget.event.name,
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                  ),
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                ),
                                Text(
                                  'Kagan Event',
                                  style: TextStyle(
                                    color: widget.accentColor,
                                    fontSize: 14,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                    const Spacer(),
                    Container(
                      width: double.infinity,
                      padding: const EdgeInsets.all(20),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.bottomCenter,
                          end: Alignment.topCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Text(
                        'Tap to zoom  Pinch to scale  Drag to pan',
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: 12,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\kagan_category_screens\kagan_music_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:audioplayers/audioplayers.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';

class KaganMusicScreen extends StatefulWidget {
  const KaganMusicScreen({super.key});

  @override
  State<KaganMusicScreen> createState() => _KaganMusicScreenState();
}

class _KaganMusicScreenState extends State<KaganMusicScreen> {
  String _searchQuery = '';
  final TextEditingController _searchController = TextEditingController();
  final FocusNode _searchFocusNode = FocusNode();
  bool _isSearchFocused = false;
  
  final ScrollController _scrollController = ScrollController();
  bool _isHeaderVisible = true;
  double _lastScrollOffset = 0;

  final AudioPlayer _audioPlayer = AudioPlayer();
  MusicTrack? _currentTrack;
  bool _isPlaying = false;
  Duration _currentPosition = Duration.zero;
  Duration _totalDuration = Duration.zero;
  bool _isLoadingAudio = false;

  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<MusicTrack> _allTracks = [];
  bool _isLoading = true;
  String? _errorMessage;
  MusicTrack? _featuredTrack;

  Map<String, Duration> _durationCache = {};
  SharedPreferences? _prefs;
  final Set<String> _loadingDurations = {};

  List<MusicTrack> get _filteredTracks {
    if (_searchQuery.isEmpty) {
      return _allTracks;
    }
    
    return _allTracks.where((track) =>
        track.title.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        track.description.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        track.category.toLowerCase().contains(_searchQuery.toLowerCase())).toList();
  }

  // Responsive helpers
  EdgeInsets _getContentPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 800) return const EdgeInsets.symmetric(horizontal: 32);
    if (width >= 600) return const EdgeInsets.symmetric(horizontal: 24);
    return const EdgeInsets.symmetric(horizontal: 16);
  }

  double _getHeroHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    final height = MediaQuery.of(context).size.height;
    if (width >= 800) return height * 0.35;
    if (width >= 600) return 250;
    return 200;
  }

  double _getCardHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 800) return 110;
    if (width >= 600) return 100;
    return 90;
  }

  double _getPlayerHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 600) return 140;
    return 120;
  }

  @override
  void initState() {
    super.initState();
    _initializePreferences();
    _setupAudioPlayer();
    _setupScrollController();
    _searchFocusNode.addListener(() {
      setState(() {
        _isSearchFocused = _searchFocusNode.hasFocus;
      });
    });
    _fetchMusicTracks();
  }

  Future<void> _initializePreferences() async {
    _prefs = await SharedPreferences.getInstance();
    _loadDurationCache();
  }

  void _loadDurationCache() {
    if (_prefs == null) return;
    
    final cacheJson = _prefs!.getString('music_duration_cache');
    if (cacheJson != null) {
      try {
        final Map<String, dynamic> decoded = json.decode(cacheJson);
        _durationCache = decoded.map((key, value) => 
          MapEntry(key, Duration(milliseconds: value as int))
        );
        debugPrint('Loaded ${_durationCache.length} cached durations');
      } catch (e) {
        debugPrint('Error loading duration cache: $e');
      }
    }
  }

  Future<void> _saveDurationCache() async {
    if (_prefs == null) return;
    
    try {
      final cacheJson = json.encode(
        _durationCache.map((key, value) => 
          MapEntry(key, value.inMilliseconds)
        )
      );
      await _prefs!.setString('music_duration_cache', cacheJson);
      debugPrint('Saved ${_durationCache.length} durations to cache');
    } catch (e) {
      debugPrint('Error saving duration cache: $e');
    }
  }

  Duration? _getCachedDuration(String trackId) {
    return _durationCache[trackId];
  }

  Future<void> _cacheDuration(String trackId, Duration duration) async {
    _durationCache[trackId] = duration;
    await _saveDurationCache();
  }

  Future<void> _loadTrackDuration(MusicTrack track) async {
    if (_durationCache.containsKey(track.id) || _loadingDurations.contains(track.id)) {
      return;
    }

    _loadingDurations.add(track.id);

    try {
      final tempPlayer = AudioPlayer();
      
      if (track.isNetworkSource) {
        await tempPlayer.setSourceUrl(track.audioPath);
      } else {
        await tempPlayer.setSource(AssetSource(track.audioPath));
      }

      Duration? duration;
      int attempts = 0;
      while (duration == null && attempts < 10) {
        duration = await tempPlayer.getDuration();
        if (duration == null) {
          await Future.delayed(const Duration(milliseconds: 200));
        }
        attempts++;
      }

      if (duration != null && duration.inMilliseconds > 0) {
        await _cacheDuration(track.id, duration);
        if (mounted) {
          setState(() {
            final index = _allTracks.indexWhere((t) => t.id == track.id);
            if (index != -1) {
              _allTracks[index] = track.copyWith(duration: duration);
            }
          });
        }
        debugPrint('Cached duration for ${track.title}: ${_formatDuration(duration)}');
      }

      await tempPlayer.dispose();
    } catch (e) {
      debugPrint('Error loading duration for ${track.title}: $e');
    } finally {
      _loadingDurations.remove(track.id);
    }
  }

  void _setupScrollController() {
    _scrollController.addListener(() {
      final currentOffset = _scrollController.offset;
      final isScrollingDown = currentOffset > _lastScrollOffset;
      final shouldHideHeader = isScrollingDown && currentOffset > 100;
      final shouldShowHeader = !isScrollingDown || currentOffset <= 50;

      if (_isHeaderVisible && shouldHideHeader && !_isSearchFocused) {
        setState(() {
          _isHeaderVisible = false;
        });
      } else if (!_isHeaderVisible && shouldShowHeader) {
        setState(() {
          _isHeaderVisible = true;
        });
      }

      _lastScrollOffset = currentOffset;
    });
  }

  void _setupAudioPlayer() {
    _audioPlayer.onPositionChanged.listen((position) {
      if (mounted) {
        setState(() {
          _currentPosition = position;
        });
      }
    });

    _audioPlayer.onDurationChanged.listen((duration) {
      if (mounted) {
        setState(() {
          _totalDuration = duration;
        });
      }
      
      if (_currentTrack != null && duration.inMilliseconds > 0) {
        _cacheDuration(_currentTrack!.id, duration);
      }
    });

    _audioPlayer.onPlayerStateChanged.listen((state) {
      if (mounted) {
        setState(() {
          _isPlaying = state == PlayerState.playing;
          _isLoadingAudio = state == PlayerState.playing && _currentPosition == Duration.zero;
        });
      }
    });

    _audioPlayer.onPlayerComplete.listen((_) {
      if (mounted) {
        setState(() {
          _isPlaying = false;
          _currentPosition = Duration.zero;
        });
      }
    });
  }

  Future<void> _fetchMusicTracks() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching Kagan music tracks from: $_baseUrl');
      
      const String apiUrl = '$_baseUrl?tribe=kagan';
      debugPrint('API URL: $apiUrl');

      final response = await http.get(
        Uri.parse(apiUrl),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      ).timeout(const Duration(seconds: 15));
      
      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');
      
      if (response.statusCode != 200) {
        throw Exception('API returned status code: ${response.statusCode}');
      }

      final Map<String, dynamic> jsonData = json.decode(response.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      if (!jsonData.containsKey('data')) {
        throw Exception('API response missing "data" field');
      }

      final dynamic rawData = jsonData['data'];
      List<dynamic> contentItems = [];
      
      if (rawData is List) {
        contentItems = rawData;
      } else if (rawData is Map) {
        contentItems = [rawData];
      } else {
        throw Exception('Unexpected data format in API response');
      }

      debugPrint('Found ${contentItems.length} content items');

      final List<MusicTrack> musicTracks = [];

      for (var item in contentItems) {
        if (item == null || item is! Map<String, dynamic>) {
          debugPrint('Skipping invalid item: $item');
          continue;
        }
        
        debugPrint('Processing item: ${item.toString()}');
        
        final dynamic id = item['id'];
        final dynamic userId = item['user_id'];
        final String? title = item['title']?.toString();
        final String? category = item['category']?.toString();
        final String? tribe = item['tribe']?.toString();
        final String? description = item['description']?.toString();
        final String? file = item['file']?.toString();
        final dynamic isArchived = item['is_archived'];
        final String? time = item['time']?.toString();
        
        if (id == null || 
            userId == null || 
            title == null || title.isEmpty ||
            category == null || category.isEmpty ||
            tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty ||
            isArchived == null ||
            time == null || time.isEmpty) {
          debugPrint('Skipping item with missing required fields');
          continue;
        }
        
        if (tribe.toLowerCase() != 'kagan') {
          debugPrint('Skipping non-Kagan item: $tribe');
          continue;
        }

        if (isArchived != 0) {
          debugPrint('Skipping archived item: $title');
          continue;
        }

        final fileType = _determineFileType(file);
        
        if (!_isAudioContent(file, category)) {
          debugPrint('Skipping non-audio content: $file (category: $category, type: $fileType)');
          continue;
        }

        final cachedDuration = _getCachedDuration(id.toString());

        final musicTrack = MusicTrack(
          id: id.toString(),
          title: title,
          description: description ?? 'No description available',
          category: _mapCategory(category),
          imagePath: _buildThumbnailUrl(file, category),
          artist: _extractArtist(description, title),
          audioPath: '$_uploadsBaseUrl$file',
          file: file,
          fileType: fileType,
          isNetworkSource: true,
          duration: cachedDuration,
        );
        
        debugPrint(' Added music track: $title (ID: $id, Category: $category, Cached Duration: ${cachedDuration != null ? _formatDuration(cachedDuration) : 'Not cached'})');
        musicTracks.add(musicTrack);

        if (cachedDuration == null) {
          _loadTrackDuration(musicTrack);
        }
      }

      debugPrint('Final music track count: ${musicTracks.length}');

      setState(() {
        _allTracks = musicTracks;
        _featuredTrack = musicTracks.isNotEmpty ? musicTracks.first : null;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching music tracks: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load music tracks: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  bool _isAudioContent(String filename, String category) {
    final String lowerFilename = filename.toLowerCase();
    final String lowerCategory = category.toLowerCase();
    
    const audioExtensions = ['.mp3', '.wav', '.aac', '.ogg', '.m4a', '.flac'];
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv'];
    
    final hasAudioExtension = audioExtensions.any((ext) => lowerFilename.endsWith(ext));
    final hasVideoExtension = videoExtensions.any((ext) => lowerFilename.endsWith(ext));
    
    const musicCategories = ['audio', 'music', 'song', 'instrument', 'ceremony'];
    final isMusicCategory = musicCategories.any((cat) => lowerCategory.contains(cat));
    
    return hasAudioExtension || (hasVideoExtension && isMusicCategory);
  }

  String _buildThumbnailUrl(String filename, String category) {
    if (_isAudioContent(filename, category)) {
      return 'assets/images/kagan_default_music.jpg';
    }
    
    final String lowerFilename = filename.toLowerCase();
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    
    if (imageExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return '$_uploadsBaseUrl$filename';
    }
    
    return 'assets/images/kagan_default_music.jpg';
  }

  FileType _determineFileType(String filename) {
    final String lowerFilename = filename.toLowerCase();
    
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv', '.flv', '.wmv'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const audioExtensions = ['.mp3', '.wav', '.aac', '.ogg', '.m4a', '.flac'];
    
    if (audioExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.audio;
    } else if (videoExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.video;
    } else if (imageExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.image;
    }
    
    return FileType.unknown;
  }

  String _mapCategory(String category) {
    switch (category.toLowerCase()) {
      case 'audio':
        return 'Traditional Music';
      case 'instrument':
        return 'Instrumental';
      case 'ceremony':
        return 'Ceremonial';
      case 'video':
        return 'Audio/Video';
      case 'music':
        return 'Music';
      case 'song':
        return 'Song';
      default:
        return category;
    }
  }

  String _extractArtist(String? description, String title) {
    if (description != null && description.isNotEmpty) {
      final RegExp artistPattern = RegExp(r'(?:by|artist|performed by|sung by)\s+([^,\.\-\n]+)', caseSensitive: false);
      final match = artistPattern.firstMatch(description);
      if (match != null && match.group(1) != null) {
        return match.group(1)!.trim();
      }
      
      if (description.length < 50 && 
          !description.toLowerCase().contains(RegExp(r'\b(the|a|an|and|or|but|in|on|at|to|for|of|with|by)\b'))) {
        return description.trim();
      }
    }
    
    final lowerTitle = title.toLowerCase();
    if (lowerTitle.contains(RegExp(r'\b(elder|traditional|ancestral|ancient)\b'))) {
      return 'Kagan Elders';
    } else if (lowerTitle.contains(RegExp(r'\b(ritual|ceremony|ceremonial|sacred)\b'))) {
      return 'Tribal Ensemble';
    } else if (lowerTitle.contains(RegExp(r'\b(instrument|instrumental|music)\b'))) {
      return 'Kagan Musicians';
    }
    
    return 'Kagan Artist';
  }

  Future<void> _refreshMusicTracks() async {
    await _fetchMusicTracks();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              AnimatedContainer(
                duration: const Duration(milliseconds: 300),
                height: (_isHeaderVisible || _isSearchFocused) ? 80 : 0,
                child: (_isHeaderVisible || _isSearchFocused) ? _buildHeader(context) : const SizedBox.shrink(),
              ),
              
              Expanded(
                child: _isSearchFocused 
                    ? _buildSearchResults()
                    : _buildMainContent(),
              ),
              
              if (_currentTrack != null) _buildInlineMusicPlayer(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeader(BuildContext context) {
    final padding = _getContentPadding(context);
    final width = MediaQuery.of(context).size.width;

    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: padding.horizontal / 2,
        vertical: 16,
      ),
      child: Row(
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused && width < 600 ? 0 : 48,
            child: _isSearchFocused && width < 600
                ? const SizedBox.shrink()
                : Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: const Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ),
          ),
          
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused && width < 600 ? 0 : 16,
          ),
          
          Expanded(
            child: Container(
              height: 48,
              constraints: const BoxConstraints(maxWidth: 600),
              decoration: BoxDecoration(
                color: const Color(0xFF2A2A2A),
                borderRadius: BorderRadius.circular(24),
                border: Border.all(
                  color: _isSearchFocused 
                      ? const Color(0xFFD4A574) 
                      : const Color(0xFFD4A574).withOpacity(0.3),
                  width: _isSearchFocused ? 2 : 1,
                ),
              ),
              child: TextField(
                controller: _searchController,
                focusNode: _searchFocusNode,
                style: const TextStyle(color: Colors.white),
                scrollPhysics: const BouncingScrollPhysics(),
                decoration: InputDecoration(
                  hintText: 'Search music tracks...',
                  hintStyle: TextStyle(
                    color: Colors.white.withOpacity(0.6),
                    fontSize: 14,
                  ),
                  prefixIcon: Icon(
                    Icons.search,
                    color: _isSearchFocused 
                        ? const Color(0xFFD4A574)
                        : Colors.white.withOpacity(0.6),
                  ),
                  suffixIcon: _searchQuery.isNotEmpty
                      ? IconButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {
                              _searchQuery = '';
                            });
                          },
                          icon: Icon(
                            Icons.clear,
                            color: Colors.white.withOpacity(0.6),
                          ),
                        )
                      : null,
                  border: InputBorder.none,
                  contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                ),
                onChanged: (value) {
                  setState(() {
                    _searchQuery = value;
                  });
                },
              ),
            ),
          ),
          
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 80 : 0,
            child: _isSearchFocused
                ? TextButton(
                    onPressed: () {
                      _searchController.clear();
                      _searchFocusNode.unfocus();
                      setState(() {
                        _searchQuery = '';
                        _isHeaderVisible = true;
                      });
                    },
                    child: const Text(
                      'Cancel',
                      style: TextStyle(
                        color: Color(0xFFD4A574),
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  )
                : const SizedBox.shrink(),
          ),
        ],
      ),
    );
  }

  Widget _buildMainContent() {
    if (_isLoading) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
            ),
            const SizedBox(height: 16),
            Text(
              'Loading Kagan music tracks...',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: 14,
              ),
            ),
          ],
        ),
      );
    }

    if (_errorMessage != null) {
      final padding = _getContentPadding(context);
      return Center(
        child: Padding(
          padding: padding,
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Colors.white.withOpacity(0.5),
              ),
              const SizedBox(height: 16),
              Text(
                'Failed to load music tracks',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.7),
                  fontSize: 18,
                  fontWeight: FontWeight.w500,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                _errorMessage!,
                style: TextStyle(
                  color: Colors.white.withOpacity(0.5),
                  fontSize: 14,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: _refreshMusicTracks,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFFD4A574),
                  foregroundColor: Colors.white,
                ),
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      );
    }

    if (_allTracks.isEmpty) {
      final padding = _getContentPadding(context);
      return Center(
        child: Padding(
          padding: padding,
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                Icons.music_note_outlined,
                size: 64,
                color: Colors.white.withOpacity(0.5),
              ),
              const SizedBox(height: 16),
              Text(
                'No Kagan music tracks available',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.7),
                  fontSize: 18,
                  fontWeight: FontWeight.w500,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                'Check back later for new music content',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.5),
                  fontSize: 14,
                ),
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: _refreshMusicTracks,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFFD4A574),
                  foregroundColor: Colors.white,
                ),
                child: const Text('Refresh'),
              ),
            ],
          ),
        ),
      );
    }

    return RefreshIndicator(
      onRefresh: _refreshMusicTracks,
      color: const Color(0xFFD4A574),
      child: CustomScrollView(
        controller: _scrollController,
        physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
        slivers: [
          SliverToBoxAdapter(
            child: _buildHeroSection(),
          ),
          SliverList(
            delegate: SliverChildBuilderDelegate(
              (context, index) {
                final track = _filteredTracks[index];
                return _buildMusicCard(track);
              },
              childCount: _filteredTracks.length,
            ),
          ),
          SliverToBoxAdapter(
            child: SizedBox(height: _currentTrack != null ? _getPlayerHeight(context) + 20 : 20),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchResults() {
    final padding = _getContentPadding(context);
    
    return Column(
      children: [
        if (_searchQuery.isNotEmpty)
          Padding(
            padding: EdgeInsets.symmetric(
              horizontal: padding.horizontal / 2,
              vertical: 8,
            ),
            child: Row(
              children: [
                Text(
                  '${_filteredTracks.length} result${_filteredTracks.length == 1 ? '' : 's'} for "$_searchQuery"',
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.7),
                    fontSize: 14,
                  ),
                ),
              ],
            ),
          ),
        
        Expanded(
          child: _searchQuery.isEmpty
              ? Center(
                  child: Text(
                    'Start typing to search...',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.5),
                      fontSize: 16,
                    ),
                  ),
                )
              : _filteredTracks.isEmpty
                  ? Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            Icons.search_off,
                            size: 48,
                            color: Colors.white.withOpacity(0.3),
                          ),
                          const SizedBox(height: 16),
                          Text(
                            'No tracks found',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.5),
                              fontSize: 18,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Text(
                            'Try different keywords',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.3),
                              fontSize: 14,
                            ),
                          ),
                        ],
                      ),
                    )
                  : ListView.builder(
                      physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
                      padding: EdgeInsets.only(
                        bottom: MediaQuery.of(context).viewInsets.bottom + (_currentTrack != null ? _getPlayerHeight(context) + 20 : 20),
                      ),
                      itemCount: _filteredTracks.length,
                      itemBuilder: (context, index) {
                        final track = _filteredTracks[index];
                        return _buildMusicCard(track);
                      },
                    ),
        ),
      ],
    );
  }

  Widget _buildHeroSection() {
    final height = _getHeroHeight(context);
    final padding = _getContentPadding(context);
    final width = MediaQuery.of(context).size.width;

    return Container(
      margin: EdgeInsets.fromLTRB(
        padding.horizontal / 2,
        16,
        padding.horizontal / 2,
        16,
      ),
      height: height,
      constraints: const BoxConstraints(maxWidth: 1200),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.4),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: Stack(
          children: [
            Image.asset(
              'assets/images/kagan_mus.jpg',
              fit: BoxFit.cover,
              width: double.infinity,
              height: double.infinity,
              errorBuilder: (context, error, stackTrace) {
                return Container(
                  decoration: const BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color(0xFFD4A574),
                        Color(0xFFB8935F),
                        Color(0xFF8B7355),
                      ],
                    ),
                  ),
                );
              },
            ),
            
            Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  colors: [
                    Colors.black.withOpacity(0.1),
                    Colors.black.withOpacity(0.7),
                  ],
                ),
              ),
            ),
            
            Positioned(
              bottom: 0,
              left: 0,
              right: 0,
              child: Container(
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                    colors: [
                      Colors.transparent,
                      Colors.black.withOpacity(0.8),
                    ],
                  ),
                ),
                padding: EdgeInsets.all(width >= 600 ? 24 : 20),
                child: Container(
                  padding: EdgeInsets.all(width >= 600 ? 20 : 16),
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  child: Text(
                    'Discover the traditional musical heritage of the Kagan people. Each song carries deep cultural meaning and connects the community to their ancestors through rhythm and melody.',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.95),
                      fontSize: width >= 600 ? 16 : 14,
                      height: 1.4,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMusicCard(MusicTrack track) {
    final isCurrentTrack = _currentTrack?.id == track.id;
    final hasDuration = track.duration != null;
    final isLoadingDuration = _loadingDurations.contains(track.id);
    final width = MediaQuery.of(context).size.width;
    final padding = _getContentPadding(context);
    final cardHeight = _getCardHeight(context);
    
    // Responsive sizing
    final imageSize = width >= 800 ? 80.0 : width >= 600 ? 70.0 : 60.0;
    final titleFontSize = width >= 800 ? 17.0 : width >= 600 ? 16.0 : 16.0;
    final descriptionFontSize = width >= 800 ? 15.0 : width >= 600 ? 14.0 : 14.0;
    final categoryFontSize = width >= 800 ? 13.0 : 12.0;
    final buttonSize = width >= 800 ? 48.0 : width >= 600 ? 44.0 : 40.0;
    final iconSize = width >= 800 ? 28.0 : width >= 600 ? 26.0 : 24.0;
    
    return Container(
      margin: EdgeInsets.symmetric(
        horizontal: padding.horizontal / 2,
        vertical: 6,
      ),
      constraints: const BoxConstraints(maxWidth: 1000),
      decoration: BoxDecoration(
        color: isCurrentTrack 
            ? const Color(0xFFD4A574).withOpacity(0.1)
            : const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: isCurrentTrack 
              ? const Color(0xFFD4A574)
              : const Color(0xFFD4A574).withOpacity(0.2),
          width: isCurrentTrack ? 2 : 1,
        ),
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          borderRadius: BorderRadius.circular(12),
          onTap: () {
            HapticFeedback.mediumImpact();
            _togglePlayPause(track);
          },
          child: Padding(
            padding: EdgeInsets.all(width >= 600 ? 14 : 12),
            child: Row(
              children: [
                Container(
                  width: imageSize,
                  height: imageSize,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(8),
                    color: const Color(0xFFD4A574).withOpacity(0.2),
                  ),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(8),
                    child: track.imagePath.startsWith('http')
                        ? Image.network(
                            track.imagePath,
                            fit: BoxFit.cover,
                            errorBuilder: (context, error, stackTrace) {
                              return Icon(
                                Icons.music_note,
                                color: const Color(0xFFD4A574),
                                size: imageSize * 0.5,
                              );
                            },
                            loadingBuilder: (context, child, loadingProgress) {
                              if (loadingProgress == null) return child;
                              return const Center(
                                child: CircularProgressIndicator(
                                  valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
                                  strokeWidth: 2,
                                ),
                              );
                            },
                          )
                        : Image.asset(
                            track.imagePath,
                            fit: BoxFit.cover,
                            errorBuilder: (context, error, stackTrace) {
                              return Icon(
                                Icons.music_note,
                                color: const Color(0xFFD4A574),
                                size: imageSize * 0.5,
                              );
                            },
                          ),
                  ),
                ),
                
                SizedBox(width: width >= 600 ? 18 : 16),
                
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        track.title,
                        style: TextStyle(
                          color: isCurrentTrack 
                              ? const Color(0xFFD4A574)
                              : Colors.white,
                          fontSize: titleFontSize,
                          fontWeight: FontWeight.bold,
                          height: 1.3,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                      const SizedBox(height: 4),
                      Text(
                        track.description,
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: descriptionFontSize,
                          height: 1.3,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                      const SizedBox(height: 6),
                      Wrap(
                        spacing: 8,
                        runSpacing: 4,
                        crossAxisAlignment: WrapCrossAlignment.center,
                        children: [
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                            decoration: BoxDecoration(
                              color: const Color(0xFFD4A574).withOpacity(0.2),
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Text(
                              track.category,
                              style: TextStyle(
                                color: const Color(0xFFD4A574),
                                fontSize: categoryFontSize,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ),
                          if (width >= 600)
                            Flexible(
                              child: Text(
                                ' ${track.artist}',
                                style: TextStyle(
                                  color: Colors.white.withOpacity(0.5),
                                  fontSize: categoryFontSize,
                                ),
                                overflow: TextOverflow.ellipsis,
                              ),
                            ),
                          if (hasDuration)
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                              decoration: BoxDecoration(
                                color: Colors.black.withOpacity(0.3),
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Icon(
                                    Icons.access_time,
                                    size: 10,
                                    color: Colors.white.withOpacity(0.6),
                                  ),
                                  const SizedBox(width: 4),
                                  Text(
                                    _formatDuration(track.duration!),
                                    style: TextStyle(
                                      color: Colors.white.withOpacity(0.6),
                                      fontSize: 11,
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                ],
                              ),
                            )
                          else if (isLoadingDuration)
                            const SizedBox(
                              width: 12,
                              height: 12,
                              child: CircularProgressIndicator(
                                strokeWidth: 1.5,
                                valueColor: AlwaysStoppedAnimation<Color>(
                                  Colors.white54,
                                ),
                              ),
                            ),
                        ],
                      ),
                    ],
                  ),
                ),
                
                SizedBox(width: width >= 600 ? 12 : 8),
                
                GestureDetector(
                  onTap: () {
                    HapticFeedback.mediumImpact();
                    _togglePlayPause(track);
                  },
                  child: Container(
                    width: buttonSize,
                    height: buttonSize,
                    decoration: BoxDecoration(
                      color: const Color(0xFFD4A574),
                      borderRadius: BorderRadius.circular(buttonSize / 2),
                    ),
                    child: Center(
                      child: _isLoadingAudio && isCurrentTrack
                          ? SizedBox(
                              width: iconSize * 0.75,
                              height: iconSize * 0.75,
                              child: const CircularProgressIndicator(
                                strokeWidth: 2,
                                valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                              ),
                            )
                          : Icon(
                              isCurrentTrack && _isPlaying 
                                  ? Icons.pause
                                  : Icons.play_arrow,
                              color: Colors.white,
                              size: iconSize,
                            ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildInlineMusicPlayer() {
    final width = MediaQuery.of(context).size.width;
    final playerHeight = _getPlayerHeight(context);
    final isTablet = width >= 600;
    final isDesktop = width >= 800;
    
    final imageSize = isDesktop ? 60.0 : isTablet ? 55.0 : 50.0;
    final titleFontSize = isDesktop ? 16.0 : isTablet ? 15.0 : 14.0;
    final artistFontSize = isDesktop ? 14.0 : isTablet ? 13.0 : 12.0;
    final iconSize = isDesktop ? 22.0 : isTablet ? 21.0 : 20.0;
    final playButtonSize = isDesktop ? 44.0 : isTablet ? 42.0 : 40.0;
    
    return Container(
      padding: EdgeInsets.all(isDesktop ? 20 : isTablet ? 18 : 16),
      decoration: const BoxDecoration(
        color: Color(0xFF1F1F1F),
        border: Border(
          top: BorderSide(
            color: Color(0xFFD4A574),
            width: 2,
          ),
        ),
      ),
      child: ConstrainedBox(
        constraints: const BoxConstraints(maxWidth: 1200),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Row(
              children: [
                Container(
                  width: imageSize,
                  height: imageSize,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(8),
                    color: const Color(0xFFD4A574).withOpacity(0.2),
                  ),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(8),
                    child: _currentTrack!.imagePath.startsWith('http')
                        ? Image.network(
                            _currentTrack!.imagePath,
                            fit: BoxFit.cover,
                            errorBuilder: (context, error, stackTrace) {
                              return Icon(
                                Icons.music_note,
                                color: const Color(0xFFD4A574),
                                size: imageSize * 0.5,
                              );
                            },
                          )
                        : Image.asset(
                            _currentTrack!.imagePath,
                            fit: BoxFit.cover,
                            errorBuilder: (context, error, stackTrace) {
                              return Icon(
                                Icons.music_note,
                                color: const Color(0xFFD4A574),
                                size: imageSize * 0.5,
                              );
                            },
                          ),
                  ),
                ),
                
                SizedBox(width: isDesktop ? 16 : 12),
                
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        _currentTrack!.title,
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: titleFontSize,
                          fontWeight: FontWeight.bold,
                          height: 1.3,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                      const SizedBox(height: 2),
                      Text(
                        _currentTrack!.artist,
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: artistFontSize,
                          height: 1.2,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ),
                ),
                
                if (isTablet) ...[
                  IconButton(
                    onPressed: () {
                      _seekTo(Duration(seconds: (_currentPosition.inSeconds - 10).clamp(0, _totalDuration.inSeconds)));
                    },
                    icon: Icon(Icons.replay_10, color: Colors.white, size: iconSize),
                  ),
                ],
                
                IconButton(
                  onPressed: () => _togglePlayPause(_currentTrack!),
                  icon: Container(
                    width: playButtonSize,
                    height: playButtonSize,
                    padding: const EdgeInsets.all(8),
                    decoration: const BoxDecoration(
                      color: Color(0xFFD4A574),
                      shape: BoxShape.circle,
                    ),
                    child: Icon(
                      _isPlaying ? Icons.pause : Icons.play_arrow,
                      color: Colors.white,
                      size: iconSize,
                    ),
                  ),
                ),
                
                if (isTablet) ...[
                  IconButton(
                    onPressed: () {
                      _seekTo(Duration(seconds: (_currentPosition.inSeconds + 30).clamp(0, _totalDuration.inSeconds)));
                    },
                    icon: Icon(Icons.forward_30, color: Colors.white, size: iconSize),
                  ),
                ],
                
                IconButton(
                  onPressed: () {
                    HapticFeedback.lightImpact();
                    _closeMusicPlayer();
                  },
                  icon: Container(
                    padding: const EdgeInsets.all(4),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.1),
                      shape: BoxShape.circle,
                    ),
                    child: Icon(
                      Icons.close,
                      color: Colors.white,
                      size: isDesktop ? 18 : 16,
                    ),
                  ),
                ),
              ],
            ),
            
            SizedBox(height: isDesktop ? 12 : 8),
            
            Column(
              children: [
                SliderTheme(
                  data: SliderTheme.of(context).copyWith(
                    activeTrackColor: const Color(0xFFD4A574),
                    inactiveTrackColor: const Color(0xFFD4A574).withOpacity(0.3),
                    thumbColor: const Color(0xFFD4A574),
                    overlayColor: const Color(0xFFD4A574).withOpacity(0.3),
                    trackHeight: isDesktop ? 5 : 4,
                    thumbShape: RoundSliderThumbShape(
                      enabledThumbRadius: isDesktop ? 7 : 6,
                    ),
                  ),
                  child: Slider(
                    value: _totalDuration.inMilliseconds > 0 
                        ? _currentPosition.inMilliseconds / _totalDuration.inMilliseconds
                        : 0.0,
                    onChanged: (value) {
                      final position = Duration(
                        milliseconds: (value * _totalDuration.inMilliseconds).round(),
                      );
                      _seekTo(position);
                    },
                  ),
                ),
                
                Padding(
                  padding: EdgeInsets.symmetric(horizontal: isDesktop ? 18 : 16),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        _formatDuration(_currentPosition),
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: isDesktop ? 13 : 12,
                        ),
                      ),
                      Text(
                        _formatDuration(_totalDuration),
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: isDesktop ? 13 : 12,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Future<void> _togglePlayPause(MusicTrack track) async {
    try {
      if (_currentTrack?.id != track.id) {
        setState(() {
          _currentTrack = track;
          _isLoadingAudio = true;
        });
        
        await _audioPlayer.stop();
        
        if (track.isNetworkSource) {
          await _audioPlayer.play(UrlSource(track.audioPath));
        } else {
          await _audioPlayer.play(AssetSource(track.audioPath));
        }
      } else {
        if (_isPlaying) {
          await _audioPlayer.pause();
        } else {
          await _audioPlayer.resume();
        }
      }
    } catch (e) {
      debugPrint('Error playing audio: $e');
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Unable to play audio: ${track.title}'),
            backgroundColor: Colors.red,
            action: SnackBarAction(
              label: 'Retry',
              textColor: Colors.white,
              onPressed: () => _togglePlayPause(track),
            ),
          ),
        );
      }
      
      setState(() {
        _isLoadingAudio = false;
      });
    }
  }

  Future<void> _seekTo(Duration position) async {
    await _audioPlayer.seek(position);
  }

  String _formatDuration(Duration duration) {
    String twoDigits(int n) => n.toString().padLeft(2, '0');
    String twoDigitMinutes = twoDigits(duration.inMinutes.remainder(60));
    String twoDigitSeconds = twoDigits(duration.inSeconds.remainder(60));
    
    if (duration.inHours > 0) {
      return "${twoDigits(duration.inHours)}:$twoDigitMinutes:$twoDigitSeconds";
    } else {
      return "$twoDigitMinutes:$twoDigitSeconds";
    }
  }

  void _closeMusicPlayer() async {
    await _audioPlayer.stop();
    setState(() {
      _currentTrack = null;
      _isPlaying = false;
      _currentPosition = Duration.zero;
      _totalDuration = Duration.zero;
      _isLoadingAudio = false;
    });
  }

  @override
  void dispose() {
    _searchController.dispose();
    _searchFocusNode.dispose();
    _scrollController.dispose();
    _audioPlayer.dispose();
    super.dispose();
  }
}

enum FileType {
  video,
  audio,
  image,
  unknown,
}

class MusicTrack {
  final String id;
  final String title;
  final String description;
  final String category;
  final String imagePath;
  final String artist;
  final String audioPath;
  final String file;
  final FileType fileType;
  final bool isNetworkSource;
  final Duration? duration;

  MusicTrack({
    required this.id,
    required this.title,
    required this.description,
    required this.category,
    required this.imagePath,
    required this.artist,
    required this.audioPath,
    required this.file,
    required this.fileType,
    this.isNetworkSource = false,
    this.duration,
  });

  MusicTrack copyWith({
    String? id,
    String? title,
    String? description,
    String? category,
    String? imagePath,
    String? artist,
    String? audioPath,
    String? file,
    FileType? fileType,
    bool? isNetworkSource,
    Duration? duration,
  }) {
    return MusicTrack(
      id: id ?? this.id,
      title: title ?? this.title,
      description: description ?? this.description,
      category: category ?? this.category,
      imagePath: imagePath ?? this.imagePath,
      artist: artist ?? this.artist,
      audioPath: audioPath ?? this.audioPath,
      file: file ?? this.file,
      fileType: fileType ?? this.fileType,
      isNetworkSource: isNetworkSource ?? this.isNetworkSource,
      duration: duration ?? this.duration,
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\kagan_category_screens\kagan_video_screen.dart
======================================

// lib/screen/kagan_category_screens/kagan_video_screen.dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:io';
import 'package:video_player/video_player.dart';
import 'package:video_thumbnail/video_thumbnail.dart';
import 'package:path_provider/path_provider.dart';
import 'package:visibility_detector/visibility_detector.dart';
import '../shared/video_player_screen.dart';
import '../../utils/video_metadata_cache.dart';

class KaganVideoScreen extends StatefulWidget {
  const KaganVideoScreen({super.key});

  @override
  State<KaganVideoScreen> createState() => _KaganVideoScreenState();
}

class _KaganVideoScreenState extends State<KaganVideoScreen> {
  String _searchQuery = '';
  final TextEditingController _searchController = TextEditingController();
  final FocusNode _searchFocusNode = FocusNode();
  bool _isSearchFocused = false;
  
  final ScrollController _scrollController = ScrollController();
  bool _isHeaderVisible = true;
  double _lastScrollOffset = 0;

  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<VideoItem> _allVideos = [];
  bool _isLoading = true;
  String? _errorMessage;
  VideoItem? _featuredVideo;
  
  final Set<String> _loadingMetadata = {};

  List<VideoItem> get _filteredVideos {
    if (_searchQuery.isEmpty) {
      return _allVideos;
    }
    
    return _allVideos.where((video) =>
        video.title.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        video.description.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        video.category.toLowerCase().contains(_searchQuery.toLowerCase())).toList();
  }

  // Enhanced responsive helper methods
  int _getCrossAxisCount(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 4;
    if (width > 900) return 3;
    if (width > 600) return 2;
    return 2;
  }

  // FIXED: More flexible childAspectRatio that accounts for content
  double _getChildAspectRatio(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    final crossAxisCount = _getCrossAxisCount(context);
    
    // Calculate available width per item
    final horizontalPadding = _getHorizontalPadding(context);
    final spacing = _getGridSpacing(context);
    final availableWidth = width - (horizontalPadding * 2) - (spacing * (crossAxisCount - 1));
    final itemWidth = availableWidth / crossAxisCount;
    
    // Dynamic height based on item width - more generous for smaller screens
    final itemHeight = itemWidth * 1.4; // Increased from 1.35 to 1.4 for more vertical room
    
    return itemWidth / itemHeight;
  }

  // FIXED: Responsive padding that scales more conservatively
  double _getHorizontalPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return width * 0.025; // 2.5% of width
    if (width > 800) return width * 0.02; // 2% of width
    return width * 0.04; // 4% of width (reduced from fixed 16)
  }

  // NEW: Responsive grid spacing
  double _getGridSpacing(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 16;
    if (width > 800) return 12;
    return 10; // Reduced from 16 to save space on small screens
  }

  // FIXED: More conservative featured video height
  double _getFeaturedVideoHeight(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final width = size.width;
    final height = size.height;
    final isLandscape = width > height;
    
    // Use percentage of screen height for better scaling
    if (width > 1200) return height * 0.35;
    if (width > 800) return height * 0.3;
    if (isLandscape) return height * 0.35;
    return height * 0.25; // Reduced from fixed 200
  }

  double _getFontSize(BuildContext context, double baseSize) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return baseSize * 1.15;
    if (width > 800) return baseSize * 1.08;
    if (width < 360) return baseSize * 0.95; // Scale down on very small screens
    return baseSize;
  }

  // NEW: Responsive header height
  double _getHeaderHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 800) return 80;
    if (width < 360) return 65;
    return 72;
  }

  // NEW: Responsive vertical spacing
  double _getVerticalSpacing(BuildContext context, double baseSpacing) {
    final height = MediaQuery.of(context).size.height;
    if (height < 700) return baseSpacing * 0.75; // Reduce on short screens
    return baseSpacing;
  }

  @override
  void initState() {
    super.initState();
    _setupScrollController();
    _searchFocusNode.addListener(() {
      setState(() {
        _isSearchFocused = _searchFocusNode.hasFocus;
      });
    });
    _fetchVideos();
  }

  void _setupScrollController() {
    _scrollController.addListener(() {
      final currentOffset = _scrollController.offset;
      final isScrollingDown = currentOffset > _lastScrollOffset;
      final shouldHideHeader = isScrollingDown && currentOffset > 100;
      final shouldShowHeader = !isScrollingDown || currentOffset <= 50;

      if (_isHeaderVisible && shouldHideHeader && !_isSearchFocused) {
        setState(() {
          _isHeaderVisible = false;
        });
      } else if (!_isHeaderVisible && shouldShowHeader) {
        setState(() {
          _isHeaderVisible = true;
        });
      }

      _lastScrollOffset = currentOffset;
    });
  }

  Future<void> _fetchVideos() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching videos from: $_baseUrl');

      List<String> urls = [
        '${_baseUrl}category=video&tribe=kagan',
        '$_baseUrl?category=video&tribe=kagan',
        '$_baseUrl?tribe=kagan',
        _baseUrl,
      ];

      http.Response? successResponse;
      
      for (String url in urls) {
        try {
          debugPrint('Trying URL: $url');
          final response = await http.get(
            Uri.parse(url),
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
            },
          ).timeout(const Duration(seconds: 15));
          
          if (response.statusCode == 200) {
            successResponse = response;
            break;
          }
        } catch (e) {
          debugPrint('Error with URL $url: $e');
          continue;
        }
      }

      if (successResponse == null) {
        throw Exception('All API endpoints failed to respond');
      }

      final Map<String, dynamic> jsonData = json.decode(successResponse.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      dynamic videoDataRaw = jsonData['data'];
      List<dynamic> videoData = [];
      
      if (videoDataRaw is List) {
        videoData = videoDataRaw;
      } else if (videoDataRaw != null) {
        videoData = [videoDataRaw];
      }

      final List<VideoItem> fetchedVideos = [];

      for (var item in videoData) {
        if (item == null) continue;
        
        final id = item['id'];
        final userId = item['user_id'];
        final title = item['title']?.toString();
        final category = item['category']?.toString();
        final tribe = item['tribe']?.toString();
        final description = item['description']?.toString();
        final file = item['file']?.toString();
        final isArchived = item['is_archived'];
        final time = item['time']?.toString();
        
        if (id == null || userId == null || title == null || title.isEmpty ||
            category == null || category.isEmpty || tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty || isArchived == null || time == null) {
          continue;
        }
        
        if (tribe.toLowerCase() != 'kagan') {
          continue;
        }

        if (isArchived != 0) {
          continue;
        }

        final fileType = _determineFileType(file);
        final videoUrl = '$_uploadsBaseUrl$file';
        
        final cachedDuration = await VideoMetadataCache.getDuration(id.toString());
        final cachedThumbnail = await VideoMetadataCache.getThumbnail(id.toString());

        final videoItem = VideoItem(
          id: id.toString(),
          title: title,
          thumbnail: cachedThumbnail ?? _buildThumbnailUrl(file),
          duration: cachedDuration ?? '--:--',
          description: description ?? 'No description available',
          category: _mapCategory(category),
          file: file,
          fileType: fileType,
          videoUrl: videoUrl,
        );
        
        debugPrint(' Valid item added: $title (Cached: duration=${cachedDuration != null}, thumbnail=${cachedThumbnail != null})');
        fetchedVideos.add(videoItem);
      }

      setState(() {
        _allVideos = fetchedVideos;
        _featuredVideo = fetchedVideos.isNotEmpty ? fetchedVideos.first : null;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching videos: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load videos: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  Future<void> _loadVideoMetadata(VideoItem video) async {
    if (video.fileType != FileType.video || 
        video.duration != '--:--' || 
        _loadingMetadata.contains(video.id)) {
      return;
    }
    
    _loadingMetadata.add(video.id);
    
    VideoPlayerController? tempController;
    try {
      debugPrint(' Loading metadata for: ${video.title}');
      
      tempController = VideoPlayerController.networkUrl(
        Uri.parse(video.videoUrl),
        videoPlayerOptions: VideoPlayerOptions(mixWithOthers: true),
      );
      
      await tempController.initialize().timeout(
        const Duration(seconds: 15),
        onTimeout: () {
          throw Exception('Timeout loading video metadata');
        },
      );
      
      if (tempController.value.duration.inSeconds > 0) {
        final minutes = tempController.value.duration.inMinutes;
        final seconds = tempController.value.duration.inSeconds % 60;
        final duration = '${minutes.toString().padLeft(2, '0')}:${seconds.toString().padLeft(2, '0')}';
        
        await VideoMetadataCache.saveDuration(video.id, duration);
        
        if (mounted) {
          setState(() {
            video.duration = duration;
          });
        }
        debugPrint(' Duration loaded and cached for ${video.title}: $duration');
      }
      
      try {
        final thumbnailDir = await getApplicationDocumentsDirectory();
        final thumbnailPath = await VideoThumbnail.thumbnailFile(
          video: video.videoUrl,
          thumbnailPath: '${thumbnailDir.path}/thumbnails',
          imageFormat: ImageFormat.JPEG,
          maxWidth: 320,
          quality: 75,
          timeMs: 1000,
        );
        
        if (thumbnailPath != null && await File(thumbnailPath).exists()) {
          await VideoMetadataCache.saveThumbnail(video.id, thumbnailPath);
          
          if (mounted) {
            setState(() {
              video.thumbnail = thumbnailPath;
            });
          }
          debugPrint(' Thumbnail generated and cached for ${video.title}');
        }
      } catch (e) {
        debugPrint(' Error generating thumbnail for ${video.title}: $e');
      }
      
    } catch (e) {
      debugPrint(' Error loading metadata for ${video.title}: $e');
      if (mounted) {
        setState(() {
          video.duration = 'N/A';
        });
      }
    } finally {
      tempController?.dispose();
      _loadingMetadata.remove(video.id);
    }
  }

  String _buildThumbnailUrl(String? filename) {
    if (filename == null || filename.isEmpty) {
      return 'assets/videos/thumbnails/default_thumbnail.jpg';
    }
    
    final String lowerFilename = filename.toLowerCase();
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv', '.flv', '.wmv'];
    bool isVideoFile = videoExtensions.any((ext) => lowerFilename.endsWith(ext));
    
    if (isVideoFile) {
      return 'assets/videos/thumbnails/default_thumbnail.jpg';
    }
    
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    bool isImageFile = imageExtensions.any((ext) => lowerFilename.endsWith(ext));
    
    if (isImageFile) {
      return '$_uploadsBaseUrl$filename';
    }
    
    return 'assets/videos/thumbnails/default_thumbnail.jpg';
  }

  FileType _determineFileType(String? filename) {
    if (filename == null || filename.isEmpty) {
      return FileType.unknown;
    }
    
    final String lowerFilename = filename.toLowerCase();
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv', '.flv', '.wmv'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const audioExtensions = ['.mp3', '.wav', '.aac', '.ogg', '.m4a'];
    
    if (videoExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.video;
    } else if (imageExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.image;
    } else if (audioExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.audio;
    }
    
    return FileType.unknown;
  }

  String _mapCategory(String? category) {
    switch (category?.toLowerCase()) {
      case 'video':
        return 'Video';
      case 'artifact':
        return 'Cultural Artifact';
      case 'instrument':
        return 'Traditional Instrument';
      case 'audio':
        return 'Audio Recording';
      case 'image':
        return 'Image';
      default:
        return 'Media';
    }
  }

  Future<void> _refreshVideos() async {
    await _fetchVideos();
  }

  @override
  void dispose() {
    _loadingMetadata.clear();
    _searchController.dispose();
    _searchFocusNode.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final horizontalPadding = _getHorizontalPadding(context);
    final headerHeight = _getHeaderHeight(context);
    
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // FIXED: Dynamic header height
              AnimatedContainer(
                duration: const Duration(milliseconds: 300),
                height: (_isHeaderVisible || _isSearchFocused) ? headerHeight : 0,
                child: (_isHeaderVisible || _isSearchFocused) 
                    ? _buildHeader(context, horizontalPadding) 
                    : const SizedBox.shrink(),
              ),
              Expanded(
                child: _isSearchFocused 
                    ? _buildSearchResults(horizontalPadding)
                    : _buildMainContent(horizontalPadding),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeader(BuildContext context, double horizontalPadding) {
    final verticalPadding = _getVerticalSpacing(context, 12);
    
    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: horizontalPadding, 
        vertical: verticalPadding
      ),
      child: Row(
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 0 : 48,
            child: _isSearchFocused 
                ? const SizedBox.shrink()
                : Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: const Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ),
          ),
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 0 : 12, // Reduced from 16
          ),
          Expanded(
            child: Container(
              height: 48,
              decoration: BoxDecoration(
                color: const Color(0xFF2A2A2A),
                borderRadius: BorderRadius.circular(24),
                border: Border.all(
                  color: _isSearchFocused 
                      ? const Color(0xFFD4A574) 
                      : const Color(0xFFD4A574).withOpacity(0.3),
                  width: _isSearchFocused ? 2 : 1,
                ),
              ),
              child: TextField(
                controller: _searchController,
                focusNode: _searchFocusNode,
                style: TextStyle(
                  color: Colors.white,
                  fontSize: _getFontSize(context, 14),
                ),
                scrollPhysics: const BouncingScrollPhysics(),
                decoration: InputDecoration(
                  hintText: 'Search videos...',
                  hintStyle: TextStyle(
                    color: Colors.white.withOpacity(0.6),
                    fontSize: _getFontSize(context, 14),
                  ),
                  prefixIcon: Icon(
                    Icons.search,
                    color: _isSearchFocused 
                        ? const Color(0xFFD4A574)
                        : Colors.white.withOpacity(0.6),
                  ),
                  suffixIcon: _searchQuery.isNotEmpty
                      ? IconButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {
                              _searchQuery = '';
                            });
                          },
                          icon: Icon(
                            Icons.clear,
                            color: Colors.white.withOpacity(0.6),
                          ),
                        )
                      : null,
                  border: InputBorder.none,
                  contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                ),
                onChanged: (value) {
                  setState(() {
                    _searchQuery = value;
                  });
                },
              ),
            ),
          ),
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 80 : 0,
            child: _isSearchFocused
                ? TextButton(
                    onPressed: () {
                      _searchController.clear();
                      _searchFocusNode.unfocus();
                      setState(() {
                        _searchQuery = '';
                        _isHeaderVisible = true;
                      });
                    },
                    child: Text(
                      'Cancel',
                      style: TextStyle(
                        color: const Color(0xFFD4A574),
                        fontWeight: FontWeight.w500,
                        fontSize: _getFontSize(context, 14),
                      ),
                    ),
                  )
                : const SizedBox.shrink(),
          ),
        ],
      ),
    );
  }

  Widget _buildMainContent(double horizontalPadding) {
    if (_isLoading) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          mainAxisSize: MainAxisSize.min,
          children: [
            const CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFD4A574)),
            ),
            SizedBox(height: _getVerticalSpacing(context, 16)),
            Text(
              'Loading Kagan videos...',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: _getFontSize(context, 14),
              ),
            ),
          ],
        ),
      );
    }

    if (_errorMessage != null) {
      return Center(
        child: Padding(
          padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Colors.white.withOpacity(0.5),
              ),
              SizedBox(height: _getVerticalSpacing(context, 16)),
              Text(
                'Failed to load videos',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.7),
                  fontSize: _getFontSize(context, 18),
                  fontWeight: FontWeight.w500,
                ),
              ),
              SizedBox(height: _getVerticalSpacing(context, 8)),
              Padding(
                padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
                child: Text(
                  _errorMessage!,
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.5),
                    fontSize: _getFontSize(context, 14),
                  ),
                  textAlign: TextAlign.center,
                ),
              ),
              SizedBox(height: _getVerticalSpacing(context, 24)),
              ElevatedButton(
                onPressed: _refreshVideos,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFFD4A574),
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(
                    horizontal: horizontalPadding,
                    vertical: _getVerticalSpacing(context, 12),
                  ),
                ),
                child: Text(
                  'Retry',
                  style: TextStyle(fontSize: _getFontSize(context, 14)),
                ),
              ),
            ],
          ),
        ),
      );
    }

    if (_allVideos.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              Icons.video_library_outlined,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            SizedBox(height: _getVerticalSpacing(context, 16)),
            Text(
              'No Kagan videos available',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: _getFontSize(context, 18),
                fontWeight: FontWeight.w500,
              ),
            ),
            SizedBox(height: _getVerticalSpacing(context, 8)),
            Text(
              'Check back later for new content',
              style: TextStyle(
                color: Colors.white.withOpacity(0.5),
                fontSize: _getFontSize(context, 14),
              ),
            ),
            SizedBox(height: _getVerticalSpacing(context, 24)),
            ElevatedButton(
              onPressed: _refreshVideos,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFFD4A574),
                foregroundColor: Colors.white,
                padding: EdgeInsets.symmetric(
                  horizontal: horizontalPadding,
                  vertical: _getVerticalSpacing(context, 12),
                ),
              ),
              child: Text(
                'Refresh',
                style: TextStyle(fontSize: _getFontSize(context, 14)),
              ),
            ),
          ],
        ),
      );
    }

    final gridSpacing = _getGridSpacing(context);

    return RefreshIndicator(
      onRefresh: _refreshVideos,
      color: const Color(0xFFD4A574),
      child: CustomScrollView(
        controller: _scrollController,
        physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
        slivers: [
          if (_featuredVideo != null)
            SliverToBoxAdapter(
              child: _buildFeaturedVideo(horizontalPadding),
            ),
          SliverToBoxAdapter(
            child: _buildBrowseSection(horizontalPadding),
          ),
          SliverPadding(
            padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
            sliver: SliverGrid(
              gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: _getCrossAxisCount(context),
                childAspectRatio: _getChildAspectRatio(context),
                crossAxisSpacing: gridSpacing,
                mainAxisSpacing: gridSpacing,
              ),
              delegate: SliverChildBuilderDelegate(
                (context, index) {
                  final video = _allVideos[index];
                  return _buildVideoCard(video);
                },
                childCount: _allVideos.length,
              ),
            ),
          ),
          SliverToBoxAdapter(
            child: SizedBox(height: _getVerticalSpacing(context, 20)),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchResults(double horizontalPadding) {
    final gridSpacing = _getGridSpacing(context);
    
    return Column(
      children: [
        if (_searchQuery.isNotEmpty)
          Padding(
            padding: EdgeInsets.symmetric(
              horizontal: horizontalPadding, 
              vertical: _getVerticalSpacing(context, 8)
            ),
            child: Row(
              children: [
                Flexible(
                  child: Text(
                    '${_filteredVideos.length} result${_filteredVideos.length == 1 ? '' : 's'} for "$_searchQuery"',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.7),
                      fontSize: _getFontSize(context, 14),
                    ),
                    overflow: TextOverflow.ellipsis,
                  ),
                ),
              ],
            ),
          ),
        Expanded(
          child: _searchQuery.isEmpty
              ? Center(
                  child: Text(
                    'Start typing to search...',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.5),
                      fontSize: _getFontSize(context, 16),
                    ),
                  ),
                )
              : _filteredVideos.isEmpty
                  ? Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(
                            Icons.search_off,
                            size: 48,
                            color: Colors.white.withOpacity(0.3),
                          ),
                          SizedBox(height: _getVerticalSpacing(context, 16)),
                          Text(
                            'No videos found',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.5),
                              fontSize: _getFontSize(context, 18),
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          SizedBox(height: _getVerticalSpacing(context, 8)),
                          Text(
                            'Try different keywords',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.3),
                              fontSize: _getFontSize(context, 14),
                            ),
                          ),
                        ],
                      ),
                    )
                  : GridView.builder(
                      physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
                      padding: EdgeInsets.only(
                        left: horizontalPadding,
                        right: horizontalPadding,
                        bottom: MediaQuery.of(context).viewInsets.bottom + 20,
                      ),
                      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                        crossAxisCount: _getCrossAxisCount(context),
                        childAspectRatio: _getChildAspectRatio(context),
                        crossAxisSpacing: gridSpacing,
                        mainAxisSpacing: gridSpacing,
                      ),
                      itemCount: _filteredVideos.length,
                      itemBuilder: (context, index) {
                        final video = _filteredVideos[index];
                        return _buildVideoCard(video);
                      },
                    ),
        ),
      ],
    );
  }

  Widget _buildFeaturedVideo(double horizontalPadding) {
    if (_featuredVideo == null) return const SizedBox.shrink();

    final featuredHeight = _getFeaturedVideoHeight(context);
    final cardPadding = horizontalPadding * 0.75; // Proportional padding

    return Container(
      margin: EdgeInsets.all(cardPadding),
      height: featuredHeight,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.4),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: () {
              HapticFeedback.mediumImpact();
              _playVideo(_featuredVideo!);
            },
            child: Stack(
              children: [
                Container(
                  width: double.infinity,
                  height: double.infinity,
                  decoration: const BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color(0xFFD4A574),
                        Color(0xFFB8956A),
                      ],
                    ),
                  ),
                  child: _buildThumbnailImage(_featuredVideo!),
                ),
                Container(
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topCenter,
                      end: Alignment.bottomCenter,
                      colors: [
                        Colors.transparent,
                        Colors.black.withOpacity(0.7),
                      ],
                    ),
                  ),
                ),
                Positioned(
                  bottom: cardPadding,
                  left: cardPadding,
                  right: cardPadding,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        'Featured: ${_featuredVideo!.title}',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: _getFontSize(context, 18),
                          fontWeight: FontWeight.bold,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                      SizedBox(height: _getVerticalSpacing(context, 4)),
                      Text(
                        _featuredVideo!.description,
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.8),
                          fontSize: _getFontSize(context, 14),
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ),
                ),
                Center(
                  child: Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.5),
                      borderRadius: BorderRadius.circular(50),
                    ),
                    child: const Icon(
                      Icons.play_arrow,
                      color: Colors.white,
                      size: 40,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildBrowseSection(double horizontalPadding) {
    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: horizontalPadding, 
        vertical: _getVerticalSpacing(context, 12)
      ),
      child: Row(
        children: [
          const Icon(
            Icons.video_library,
            color: Color(0xFFD4A574),
            size: 20,
          ),
          SizedBox(width: _getVerticalSpacing(context, 8)),
          Flexible(
            child: Text(
              'Browse Kagan videos',
              style: TextStyle(
                color: const Color(0xFFD4A574),
                fontSize: _getFontSize(context, 16),
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
              overflow: TextOverflow.ellipsis,
            ),
          ),
        ],
      ),
    );
  }

  // FIXED: Complete video card rewrite with proper constraints
  Widget _buildVideoCard(VideoItem video) {
    return VisibilityDetector(
      key: Key('video_${video.id}'),
      onVisibilityChanged: (info) {
        if (info.visibleFraction > 0.1 && video.duration == '--:--') {
          _loadVideoMetadata(video);
        }
      },
      child: LayoutBuilder(
        builder: (context, constraints) {
          // Calculate heights dynamically based on available space
          final cardWidth = constraints.maxWidth;
          final cardHeight = constraints.maxHeight;
          
          // Image should take 60% of card height
          final imageHeight = cardHeight * 0.6;
          // Info section takes remaining 40%
          final infoHeight = cardHeight * 0.4;
          
          return Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.3),
                  blurRadius: 6,
                  offset: const Offset(0, 3),
                ),
              ],
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: Material(
                color: Colors.transparent,
                child: InkWell(
                  onTap: () {
                    HapticFeedback.mediumImpact();
                    _playVideo(video);
                  },
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // FIXED: Use SizedBox with explicit height instead of Expanded
                      SizedBox(
                        height: imageHeight,
                        width: double.infinity,
                        child: Stack(
                          children: [
                            Container(
                              width: double.infinity,
                              height: double.infinity,
                              decoration: const BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                  colors: [
                                    Color(0xFFD4A574),
                                    Color(0xFFB8956A),
                                  ],
                                ),
                              ),
                              child: _buildThumbnailImage(video),
                            ),
                            Positioned(
                              top: 6,
                              right: 6,
                              child: Container(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 6,
                                  vertical: 2,
                                ),
                                decoration: BoxDecoration(
                                  color: Colors.black.withOpacity(0.7),
                                  borderRadius: BorderRadius.circular(4),
                                ),
                                child: Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    if (video.duration == '--:--' && _loadingMetadata.contains(video.id))
                                      const Padding(
                                        padding: EdgeInsets.only(right: 4),
                                        child: SizedBox(
                                          width: 8,
                                          height: 8,
                                          child: CircularProgressIndicator(
                                            strokeWidth: 1.5,
                                            valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                                          ),
                                        ),
                                      ),
                                    Text(
                                      video.duration,
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: _getFontSize(context, 10),
                                        fontWeight: FontWeight.w500,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                            Center(
                              child: Container(
                                padding: EdgeInsets.all(cardWidth * 0.08), // Proportional padding
                                decoration: BoxDecoration(
                                  color: Colors.black.withOpacity(0.5),
                                  borderRadius: BorderRadius.circular(30),
                                ),
                                child: Icon(
                                  video.fileType == FileType.video 
                                      ? Icons.play_arrow
                                      : video.fileType == FileType.audio
                                          ? Icons.music_note
                                          : Icons.image,
                                  color: Colors.white,
                                  size: cardWidth * 0.15, // Proportional icon size
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      // FIXED: Use SizedBox with explicit height - NO Flexible/Expanded
                      SizedBox(
                        height: infoHeight,
                        width: double.infinity,
                        child: Container(
                          padding: EdgeInsets.all(cardWidth * 0.035), // Reduced padding
                          color: const Color(0xFF2A2A2A),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              // FIXED: Removed Flexible wrappers - direct Text with constraints
                              Text(
                                video.title,
                                style: TextStyle(
                                  color: Colors.white,
                                  fontSize: _getFontSize(context, 12), // Reduced from 13
                                  fontWeight: FontWeight.w600,
                                  height: 1.2,
                                ),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                              SizedBox(height: cardHeight * 0.005), // Reduced spacing
                              Text(
                                video.description,
                                style: TextStyle(
                                  color: Colors.white.withOpacity(0.6),
                                  fontSize: _getFontSize(context, 10), // Reduced from 11
                                  height: 1.2,
                                ),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                              // FIXED: Spacer pushes category to bottom naturally
                              const Spacer(),
                              Container(
                                padding: EdgeInsets.symmetric(
                                  horizontal: cardWidth * 0.02, // Reduced padding
                                  vertical: cardHeight * 0.006, // Reduced padding
                                ),
                                decoration: BoxDecoration(
                                  color: const Color(0xFFD4A574).withOpacity(0.2),
                                  borderRadius: BorderRadius.circular(6),
                                ),
                                child: Text(
                                  video.category,
                                  style: TextStyle(
                                    color: const Color(0xFFD4A574),
                                    fontSize: _getFontSize(context, 9), // Reduced from 10
                                    fontWeight: FontWeight.w500,
                                  ),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildThumbnailImage(VideoItem video) {
    if (video.thumbnail.startsWith('/data') || video.thumbnail.startsWith('/storage')) {
      return Image.file(
        File(video.thumbnail),
        fit: BoxFit.cover,
        errorBuilder: (context, error, stackTrace) {
          return const Center(
            child: Icon(
              Icons.play_circle_outline,
              color: Colors.white,
              size: 40,
            ),
          );
        },
      );
    }
    
    if (video.thumbnail.startsWith('http')) {
      return Image.network(
        video.thumbnail,
        fit: BoxFit.cover,
        errorBuilder: (context, error, stackTrace) {
          return const Center(
            child: Icon(
              Icons.play_circle_outline,
              color: Colors.white,
              size: 40,
            ),
          );
        },
        loadingBuilder: (context, child, loadingProgress) {
          if (loadingProgress == null) return child;
          return const Center(
            child: CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
            ),
          );
        },
      );
    }
    
    return Image.asset(
      video.thumbnail,
      fit: BoxFit.cover,
      errorBuilder: (context, error, stackTrace) {
        return const Center(
          child: Icon(
            Icons.play_circle_outline,
            color: Colors.white,
            size: 40,
          ),
        );
      },
    );
  }

  void _playVideo(VideoItem video) {
    if (video.file.isEmpty || video.fileType != FileType.video) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            video.fileType == FileType.audio 
                ? 'This is an audio file. Audio player not implemented yet.'
                : video.fileType == FileType.image
                    ? 'This is an image file, not a video.'
                    : 'Cannot play this file type.',
          ),
          backgroundColor: const Color(0xFFD4A574),
        ),
      );
      return;
    }

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => VideoPlayerScreen(
          videoTitle: video.title,
          videoDescription: video.description,
          thumbnailPath: video.thumbnail,
          duration: video.duration,
          accentColor: const Color(0xFFD4A574),
          tribalName: 'Kagan',
          videoUrl: video.videoUrl,
        ),
      ),
    );
  }
}

enum FileType {
  video,
  audio,
  image,
  unknown,
}

class VideoItem {
  final String id;
  final String title;
  String thumbnail;
  String duration;
  final String description;
  final String category;
  final String file;
  final FileType fileType;
  final String videoUrl;

  VideoItem({
    required this.id,
    required this.title,
    required this.thumbnail,
    required this.duration,
    required this.description,
    required this.category,
    required this.file,
    required this.fileType,
    required this.videoUrl,
  });
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\learn_more_screen\kagan_learn_more_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

class KaganCulturalLearnMoreScreen extends StatelessWidget {
  const KaganCulturalLearnMoreScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SingleChildScrollView(
          physics: const BouncingScrollPhysics(),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              _buildHeaderSection(context),
              const SizedBox(height: 24),
              _buildContentSection(),
              const SizedBox(height: 40),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeaderSection(BuildContext context) {
    return SizedBox(
      height: 300,
      child: Stack(
        children: [
          // Background Image
          Container(
            height: 300,
            width: double.infinity,
            decoration: const BoxDecoration(
              borderRadius: BorderRadius.only(
                bottomLeft: Radius.circular(24),
                bottomRight: Radius.circular(24),
              ),
            ),
            child: ClipRRect(
              borderRadius: const BorderRadius.only(
                bottomLeft: Radius.circular(24),
                bottomRight: Radius.circular(24),
              ),
              child: Image.asset(
                'assets/images/kagan_lm.jpg',
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    decoration: const BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Color(0xFF8B4513),
                          Color(0xFF654321),
                          Color(0xFF2F1B14),
                        ],
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
          
          // Dark Overlay
          Container(
            height: 300,
            width: double.infinity,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Colors.black.withOpacity(0.4),
                  Colors.black.withOpacity(0.7),
                ],
              ),
              borderRadius: const BorderRadius.only(
                bottomLeft: Radius.circular(24),
                bottomRight: Radius.circular(24),
              ),
            ),
          ),
          
          // Content Overlay
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Back Button
                  Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: const Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ),
                  
                  const Spacer(),
                  
                  // Title
                  const Text(
                    'KAGAN',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 32,
                      fontWeight: FontWeight.bold,
                      letterSpacing: 2,
                      shadows: [
                        Shadow(
                          offset: Offset(0, 2),
                          blurRadius: 4,
                          color: Colors.black54,
                        ),
                      ],
                    ),
                  ),
                  
                  const SizedBox(height: 8),
                  
                  Text(
                    'Indigenous People of Mindanao',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.9),
                      fontSize: 16,
                      fontWeight: FontWeight.w400,
                      letterSpacing: 0.5,
                    ),
                  ),
                  
                  const SizedBox(height: 16),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildContentSection() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Introduction Section
          _buildSectionTitle('ABOUT THE KAGAN'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The Kagan tribe has occupied their ancestral domain since time immemorial and has been considering the lands encompassed therein as their life  the value of their existence. Kagan community is governed by a Pyagmatikadung / Datu who has his Council of Elders formed to eventually attend to the general affairs of said community',
          ),
          
          const SizedBox(height: 32),
          
          // Origins and Legend Section
          _buildSectionTitle('ORIGINS & LEGEND'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The Kagan elders narrated that the word Kagan comes from the root word Kaag, which means to inform or to warn. ' 
            'According to Datu Belardo Bungad, the name Kaag was not ascribed by other people, rather it is their people who called themselves as such.  '
            'Another ascription based on an oral tradition recounted a person from Tagasug saying Kyalagan ko na which meant I have found it.',
          ),
          
          const SizedBox(height: 32),
          
          // Cultural Practices Section
          _buildSectionTitle('CULTURAL PRACTICES'),
          const SizedBox(height: 16),
          
          _buildPracticeItem(
            icon: Icons.spa,
            title: 'Traditional Healing',
            description: 'The Kagan are known for their extensive knowledge of medicinal plants and traditional healing practices passed down through generations.',
          ),
          
          const SizedBox(height: 16),
          
          _buildPracticeItem(
            icon: Icons.auto_awesome,
            title: 'Spiritual Rituals',
            description: 'The sacred place of the Kagan tribe of Madaum called as Banakon where they used to offer rituals like Panuwak Buka." '
                         'A ritual called as Panuwak Buka conducted at Banakon (Barret Beach) in Barangay Madaum performed by Datu Belardo Bungad to prevent calamities and bad things from happening in the community.',
          ),
          
          const SizedBox(height: 16),
          
          _buildPracticeItem(
            icon: Icons.palette,
            title: 'Craftsmanship',
            description: 'Aside from marking their territories with bodies of water, the Kagan also used huge trees such as Durian and Baluno as well as the Bamboo grass as their marker.',
          ),
          
          const SizedBox(height: 32),
          
          // Lifestyle Section
          _buildSectionTitle('TRADITIONAL LIFESTYLE'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The Kagan community invoked the concept of self-delineation in identifying their traditional landmarks.'
            'Kagan ancestors in Madaum consider Hijo River as an important part of their lives as this is where trade and other economic activities occur.'
          ),
          
          const SizedBox(height: 32),
          
          // Modern Challenges Section
          _buildSectionTitle('PRESERVING CULTURE'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The Kagan tribe is similar to Mansaka and Mandaya as these indigenous tribes also valued the conduct of rituals, and referred to their God as Tagallang na Magbabaya.',
          ),
        ],
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Row(
      children: [
        Container(
          width: 4,
          height: 24,
          decoration: BoxDecoration(
            color: const Color(0xFFD4A574),
            borderRadius: BorderRadius.circular(2),
          ),
        ),
        const SizedBox(width: 12),
        Text(
          title,
          style: const TextStyle(
            color: Color(0xFFD4A574),
            fontSize: 18,
            fontWeight: FontWeight.bold,
            letterSpacing: 1.2,
          ),
        ),
      ],
    );
  }

  Widget _buildDescriptionCard(String description) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFFD4A574).withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Text(
        description,
        style: const TextStyle(
          color: Colors.white,
          fontSize: 16,
          height: 1.6,
          fontWeight: FontWeight.w400,
        ),
      ),
    );
  }

  Widget _buildPracticeItem({
    required IconData icon,
    required String title,
    required String description,
  }) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFFD4A574).withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: const Color(0xFFD4A574).withOpacity(0.2),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Icon(
              icon,
              color: const Color(0xFFD4A574),
              size: 24,
            ),
          ),
          
          const SizedBox(width: 16),
          
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: const TextStyle(
                    color: Color(0xFFD4A574),
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 0.5,
                  ),
                ),
                
                const SizedBox(height: 8),
                
                Text(
                  description,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    height: 1.5,
                    fontWeight: FontWeight.w400,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\learn_more_screen\mandaya_learn_more_screen.dart
======================================

// lib/screen/learn_more_screen/mandaya_learn_more_screen.dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

class MandayaCulturalLearnMoreScreen extends StatelessWidget {
  const MandayaCulturalLearnMoreScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SingleChildScrollView(
          physics: const BouncingScrollPhysics(),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              _buildHeaderSection(context),
              const SizedBox(height: 24),
              _buildContentSection(),
              const SizedBox(height: 40),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeaderSection(BuildContext context) {
    return SizedBox(
      height: 300,
      child: Stack(
        children: [
          // Background Image
          Container(
            height: 300,
            width: double.infinity,
            decoration: const BoxDecoration(
              borderRadius: BorderRadius.only(
                bottomLeft: Radius.circular(24),
                bottomRight: Radius.circular(24),
              ),
            ),
            child: ClipRRect(
              borderRadius: const BorderRadius.only(
                bottomLeft: Radius.circular(24),
                bottomRight: Radius.circular(24),
              ),
              child: Image.asset(
                'assets/images/mandaya_lm.jpg',
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    decoration: const BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Color(0xFF4A5D23),
                          Color(0xFF2F3E15),
                          Color(0xFF1A2209),
                        ],
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
          
          // Dark Overlay
          Container(
            height: 300,
            width: double.infinity,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Colors.black.withOpacity(0.4),
                  Colors.black.withOpacity(0.7),
                ],
              ),
              borderRadius: const BorderRadius.only(
                bottomLeft: Radius.circular(24),
                bottomRight: Radius.circular(24),
              ),
            ),
          ),
          
          // Content Overlay
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Back Button
                  Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: const Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ),
                  
                  const Spacer(),
                  
                  // Title
                  const Text(
                    'MANDAYA',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 32,
                      fontWeight: FontWeight.bold,
                      letterSpacing: 2,
                      shadows: [
                        Shadow(
                          offset: Offset(0, 2),
                          blurRadius: 4,
                          color: Colors.black54,
                        ),
                      ],
                    ),
                  ),
                  
                  const SizedBox(height: 8),
                  
                  Text(
                    'Indigenous People of Davao Oriental',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.9),
                      fontSize: 16,
                      fontWeight: FontWeight.w400,
                      letterSpacing: 0.5,
                    ),
                  ),
                  
                  const SizedBox(height: 16),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildContentSection() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Introduction Section
          _buildSectionTitle('ABOUT THE MANDAYA'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'One of Tagums dominant indigenous groups, the Mandaya tribe is a native community or Tipanud in the area. They also fosters a good relationship with those from the tribes of Kagan and Mansaka.',
          ),
          
          const SizedBox(height: 32),
          
          // Origins and Legend Section
          _buildSectionTitle('ORIGINS & LEGENDS'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The word Mandaya came from the words man and daya which means people from the upstream. '
            'Mandaya is said to have originated from the interpretation of an utterance of those who live downstream.',
          ),
          
          const SizedBox(height: 32),
          
          // Cultural Practices Section
          _buildSectionTitle('CULTURAL PRACTICES'),
          const SizedBox(height: 16),
          
          _buildPracticeItem(
            icon: Icons.healing,
            title: 'Traditional Healing',
            description: 'Traditional leaders of the Mandaya also include the Baylan who is the communitys spiritual healer who can foresee future happenings, such as calamities and disasters. As a priest or priestess, the Baylan performs rituals yet does not conduct wedding ceremonies.',
          ),
          
          const SizedBox(height: 16),
          
          _buildPracticeItem(
            icon: Icons.people,
            title: 'Spritual Rituals',
            description: 'The Mandaya tribe is headed by a Datu or Bia who, as the supreme leader, must be a teacher, mediator and adviser to the members of the community; a culture master who officiates traditional ceremonies like tribal weddings and such other celebrations; and a judge who implements and executes the delivery of their justice system.',
          ),
          
          const SizedBox(height: 16),
          
          _buildPracticeItem(
            icon: Icons.handyman,
            title: 'Craftmanship',
            description: 'The craftsmanship of the Mandaya is shown in the dagum, the traditional Mandaya blouse, which is part of their cultural attire',
          ),
          
          const SizedBox(height: 32),
          
          // Lifestyle Section
          _buildSectionTitle('TRADITIONAL LIFESTYLE'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The members of the Mandaya communities are among the original settlers of Tagum and they have been in possession of their land since before the 18th century. '
            'They lived simply, foraging their territory for means that would provide them with their sustenance and basic needs.',
          ),
          
          const SizedBox(height: 32),
          
          // Modern Challenges Section
          _buildSectionTitle('PRESERVING CULTURE'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The Mandaya tribe fosters good relationships with other tribes and preserves their traditional territories in the barangays of Mankilam, Cuambogan, Pagsabangan, Canocotan, and San Miguel.',
          ),
        ],
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Row(
      children: [
        Container(
          width: 4,
          height: 24,
          decoration: BoxDecoration(
            color: const Color(0xFF7FB069),
            borderRadius: BorderRadius.circular(2),
          ),
        ),
        const SizedBox(width: 12),
        Text(
          title,
          style: const TextStyle(
            color: Color(0xFF7FB069),
            fontSize: 18,
            fontWeight: FontWeight.bold,
            letterSpacing: 1.2,
          ),
        ),
      ],
    );
  }

  Widget _buildDescriptionCard(String description) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFF7FB069).withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Text(
        description,
        style: const TextStyle(
          color: Colors.white,
          fontSize: 16,
          height: 1.6,
          fontWeight: FontWeight.w400,
        ),
      ),
    );
  }

  Widget _buildPracticeItem({
    required IconData icon,
    required String title,
    required String description,
  }) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFF7FB069).withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: const Color(0xFF7FB069).withOpacity(0.2),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Icon(
              icon,
              color: const Color(0xFF7FB069),
              size: 24,
            ),
          ),
          
          const SizedBox(width: 16),
          
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: const TextStyle(
                    color: Color(0xFF7FB069),
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 0.5,
                  ),
                ),
                
                const SizedBox(height: 8),
                
                Text(
                  description,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    height: 1.5,
                    fontWeight: FontWeight.w400,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\learn_more_screen\mansaka_learn_more_screen.dart
======================================

// lib/screen/learn_more_screen/mansaka_learn_more_screen.dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

class MansakaCulturalLearnMoreScreen extends StatelessWidget {
  const MansakaCulturalLearnMoreScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SingleChildScrollView(
          physics: const BouncingScrollPhysics(),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              _buildHeaderSection(context),
              const SizedBox(height: 24),
              _buildContentSection(),
              const SizedBox(height: 40),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeaderSection(BuildContext context) {
    return SizedBox(
      height: 300,
      child: Stack(
        children: [
          // Background Image
          Container(
            height: 300,
            width: double.infinity,
            decoration: const BoxDecoration(
              borderRadius: BorderRadius.only(
                bottomLeft: Radius.circular(24),
                bottomRight: Radius.circular(24),
              ),
            ),
            child: ClipRRect(
              borderRadius: const BorderRadius.only(
                bottomLeft: Radius.circular(24),
                bottomRight: Radius.circular(24),
              ),
              child: Image.asset(
                'assets/images/mansaka_lm.jpg',
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    decoration: const BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Color(0xFF5D4E75),
                          Color(0xFF3F325A),
                          Color(0xFF2A1F3D),
                        ],
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
          
          // Dark Overlay
          Container(
            height: 300,
            width: double.infinity,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Colors.black.withOpacity(0.4),
                  Colors.black.withOpacity(0.7),
                ],
              ),
              borderRadius: const BorderRadius.only(
                bottomLeft: Radius.circular(24),
                bottomRight: Radius.circular(24),
              ),
            ),
          ),
          
          // Content Overlay
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Back Button
                  Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: const Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ),
                  
                  const Spacer(),
                  
                  // Title
                  const Text(
                    'MANSAKA',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 32,
                      fontWeight: FontWeight.bold,
                      letterSpacing: 2,
                      shadows: [
                        Shadow(
                          offset: Offset(0, 2),
                          blurRadius: 4,
                          color: Colors.black54,
                        ),
                      ],
                    ),
                  ),
                  
                  const SizedBox(height: 8),
                  
                  Text(
                    'Indigenous People of Davao de Oro',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.9),
                      fontSize: 16,
                      fontWeight: FontWeight.w400,
                      letterSpacing: 0.5,
                    ),
                  ),
                  
                  const SizedBox(height: 16),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildContentSection() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Introduction Section
          _buildSectionTitle('ABOUT THE MANSAKA'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The indigenous socio-political structure of the Mansaka tribe, established to promote order, maintain security and advance the development of their communities.',
          ),
          
          const SizedBox(height: 32),
          
          // Origins and Legend Section
          _buildSectionTitle('ORIGINS & LEGENDS'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The term Mansaka was derived from the words man, meaning first and saka, meaning to ascend. '
            'Mansaka meant the first people to ascend the mountains or go upstream. '
            'Prior to being called as Mansaka, their people had once been called as utaw which meant an indigenous person with innate character and virtues.'
          ),
          
          const SizedBox(height: 32),
          
          // Cultural Practices Section
          _buildSectionTitle('CULTURAL PRACTICES'),
          const SizedBox(height: 16),
          
          _buildPracticeItem(
            icon: Icons.healing,
            title: 'Traditional Healing',
            description: 'the Balyan, who is either male or female, is an important part of the structure of the Mansaka tribe. They are spiritual healers known as intelligent persons and are respected by the members of the tribe. Their knowing the cause of a member of a Mansaka tribes illness and their corresponding traditional medications had them viewed as someone endowed with special wisdom.',
          ),
        
          const SizedBox(height: 16),
          
          _buildPracticeItem(
            icon: Icons.nature_people,
            title: 'Spiritual Rituals',
            description: 'The Kyalalaysan is a prominent leader of the Mansaka tribe, equal in stature to the highest spiritual leaders, and skilled in rituals with singing and chanting. ' 
                          'Usually from a family of Balyan, the current Kyalalaysan of Tagum, Aguido Sucnaan Sr., succeeded his grandfather, Pyagmatikadung Tangkunay. Past Kyalalaysan include Lantones, Manggang, Kalipayan, Uyop Uyopan, and Mailom.',
          ),
          
          const SizedBox(height: 16),
          
          _buildPracticeItem(
            icon: Icons.handyman,
            title: 'Craftsmanship',
            description: 'The Mansaka show craftsmanship in rituals through singing and chanting, a skill practiced by the Kyalalaysan and passed down from their ancestors',
          ),

          const SizedBox(height: 32),
          
          // Lifestyle Section
          _buildSectionTitle('TRADITIONAL LIFESTYLE'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'They traditionally believe that the land is provided by Magbabaya, and considers their land as a very important possession which they inherited from their ancestors especially because they are dependent on the resources found within their domain.',
          ),
          
          const SizedBox(height: 32),
          
          // Modern Challenges Section
          _buildSectionTitle('PRESERVING CULTURE'),
          const SizedBox(height: 16),
          _buildDescriptionCard(
            'The tribe also considers it their responsibility to protect, defend and handle the land well enough to be able to bequeath it to the next generation. Maintained their sense of pride and remained true to their cause of protecting their identity and cultural heritage.',
          ),
        ],
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Row(
      children: [
        Container(
          width: 4,
          height: 24,
          decoration: BoxDecoration(
            color: const Color(0xFFB19CD9),
            borderRadius: BorderRadius.circular(2),
          ),
        ),
        const SizedBox(width: 12),
        Text(
          title,
          style: const TextStyle(
            color: Color(0xFFB19CD9),
            fontSize: 18,
            fontWeight: FontWeight.bold,
            letterSpacing: 1.2,
          ),
        ),
      ],
    );
  }

  Widget _buildDescriptionCard(String description) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFFB19CD9).withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Text(
        description,
        style: const TextStyle(
          color: Colors.white,
          fontSize: 16,
          height: 1.6,
          fontWeight: FontWeight.w400,
        ),
      ),
    );
  }

  Widget _buildPracticeItem({
    required IconData icon,
    required String title,
    required String description,
  }) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFFB19CD9).withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: const Color(0xFFB19CD9).withOpacity(0.2),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Icon(
              icon,
              color: const Color(0xFFB19CD9),
              size: 24,
            ),
          ),
          
          const SizedBox(width: 16),
          
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: const TextStyle(
                    color: Color(0xFFB19CD9),
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 0.5,
                  ),
                ),
                
                const SizedBox(height: 8),
                
                Text(
                  description,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    height: 1.5,
                    fontWeight: FontWeight.w400,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mandaya_category_screens\mandaya_artifacts_screen.dart
======================================

// lib/screen/mandaya_category_screens/mandaya_artifacts_screen.dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

class MandayaArtifactsScreen extends StatefulWidget {
  const MandayaArtifactsScreen({super.key});

  @override
  State<MandayaArtifactsScreen> createState() => _MandayaArtifactsScreenState();
}

class _MandayaArtifactsScreenState extends State<MandayaArtifactsScreen> {
  final TextEditingController _searchController = TextEditingController();
  String _searchQuery = '';

  // API and loading state
  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<ArtifactItem> _allArtifacts = [];
  bool _isLoading = true;
  String? _errorMessage;

  List<ArtifactItem> get _filteredArtifacts {
    if (_searchQuery.isEmpty) {
      return _allArtifacts;
    }
    return _allArtifacts.where((artifact) {
      return artifact.name.toLowerCase().contains(_searchQuery.toLowerCase()) ||
             artifact.description.toLowerCase().contains(_searchQuery.toLowerCase());
    }).toList();
  }

  // Responsive helper methods
  int _getCrossAxisCount(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 4;
    if (width > 800) return 3;
    if (width > 600) return 2;
    return 2;
  }

  double _getChildAspectRatio(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 800) return 0.9;
    return 0.85;
  }

  double _getHorizontalPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 40;
    if (width > 800) return 32;
    return 20;
  }

  double _getFeaturedImageHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    final height = MediaQuery.of(context).size.height;
    if (width > 800) return height * 0.35;
    return 200;
  }

  @override
  void initState() {
    super.initState();
    _fetchArtifacts();
  }

  Future<void> _fetchArtifacts() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching Mandaya artifacts from: $_baseUrl');
      
      const String apiUrl = '$_baseUrl?tribe=mandaya&category=artifact';
      debugPrint('API URL: $apiUrl');

      final response = await http.get(
        Uri.parse(apiUrl),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      ).timeout(const Duration(seconds: 15));
      
      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');
      
      if (response.statusCode != 200) {
        throw Exception('API returned status code: ${response.statusCode}');
      }

      final Map<String, dynamic> jsonData = json.decode(response.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      if (!jsonData.containsKey('data')) {
        throw Exception('API response missing "data" field');
      }

      final dynamic rawData = jsonData['data'];
      List<dynamic> contentItems = [];
      
      if (rawData is List) {
        contentItems = rawData;
      } else if (rawData is Map) {
        contentItems = [rawData];
      } else {
        throw Exception('Unexpected data format in API response');
      }

      debugPrint('Found ${contentItems.length} content items');

      final List<ArtifactItem> artifacts = [];

      for (var item in contentItems) {
        if (item == null || item is! Map<String, dynamic>) {
          debugPrint('Skipping invalid item: $item');
          continue;
        }
        
        debugPrint('Processing item: ${item.toString()}');
        
        final dynamic id = item['id'];
        final dynamic userId = item['user_id'];
        final String? title = item['title']?.toString();
        final String? category = item['category']?.toString();
        final String? tribe = item['tribe']?.toString();
        final String? description = item['description']?.toString();
        final String? file = item['file']?.toString();
        final dynamic isArchived = item['is_archived'];
        final String? time = item['time']?.toString();
        
        if (id == null || 
            userId == null || 
            title == null || title.isEmpty ||
            category == null || category.isEmpty ||
            tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty ||
            isArchived == null ||
            time == null || time.isEmpty) {
          debugPrint('Skipping item with missing required fields');
          continue;
        }
        
        if (tribe.toLowerCase() != 'mandaya') {
          debugPrint('Skipping non-Mandaya item: $tribe');
          continue;
        }

        if (isArchived != 0) {
          debugPrint('Skipping archived item: $title');
          continue;
        }

        if (category.toLowerCase() != 'artifact' && !_isImageContent(file)) {
          debugPrint('Skipping non-artifact content: $file (category: $category)');
          continue;
        }

        final artifact = ArtifactItem(
          id: id.toString(),
          name: title,
          description: description ?? 'No description available',
          imagePath: '$_uploadsBaseUrl$file',
          file: file,
          isNetworkSource: true,
        );
        
        debugPrint(' Added artifact: $title (ID: $id, Category: $category)');
        artifacts.add(artifact);
      }

      debugPrint('Final artifact count: ${artifacts.length}');

      setState(() {
        _allArtifacts = artifacts;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching artifacts: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load artifacts: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  bool _isImageContent(String filename) {
    final String lowerFilename = filename.toLowerCase();
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    return imageExtensions.any((ext) => lowerFilename.endsWith(ext));
  }

  Future<void> _refreshArtifacts() async {
    await _fetchArtifacts();
  }

  @override
  Widget build(BuildContext context) {
    final horizontalPadding = _getHorizontalPadding(context);
    
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              _buildHeader(horizontalPadding),
              Expanded(
                child: _isLoading 
                    ? _buildLoadingState()
                    : _errorMessage != null 
                        ? _buildErrorState()
                        : _allArtifacts.isEmpty
                            ? _buildEmptyState()
                            : _buildContent(horizontalPadding),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildLoadingState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const CircularProgressIndicator(
            valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
          ),
          const SizedBox(height: 16),
          Text(
            'Loading Mandaya artifacts...',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 14,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildErrorState() {
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: _getHorizontalPadding(context)),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            const SizedBox(height: 16),
            Text(
              'Failed to load artifacts',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              _errorMessage!,
              style: TextStyle(
                color: Colors.white.withOpacity(0.5),
                fontSize: 14,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: _refreshArtifacts,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF7FB069),
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 16),
              ),
              child: const Text('Retry'),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.museum_outlined,
            size: 64,
            color: Colors.white.withOpacity(0.5),
          ),
          const SizedBox(height: 16),
          Text(
            'No Mandaya artifacts available',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 18,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Check back later for new artifacts',
            style: TextStyle(
              color: Colors.white.withOpacity(0.5),
              fontSize: 14,
            ),
          ),
          const SizedBox(height: 24),
          ElevatedButton(
            onPressed: _refreshArtifacts,
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF7FB069),
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 16),
            ),
            child: const Text('Refresh'),
          ),
        ],
      ),
    );
  }

  Widget _buildContent(double horizontalPadding) {
    return RefreshIndicator(
      onRefresh: _refreshArtifacts,
      color: const Color(0xFF7FB069),
      child: SingleChildScrollView(
        physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
        keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSearchBar(horizontalPadding),
            const SizedBox(height: 20),
            _buildFeaturedImage(horizontalPadding),
            const SizedBox(height: 24),
            _buildDescription(horizontalPadding),
            const SizedBox(height: 32),
            _buildBrowseSection(horizontalPadding),
            const SizedBox(height: 20),
            _buildArtifactsGrid(horizontalPadding),
            SizedBox(height: 40 + MediaQuery.of(context).viewInsets.bottom),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader(double horizontalPadding) {
    final isLargeScreen = MediaQuery.of(context).size.width > 800;
    
    return Padding(
      padding: EdgeInsets.all(horizontalPadding),
      child: Row(
        children: [
          Container(
            decoration: BoxDecoration(
              color: Colors.black.withOpacity(0.3),
              borderRadius: BorderRadius.circular(12),
            ),
            child: IconButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                Navigator.pop(context);
              },
              icon: Icon(
                Icons.arrow_back_ios,
                color: Colors.white,
                size: isLargeScreen ? 24 : 20,
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Text(
              'MANDAYA ARTIFACTS',
              style: TextStyle(
                color: Colors.white,
                fontSize: isLargeScreen ? 24 : 20,
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchBar(double horizontalPadding) {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Container(
        decoration: BoxDecoration(
          color: const Color(0xFF2A2A2A),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: const Color(0xFF7FB069).withOpacity(0.3),
            width: 1,
          ),
        ),
        child: TextField(
          controller: _searchController,
          onChanged: (value) {
            setState(() {
              _searchQuery = value;
            });
          },
          style: const TextStyle(color: Colors.white),
          decoration: InputDecoration(
            hintText: 'Search artifacts',
            hintStyle: TextStyle(
              color: Colors.white.withOpacity(0.6),
              fontSize: 16,
            ),
            prefixIcon: Icon(
              Icons.search,
              color: Colors.white.withOpacity(0.6),
            ),
            suffixIcon: _searchQuery.isNotEmpty
                ? IconButton(
                    onPressed: () {
                      setState(() {
                        _searchController.clear();
                        _searchQuery = '';
                      });
                    },
                    icon: Icon(
                      Icons.clear,
                      color: Colors.white.withOpacity(0.6),
                    ),
                  )
                : null,
            border: InputBorder.none,
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 16,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildFeaturedImage(double horizontalPadding) {
    final imageHeight = _getFeaturedImageHeight(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Container(
        height: imageHeight,
        width: double.infinity,
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Image.asset(
            'assets/images/mandaya_arti.jpg',
            fit: BoxFit.cover,
            errorBuilder: (context, error, stackTrace) {
              return Container(
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      Color(0xFF7FB069),
                      Color(0xFF6B8E23),
                      Color(0xFF556B2F),
                    ],
                  ),
                ),
                child: const Center(
                  child: Icon(
                    Icons.museum,
                    color: Colors.white,
                    size: 60,
                  ),
                ),
              );
            },
          ),
        ),
      ),
    );
  }

  Widget _buildDescription(double horizontalPadding) {
    final isLargeScreen = MediaQuery.of(context).size.width > 800;
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Discover authentic Mandaya artifacts - physical objects that tell the story of this indigenous tribe\'s rich cultural heritage, craftsmanship, and daily life.',
            style: TextStyle(
              color: Colors.white.withOpacity(0.9),
              fontSize: isLargeScreen ? 18 : 16,
              height: 1.6,
              letterSpacing: 0.5,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBrowseSection(double horizontalPadding) {
    final isLargeScreen = MediaQuery.of(context).size.width > 800;
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Text(
        'Browse artifacts (${_filteredArtifacts.length})',
        style: TextStyle(
          color: Colors.white,
          fontSize: isLargeScreen ? 22 : 20,
          fontWeight: FontWeight.bold,
        ),
      ),
    );
  }

  Widget _buildArtifactsGrid(double horizontalPadding) {
    if (_filteredArtifacts.isEmpty) {
      return _buildNoResults(horizontalPadding);
    }

    final crossAxisCount = _getCrossAxisCount(context);
    final aspectRatio = _getChildAspectRatio(context);
    final spacing = MediaQuery.of(context).size.width > 800 ? 20.0 : 16.0;

    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: GridView.builder(
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: crossAxisCount,
          crossAxisSpacing: spacing,
          mainAxisSpacing: spacing,
          childAspectRatio: aspectRatio,
        ),
        itemCount: _filteredArtifacts.length,
        itemBuilder: (context, index) {
          return _buildArtifactCard(_filteredArtifacts[index], index);
        },
      ),
    );
  }

  Widget _buildNoResults(double horizontalPadding) {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const SizedBox(height: 60),
            Icon(
              Icons.search_off,
              size: 64,
              color: Colors.white.withOpacity(0.3),
            ),
            const SizedBox(height: 16),
            Text(
              'No artifacts found',
              style: TextStyle(
                color: Colors.white.withOpacity(0.6),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'Try searching with different keywords',
              style: TextStyle(
                color: Colors.white.withOpacity(0.4),
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 60),
          ],
        ),
      ),
    );
  }

  Widget _buildArtifactCard(ArtifactItem artifact, int index) {
    final isLargeScreen = MediaQuery.of(context).size.width > 800;
    
    return GestureDetector(
      onTap: () {
        HapticFeedback.mediumImpact();
        _showArtifactViewer(artifact, index);
      },
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              Expanded(
                flex: 3,
                child: artifact.isNetworkSource
                    ? Image.network(
                        artifact.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFF7FB069),
                                  Color(0xFF6B8E23),
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 40,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            color: const Color(0xFF2A2A2A),
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
                                strokeWidth: 2,
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        artifact.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFF7FB069),
                                  Color(0xFF6B8E23),
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 40,
                              ),
                            ),
                          );
                        },
                      ),
              ),
              Container(
                padding: EdgeInsets.all(isLargeScreen ? 16 : 12),
                color: const Color(0xFF2A2A2A),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      artifact.name,
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: isLargeScreen ? 16 : 14,
                        fontWeight: FontWeight.bold,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    SizedBox(height: isLargeScreen ? 6 : 4),
                    Text(
                      artifact.description,
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: isLargeScreen ? 14 : 12,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showArtifactViewer(ArtifactItem artifact, int index) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => ArtifactViewerBottomSheet(
        artifacts: _filteredArtifacts,
        initialIndex: index,
        accentColor: const Color(0xFF7FB069),
      ),
    );
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }
}

// Legacy classes for backward compatibility
class ArtifactCategory {
  final String title;
  final String subtitle;
  final String imagePath;
  final List<Color> gradientColors;
  final List<ArtifactItem> artifacts;

  ArtifactCategory({
    required this.title,
    required this.subtitle,
    required this.imagePath,
    required this.gradientColors,
    required this.artifacts,
  });
}

class ArtifactGalleryScreen extends StatelessWidget {
  final ArtifactCategory category;
  final Color accentColor;

  const ArtifactGalleryScreen({
    super.key,
    required this.category,
    required this.accentColor,
  });

  void _showArtifactViewer(BuildContext context, int initialIndex) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => ArtifactViewerBottomSheet(
        artifacts: category.artifacts,
        initialIndex: initialIndex,
        accentColor: accentColor,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      resizeToAvoidBottomInset: true,
      backgroundColor: const Color(0xFF1a1a1a),
      body: SafeArea(
        child: Column(
          children: [
            _buildHeader(context),
            Expanded(
              child: Padding(
                padding: EdgeInsets.only(
                  left: 20,
                  right: 20,
                  top: 20,
                  bottom: 20 + MediaQuery.of(context).viewInsets.bottom,
                ),
                child: GridView.builder(
                  keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
                  gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                    crossAxisCount: 2,
                    crossAxisSpacing: 16,
                    mainAxisSpacing: 16,
                    childAspectRatio: 0.8,
                  ),
                  itemCount: category.artifacts.length,
                  itemBuilder: (context, index) {
                    return _buildArtifactCard(category.artifacts[index], index, context);
                  },
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.all(20),
      child: Row(
        children: [
          Container(
            decoration: BoxDecoration(
              color: Colors.black.withOpacity(0.3),
              borderRadius: BorderRadius.circular(12),
            ),
            child: IconButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                Navigator.pop(context);
              },
              icon: const Icon(
                Icons.arrow_back_ios,
                color: Colors.white,
                size: 20,
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Text(
              category.title.toUpperCase(),
              style: const TextStyle(
                color: Colors.white,
                fontSize: 18,
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildArtifactCard(ArtifactItem artifact, int index, BuildContext context) {
    return GestureDetector(
      onTap: () {
        HapticFeedback.mediumImpact();
        _showArtifactViewer(context, index);
      },
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: artifact.isNetworkSource
              ? Image.network(
                  artifact.imagePath,
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) {
                    return Container(
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: [
                            accentColor.withOpacity(0.7),
                            accentColor,
                          ],
                        ),
                      ),
                      child: const Center(
                        child: Icon(
                          Icons.museum,
                          color: Colors.white,
                          size: 40,
                        ),
                      ),
                    );
                  },
                )
              : Image.asset(
                  artifact.imagePath,
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) {
                    return Container(
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: [
                            accentColor.withOpacity(0.7),
                            accentColor,
                          ],
                        ),
                      ),
                      child: const Center(
                        child: Icon(
                          Icons.museum,
                          color: Colors.white,
                          size: 40,
                        ),
                      ),
                    );
                  },
                ),
        ),
      ),
    );
  }
}

class ArtifactItem {
  final String? id;
  final String name;
  final String description;
  final String imagePath;
  final String? file;
  final bool isNetworkSource;

  ArtifactItem({
    this.id,
    required this.name,
    required this.description,
    required this.imagePath,
    this.file,
    this.isNetworkSource = false,
  });
}

class ArtifactViewerBottomSheet extends StatefulWidget {
  final List<ArtifactItem> artifacts;
  final int initialIndex;
  final Color accentColor;

  const ArtifactViewerBottomSheet({
    super.key,
    required this.artifacts,
    required this.initialIndex,
    required this.accentColor,
  });

  @override
  State<ArtifactViewerBottomSheet> createState() => _ArtifactViewerBottomSheetState();
}

class _ArtifactViewerBottomSheetState extends State<ArtifactViewerBottomSheet> {
  late PageController _pageController;
  late int _currentIndex;

  @override
  void initState() {
    super.initState();
    _currentIndex = widget.initialIndex;
    _pageController = PageController(initialPage: widget.initialIndex);
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  double _getMaxHeight(BuildContext context) {
    final height = MediaQuery.of(context).size.height;
    final width = MediaQuery.of(context).size.width;
    if (width > 800) return height * 0.85;
    return height * 0.9;
  }

  @override
  Widget build(BuildContext context) {
    final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;
    final maxHeight = _getMaxHeight(context);
    final isLargeScreen = MediaQuery.of(context).size.width > 800;
    
    return Container(
      height: maxHeight,
      decoration: const BoxDecoration(
        color: Color(0xFF1a1a1a),
        borderRadius: BorderRadius.vertical(
          top: Radius.circular(20),
        ),
      ),
      child: Column(
        children: [
          _buildHandle(),
          _buildHeader(isLargeScreen),
          Expanded(
            child: PageView.builder(
              controller: _pageController,
              onPageChanged: (index) {
                setState(() {
                  _currentIndex = index;
                });
                HapticFeedback.selectionClick();
              },
              itemCount: widget.artifacts.length,
              itemBuilder: (context, index) {
                return _buildArtifactCard(widget.artifacts[index], isLargeScreen);
              },
            ),
          ),
          _buildPageIndicator(),
          SizedBox(height: 20 + keyboardHeight * 0.1),
        ],
      ),
    );
  }

  Widget _buildHandle() {
    return Container(
      margin: const EdgeInsets.only(top: 12, bottom: 8),
      width: 40,
      height: 4,
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.3),
        borderRadius: BorderRadius.circular(2),
      ),
    );
  }

  Widget _buildHeader(bool isLargeScreen) {
    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: isLargeScreen ? 32 : 20,
        vertical: 10,
      ),
      child: Row(
        children: [
          Text(
            'Artifact Details',
            style: TextStyle(
              color: Colors.white,
              fontSize: isLargeScreen ? 20 : 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.pop(context),
            icon: Icon(
              Icons.close,
              color: Colors.white,
              size: isLargeScreen ? 28 : 24,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildArtifactCard(ArtifactItem artifact, bool isLargeScreen) {
    final horizontalPadding = isLargeScreen ? 32.0 : 20.0;
    final imageHeight = isLargeScreen ? 400.0 : 250.0;
    
    return SingleChildScrollView(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          GestureDetector(
            onTap: () => _showFullScreenImage(artifact),
            child: Container(
              height: imageHeight,
              width: double.infinity,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.4),
                    blurRadius: 8,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(16),
                child: Stack(
                  children: [
                    artifact.isNetworkSource
                        ? Image.network(
                            artifact.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: const Center(
                                  child: Icon(
                                    Icons.museum,
                                    color: Colors.white,
                                    size: 60,
                                  ),
                                ),
                              );
                            },
                            loadingBuilder: (context, child, loadingProgress) {
                              if (loadingProgress == null) return child;
                              return Container(
                                color: const Color(0xFF2A2A2A),
                                child: const Center(
                                  child: CircularProgressIndicator(
                                    valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
                                  ),
                                ),
                              );
                            },
                          )
                        : Image.asset(
                            artifact.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: const Center(
                                  child: Icon(
                                    Icons.museum,
                                    color: Colors.white,
                                    size: 60,
                                  ),
                                ),
                              );
                            },
                          ),
                    Positioned(
                      top: 8,
                      right: 8,
                      child: Container(
                        padding: const EdgeInsets.all(6),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.6),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: const Icon(
                          Icons.fullscreen,
                          color: Colors.white,
                          size: 16,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: EdgeInsets.all(isLargeScreen ? 20 : 16),
            decoration: BoxDecoration(
              color: const Color(0xFF2A2A2A),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  artifact.name,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: isLargeScreen ? 18 : 16,
                    fontWeight: FontWeight.w600,
                    height: 1.4,
                  ),
                ),
                const SizedBox(height: 12),
                Text(
                  artifact.description,
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.9),
                    fontSize: isLargeScreen ? 16 : 14,
                    height: 1.5,
                  ),
                ),
              ],
            ),
          ),
          SizedBox(height: 30 + MediaQuery.of(context).viewInsets.bottom * 0.1),
        ],
      ),
    );
  }

  void _showFullScreenImage(ArtifactItem artifact) {
    Navigator.of(context).push(
      PageRouteBuilder(
        opaque: false,
        barrierColor: Colors.black,
        pageBuilder: (BuildContext context, _, __) {
          return FullScreenImageViewer(
            artifact: artifact,
            accentColor: widget.accentColor,
          );
        },
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
      ),
    );
  }

  Widget _buildPageIndicator() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: List.generate(
        widget.artifacts.length,
        (index) => Container(
          margin: const EdgeInsets.symmetric(horizontal: 4),
          width: 8,
          height: 8,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: index == _currentIndex
                ? widget.accentColor
                : Colors.white.withOpacity(0.3),
          ),
        ),
      ),
    );
  }
}

class FullScreenImageViewer extends StatefulWidget {
  final ArtifactItem artifact;
  final Color accentColor;

  const FullScreenImageViewer({
    super.key,
    required this.artifact,
    required this.accentColor,
  });

  @override
  State<FullScreenImageViewer> createState() => _FullScreenImageViewerState();
}

class _FullScreenImageViewerState extends State<FullScreenImageViewer> {
  bool _showControls = true;

  @override
  void initState() {
    super.initState();
    _hideControlsAfterDelay();
  }

  void _hideControlsAfterDelay() {
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        setState(() {
          _showControls = false;
        });
      }
    });
  }

  void _toggleControls() {
    setState(() {
      _showControls = !_showControls;
    });
    if (_showControls) {
      _hideControlsAfterDelay();
    }
  }

  @override
  Widget build(BuildContext context) {
    final isLargeScreen = MediaQuery.of(context).size.width > 800;
    
    return Scaffold(
      backgroundColor: Colors.black,
      body: GestureDetector(
        onTap: _toggleControls,
        child: Stack(
          children: [
            Center(
              child: InteractiveViewer(
                panEnabled: true,
                boundaryMargin: const EdgeInsets.all(20),
                minScale: 0.5,
                maxScale: 4.0,
                child: widget.artifact.isNetworkSource
                    ? Image.network(
                        widget.artifact.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            color: Colors.black,
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        widget.artifact.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                      ),
              ),
            ),
            AnimatedOpacity(
              opacity: _showControls ? 1.0 : 0.0,
              duration: const Duration(milliseconds: 300),
              child: SafeArea(
                child: Column(
                  children: [
                    Container(
                      width: double.infinity,
                      padding: EdgeInsets.symmetric(
                        horizontal: isLargeScreen ? 32 : 20,
                        vertical: 16,
                      ),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Row(
                        children: [
                          IconButton(
                            onPressed: () => Navigator.pop(context),
                            icon: Icon(
                              Icons.close,
                              color: Colors.white,
                              size: isLargeScreen ? 32 : 28,
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  widget.artifact.name,
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: isLargeScreen ? 20 : 18,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                Text(
                                  'Mandaya Artifact',
                                  style: TextStyle(
                                    color: widget.accentColor,
                                    fontSize: isLargeScreen ? 16 : 14,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                    const Spacer(),
                    Container(
                      width: double.infinity,
                      padding: EdgeInsets.all(isLargeScreen ? 32 : 20),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.bottomCenter,
                          end: Alignment.topCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Tap to zoom  Pinch to scale  Drag to pan',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.7),
                              fontSize: isLargeScreen ? 14 : 12,
                            ),
                            textAlign: TextAlign.center,
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mandaya_category_screens\mandaya_event_screen.dart
======================================

// lib/screen/mandaya_category_screens/mandaya_event_screen.dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

class MandayaEventScreen extends StatefulWidget {
  const MandayaEventScreen({super.key});

  @override
  State<MandayaEventScreen> createState() => _MandayaEventScreenState();
}

class _MandayaEventScreenState extends State<MandayaEventScreen> {
  final TextEditingController _searchController = TextEditingController();
  String _searchQuery = '';

  // API and loading state
  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<EventItem> _allEvents = [];
  bool _isLoading = true;
  String? _errorMessage;

  List<EventItem> get _filteredEvents {
    if (_searchQuery.isEmpty) {
      return _allEvents;
    }
    return _allEvents.where((event) {
      return event.name.toLowerCase().contains(_searchQuery.toLowerCase()) ||
             event.description.toLowerCase().contains(_searchQuery.toLowerCase()) ||
             event.location.toLowerCase().contains(_searchQuery.toLowerCase());
    }).toList();
  }

  // Responsive helper methods
  int _getCrossAxisCount(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 1200) return 4; // Desktop
    if (width >= 900) return 3;  // Tablet landscape
    if (width >= 600) return 2;  // Tablet portrait
    return 2;                     // Mobile
  }

  double _getHorizontalPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 1200) return 40;
    if (width >= 600) return 30;
    return 20;
  }

  double _getFeaturedImageHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 1200) return 300;
    if (width >= 600) return 250;
    return 200;
  }

  double _getFontSize(BuildContext context, double baseSize) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 1200) return baseSize * 1.2;
    if (width >= 600) return baseSize * 1.1;
    return baseSize;
  }

  @override
  void initState() {
    super.initState();
    _fetchEvents();
  }

  Future<void> _fetchEvents() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching Mandaya events from: $_baseUrl');
      
      const String apiUrl = '$_baseUrl?tribe=mandaya&category=event';
      debugPrint('API URL: $apiUrl');

      final response = await http.get(
        Uri.parse(apiUrl),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      ).timeout(const Duration(seconds: 15));
      
      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');
      
      if (response.statusCode != 200) {
        throw Exception('API returned status code: ${response.statusCode}');
      }

      final Map<String, dynamic> jsonData = json.decode(response.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      if (!jsonData.containsKey('data')) {
        throw Exception('API response missing "data" field');
      }

      final dynamic rawData = jsonData['data'];
      List<dynamic> contentItems = [];
      
      if (rawData is List) {
        contentItems = rawData;
      } else if (rawData is Map) {
        contentItems = [rawData];
      } else {
        throw Exception('Unexpected data format in API response');
      }

      debugPrint('Found ${contentItems.length} content items');

      final List<EventItem> events = [];

      for (var item in contentItems) {
        if (item == null || item is! Map<String, dynamic>) {
          debugPrint('Skipping invalid item: $item');
          continue;
        }
        
        debugPrint('Processing item: ${item.toString()}');
        
        final dynamic id = item['id'];
        final dynamic userId = item['user_id'];
        final String? title = item['title']?.toString();
        final String? category = item['category']?.toString();
        final String? tribe = item['tribe']?.toString();
        final String? description = item['description']?.toString();
        final String? file = item['file']?.toString();
        final dynamic isArchived = item['is_archived'];
        final String? time = item['time']?.toString();
        
        if (id == null || 
            userId == null || 
            title == null || title.isEmpty ||
            category == null || category.isEmpty ||
            tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty ||
            isArchived == null ||
            time == null || time.isEmpty) {
          debugPrint('Skipping item with missing required fields');
          continue;
        }
        
        if (tribe.toLowerCase() != 'mandaya') {
          debugPrint('Skipping non-Mandaya item: $tribe');
          continue;
        }

        if (isArchived != 0) {
          debugPrint('Skipping archived item: $title');
          continue;
        }

        if (category.toLowerCase() != 'event' && !_isImageContent(file)) {
          debugPrint('Skipping non-event content: $file (category: $category)');
          continue;
        }

        final event = EventItem(
          id: id.toString(),
          name: title,
          description: description ?? 'No description available',
          imagePath: '$_uploadsBaseUrl$file',
          file: file,
          location: 'Davao Oriental, Philippines',
          date: _formatDate(time),
          isNetworkSource: true,
        );
        
        debugPrint(' Added event: $title (ID: $id, Category: $category)');
        events.add(event);
      }

      debugPrint('Final event count: ${events.length}');

      setState(() {
        _allEvents = events;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching events: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load events: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  bool _isImageContent(String filename) {
    final String lowerFilename = filename.toLowerCase();
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    return imageExtensions.any((ext) => lowerFilename.endsWith(ext));
  }

  String _formatDate(String timeString) {
    try {
      final DateTime dateTime = DateTime.parse(timeString);
      final months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                     'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return '${months[dateTime.month - 1]} ${dateTime.day}, ${dateTime.year}';
    } catch (e) {
      return timeString;
    }
  }

  Future<void> _refreshEvents() async {
    await _fetchEvents();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              _buildHeader(),
              Expanded(
                child: _isLoading 
                    ? _buildLoadingState()
                    : _errorMessage != null 
                        ? _buildErrorState()
                        : _allEvents.isEmpty
                            ? _buildEmptyState()
                            : _buildContent(),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildLoadingState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const CircularProgressIndicator(
            valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
          ),
          const SizedBox(height: 16),
          Text(
            'Loading Mandaya events...',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: _getFontSize(context, 14),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildErrorState() {
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: _getHorizontalPadding(context)),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: _getFontSize(context, 64),
              color: Colors.white.withOpacity(0.5),
            ),
            const SizedBox(height: 16),
            Text(
              'Failed to load events',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: _getFontSize(context, 18),
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32),
              child: Text(
                _errorMessage!,
                style: TextStyle(
                  color: Colors.white.withOpacity(0.5),
                  fontSize: _getFontSize(context, 14),
                ),
                textAlign: TextAlign.center,
              ),
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: _refreshEvents,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF7FB069),
                foregroundColor: Colors.white,
                padding: EdgeInsets.symmetric(
                  horizontal: _getFontSize(context, 24),
                  vertical: _getFontSize(context, 12),
                ),
              ),
              child: Text(
                'Retry',
                style: TextStyle(fontSize: _getFontSize(context, 14)),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.event_outlined,
            size: _getFontSize(context, 64),
            color: Colors.white.withOpacity(0.5),
          ),
          const SizedBox(height: 16),
          Text(
            'No Mandaya events available',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: _getFontSize(context, 18),
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Check back later for new events',
            style: TextStyle(
              color: Colors.white.withOpacity(0.5),
              fontSize: _getFontSize(context, 14),
            ),
          ),
          const SizedBox(height: 24),
          ElevatedButton(
            onPressed: _refreshEvents,
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF7FB069),
              foregroundColor: Colors.white,
              padding: EdgeInsets.symmetric(
                horizontal: _getFontSize(context, 24),
                vertical: _getFontSize(context, 12),
              ),
            ),
            child: Text(
              'Refresh',
              style: TextStyle(fontSize: _getFontSize(context, 14)),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildContent() {
    final horizontalPadding = _getHorizontalPadding(context);
    final isDesktop = MediaQuery.of(context).size.width >= 1200;
    
    return RefreshIndicator(
      onRefresh: _refreshEvents,
      color: const Color(0xFF7FB069),
      child: LayoutBuilder(
        builder: (context, constraints) {
          return SingleChildScrollView(
            physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
            keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
            child: ConstrainedBox(
              constraints: BoxConstraints(
                maxWidth: isDesktop ? 1400 : double.infinity,
              ),
              child: Center(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildSearchBar(),
                    const SizedBox(height: 20),
                    _buildFeaturedImage(),
                    const SizedBox(height: 24),
                    _buildDescription(),
                    const SizedBox(height: 32),
                    _buildBrowseSection(),
                    const SizedBox(height: 20),
                    _buildEventsGrid(),
                    SizedBox(height: 40 + MediaQuery.of(context).viewInsets.bottom),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildHeader() {
    final horizontalPadding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.all(horizontalPadding),
      child: Row(
        children: [
          Container(
            decoration: BoxDecoration(
              color: Colors.black.withOpacity(0.3),
              borderRadius: BorderRadius.circular(12),
            ),
            child: IconButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                Navigator.pop(context);
              },
              icon: Icon(
                Icons.arrow_back_ios,
                color: Colors.white,
                size: _getFontSize(context, 20),
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Text(
              'MANDAYA EVENTS',
              style: TextStyle(
                color: Colors.white,
                fontSize: _getFontSize(context, 20),
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchBar() {
    final horizontalPadding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Container(
        constraints: const BoxConstraints(maxWidth: 800),
        decoration: BoxDecoration(
          color: const Color(0xFF2A2A2A),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: const Color(0xFF7FB069).withOpacity(0.3),
            width: 1,
          ),
        ),
        child: TextField(
          controller: _searchController,
          onChanged: (value) {
            setState(() {
              _searchQuery = value;
            });
          },
          style: TextStyle(
            color: Colors.white,
            fontSize: _getFontSize(context, 16),
          ),
          decoration: InputDecoration(
            hintText: 'Search events',
            hintStyle: TextStyle(
              color: Colors.white.withOpacity(0.6),
              fontSize: _getFontSize(context, 16),
            ),
            prefixIcon: Icon(
              Icons.search,
              color: Colors.white.withOpacity(0.6),
              size: _getFontSize(context, 24),
            ),
            suffixIcon: _searchQuery.isNotEmpty
                ? IconButton(
                    onPressed: () {
                      setState(() {
                        _searchController.clear();
                        _searchQuery = '';
                      });
                    },
                    icon: Icon(
                      Icons.clear,
                      color: Colors.white.withOpacity(0.6),
                      size: _getFontSize(context, 24),
                    ),
                  )
                : null,
            border: InputBorder.none,
            contentPadding: EdgeInsets.symmetric(
              horizontal: 16,
              vertical: _getFontSize(context, 16),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildFeaturedImage() {
    final horizontalPadding = _getHorizontalPadding(context);
    final imageHeight = _getFeaturedImageHeight(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Container(
        height: imageHeight,
        width: double.infinity,
        constraints: const BoxConstraints(maxWidth: 1200),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Image.asset(
            'assets/images/mandaya_eve.jpg',
            fit: BoxFit.cover,
            errorBuilder: (context, error, stackTrace) {
              return Container(
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      Color(0xFF7FB069),
                      Color(0xFF4A5D23),
                      Color(0xFF2F3E15),
                    ],
                  ),
                ),
                child: Center(
                  child: Icon(
                    Icons.event,
                    color: Colors.white,
                    size: _getFontSize(context, 60),
                  ),
                ),
              );
            },
          ),
        ),
      ),
    );
  }

  Widget _buildDescription() {
    final horizontalPadding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Container(
        constraints: const BoxConstraints(maxWidth: 1200),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'Browse through a collection of historical and contemporary photographs showcasing Mandaya events, ceremonies, and cultural celebrations that preserve their rich heritage.',
              style: TextStyle(
                color: Colors.white.withOpacity(0.9),
                fontSize: _getFontSize(context, 16),
                height: 1.6,
                letterSpacing: 0.5,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildBrowseSection() {
    final horizontalPadding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Text(
        'Browse events (${_filteredEvents.length})',
        style: TextStyle(
          color: Colors.white,
          fontSize: _getFontSize(context, 20),
          fontWeight: FontWeight.bold,
        ),
      ),
    );
  }

  Widget _buildEventsGrid() {
    if (_filteredEvents.isEmpty) {
      return _buildNoResults();
    }

    final horizontalPadding = _getHorizontalPadding(context);
    final crossAxisCount = _getCrossAxisCount(context);
    final spacing = MediaQuery.of(context).size.width >= 900 ? 20.0 : 16.0;

    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Container(
        constraints: const BoxConstraints(maxWidth: 1400),
        child: GridView.builder(
          shrinkWrap: true,
          physics: const NeverScrollableScrollPhysics(),
          gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
            crossAxisCount: crossAxisCount,
            crossAxisSpacing: spacing,
            mainAxisSpacing: spacing,
            childAspectRatio: 0.85,
          ),
          itemCount: _filteredEvents.length,
          itemBuilder: (context, index) {
            return _buildEventCard(_filteredEvents[index], index);
          },
        ),
      ),
    );
  }

  Widget _buildNoResults() {
    final horizontalPadding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const SizedBox(height: 60),
            Icon(
              Icons.search_off,
              size: _getFontSize(context, 64),
              color: Colors.white.withOpacity(0.3),
            ),
            const SizedBox(height: 16),
            Text(
              'No events found',
              style: TextStyle(
                color: Colors.white.withOpacity(0.6),
                fontSize: _getFontSize(context, 18),
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'Try searching with different keywords',
              style: TextStyle(
                color: Colors.white.withOpacity(0.4),
                fontSize: _getFontSize(context, 14),
              ),
            ),
            const SizedBox(height: 60),
          ],
        ),
      ),
    );
  }

  Widget _buildEventCard(EventItem event, int index) {
    final isLargeScreen = MediaQuery.of(context).size.width >= 900;
    
    return GestureDetector(
      onTap: () {
        HapticFeedback.mediumImpact();
        _showEventViewer(event, index);
      },
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              Expanded(
                flex: 3,
                child: event.isNetworkSource
                    ? Image.network(
                        event.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFF7FB069),
                                  Color(0xFF4A5D23),
                                ],
                              ),
                            ),
                            child: Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: isLargeScreen ? 50 : 40,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            color: const Color(0xFF2A2A2A),
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
                                strokeWidth: 2,
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        event.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFF7FB069),
                                  Color(0xFF4A5D23),
                                ],
                              ),
                            ),
                            child: Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: isLargeScreen ? 50 : 40,
                              ),
                            ),
                          );
                        },
                      ),
              ),
              Container(
                padding: EdgeInsets.all(isLargeScreen ? 16 : 12),
                color: const Color(0xFF2A2A2A),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      event.name,
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: _getFontSize(context, 14),
                        fontWeight: FontWeight.bold,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 4),
                    Text(
                      event.description,
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: _getFontSize(context, 12),
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showEventViewer(EventItem event, int index) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => EventViewerBottomSheet(
        events: _filteredEvents,
        initialIndex: index,
        accentColor: const Color(0xFF7FB069),
      ),
    );
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }
}

class EventItem {
  final String? id;
  final String name;
  final String description;
  final String imagePath;
  final String? file;
  final String location;
  final String date;
  final bool isNetworkSource;

  EventItem({
    this.id,
    required this.name,
    required this.description,
    required this.imagePath,
    this.file,
    required this.location,
    required this.date,
    this.isNetworkSource = false,
  });
}

class EventViewerBottomSheet extends StatefulWidget {
  final List<EventItem> events;
  final int initialIndex;
  final Color accentColor;

  const EventViewerBottomSheet({
    super.key,
    required this.events,
    required this.initialIndex,
    required this.accentColor,
  });

  @override
  State<EventViewerBottomSheet> createState() => _EventViewerBottomSheetState();
}

class _EventViewerBottomSheetState extends State<EventViewerBottomSheet> {
  late PageController _pageController;
  late int _currentIndex;

  @override
  void initState() {
    super.initState();
    _currentIndex = widget.initialIndex;
    _pageController = PageController(initialPage: widget.initialIndex);
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  double _getFontSize(BuildContext context, double baseSize) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 1200) return baseSize * 1.2;
    if (width >= 600) return baseSize * 1.1;
    return baseSize;
  }

  double _getHorizontalPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 1200) return 40;
    if (width >= 600) return 30;
    return 20;
  }

  @override
  Widget build(BuildContext context) {
    final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;
    final screenHeight = MediaQuery.of(context).size.height;
    final maxHeight = screenHeight * 0.9;
    
    return Container(
      constraints: BoxConstraints(maxHeight: maxHeight),
      decoration: const BoxDecoration(
        color: Color(0xFF1a1a1a),
        borderRadius: BorderRadius.vertical(
          top: Radius.circular(20),
        ),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          _buildHandle(),
          _buildHeader(),
          Flexible(
            child: PageView.builder(
              controller: _pageController,
              onPageChanged: (index) {
                setState(() {
                  _currentIndex = index;
                });
                HapticFeedback.selectionClick();
              },
              itemCount: widget.events.length,
              itemBuilder: (context, index) {
                return _buildEventCard(widget.events[index]);
              },
            ),
          ),
          _buildPageIndicator(),
          SizedBox(height: 20 + keyboardHeight * 0.1),
        ],
      ),
    );
  }

  Widget _buildHandle() {
    return Container(
      margin: const EdgeInsets.only(top: 12, bottom: 8),
      width: 40,
      height: 4,
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.3),
        borderRadius: BorderRadius.circular(2),
      ),
    );
  }

  Widget _buildHeader() {
    final horizontalPadding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding, vertical: 10),
      child: Row(
        children: [
          Text(
            'Event Details',
            style: TextStyle(
              color: Colors.white,
              fontSize: _getFontSize(context, 18),
              fontWeight: FontWeight.bold,
            ),
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.pop(context),
            icon: Icon(
              Icons.close,
              color: Colors.white,
              size: _getFontSize(context, 24),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEventCard(EventItem event) {
    final horizontalPadding = _getHorizontalPadding(context);
    final screenWidth = MediaQuery.of(context).size.width;
    final imageHeight = screenWidth >= 900 ? 350.0 : screenWidth >= 600 ? 300.0 : 250.0;
    
    return SingleChildScrollView(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          GestureDetector(
            onTap: () => _showFullScreenImage(event),
            child: Container(
              height: imageHeight,
              width: double.infinity,
              constraints: const BoxConstraints(maxWidth: 800),
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.4),
                    blurRadius: 8,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(16),
                child: Stack(
                  children: [
                    event.isNetworkSource
                        ? Image.network(
                            event.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: Center(
                                  child: Icon(
                                    Icons.event,
                                    color: Colors.white,
                                    size: _getFontSize(context, 60),
                                  ),
                                ),
                              );
                            },
                            loadingBuilder: (context, child, loadingProgress) {
                              if (loadingProgress == null) return child;
                              return Container(
                                color: const Color(0xFF2A2A2A),
                                child: const Center(
                                  child: CircularProgressIndicator(
                                    valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
                                  ),
                                ),
                              );
                            },
                          )
                        : Image.asset(
                            event.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: Center(
                                  child: Icon(
                                    Icons.event,
                                    color: Colors.white,
                                    size: _getFontSize(context, 60),
                                  ),
                                ),
                              );
                            },
                          ),
                    Positioned(
                      top: 8,
                      right: 8,
                      child: Container(
                        padding: const EdgeInsets.all(6),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.6),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Icon(
                          Icons.fullscreen,
                          color: Colors.white,
                          size: _getFontSize(context, 16),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            constraints: const BoxConstraints(maxWidth: 800),
            padding: EdgeInsets.all(_getFontSize(context, 16)),
            decoration: BoxDecoration(
              color: const Color(0xFF2A2A2A),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  event.name,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: _getFontSize(context, 16),
                    fontWeight: FontWeight.w600,
                    height: 1.4,
                  ),
                ),
                const SizedBox(height: 12),
                Text(
                  event.description,
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.9),
                    fontSize: _getFontSize(context, 14),
                    height: 1.5,
                  ),
                ),
              ],
            ),
          ),
          SizedBox(height: 30 + MediaQuery.of(context).viewInsets.bottom * 0.1),
        ],
      ),
    );
  }

  void _showFullScreenImage(EventItem event) {
    Navigator.of(context).push(
      PageRouteBuilder(
        opaque: false,
        barrierColor: Colors.black,
        pageBuilder: (BuildContext context, _, __) {
          return FullScreenImageViewer(
            event: event,
            accentColor: widget.accentColor,
          );
        },
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
      ),
    );
  }

  Widget _buildPageIndicator() {
    final indicatorSize = MediaQuery.of(context).size.width >= 600 ? 10.0 : 8.0;
    
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: List.generate(
        widget.events.length,
        (index) => Container(
          margin: const EdgeInsets.symmetric(horizontal: 4),
          width: indicatorSize,
          height: indicatorSize,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: index == _currentIndex
                ? widget.accentColor
                : Colors.white.withOpacity(0.3),
          ),
        ),
      ),
    );
  }
}

class FullScreenImageViewer extends StatefulWidget {
  final EventItem event;
  final Color accentColor;

  const FullScreenImageViewer({
    super.key,
    required this.event,
    required this.accentColor,
  });

  @override
  State<FullScreenImageViewer> createState() => _FullScreenImageViewerState();
}

class _FullScreenImageViewerState extends State<FullScreenImageViewer> {
  bool _showControls = true;

  @override
  void initState() {
    super.initState();
    _hideControlsAfterDelay();
  }

  void _hideControlsAfterDelay() {
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        setState(() {
          _showControls = false;
        });
      }
    });
  }

  void _toggleControls() {
    setState(() {
      _showControls = !_showControls;
    });
    if (_showControls) {
      _hideControlsAfterDelay();
    }
  }

  double _getFontSize(BuildContext context, double baseSize) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 1200) return baseSize * 1.2;
    if (width >= 600) return baseSize * 1.1;
    return baseSize;
  }

  @override
  Widget build(BuildContext context) {
    final isLargeScreen = MediaQuery.of(context).size.width >= 900;
    
    return Scaffold(
      backgroundColor: Colors.black,
      body: GestureDetector(
        onTap: _toggleControls,
        child: Stack(
          children: [
            Center(
              child: InteractiveViewer(
                panEnabled: true,
                boundaryMargin: EdgeInsets.all(isLargeScreen ? 40 : 20),
                minScale: 0.5,
                maxScale: 4.0,
                child: widget.event.isNetworkSource
                    ? Image.network(
                        widget.event.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: _getFontSize(context, 100),
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            color: Colors.black,
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        widget.event.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: _getFontSize(context, 100),
                              ),
                            ),
                          );
                        },
                      ),
              ),
            ),
            AnimatedOpacity(
              opacity: _showControls ? 1.0 : 0.0,
              duration: const Duration(milliseconds: 300),
              child: SafeArea(
                child: Column(
                  children: [
                    Container(
                      width: double.infinity,
                      padding: EdgeInsets.symmetric(
                        horizontal: isLargeScreen ? 30 : 20,
                        vertical: isLargeScreen ? 20 : 16,
                      ),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Row(
                        children: [
                          IconButton(
                            onPressed: () => Navigator.pop(context),
                            icon: Icon(
                              Icons.close,
                              color: Colors.white,
                              size: _getFontSize(context, 28),
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  widget.event.name,
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: _getFontSize(context, 18),
                                    fontWeight: FontWeight.bold,
                                  ),
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                ),
                                Text(
                                  'Mandaya Event',
                                  style: TextStyle(
                                    color: widget.accentColor,
                                    fontSize: _getFontSize(context, 14),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                    const Spacer(),
                    Container(
                      width: double.infinity,
                      padding: EdgeInsets.all(isLargeScreen ? 30 : 20),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.bottomCenter,
                          end: Alignment.topCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Text(
                        'Tap to zoom  Pinch to scale  Drag to pan',
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: _getFontSize(context, 12),
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mandaya_category_screens\mandaya_music_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:audioplayers/audioplayers.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';

class MandayaMusicScreen extends StatefulWidget {
  const MandayaMusicScreen({super.key});

  @override
  State<MandayaMusicScreen> createState() => _MandayaMusicScreenState();
}

class _MandayaMusicScreenState extends State<MandayaMusicScreen> {
  String _searchQuery = '';
  final TextEditingController _searchController = TextEditingController();
  final FocusNode _searchFocusNode = FocusNode();
  bool _isSearchFocused = false;
  
  // Scroll controller and visibility state
  final ScrollController _scrollController = ScrollController();
  bool _isHeaderVisible = true;
  double _lastScrollOffset = 0;

  // Audio player related variables
  final AudioPlayer _audioPlayer = AudioPlayer();
  MusicTrack? _currentTrack;
  bool _isPlaying = false;
  Duration _currentPosition = Duration.zero;
  Duration _totalDuration = Duration.zero;
  bool _isLoadingAudio = false;

  // API and loading state
  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<MusicTrack> _allTracks = [];
  bool _isLoading = true;
  String? _errorMessage;
  MusicTrack? _featuredTrack;

  // Duration cache
  Map<String, Duration> _durationCache = {};
  SharedPreferences? _prefs;
  final Set<String> _loadingDurations = {};

  List<MusicTrack> get _filteredTracks {
    if (_searchQuery.isEmpty) {
      return _allTracks;
    }
    
    return _allTracks.where((track) =>
        track.title.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        track.description.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        track.category.toLowerCase().contains(_searchQuery.toLowerCase())).toList();
  }

  @override
  void initState() {
    super.initState();
    _initializePreferences();
    _setupAudioPlayer();
    _setupScrollController();
    _searchFocusNode.addListener(() {
      setState(() {
        _isSearchFocused = _searchFocusNode.hasFocus;
      });
    });
    _fetchMusicTracks();
  }

  Future<void> _initializePreferences() async {
    _prefs = await SharedPreferences.getInstance();
    _loadDurationCache();
  }

  void _loadDurationCache() {
    if (_prefs == null) return;
    
    final cacheJson = _prefs!.getString('mandaya_music_duration_cache');
    if (cacheJson != null) {
      try {
        final Map<String, dynamic> decoded = json.decode(cacheJson);
        _durationCache = decoded.map((key, value) => 
          MapEntry(key, Duration(milliseconds: value as int))
        );
        debugPrint('Loaded ${_durationCache.length} cached Mandaya durations');
      } catch (e) {
        debugPrint('Error loading duration cache: $e');
      }
    }
  }

  Future<void> _saveDurationCache() async {
    if (_prefs == null) return;
    
    try {
      final cacheJson = json.encode(
        _durationCache.map((key, value) => 
          MapEntry(key, value.inMilliseconds)
        )
      );
      await _prefs!.setString('mandaya_music_duration_cache', cacheJson);
      debugPrint('Saved ${_durationCache.length} Mandaya durations to cache');
    } catch (e) {
      debugPrint('Error saving duration cache: $e');
    }
  }

  Duration? _getCachedDuration(String trackId) {
    return _durationCache[trackId];
  }

  Future<void> _cacheDuration(String trackId, Duration duration) async {
    _durationCache[trackId] = duration;
    await _saveDurationCache();
  }

  Future<void> _loadTrackDuration(MusicTrack track) async {
    if (_durationCache.containsKey(track.id) || _loadingDurations.contains(track.id)) {
      return;
    }

    _loadingDurations.add(track.id);

    try {
      final tempPlayer = AudioPlayer();
      
      if (track.isNetworkSource) {
        await tempPlayer.setSourceUrl(track.audioPath);
      } else {
        await tempPlayer.setSource(AssetSource(track.audioPath));
      }

      Duration? duration;
      int attempts = 0;
      while (duration == null && attempts < 10) {
        duration = await tempPlayer.getDuration();
        if (duration == null) {
          await Future.delayed(const Duration(milliseconds: 200));
        }
        attempts++;
      }

      if (duration != null && duration.inMilliseconds > 0) {
        await _cacheDuration(track.id, duration);
        if (mounted) {
          setState(() {
            final index = _allTracks.indexWhere((t) => t.id == track.id);
            if (index != -1) {
              _allTracks[index] = track.copyWith(duration: duration);
            }
          });
        }
        debugPrint('Cached duration for ${track.title}: ${_formatDuration(duration)}');
      }

      await tempPlayer.dispose();
    } catch (e) {
      debugPrint('Error loading duration for ${track.title}: $e');
    } finally {
      _loadingDurations.remove(track.id);
    }
  }

  void _setupScrollController() {
    _scrollController.addListener(() {
      final currentOffset = _scrollController.offset;
      final isScrollingDown = currentOffset > _lastScrollOffset;
      final shouldHideHeader = isScrollingDown && currentOffset > 100;
      final shouldShowHeader = !isScrollingDown || currentOffset <= 50;

      if (_isHeaderVisible && shouldHideHeader && !_isSearchFocused) {
        setState(() {
          _isHeaderVisible = false;
        });
      } else if (!_isHeaderVisible && shouldShowHeader) {
        setState(() {
          _isHeaderVisible = true;
        });
      }

      _lastScrollOffset = currentOffset;
    });
  }

  void _setupAudioPlayer() {
    _audioPlayer.onPositionChanged.listen((position) {
      if (mounted) {
        setState(() {
          _currentPosition = position;
        });
      }
    });

    _audioPlayer.onDurationChanged.listen((duration) {
      if (mounted) {
        setState(() {
          _totalDuration = duration;
        });
      }
      
      if (_currentTrack != null && duration.inMilliseconds > 0) {
        _cacheDuration(_currentTrack!.id, duration);
      }
    });

    _audioPlayer.onPlayerStateChanged.listen((state) {
      if (mounted) {
        setState(() {
          _isPlaying = state == PlayerState.playing;
          _isLoadingAudio = state == PlayerState.playing && _currentPosition == Duration.zero;
        });
      }
    });

    _audioPlayer.onPlayerComplete.listen((_) {
      if (mounted) {
        setState(() {
          _isPlaying = false;
          _currentPosition = Duration.zero;
        });
      }
    });
  }

  Future<void> _fetchMusicTracks() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching Mandaya music tracks from: $_baseUrl');
      
      const String apiUrl = '$_baseUrl?tribe=mandaya';
      debugPrint('API URL: $apiUrl');

      final response = await http.get(
        Uri.parse(apiUrl),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      ).timeout(const Duration(seconds: 15));
      
      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');
      
      if (response.statusCode != 200) {
        throw Exception('API returned status code: ${response.statusCode}');
      }

      final Map<String, dynamic> jsonData = json.decode(response.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      if (!jsonData.containsKey('data')) {
        throw Exception('API response missing "data" field');
      }

      final dynamic rawData = jsonData['data'];
      List<dynamic> contentItems = [];
      
      if (rawData is List) {
        contentItems = rawData;
      } else if (rawData is Map) {
        contentItems = [rawData];
      } else {
        throw Exception('Unexpected data format in API response');
      }

      debugPrint('Found ${contentItems.length} content items');

      final List<MusicTrack> musicTracks = [];

      for (var item in contentItems) {
        if (item == null || item is! Map<String, dynamic>) {
          debugPrint('Skipping invalid item: $item');
          continue;
        }
        
        debugPrint('Processing item: ${item.toString()}');
        
        final dynamic id = item['id'];
        final dynamic userId = item['user_id'];
        final String? title = item['title']?.toString();
        final String? category = item['category']?.toString();
        final String? tribe = item['tribe']?.toString();
        final String? description = item['description']?.toString();
        final String? file = item['file']?.toString();
        final dynamic isArchived = item['is_archived'];
        final String? time = item['time']?.toString();
        
        if (id == null || 
            userId == null || 
            title == null || title.isEmpty ||
            category == null || category.isEmpty ||
            tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty ||
            isArchived == null ||
            time == null || time.isEmpty) {
          debugPrint('Skipping item with missing required fields');
          continue;
        }
        
        if (tribe.toLowerCase() != 'mandaya') {
          debugPrint('Skipping non-Mandaya item: $tribe');
          continue;
        }

        if (isArchived != 0) {
          debugPrint('Skipping archived item: $title');
          continue;
        }

        final fileType = _determineFileType(file);
        
        if (!_isAudioContent(file, category)) {
          debugPrint('Skipping non-audio content: $file (category: $category, type: $fileType)');
          continue;
        }

        final cachedDuration = _getCachedDuration(id.toString());

        final musicTrack = MusicTrack(
          id: id.toString(),
          title: title,
          description: description ?? 'No description available',
          category: _mapCategory(category),
          imagePath: _buildThumbnailUrl(file, category),
          artist: _extractArtist(description, title),
          audioPath: '$_uploadsBaseUrl$file',
          file: file,
          fileType: fileType,
          isNetworkSource: true,
          duration: cachedDuration,
        );
        
        debugPrint(' Added music track: $title (ID: $id, Category: $category, Cached Duration: ${cachedDuration != null ? _formatDuration(cachedDuration) : 'Not cached'})');
        musicTracks.add(musicTrack);

        if (cachedDuration == null) {
          _loadTrackDuration(musicTrack);
        }
      }

      debugPrint('Final music track count: ${musicTracks.length}');

      setState(() {
        _allTracks = musicTracks;
        _featuredTrack = musicTracks.isNotEmpty ? musicTracks.first : null;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching music tracks: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load music tracks: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  bool _isAudioContent(String filename, String category) {
    final String lowerFilename = filename.toLowerCase();
    final String lowerCategory = category.toLowerCase();
    
    const audioExtensions = ['.mp3', '.wav', '.aac', '.ogg', '.m4a', '.flac'];
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv'];
    
    final hasAudioExtension = audioExtensions.any((ext) => lowerFilename.endsWith(ext));
    final hasVideoExtension = videoExtensions.any((ext) => lowerFilename.endsWith(ext));
    
    const musicCategories = ['audio', 'music', 'song', 'instrument', 'ceremony'];
    final isMusicCategory = musicCategories.any((cat) => lowerCategory.contains(cat));
    
    return hasAudioExtension || (hasVideoExtension && isMusicCategory);
  }

  String _buildThumbnailUrl(String filename, String category) {
    if (_isAudioContent(filename, category)) {
      return 'assets/images/mandaya_default_music.jpg';
    }
    
    final String lowerFilename = filename.toLowerCase();
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    
    if (imageExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return '$_uploadsBaseUrl$filename';
    }
    
    return 'assets/images/mandaya_default_music.jpg';
  }

  FileType _determineFileType(String filename) {
    final String lowerFilename = filename.toLowerCase();
    
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv', '.flv', '.wmv'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const audioExtensions = ['.mp3', '.wav', '.aac', '.ogg', '.m4a', '.flac'];
    
    if (audioExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.audio;
    } else if (videoExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.video;
    } else if (imageExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.image;
    }
    
    return FileType.unknown;
  }

  String _mapCategory(String category) {
    switch (category.toLowerCase()) {
      case 'audio':
        return 'Traditional Music';
      case 'instrument':
        return 'Instrumental';
      case 'ceremony':
        return 'Ceremonial';
      case 'video':
        return 'Audio/Video';
      case 'music':
        return 'Music';
      case 'song':
        return 'Song';
      default:
        return category;
    }
  }

  String _extractArtist(String? description, String title) {
    if (description != null && description.isNotEmpty) {
      final RegExp artistPattern = RegExp(r'(?:by|artist|performed by|sung by)\s+([^,\.\-\n]+)', caseSensitive: false);
      final match = artistPattern.firstMatch(description);
      if (match != null && match.group(1) != null) {
        return match.group(1)!.trim();
      }
      
      if (description.length < 50 && 
          !description.toLowerCase().contains(RegExp(r'\b(the|a|an|and|or|but|in|on|at|to|for|of|with|by)\b'))) {
        return description.trim();
      }
    }
    
    final lowerTitle = title.toLowerCase();
    if (lowerTitle.contains(RegExp(r'\b(elder|traditional|ancestral|ancient)\b'))) {
      return 'Mandaya Elders';
    } else if (lowerTitle.contains(RegExp(r'\b(ritual|ceremony|ceremonial|sacred)\b'))) {
      return 'Tribal Ensemble';
    } else if (lowerTitle.contains(RegExp(r'\b(instrument|instrumental|music)\b'))) {
      return 'Mandaya Musicians';
    }
    
    return 'Mandaya Artist';
  }

  Future<void> _refreshMusicTracks() async {
    await _fetchMusicTracks();
  }

  // Helper method to get responsive values
  double _getResponsiveValue(BuildContext context, {
    required double mobile,
    required double tablet,
    required double desktop,
  }) {
    final width = MediaQuery.of(context).size.width;
    if (width < 600) return mobile;
    if (width < 1024) return tablet;
    return desktop;
  }

  // Helper method to check if device is tablet or larger
  bool _isTabletOrLarger(BuildContext context) {
    return MediaQuery.of(context).size.width >= 600;
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final isTablet = screenWidth >= 600;
    final isDesktop = screenWidth >= 1024;

    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              AnimatedContainer(
                duration: const Duration(milliseconds: 300),
                height: (_isHeaderVisible || _isSearchFocused) 
                    ? _getResponsiveValue(context, mobile: 80, tablet: 90, desktop: 100)
                    : 0,
                child: (_isHeaderVisible || _isSearchFocused) 
                    ? _buildHeader(context) 
                    : const SizedBox.shrink(),
              ),
              
              Expanded(
                child: _isSearchFocused 
                    ? _buildSearchResults()
                    : _buildMainContent(),
              ),
              
              if (_currentTrack != null) _buildInlineMusicPlayer(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeader(BuildContext context) {
    final isTablet = _isTabletOrLarger(context);
    
    return Container(
      padding: EdgeInsets.all(isTablet ? 20 : 16),
      child: Row(
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 0 : (isTablet ? 56 : 48),
            child: _isSearchFocused 
                ? const SizedBox.shrink()
                : Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: isTablet ? 24 : 20,
                      ),
                    ),
                  ),
          ),
          
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 0 : 16,
          ),
          
          Expanded(
            child: Container(
              height: isTablet ? 56 : 48,
              decoration: BoxDecoration(
                color: const Color(0xFF2A2A2A),
                borderRadius: BorderRadius.circular(isTablet ? 28 : 24),
                border: Border.all(
                  color: _isSearchFocused 
                      ? const Color(0xFF7FB069) 
                      : const Color(0xFF7FB069).withOpacity(0.3),
                  width: _isSearchFocused ? 2 : 1,
                ),
              ),
              child: TextField(
                controller: _searchController,
                focusNode: _searchFocusNode,
                style: TextStyle(
                  color: Colors.white,
                  fontSize: isTablet ? 16 : 14,
                ),
                scrollPhysics: const BouncingScrollPhysics(),
                decoration: InputDecoration(
                  hintText: 'Search music tracks...',
                  hintStyle: TextStyle(
                    color: Colors.white.withOpacity(0.6),
                    fontSize: isTablet ? 16 : 14,
                  ),
                  prefixIcon: Icon(
                    Icons.search,
                    color: _isSearchFocused 
                        ? const Color(0xFF7FB069)
                        : Colors.white.withOpacity(0.6),
                    size: isTablet ? 26 : 22,
                  ),
                  suffixIcon: _searchQuery.isNotEmpty
                      ? IconButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {
                              _searchQuery = '';
                            });
                          },
                          icon: Icon(
                            Icons.clear,
                            color: Colors.white.withOpacity(0.6),
                            size: isTablet ? 24 : 20,
                          ),
                        )
                      : null,
                  border: InputBorder.none,
                  contentPadding: EdgeInsets.symmetric(
                    horizontal: isTablet ? 20 : 16,
                    vertical: isTablet ? 16 : 12,
                  ),
                ),
                onChanged: (value) {
                  setState(() {
                    _searchQuery = value;
                  });
                },
              ),
            ),
          ),
          
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 80 : 0,
            child: _isSearchFocused
                ? TextButton(
                    onPressed: () {
                      _searchController.clear();
                      _searchFocusNode.unfocus();
                      setState(() {
                        _searchQuery = '';
                        _isHeaderVisible = true;
                      });
                    },
                    child: Text(
                      'Cancel',
                      style: TextStyle(
                        color: const Color(0xFF7FB069),
                        fontWeight: FontWeight.w500,
                        fontSize: isTablet ? 16 : 14,
                      ),
                    ),
                  )
                : const SizedBox.shrink(),
          ),
        ],
      ),
    );
  }

  Widget _buildMainContent() {
    final isTablet = _isTabletOrLarger(context);
    
    if (_isLoading) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            SizedBox(
              width: isTablet ? 60 : 48,
              height: isTablet ? 60 : 48,
              child: const CircularProgressIndicator(
                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
                strokeWidth: 3,
              ),
            ),
            SizedBox(height: isTablet ? 24 : 16),
            Text(
              'Loading Mandaya music tracks...',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: isTablet ? 16 : 14,
              ),
            ),
          ],
        ),
      );
    }

    if (_errorMessage != null) {
      return Center(
        child: Padding(
          padding: EdgeInsets.all(isTablet ? 48 : 32),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                Icons.error_outline,
                size: isTablet ? 80 : 64,
                color: Colors.white.withOpacity(0.5),
              ),
              SizedBox(height: isTablet ? 24 : 16),
              Text(
                'Failed to load music tracks',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.7),
                  fontSize: isTablet ? 22 : 18,
                  fontWeight: FontWeight.w500,
                ),
              ),
              SizedBox(height: isTablet ? 12 : 8),
              Text(
                _errorMessage!,
                style: TextStyle(
                  color: Colors.white.withOpacity(0.5),
                  fontSize: isTablet ? 16 : 14,
                ),
                textAlign: TextAlign.center,
              ),
              SizedBox(height: isTablet ? 32 : 24),
              ElevatedButton(
                onPressed: _refreshMusicTracks,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF7FB069),
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(
                    horizontal: isTablet ? 32 : 24,
                    vertical: isTablet ? 16 : 12,
                  ),
                  textStyle: TextStyle(
                    fontSize: isTablet ? 16 : 14,
                  ),
                ),
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      );
    }

    if (_allTracks.isEmpty) {
      return Center(
        child: Padding(
          padding: EdgeInsets.all(isTablet ? 48 : 32),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                Icons.music_note_outlined,
                size: isTablet ? 80 : 64,
                color: Colors.white.withOpacity(0.5),
              ),
              SizedBox(height: isTablet ? 24 : 16),
              Text(
                'No Mandaya music tracks available',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.7),
                  fontSize: isTablet ? 22 : 18,
                  fontWeight: FontWeight.w500,
                ),
                textAlign: TextAlign.center,
              ),
              SizedBox(height: isTablet ? 12 : 8),
              Text(
                'Check back later for new music content',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.5),
                  fontSize: isTablet ? 16 : 14,
                ),
              ),
              SizedBox(height: isTablet ? 32 : 24),
              ElevatedButton(
                onPressed: _refreshMusicTracks,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF7FB069),
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(
                    horizontal: isTablet ? 32 : 24,
                    vertical: isTablet ? 16 : 12,
                  ),
                  textStyle: TextStyle(
                    fontSize: isTablet ? 16 : 14,
                  ),
                ),
                child: const Text('Refresh'),
              ),
            ],
          ),
        ),
      );
    }

    return RefreshIndicator(
      onRefresh: _refreshMusicTracks,
      color: const Color(0xFF7FB069),
      child: CustomScrollView(
        controller: _scrollController,
        physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
        slivers: [
          SliverToBoxAdapter(
            child: _buildHeroSection(),
          ),
          SliverPadding(
            padding: EdgeInsets.symmetric(
              horizontal: _getResponsiveValue(context, mobile: 0, tablet: 24, desktop: 48),
            ),
            sliver: SliverList(
              delegate: SliverChildBuilderDelegate(
                (context, index) {
                  final track = _filteredTracks[index];
                  return _buildMusicCard(track);
                },
                childCount: _filteredTracks.length,
              ),
            ),
          ),
          SliverToBoxAdapter(
            child: SizedBox(height: _currentTrack != null ? 140 : 20),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchResults() {
    final isTablet = _isTabletOrLarger(context);
    
    return Column(
      children: [
        if (_searchQuery.isNotEmpty)
          Padding(
            padding: EdgeInsets.symmetric(
              horizontal: isTablet ? 24 : 16,
              vertical: isTablet ? 12 : 8,
            ),
            child: Row(
              children: [
                Text(
                  '${_filteredTracks.length} result${_filteredTracks.length == 1 ? '' : 's'} for "$_searchQuery"',
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.7),
                    fontSize: isTablet ? 16 : 14,
                  ),
                ),
              ],
            ),
          ),
        
        Expanded(
          child: _searchQuery.isEmpty
              ? Center(
                  child: Text(
                    'Start typing to search...',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.5),
                      fontSize: isTablet ? 18 : 16,
                    ),
                  ),
                )
              : _filteredTracks.isEmpty
                  ? Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            Icons.search_off,
                            size: isTablet ? 64 : 48,
                            color: Colors.white.withOpacity(0.3),
                          ),
                          SizedBox(height: isTablet ? 20 : 16),
                          Text(
                            'No tracks found',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.5),
                              fontSize: isTablet ? 20 : 18,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          SizedBox(height: isTablet ? 12 : 8),
                          Text(
                            'Try different keywords',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.3),
                              fontSize: isTablet ? 16 : 14,
                            ),
                          ),
                        ],
                      ),
                    )
                  : ListView.builder(
                      physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
                      padding: EdgeInsets.only(
                        left: isTablet ? 24 : 0,
                        right: isTablet ? 24 : 0,
                        bottom: MediaQuery.of(context).viewInsets.bottom + (_currentTrack != null ? 140 : 20),
                      ),
                      itemCount: _filteredTracks.length,
                      itemBuilder: (context, index) {
                        final track = _filteredTracks[index];
                        return _buildMusicCard(track);
                      },
                    ),
        ),
      ],
    );
  }

  Widget _buildHeroSection() {
    final screenWidth = MediaQuery.of(context).size.width;
    final isTablet = screenWidth >= 600;
    final isDesktop = screenWidth >= 1024;
    
    final height = isDesktop ? 300.0 : (isTablet ? 250.0 : 200.0);
    final margin = EdgeInsets.symmetric(
      horizontal: isDesktop ? 48 : (isTablet ? 24 : 16),
      vertical: isTablet ? 20 : 16,
    );
    
    return Container(
      margin: margin,
      height: height,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(isTablet ? 20 : 16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.4),
            blurRadius: isTablet ? 12 : 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(isTablet ? 20 : 16),
        child: Stack(
          children: [
            Image.asset(
              'assets/images/mandaya_mus.jpg',
              fit: BoxFit.cover,
              width: double.infinity,
              height: double.infinity,
              errorBuilder: (context, error, stackTrace) {
                return Container(
                  decoration: const BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color(0xFF7FB069),
                        Color(0xFF6B8E23),
                        Color(0xFF556B2F),
                      ],
                    ),
                  ),
                );
              },
            ),
            
            Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  colors: [
                    Colors.black.withOpacity(0.1),
                    Colors.black.withOpacity(0.7),
                  ],
                ),
              ),
            ),
            
            Positioned(
              bottom: 0,
              left: 0,
              right: 0,
              child: Container(
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                    colors: [
                      Colors.transparent,
                      Colors.black.withOpacity(0.8),
                    ],
                  ),
                ),
                padding: EdgeInsets.all(isTablet ? 24 : 20),
                child: Container(
                  padding: EdgeInsets.all(isTablet ? 20 : 16),
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(isTablet ? 16 : 12),
                    border: Border.all(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  child: Text(
                    'Experience the rich musical traditions of the Mandaya people. From epic dagit chants to ceremonial dances, each melody tells the story of their ancestral heritage and connection to nature.',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.95),
                      fontSize: isDesktop ? 16 : (isTablet ? 15 : 14),
                      height: 1.4,
                      fontWeight: FontWeight.w500,
                    ),
                    maxLines: isDesktop ? 4 : 3,
                    overflow: TextOverflow.ellipsis,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMusicCard(MusicTrack track) {
    final isCurrentTrack = _currentTrack?.id == track.id;
    final hasDuration = track.duration != null;
    final isLoadingDuration = _loadingDurations.contains(track.id);
    final isTablet = _isTabletOrLarger(context);
    
    final cardPadding = isTablet ? 16.0 : 12.0;
    final imageSize = isTablet ? 70.0 : 60.0;
    final playButtonSize = isTablet ? 48.0 : 40.0;
    
    return Container(
      margin: EdgeInsets.symmetric(
        horizontal: isTablet ? 0 : 16,
        vertical: isTablet ? 8 : 6,
      ),
      decoration: BoxDecoration(
        color: isCurrentTrack 
            ? const Color(0xFF7FB069).withOpacity(0.1)
            : const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(isTablet ? 16 : 12),
        border: Border.all(
          color: isCurrentTrack 
              ? const Color(0xFF7FB069)
              : const Color(0xFF7FB069).withOpacity(0.2),
          width: isCurrentTrack ? 2 : 1,
        ),
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          borderRadius: BorderRadius.circular(isTablet ? 16 : 12),
          onTap: () {
            HapticFeedback.mediumImpact();
            _togglePlayPause(track);
          },
          child: Padding(
            padding: EdgeInsets.all(cardPadding),
            child: Row(
              children: [
                Container(
                  width: imageSize,
                  height: imageSize,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(isTablet ? 12 : 8),
                    color: const Color(0xFF7FB069).withOpacity(0.2),
                  ),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(isTablet ? 12 : 8),
                    child: track.imagePath.startsWith('http')
                        ? Image.network(
                            track.imagePath,
                            fit: BoxFit.cover,
                            errorBuilder: (context, error, stackTrace) {
                              return Icon(
                                Icons.music_note,
                                color: const Color(0xFF7FB069),
                                size: isTablet ? 35 : 30,
                              );
                            },
                            loadingBuilder: (context, child, loadingProgress) {
                              if (loadingProgress == null) return child;
                              return const Center(
                                child: CircularProgressIndicator(
                                  valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
                                  strokeWidth: 2,
                                ),
                              );
                            },
                          )
                        : Image.asset(
                            track.imagePath,
                            fit: BoxFit.cover,
                            errorBuilder: (context, error, stackTrace) {
                              return Icon(
                                Icons.music_note,
                                color: const Color(0xFF7FB069),
                                size: isTablet ? 35 : 30,
                              );
                            },
                          ),
                  ),
                ),
                
                SizedBox(width: isTablet ? 20 : 16),
                
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        track.title,
                        style: TextStyle(
                          color: isCurrentTrack 
                              ? const Color(0xFF7FB069)
                              : Colors.white,
                          fontSize: isTablet ? 18 : 16,
                          fontWeight: FontWeight.bold,
                        ),
                        maxLines: 3,
                        overflow: TextOverflow.ellipsis,
                      ),
                      SizedBox(height: isTablet ? 6 : 4),
                      Text(
                        track.description,
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: isTablet ? 15 : 14,
                        ),
                        maxLines: 3,
                        overflow: TextOverflow.ellipsis,
                      ),
                      SizedBox(height: isTablet ? 6 : 4),
                      Wrap(
                        spacing: 8,
                        runSpacing: 4,
                        crossAxisAlignment: WrapCrossAlignment.center,
                        children: [
                          Container(
                            padding: EdgeInsets.symmetric(
                              horizontal: isTablet ? 10 : 8,
                              vertical: isTablet ? 4 : 2,
                            ),
                            decoration: BoxDecoration(
                              color: const Color(0xFF7FB069).withOpacity(0.2),
                              borderRadius: BorderRadius.circular(isTablet ? 14 : 12),
                            ),
                            child: Text(
                              track.category,
                              style: TextStyle(
                                color: const Color(0xFF7FB069),
                                fontSize: isTablet ? 13 : 12,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ),
                          Text(
                            ' ${track.artist}',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.5),
                              fontSize: isTablet ? 13 : 12,
                            ),
                          ),
                          if (hasDuration)
                            Container(
                              padding: EdgeInsets.symmetric(
                                horizontal: isTablet ? 8 : 6,
                                vertical: isTablet ? 4 : 2,
                              ),
                              decoration: BoxDecoration(
                                color: Colors.black.withOpacity(0.3),
                                borderRadius: BorderRadius.circular(isTablet ? 10 : 8),
                              ),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Icon(
                                    Icons.access_time,
                                    size: isTablet ? 12 : 10,
                                    color: Colors.white.withOpacity(0.6),
                                  ),
                                  SizedBox(width: isTablet ? 5 : 4),
                                  Text(
                                    _formatDuration(track.duration!),
                                    style: TextStyle(
                                      color: Colors.white.withOpacity(0.6),
                                      fontSize: isTablet ? 12 : 11,
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                ],
                              ),
                            )
                          else if (isLoadingDuration)
                            SizedBox(
                              width: isTablet ? 14 : 12,
                              height: isTablet ? 14 : 12,
                              child: CircularProgressIndicator(
                                strokeWidth: 1.5,
                                valueColor: AlwaysStoppedAnimation<Color>(
                                  Colors.white.withOpacity(0.4),
                                ),
                              ),
                            ),
                        ],
                      ),
                    ],
                  ),
                ),
                
                SizedBox(width: isTablet ? 12 : 8),
                
                GestureDetector(
                  onTap: () {
                    HapticFeedback.mediumImpact();
                    _togglePlayPause(track);
                  },
                  child: Container(
                    width: playButtonSize,
                    height: playButtonSize,
                    decoration: BoxDecoration(
                      color: const Color(0xFF7FB069),
                      borderRadius: BorderRadius.circular(playButtonSize / 2),
                    ),
                    child: _isLoadingAudio && isCurrentTrack
                        ? SizedBox(
                            width: 20,
                            height: 20,
                            child: CircularProgressIndicator(
                              strokeWidth: isTablet ? 2.5 : 2,
                              valueColor: const AlwaysStoppedAnimation<Color>(Colors.white),
                            ),
                          )
                        : Icon(
                            isCurrentTrack && _isPlaying 
                                ? Icons.pause
                                : Icons.play_arrow,
                            color: Colors.white,
                            size: isTablet ? 28 : 24,
                          ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildInlineMusicPlayer() {
    final isTablet = _isTabletOrLarger(context);
    final screenWidth = MediaQuery.of(context).size.width;
    final isDesktop = screenWidth >= 1024;
    
    return Container(
      padding: EdgeInsets.all(isTablet ? 20 : 16),
      decoration: const BoxDecoration(
        color: Color(0xFF1F1F1F),
        border: Border(
          top: BorderSide(
            color: Color(0xFF7FB069),
            width: 2,
          ),
        ),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Row(
            children: [
              Container(
                width: isTablet ? 60.0 : 50.0,
                height: isTablet ? 60.0 : 50.0,
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(isTablet ? 12 : 8),
                  color: const Color(0xFF7FB069).withOpacity(0.2),
                ),
                child: ClipRRect(
                  borderRadius: BorderRadius.circular(isTablet ? 12 : 8),
                  child: _currentTrack!.imagePath.startsWith('http')
                      ? Image.network(
                          _currentTrack!.imagePath,
                          fit: BoxFit.cover,
                          errorBuilder: (context, error, stackTrace) {
                            return Icon(
                              Icons.music_note,
                              color: const Color(0xFF7FB069),
                              size: isTablet ? 30 : 25,
                            );
                          },
                        )
                      : Image.asset(
                          _currentTrack!.imagePath,
                          fit: BoxFit.cover,
                          errorBuilder: (context, error, stackTrace) {
                            return Icon(
                              Icons.music_note,
                              color: const Color(0xFF7FB069),
                              size: isTablet ? 30 : 25,
                            );
                          },
                        ),
                ),
              ),
              
              SizedBox(width: isTablet ? 16 : 12),
              
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      _currentTrack!.title,
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: isTablet ? 16 : 14,
                        fontWeight: FontWeight.bold,
                      ),
                      maxLines: 3,
                      overflow: TextOverflow.ellipsis,
                    ),
                    SizedBox(height: isTablet ? 4 : 2),
                    Text(
                      _currentTrack!.artist,
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: isTablet ? 14 : 12,
                      ),
                      maxLines: 3,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
              
              if (isDesktop) ...[
                IconButton(
                  onPressed: () {
                    _seekTo(Duration(seconds: (_currentPosition.inSeconds - 10).clamp(0, _totalDuration.inSeconds)));
                  },
                  icon: const Icon(Icons.replay_10, color: Colors.white, size: 24),
                ),
              ],
              
              IconButton(
                iconSize: isTablet ? 24 : 20,
                onPressed: () => _togglePlayPause(_currentTrack!),
                icon: Container(
                  padding: EdgeInsets.all(isTablet ? 10 : 8),
                  decoration: const BoxDecoration(
                    color: Color(0xFF7FB069),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    _isPlaying ? Icons.pause : Icons.play_arrow,
                    color: Colors.white,
                    size: isTablet ? 24 : 20,
                  ),
                ),
              ),
              
              if (isDesktop) ...[
                IconButton(
                  onPressed: () {
                    _seekTo(Duration(seconds: (_currentPosition.inSeconds + 30).clamp(0, _totalDuration.inSeconds)));
                  },
                  icon: const Icon(Icons.forward_30, color: Colors.white, size: 24),
                ),
              ],
              
              IconButton(
                iconSize: isTablet ? 20 : 16,
                onPressed: () {
                  HapticFeedback.lightImpact();
                  _closeMusicPlayer();
                },
                icon: Container(
                  padding: EdgeInsets.all(isTablet ? 6 : 4),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    Icons.close,
                    color: Colors.white,
                    size: isTablet ? 18 : 16,
                  ),
                ),
              ),
            ],
          ),
          
          SizedBox(height: isTablet ? 12 : 8),
          
          Column(
            children: [
              SliderTheme(
                data: SliderTheme.of(context).copyWith(
                  activeTrackColor: const Color(0xFF7FB069),
                  inactiveTrackColor: const Color(0xFF7FB069).withOpacity(0.3),
                  thumbColor: const Color(0xFF7FB069),
                  overlayColor: const Color(0xFF7FB069).withOpacity(0.3),
                  trackHeight: isTablet ? 5 : 4,
                  thumbShape: RoundSliderThumbShape(
                    enabledThumbRadius: isTablet ? 8 : 6,
                  ),
                ),
                child: Slider(
                  value: _totalDuration.inMilliseconds > 0 
                      ? _currentPosition.inMilliseconds / _totalDuration.inMilliseconds
                      : 0.0,
                  onChanged: (value) {
                    final position = Duration(
                      milliseconds: (value * _totalDuration.inMilliseconds).round(),
                    );
                    _seekTo(position);
                  },
                ),
              ),
              
              Padding(
                padding: EdgeInsets.symmetric(horizontal: isTablet ? 20 : 16),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      _formatDuration(_currentPosition),
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: isTablet ? 13 : 12,
                      ),
                    ),
                    Text(
                      _formatDuration(_totalDuration),
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: isTablet ? 13 : 12,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Future<void> _togglePlayPause(MusicTrack track) async {
    try {
      if (_currentTrack?.id != track.id) {
        setState(() {
          _currentTrack = track;
          _isLoadingAudio = true;
        });
        
        await _audioPlayer.stop();
        
        if (track.isNetworkSource) {
          await _audioPlayer.play(UrlSource(track.audioPath));
        } else {
          await _audioPlayer.play(AssetSource(track.audioPath));
        }
      } else {
        if (_isPlaying) {
          await _audioPlayer.pause();
        } else {
          await _audioPlayer.resume();
        }
      }
    } catch (e) {
      debugPrint('Error playing audio: $e');
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Unable to play audio: ${track.title}'),
            backgroundColor: Colors.red,
            action: SnackBarAction(
              label: 'Retry',
              textColor: Colors.white,
              onPressed: () => _togglePlayPause(track),
            ),
          ),
        );
      }
      
      setState(() {
        _isLoadingAudio = false;
      });
    }
  }

  Future<void> _seekTo(Duration position) async {
    await _audioPlayer.seek(position);
  }

  String _formatDuration(Duration duration) {
    String twoDigits(int n) => n.toString().padLeft(2, '0');
    String twoDigitMinutes = twoDigits(duration.inMinutes.remainder(60));
    String twoDigitSeconds = twoDigits(duration.inSeconds.remainder(60));
    
    if (duration.inHours > 0) {
      return "${twoDigits(duration.inHours)}:$twoDigitMinutes:$twoDigitSeconds";
    } else {
      return "$twoDigitMinutes:$twoDigitSeconds";
    }
  }

  void _closeMusicPlayer() async {
    await _audioPlayer.stop();
    setState(() {
      _currentTrack = null;
      _isPlaying = false;
      _currentPosition = Duration.zero;
      _totalDuration = Duration.zero;
      _isLoadingAudio = false;
    });
  }

  @override
  void dispose() {
    _searchController.dispose();
    _searchFocusNode.dispose();
    _scrollController.dispose();
    _audioPlayer.dispose();
    super.dispose();
  }
}

enum FileType {
  video,
  audio,
  image,
  unknown,
}

class MusicTrack {
  final String id;
  final String title;
  final String description;
  final String category;
  final String imagePath;
  final String artist;
  final String audioPath;
  final String file;
  final FileType fileType;
  final bool isNetworkSource;
  final Duration? duration;

  MusicTrack({
    required this.id,
    required this.title,
    required this.description,
    required this.category,
    required this.imagePath,
    required this.artist,
    required this.audioPath,
    required this.file,
    required this.fileType,
    this.isNetworkSource = false,
    this.duration,
  });

  MusicTrack copyWith({
    String? id,
    String? title,
    String? description,
    String? category,
    String? imagePath,
    String? artist,
    String? audioPath,
    String? file,
    FileType? fileType,
    bool? isNetworkSource,
    Duration? duration,
  }) {
    return MusicTrack(
      id: id ?? this.id,
      title: title ?? this.title,
      description: description ?? this.description,
      category: category ?? this.category,
      imagePath: imagePath ?? this.imagePath,
      artist: artist ?? this.artist,
      audioPath: audioPath ?? this.audioPath,
      file: file ?? this.file,
      fileType: fileType ?? this.fileType,
      isNetworkSource: isNetworkSource ?? this.isNetworkSource,
      duration: duration ?? this.duration,
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mandaya_category_screens\mandaya_video_screen.dart
======================================

// lib/screen/mandaya_category_screens/mandaya_video_screen.dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:io';
import 'package:video_player/video_player.dart';
import 'package:video_thumbnail/video_thumbnail.dart';
import 'package:path_provider/path_provider.dart';
import 'package:visibility_detector/visibility_detector.dart';
import '../shared/video_player_screen.dart';
import '../../utils/video_metadata_cache.dart';

class MandayaVideoScreen extends StatefulWidget {
  const MandayaVideoScreen({super.key});

  @override
  State<MandayaVideoScreen> createState() => _MandayaVideoScreenState();
}

class _MandayaVideoScreenState extends State<MandayaVideoScreen> {
  String _searchQuery = '';
  final TextEditingController _searchController = TextEditingController();
  final FocusNode _searchFocusNode = FocusNode();
  bool _isSearchFocused = false;
  
  final ScrollController _scrollController = ScrollController();
  bool _isHeaderVisible = true;
  double _lastScrollOffset = 0;

  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<VideoItem> _allVideos = [];
  bool _isLoading = true;
  String? _errorMessage;
  VideoItem? _featuredVideo;
  
  final Set<String> _loadingMetadata = {};

  List<VideoItem> get _filteredVideos {
    if (_searchQuery.isEmpty) {
      return _allVideos;
    }
    
    return _allVideos.where((video) =>
        video.title.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        video.description.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        video.category.toLowerCase().contains(_searchQuery.toLowerCase())).toList();
  }

  // Enhanced responsive helper methods (from Kagan)
  int _getCrossAxisCount(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 4;
    if (width > 900) return 3;
    if (width > 600) return 2;
    return 2;
  }

  // FIXED: More flexible childAspectRatio that accounts for content
  double _getChildAspectRatio(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    final crossAxisCount = _getCrossAxisCount(context);
    
    // Calculate available width per item
    final horizontalPadding = _getHorizontalPadding(context);
    final spacing = _getGridSpacing(context);
    final availableWidth = width - (horizontalPadding * 2) - (spacing * (crossAxisCount - 1));
    final itemWidth = availableWidth / crossAxisCount;
    
    // Dynamic height based on item width - more generous for smaller screens
    final itemHeight = itemWidth * 1.4; // Increased from 1.35 to 1.4 for more vertical room
    
    return itemWidth / itemHeight;
  }

  // FIXED: Responsive padding that scales more conservatively
  double _getHorizontalPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return width * 0.025; // 2.5% of width
    if (width > 800) return width * 0.02; // 2% of width
    return width * 0.04; // 4% of width (reduced from fixed 16)
  }

  // NEW: Responsive grid spacing
  double _getGridSpacing(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 16;
    if (width > 800) return 12;
    return 10; // Reduced from 16 to save space on small screens
  }

  // FIXED: More conservative featured video height
  double _getFeaturedVideoHeight(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final width = size.width;
    final height = size.height;
    final isLandscape = width > height;
    
    // Use percentage of screen height for better scaling
    if (width > 1200) return height * 0.35;
    if (width > 800) return height * 0.3;
    if (isLandscape) return height * 0.35;
    return height * 0.25; // Reduced from fixed 200
  }

  double _getFontSize(BuildContext context, double baseSize) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return baseSize * 1.15;
    if (width > 800) return baseSize * 1.08;
    if (width < 360) return baseSize * 0.95; // Scale down on very small screens
    return baseSize;
  }

  // NEW: Responsive header height
  double _getHeaderHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 800) return 80;
    if (width < 360) return 65;
    return 72;
  }

  // NEW: Responsive vertical spacing
  double _getVerticalSpacing(BuildContext context, double baseSpacing) {
    final height = MediaQuery.of(context).size.height;
    if (height < 700) return baseSpacing * 0.75; // Reduce on short screens
    return baseSpacing;
  }

  @override
  void initState() {
    super.initState();
    _setupScrollController();
    _searchFocusNode.addListener(() {
      setState(() {
        _isSearchFocused = _searchFocusNode.hasFocus;
      });
    });
    _fetchVideos();
  }

  void _setupScrollController() {
    _scrollController.addListener(() {
      final currentOffset = _scrollController.offset;
      final isScrollingDown = currentOffset > _lastScrollOffset;
      final shouldHideHeader = isScrollingDown && currentOffset > 100;
      final shouldShowHeader = !isScrollingDown || currentOffset <= 50;

      if (_isHeaderVisible && shouldHideHeader && !_isSearchFocused) {
        setState(() {
          _isHeaderVisible = false;
        });
      } else if (!_isHeaderVisible && shouldShowHeader) {
        setState(() {
          _isHeaderVisible = true;
        });
      }

      _lastScrollOffset = currentOffset;
    });
  }

  Future<void> _fetchVideos() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching videos from: $_baseUrl');

      List<String> urls = [
        '${_baseUrl}category=video&tribe=mandaya',
        '$_baseUrl?category=video&tribe=mandaya',
        '$_baseUrl?tribe=mandaya',
        _baseUrl,
      ];

      http.Response? successResponse;
      
      for (String url in urls) {
        try {
          debugPrint('Trying URL: $url');
          final response = await http.get(
            Uri.parse(url),
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
            },
          ).timeout(const Duration(seconds: 15));
          
          if (response.statusCode == 200) {
            successResponse = response;
            break;
          }
        } catch (e) {
          debugPrint('Error with URL $url: $e');
          continue;
        }
      }

      if (successResponse == null) {
        throw Exception('All API endpoints failed to respond');
      }

      final Map<String, dynamic> jsonData = json.decode(successResponse.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      dynamic videoDataRaw = jsonData['data'];
      List<dynamic> videoData = [];
      
      if (videoDataRaw is List) {
        videoData = videoDataRaw;
      } else if (videoDataRaw != null) {
        videoData = [videoDataRaw];
      }

      final List<VideoItem> fetchedVideos = [];

      for (var item in videoData) {
        if (item == null) continue;
        
        final id = item['id'];
        final userId = item['user_id'];
        final title = item['title']?.toString();
        final category = item['category']?.toString();
        final tribe = item['tribe']?.toString();
        final description = item['description']?.toString();
        final file = item['file']?.toString();
        final isArchived = item['is_archived'];
        final time = item['time']?.toString();
        
        if (id == null || userId == null || title == null || title.isEmpty ||
            category == null || category.isEmpty || tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty || isArchived == null || time == null) {
          continue;
        }
        
        if (tribe.toLowerCase() != 'mandaya') {
          continue;
        }

        if (isArchived != 0) {
          continue;
        }

        final fileType = _determineFileType(file);
        final videoUrl = '$_uploadsBaseUrl$file';
        
        final cachedDuration = await VideoMetadataCache.getDuration(id.toString());
        final cachedThumbnail = await VideoMetadataCache.getThumbnail(id.toString());

        final videoItem = VideoItem(
          id: id.toString(),
          title: title,
          thumbnail: cachedThumbnail ?? _buildThumbnailUrl(file),
          duration: cachedDuration ?? '--:--',
          description: description ?? 'No description available',
          category: _mapCategory(category),
          file: file,
          fileType: fileType,
          videoUrl: videoUrl,
        );
        
        debugPrint(' Valid item added: $title (Cached: duration=${cachedDuration != null}, thumbnail=${cachedThumbnail != null})');
        fetchedVideos.add(videoItem);
      }

      setState(() {
        _allVideos = fetchedVideos;
        _featuredVideo = fetchedVideos.isNotEmpty ? fetchedVideos.first : null;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching videos: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load videos: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  Future<void> _loadVideoMetadata(VideoItem video) async {
    if (video.fileType != FileType.video || 
        video.duration != '--:--' || 
        _loadingMetadata.contains(video.id)) {
      return;
    }
    
    _loadingMetadata.add(video.id);
    
    VideoPlayerController? tempController;
    try {
      debugPrint(' Loading metadata for: ${video.title}');
      
      tempController = VideoPlayerController.networkUrl(
        Uri.parse(video.videoUrl),
        videoPlayerOptions: VideoPlayerOptions(mixWithOthers: true),
      );
      
      await tempController.initialize().timeout(
        const Duration(seconds: 15),
        onTimeout: () {
          throw Exception('Timeout loading video metadata');
        },
      );
      
      if (tempController.value.duration.inSeconds > 0) {
        final minutes = tempController.value.duration.inMinutes;
        final seconds = tempController.value.duration.inSeconds % 60;
        final duration = '${minutes.toString().padLeft(2, '0')}:${seconds.toString().padLeft(2, '0')}';
        
        await VideoMetadataCache.saveDuration(video.id, duration);
        
        if (mounted) {
          setState(() {
            video.duration = duration;
          });
        }
        debugPrint(' Duration loaded and cached for ${video.title}: $duration');
      }
      
      try {
        final thumbnailDir = await getApplicationDocumentsDirectory();
        final thumbnailPath = await VideoThumbnail.thumbnailFile(
          video: video.videoUrl,
          thumbnailPath: '${thumbnailDir.path}/thumbnails',
          imageFormat: ImageFormat.JPEG,
          maxWidth: 320,
          quality: 75,
          timeMs: 1000,
        );
        
        if (thumbnailPath != null && await File(thumbnailPath).exists()) {
          await VideoMetadataCache.saveThumbnail(video.id, thumbnailPath);
          
          if (mounted) {
            setState(() {
              video.thumbnail = thumbnailPath;
            });
          }
          debugPrint(' Thumbnail generated and cached for ${video.title}');
        }
      } catch (e) {
        debugPrint(' Error generating thumbnail for ${video.title}: $e');
      }
      
    } catch (e) {
      debugPrint(' Error loading metadata for ${video.title}: $e');
      if (mounted) {
        setState(() {
          video.duration = 'N/A';
        });
      }
    } finally {
      tempController?.dispose();
      _loadingMetadata.remove(video.id);
    }
  }

  String _buildThumbnailUrl(String? filename) {
    if (filename == null || filename.isEmpty) {
      return 'assets/videos/thumbnails/default_thumbnail.jpg';
    }
    
    final String lowerFilename = filename.toLowerCase();
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv', '.flv', '.wmv'];
    bool isVideoFile = videoExtensions.any((ext) => lowerFilename.endsWith(ext));
    
    if (isVideoFile) {
      return 'assets/videos/thumbnails/default_thumbnail.jpg';
    }
    
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    bool isImageFile = imageExtensions.any((ext) => lowerFilename.endsWith(ext));
    
    if (isImageFile) {
      return '$_uploadsBaseUrl$filename';
    }
    
    return 'assets/videos/thumbnails/default_thumbnail.jpg';
  }

  FileType _determineFileType(String? filename) {
    if (filename == null || filename.isEmpty) {
      return FileType.unknown;
    }
    
    final String lowerFilename = filename.toLowerCase();
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv', '.flv', '.wmv'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const audioExtensions = ['.mp3', '.wav', '.aac', '.ogg', '.m4a'];
    
    if (videoExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.video;
    } else if (imageExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.image;
    } else if (audioExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.audio;
    }
    
    return FileType.unknown;
  }

  String _mapCategory(String? category) {
    switch (category?.toLowerCase()) {
      case 'video':
        return 'Video';
      case 'artifact':
        return 'Cultural Artifact';
      case 'instrument':
        return 'Traditional Instrument';
      case 'audio':
        return 'Audio Recording';
      case 'image':
        return 'Image';
      default:
        return 'Media';
    }
  }

  Future<void> _refreshVideos() async {
    await _fetchVideos();
  }

  @override
  void dispose() {
    _loadingMetadata.clear();
    _searchController.dispose();
    _searchFocusNode.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final horizontalPadding = _getHorizontalPadding(context);
    final headerHeight = _getHeaderHeight(context);
    
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // FIXED: Dynamic header height
              AnimatedContainer(
                duration: const Duration(milliseconds: 300),
                height: (_isHeaderVisible || _isSearchFocused) ? headerHeight : 0,
                child: (_isHeaderVisible || _isSearchFocused) 
                    ? _buildHeader(context, horizontalPadding) 
                    : const SizedBox.shrink(),
              ),
              Expanded(
                child: _isSearchFocused 
                    ? _buildSearchResults(horizontalPadding)
                    : _buildMainContent(horizontalPadding),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeader(BuildContext context, double horizontalPadding) {
    final verticalPadding = _getVerticalSpacing(context, 12);
    
    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: horizontalPadding, 
        vertical: verticalPadding
      ),
      child: Row(
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 0 : 48,
            child: _isSearchFocused 
                ? const SizedBox.shrink()
                : Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: const Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ),
          ),
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 0 : 12, // Reduced from 16
          ),
          Expanded(
            child: Container(
              height: 48,
              decoration: BoxDecoration(
                color: const Color(0xFF2A2A2A),
                borderRadius: BorderRadius.circular(24),
                border: Border.all(
                  color: _isSearchFocused 
                      ? const Color(0xFF7FB069) 
                      : const Color(0xFF7FB069).withOpacity(0.3),
                  width: _isSearchFocused ? 2 : 1,
                ),
              ),
              child: TextField(
                controller: _searchController,
                focusNode: _searchFocusNode,
                style: TextStyle(
                  color: Colors.white,
                  fontSize: _getFontSize(context, 14),
                ),
                scrollPhysics: const BouncingScrollPhysics(),
                decoration: InputDecoration(
                  hintText: 'Search videos...',
                  hintStyle: TextStyle(
                    color: Colors.white.withOpacity(0.6),
                    fontSize: _getFontSize(context, 14),
                  ),
                  prefixIcon: Icon(
                    Icons.search,
                    color: _isSearchFocused 
                        ? const Color(0xFF7FB069)
                        : Colors.white.withOpacity(0.6),
                  ),
                  suffixIcon: _searchQuery.isNotEmpty
                      ? IconButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {
                              _searchQuery = '';
                            });
                          },
                          icon: Icon(
                            Icons.clear,
                            color: Colors.white.withOpacity(0.6),
                          ),
                        )
                      : null,
                  border: InputBorder.none,
                  contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                ),
                onChanged: (value) {
                  setState(() {
                    _searchQuery = value;
                  });
                },
              ),
            ),
          ),
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 80 : 0,
            child: _isSearchFocused
                ? TextButton(
                    onPressed: () {
                      _searchController.clear();
                      _searchFocusNode.unfocus();
                      setState(() {
                        _searchQuery = '';
                        _isHeaderVisible = true;
                      });
                    },
                    child: Text(
                      'Cancel',
                      style: TextStyle(
                        color: const Color(0xFF7FB069),
                        fontWeight: FontWeight.w500,
                        fontSize: _getFontSize(context, 14),
                      ),
                    ),
                  )
                : const SizedBox.shrink(),
          ),
        ],
      ),
    );
  }

  Widget _buildMainContent(double horizontalPadding) {
    if (_isLoading) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          mainAxisSize: MainAxisSize.min,
          children: [
            const CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF7FB069)),
            ),
            SizedBox(height: _getVerticalSpacing(context, 16)),
            Text(
              'Loading Mandaya videos...',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: _getFontSize(context, 14),
              ),
            ),
          ],
        ),
      );
    }

    if (_errorMessage != null) {
      return Center(
        child: Padding(
          padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Colors.white.withOpacity(0.5),
              ),
              SizedBox(height: _getVerticalSpacing(context, 16)),
              Text(
                'Failed to load videos',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.7),
                  fontSize: _getFontSize(context, 18),
                  fontWeight: FontWeight.w500,
                ),
              ),
              SizedBox(height: _getVerticalSpacing(context, 8)),
              Padding(
                padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
                child: Text(
                  _errorMessage!,
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.5),
                    fontSize: _getFontSize(context, 14),
                  ),
                  textAlign: TextAlign.center,
                ),
              ),
              SizedBox(height: _getVerticalSpacing(context, 24)),
              ElevatedButton(
                onPressed: _refreshVideos,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF7FB069),
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(
                    horizontal: horizontalPadding,
                    vertical: _getVerticalSpacing(context, 12),
                  ),
                ),
                child: Text(
                  'Retry',
                  style: TextStyle(fontSize: _getFontSize(context, 14)),
                ),
              ),
            ],
          ),
        ),
      );
    }

    if (_allVideos.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              Icons.video_library_outlined,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            SizedBox(height: _getVerticalSpacing(context, 16)),
            Text(
              'No Mandaya videos available',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: _getFontSize(context, 18),
                fontWeight: FontWeight.w500,
              ),
            ),
            SizedBox(height: _getVerticalSpacing(context, 8)),
            Text(
              'Check back later for new content',
              style: TextStyle(
                color: Colors.white.withOpacity(0.5),
                fontSize: _getFontSize(context, 14),
              ),
            ),
            SizedBox(height: _getVerticalSpacing(context, 24)),
            ElevatedButton(
              onPressed: _refreshVideos,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF7FB069),
                foregroundColor: Colors.white,
                padding: EdgeInsets.symmetric(
                  horizontal: horizontalPadding,
                  vertical: _getVerticalSpacing(context, 12),
                ),
              ),
              child: Text(
                'Refresh',
                style: TextStyle(fontSize: _getFontSize(context, 14)),
              ),
            ),
          ],
        ),
      );
    }

    final gridSpacing = _getGridSpacing(context);

    return RefreshIndicator(
      onRefresh: _refreshVideos,
      color: const Color(0xFF7FB069),
      child: CustomScrollView(
        controller: _scrollController,
        physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
        slivers: [
          if (_featuredVideo != null)
            SliverToBoxAdapter(
              child: _buildFeaturedVideo(horizontalPadding),
            ),
          SliverToBoxAdapter(
            child: _buildBrowseSection(horizontalPadding),
          ),
          SliverPadding(
            padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
            sliver: SliverGrid(
              gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: _getCrossAxisCount(context),
                childAspectRatio: _getChildAspectRatio(context),
                crossAxisSpacing: gridSpacing,
                mainAxisSpacing: gridSpacing,
              ),
              delegate: SliverChildBuilderDelegate(
                (context, index) {
                  final video = _allVideos[index];
                  return _buildVideoCard(video);
                },
                childCount: _allVideos.length,
              ),
            ),
          ),
          SliverToBoxAdapter(
            child: SizedBox(height: _getVerticalSpacing(context, 20)),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchResults(double horizontalPadding) {
    final gridSpacing = _getGridSpacing(context);
    
    return Column(
      children: [
        if (_searchQuery.isNotEmpty)
          Padding(
            padding: EdgeInsets.symmetric(
              horizontal: horizontalPadding, 
              vertical: _getVerticalSpacing(context, 8)
            ),
            child: Row(
              children: [
                Flexible(
                  child: Text(
                    '${_filteredVideos.length} result${_filteredVideos.length == 1 ? '' : 's'} for "$_searchQuery"',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.7),
                      fontSize: _getFontSize(context, 14),
                    ),
                    overflow: TextOverflow.ellipsis,
                  ),
                ),
              ],
            ),
          ),
        Expanded(
          child: _searchQuery.isEmpty
              ? Center(
                  child: Text(
                    'Start typing to search...',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.5),
                      fontSize: _getFontSize(context, 16),
                    ),
                  ),
                )
              : _filteredVideos.isEmpty
                  ? Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(
                            Icons.search_off,
                            size: 48,
                            color: Colors.white.withOpacity(0.3),
                          ),
                          SizedBox(height: _getVerticalSpacing(context, 16)),
                          Text(
                            'No videos found',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.5),
                              fontSize: _getFontSize(context, 18),
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          SizedBox(height: _getVerticalSpacing(context, 8)),
                          Text(
                            'Try different keywords',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.3),
                              fontSize: _getFontSize(context, 14),
                            ),
                          ),
                        ],
                      ),
                    )
                  : GridView.builder(
                      physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
                      padding: EdgeInsets.only(
                        left: horizontalPadding,
                        right: horizontalPadding,
                        bottom: MediaQuery.of(context).viewInsets.bottom + 20,
                      ),
                      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                        crossAxisCount: _getCrossAxisCount(context),
                        childAspectRatio: _getChildAspectRatio(context),
                        crossAxisSpacing: gridSpacing,
                        mainAxisSpacing: gridSpacing,
                      ),
                      itemCount: _filteredVideos.length,
                      itemBuilder: (context, index) {
                        final video = _filteredVideos[index];
                        return _buildVideoCard(video);
                      },
                    ),
        ),
      ],
    );
  }

  Widget _buildFeaturedVideo(double horizontalPadding) {
    if (_featuredVideo == null) return const SizedBox.shrink();

    final featuredHeight = _getFeaturedVideoHeight(context);
    final cardPadding = horizontalPadding * 0.75; // Proportional padding

    return Container(
      margin: EdgeInsets.all(cardPadding),
      height: featuredHeight,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.4),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: () {
              HapticFeedback.mediumImpact();
              _playVideo(_featuredVideo!);
            },
            child: Stack(
              children: [
                Container(
                  width: double.infinity,
                  height: double.infinity,
                  decoration: const BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color(0xFF7FB069),
                        Color(0xFF5D8A47),
                      ],
                    ),
                  ),
                  child: _buildThumbnailImage(_featuredVideo!),
                ),
                Container(
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topCenter,
                      end: Alignment.bottomCenter,
                      colors: [
                        Colors.transparent,
                        Colors.black.withOpacity(0.7),
                      ],
                    ),
                  ),
                ),
                Positioned(
                  bottom: cardPadding,
                  left: cardPadding,
                  right: cardPadding,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        'Featured: ${_featuredVideo!.title}',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: _getFontSize(context, 18),
                          fontWeight: FontWeight.bold,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                      SizedBox(height: _getVerticalSpacing(context, 4)),
                      Text(
                        _featuredVideo!.description,
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.8),
                          fontSize: _getFontSize(context, 14),
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ),
                ),
                Center(
                  child: Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.5),
                      borderRadius: BorderRadius.circular(50),
                    ),
                    child: const Icon(
                      Icons.play_arrow,
                      color: Colors.white,
                      size: 40,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildBrowseSection(double horizontalPadding) {
    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: horizontalPadding, 
        vertical: _getVerticalSpacing(context, 12)
      ),
      child: Row(
        children: [
          const Icon(
            Icons.video_library,
            color: Color(0xFF7FB069),
            size: 20,
          ),
          SizedBox(width: _getVerticalSpacing(context, 8)),
          Flexible(
            child: Text(
              'Browse Mandaya videos',
              style: TextStyle(
                color: const Color(0xFF7FB069),
                fontSize: _getFontSize(context, 16),
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
              overflow: TextOverflow.ellipsis,
            ),
          ),
        ],
      ),
    );
  }

  // FIXED: Complete video card rewrite with proper constraints (from Kagan)
  Widget _buildVideoCard(VideoItem video) {
    return VisibilityDetector(
      key: Key('video_${video.id}'),
      onVisibilityChanged: (info) {
        if (info.visibleFraction > 0.1 && video.duration == '--:--') {
          _loadVideoMetadata(video);
        }
      },
      child: LayoutBuilder(
        builder: (context, constraints) {
          // Calculate heights dynamically based on available space
          final cardWidth = constraints.maxWidth;
          final cardHeight = constraints.maxHeight;
          
          // Image should take 60% of card height
          final imageHeight = cardHeight * 0.6;
          // Info section takes remaining 40%
          final infoHeight = cardHeight * 0.4;
          
          return Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.3),
                  blurRadius: 6,
                  offset: const Offset(0, 3),
                ),
              ],
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: Material(
                color: Colors.transparent,
                child: InkWell(
                  onTap: () {
                    HapticFeedback.mediumImpact();
                    _playVideo(video);
                  },
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // FIXED: Use SizedBox with explicit height instead of Expanded
                      SizedBox(
                        height: imageHeight,
                        width: double.infinity,
                        child: Stack(
                          children: [
                            Container(
                              width: double.infinity,
                              height: double.infinity,
                              decoration: const BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                  colors: [
                                    Color(0xFF7FB069),
                                    Color(0xFF5D8A47),
                                  ],
                                ),
                              ),
                              child: _buildThumbnailImage(video),
                            ),
                            Positioned(
                              top: 6,
                              right: 6,
                              child: Container(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 6,
                                  vertical: 2,
                                ),
                                decoration: BoxDecoration(
                                  color: Colors.black.withOpacity(0.7),
                                  borderRadius: BorderRadius.circular(4),
                                ),
                                child: Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    if (video.duration == '--:--' && _loadingMetadata.contains(video.id))
                                      const Padding(
                                        padding: EdgeInsets.only(right: 4),
                                        child: SizedBox(
                                          width: 8,
                                          height: 8,
                                          child: CircularProgressIndicator(
                                            strokeWidth: 1.5,
                                            valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                                          ),
                                        ),
                                      ),
                                    Text(
                                      video.duration,
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: _getFontSize(context, 10),
                                        fontWeight: FontWeight.w500,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                            Center(
                              child: Container(
                                padding: EdgeInsets.all(cardWidth * 0.08), // Proportional padding
                                decoration: BoxDecoration(
                                  color: Colors.black.withOpacity(0.5),
                                  borderRadius: BorderRadius.circular(30),
                                ),
                                child: Icon(
                                  video.fileType == FileType.video 
                                      ? Icons.play_arrow
                                      : video.fileType == FileType.audio
                                          ? Icons.music_note
                                          : Icons.image,
                                  color: Colors.white,
                                  size: cardWidth * 0.15, // Proportional icon size
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      // FIXED: Use SizedBox with explicit height - NO Flexible/Expanded
                      SizedBox(
                        height: infoHeight,
                        width: double.infinity,
                        child: Container(
                          padding: EdgeInsets.all(cardWidth * 0.035), // Reduced padding
                          color: const Color(0xFF2A2A2A),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              // FIXED: Removed Flexible wrappers - direct Text with constraints
                              Text(
                                video.title,
                                style: TextStyle(
                                  color: Colors.white,
                                  fontSize: _getFontSize(context, 12), // Reduced from 13
                                  fontWeight: FontWeight.w600,
                                  height: 1.2,
                                ),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                              SizedBox(height: cardHeight * 0.005), // Reduced spacing
                              Text(
                                video.description,
                                style: TextStyle(
                                  color: Colors.white.withOpacity(0.6),
                                  fontSize: _getFontSize(context, 10), // Reduced from 11
                                  height: 1.2,
                                ),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                              // FIXED: Spacer pushes category to bottom naturally
                              const Spacer(),
                              Container(
                                padding: EdgeInsets.symmetric(
                                  horizontal: cardWidth * 0.02, // Reduced padding
                                  vertical: cardHeight * 0.006, // Reduced padding
                                ),
                                decoration: BoxDecoration(
                                  color: const Color(0xFF7FB069).withOpacity(0.2),
                                  borderRadius: BorderRadius.circular(6),
                                ),
                                child: Text(
                                  video.category,
                                  style: TextStyle(
                                    color: const Color(0xFF7FB069),
                                    fontSize: _getFontSize(context, 9), // Reduced from 10
                                    fontWeight: FontWeight.w500,
                                  ),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildThumbnailImage(VideoItem video) {
    if (video.thumbnail.startsWith('/data') || video.thumbnail.startsWith('/storage')) {
      return Image.file(
        File(video.thumbnail),
        fit: BoxFit.cover,
        errorBuilder: (context, error, stackTrace) {
          return const Center(
            child: Icon(
              Icons.play_circle_outline,
              color: Colors.white,
              size: 40,
            ),
          );
        },
      );
    }
    
    if (video.thumbnail.startsWith('http')) {
      return Image.network(
        video.thumbnail,
        fit: BoxFit.cover,
        errorBuilder: (context, error, stackTrace) {
          return const Center(
            child: Icon(
              Icons.play_circle_outline,
              color: Colors.white,
              size: 40,
            ),
          );
        },
        loadingBuilder: (context, child, loadingProgress) {
          if (loadingProgress == null) return child;
          return const Center(
            child: CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
            ),
          );
        },
      );
    }
    
    return Image.asset(
      video.thumbnail,
      fit: BoxFit.cover,
      errorBuilder: (context, error, stackTrace) {
        return const Center(
          child: Icon(
            Icons.play_circle_outline,
            color: Colors.white,
            size: 40,
          ),
        );
      },
    );
  }

  void _playVideo(VideoItem video) {
    if (video.file.isEmpty || video.fileType != FileType.video) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            video.fileType == FileType.audio 
                ? 'This is an audio file. Audio player not implemented yet.'
                : video.fileType == FileType.image
                    ? 'This is an image file, not a video.'
                    : 'Cannot play this file type.',
          ),
          backgroundColor: const Color(0xFF7FB069),
        ),
      );
      return;
    }

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => VideoPlayerScreen(
          videoTitle: video.title,
          videoDescription: video.description,
          thumbnailPath: video.thumbnail,
          duration: video.duration,
          accentColor: const Color(0xFF7FB069),
          tribalName: 'Mandaya',
          videoUrl: video.videoUrl,
        ),
      ),
    );
  }
}

enum FileType {
  video,
  audio,
  image,
  unknown,
}

class VideoItem {
  final String id;
  final String title;
  String thumbnail;
  String duration;
  final String description;
  final String category;
  final String file;
  final FileType fileType;
  final String videoUrl;

  VideoItem({
    required this.id,
    required this.title,
    required this.thumbnail,
    required this.duration,
    required this.description,
    required this.category,
    required this.file,
    required this.fileType,
    required this.videoUrl,
  });
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mansaka_category_screens\mansaka_artifacts_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

class MansakaArtifactsScreen extends StatefulWidget {
  const MansakaArtifactsScreen({super.key});

  @override
  State<MansakaArtifactsScreen> createState() => _MansakaArtifactsScreenState();
}

class _MansakaArtifactsScreenState extends State<MansakaArtifactsScreen> {
  final TextEditingController _searchController = TextEditingController();
  String _searchQuery = '';

  // API and loading state
  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<ArtifactItem> _allArtifacts = [];
  bool _isLoading = true;
  String? _errorMessage;

  List<ArtifactItem> get _filteredArtifacts {
    if (_searchQuery.isEmpty) {
      return _allArtifacts;
    }
    return _allArtifacts.where((artifact) {
      return artifact.name.toLowerCase().contains(_searchQuery.toLowerCase()) ||
             artifact.description.toLowerCase().contains(_searchQuery.toLowerCase());
    }).toList();
  }

  // Responsive helper methods
  int _getCrossAxisCount(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 4;
    if (width > 800) return 3;
    if (width > 600) return 2;
    return 2;
  }

  double _getChildAspectRatio(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 0.9;
    if (width > 800) return 0.85;
    return 0.85;
  }

  double _getHorizontalPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 40;
    if (width > 800) return 32;
    if (width > 600) return 24;
    return 20;
  }

  double _getFeaturedImageHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    final height = MediaQuery.of(context).size.height;
    if (width > 1200) return height * 0.35;
    if (width > 800) return height * 0.3;
    if (width > 600) return 250;
    return 200;
  }

  double _getGridSpacing(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 800) return 20;
    return 16;
  }

  @override
  void initState() {
    super.initState();
    _fetchArtifacts();
  }

  Future<void> _fetchArtifacts() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching Mansaka artifacts from: $_baseUrl');
      
      const String apiUrl = '$_baseUrl?tribe=mansaka&category=artifact';
      debugPrint('API URL: $apiUrl');

      final response = await http.get(
        Uri.parse(apiUrl),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      ).timeout(const Duration(seconds: 15));
      
      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');
      
      if (response.statusCode != 200) {
        throw Exception('API returned status code: ${response.statusCode}');
      }

      final Map<String, dynamic> jsonData = json.decode(response.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      if (!jsonData.containsKey('data')) {
        throw Exception('API response missing "data" field');
      }

      final dynamic rawData = jsonData['data'];
      List<dynamic> contentItems = [];
      
      if (rawData is List) {
        contentItems = rawData;
      } else if (rawData is Map) {
        contentItems = [rawData];
      } else {
        throw Exception('Unexpected data format in API response');
      }

      debugPrint('Found ${contentItems.length} content items');

      final List<ArtifactItem> artifacts = [];

      for (var item in contentItems) {
        if (item == null || item is! Map<String, dynamic>) {
          debugPrint('Skipping invalid item: $item');
          continue;
        }
        
        debugPrint('Processing item: ${item.toString()}');
        
        final dynamic id = item['id'];
        final dynamic userId = item['user_id'];
        final String? title = item['title']?.toString();
        final String? category = item['category']?.toString();
        final String? tribe = item['tribe']?.toString();
        final String? description = item['description']?.toString();
        final String? file = item['file']?.toString();
        final dynamic isArchived = item['is_archived'];
        final String? time = item['time']?.toString();
        
        if (id == null || 
            userId == null || 
            title == null || title.isEmpty ||
            category == null || category.isEmpty ||
            tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty ||
            isArchived == null ||
            time == null || time.isEmpty) {
          debugPrint('Skipping item with missing required fields');
          continue;
        }
        
        if (tribe.toLowerCase() != 'mansaka') {
          debugPrint('Skipping non-Mansaka item: $tribe');
          continue;
        }

        if (isArchived != 0) {
          debugPrint('Skipping archived item: $title');
          continue;
        }

        if (category.toLowerCase() != 'artifact' && !_isImageContent(file)) {
          debugPrint('Skipping non-artifact content: $file (category: $category)');
          continue;
        }

        final artifact = ArtifactItem(
          id: id.toString(),
          name: title,
          description: description ?? 'No description available',
          imagePath: '$_uploadsBaseUrl$file',
          file: file,
          isNetworkSource: true,
        );
        
        debugPrint(' Added artifact: $title (ID: $id, Category: $category)');
        artifacts.add(artifact);
      }

      debugPrint('Final artifact count: ${artifacts.length}');

      setState(() {
        _allArtifacts = artifacts;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching artifacts: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load artifacts: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  bool _isImageContent(String filename) {
    final String lowerFilename = filename.toLowerCase();
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    return imageExtensions.any((ext) => lowerFilename.endsWith(ext));
  }

  Future<void> _refreshArtifacts() async {
    await _fetchArtifacts();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              _buildHeader(),
              Expanded(
                child: _isLoading 
                    ? _buildLoadingState()
                    : _errorMessage != null 
                        ? _buildErrorState()
                        : _allArtifacts.isEmpty
                            ? _buildEmptyState()
                            : _buildContent(),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildLoadingState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const CircularProgressIndicator(
            valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF4CAF50)),
          ),
          const SizedBox(height: 16),
          Text(
            'Loading Mansaka artifacts...',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 14,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildErrorState() {
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: _getHorizontalPadding(context)),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            const SizedBox(height: 16),
            Text(
              'Failed to load artifacts',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              _errorMessage!,
              style: TextStyle(
                color: Colors.white.withOpacity(0.5),
                fontSize: 14,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: _refreshArtifacts,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF4CAF50),
                foregroundColor: Colors.white,
              ),
              child: const Text('Retry'),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: _getHorizontalPadding(context)),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.museum_outlined,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            const SizedBox(height: 16),
            Text(
              'No Mansaka artifacts available',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
            Text(
              'Check back later for new artifacts',
              style: TextStyle(
                color: Colors.white.withOpacity(0.5),
                fontSize: 14,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: _refreshArtifacts,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF4CAF50),
                foregroundColor: Colors.white,
              ),
              child: const Text('Refresh'),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildContent() {
    return RefreshIndicator(
      onRefresh: _refreshArtifacts,
      color: const Color(0xFF4CAF50),
      child: LayoutBuilder(
        builder: (context, constraints) {
          return SingleChildScrollView(
            physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
            keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
            child: ConstrainedBox(
              constraints: BoxConstraints(
                minHeight: constraints.maxHeight,
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _buildSearchBar(),
                  const SizedBox(height: 20),
                  _buildFeaturedImage(),
                  const SizedBox(height: 24),
                  _buildDescription(),
                  const SizedBox(height: 32),
                  _buildBrowseSection(),
                  const SizedBox(height: 20),
                  _buildArtifactsGrid(),
                  SizedBox(height: 40 + MediaQuery.of(context).viewInsets.bottom),
                ],
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildHeader() {
    final horizontalPadding = _getHorizontalPadding(context);
    final isLargeScreen = MediaQuery.of(context).size.width > 600;
    
    return Padding(
      padding: EdgeInsets.all(horizontalPadding),
      child: Row(
        children: [
          Container(
            decoration: BoxDecoration(
              color: Colors.black.withOpacity(0.3),
              borderRadius: BorderRadius.circular(12),
            ),
            child: IconButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                Navigator.pop(context);
              },
              icon: Icon(
                Icons.arrow_back_ios,
                color: Colors.white,
                size: isLargeScreen ? 24 : 20,
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Text(
              'MANSAKA ARTIFACTS',
              style: TextStyle(
                color: Colors.white,
                fontSize: isLargeScreen ? 24 : 20,
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchBar() {
    final horizontalPadding = _getHorizontalPadding(context);
    final isLargeScreen = MediaQuery.of(context).size.width > 600;
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Container(
        constraints: const BoxConstraints(maxWidth: 800),
        decoration: BoxDecoration(
          color: const Color(0xFF2A2A2A),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: const Color(0xFFB19CD9).withOpacity(0.3),
            width: 1,
          ),
        ),
        child: TextField(
          controller: _searchController,
          onChanged: (value) {
            setState(() {
              _searchQuery = value;
            });
          },
          style: TextStyle(
            color: Colors.white,
            fontSize: isLargeScreen ? 18 : 16,
          ),
          decoration: InputDecoration(
            hintText: 'Search artifacts',
            hintStyle: TextStyle(
              color: Colors.white.withOpacity(0.6),
              fontSize: isLargeScreen ? 18 : 16,
            ),
            prefixIcon: Icon(
              Icons.search,
              color: Colors.white.withOpacity(0.6),
              size: isLargeScreen ? 28 : 24,
            ),
            suffixIcon: _searchQuery.isNotEmpty
                ? IconButton(
                    onPressed: () {
                      setState(() {
                        _searchController.clear();
                        _searchQuery = '';
                      });
                    },
                    icon: Icon(
                      Icons.clear,
                      color: Colors.white.withOpacity(0.6),
                      size: isLargeScreen ? 28 : 24,
                    ),
                  )
                : null,
            border: InputBorder.none,
            contentPadding: EdgeInsets.symmetric(
              horizontal: 16,
              vertical: isLargeScreen ? 20 : 16,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildFeaturedImage() {
    final horizontalPadding = _getHorizontalPadding(context);
    final imageHeight = _getFeaturedImageHeight(context);
    
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
        child: Container(
          constraints: const BoxConstraints(maxWidth: 1200),
          height: imageHeight,
          width: double.infinity,
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.4),
                blurRadius: 8,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(16),
            child: Image.asset(
              'assets/images/mansaka_arti.jpg',
              fit: BoxFit.cover,
              errorBuilder: (context, error, stackTrace) {
                return Container(
                  decoration: const BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color(0xFFB19CD9),
                        Color(0xFF5D4E75),
                        Color(0xFF3F325A),
                      ],
                    ),
                  ),
                  child: const Center(
                    child: Icon(
                      Icons.museum,
                      color: Colors.white,
                      size: 60,
                    ),
                  ),
                );
              },
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildDescription() {
    final horizontalPadding = _getHorizontalPadding(context);
    final isLargeScreen = MediaQuery.of(context).size.width > 600;
    
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
        child: Container(
          constraints: const BoxConstraints(maxWidth: 1200),
          child: Text(
            'Discover authentic Mansaka artifacts - physical objects that tell the story of this indigenous tribe\'s rich cultural heritage, craftsmanship, and daily life.',
            style: TextStyle(
              color: Colors.white.withOpacity(0.9),
              fontSize: isLargeScreen ? 18 : 16,
              height: 1.6,
              letterSpacing: 0.5,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildBrowseSection() {
    final horizontalPadding = _getHorizontalPadding(context);
    final isLargeScreen = MediaQuery.of(context).size.width > 600;
    
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
        child: Container(
          constraints: const BoxConstraints(maxWidth: 1200),
          width: double.infinity,
          child: Text(
            'Browse artifacts (${_filteredArtifacts.length})',
            style: TextStyle(
              color: Colors.white,
              fontSize: isLargeScreen ? 24 : 20,
              fontWeight: FontWeight.bold,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildArtifactsGrid() {
    if (_filteredArtifacts.isEmpty) {
      return _buildNoResults();
    }

    final horizontalPadding = _getHorizontalPadding(context);
    final crossAxisCount = _getCrossAxisCount(context);
    final childAspectRatio = _getChildAspectRatio(context);
    final spacing = _getGridSpacing(context);
    
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
        child: Container(
          constraints: const BoxConstraints(maxWidth: 1200),
          child: GridView.builder(
            shrinkWrap: true,
            physics: const NeverScrollableScrollPhysics(),
            gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
              crossAxisCount: crossAxisCount,
              crossAxisSpacing: spacing,
              mainAxisSpacing: spacing,
              childAspectRatio: childAspectRatio,
            ),
            itemCount: _filteredArtifacts.length,
            itemBuilder: (context, index) {
              return _buildArtifactCard(_filteredArtifacts[index], index);
            },
          ),
        ),
      ),
    );
  }

  Widget _buildNoResults() {
    final horizontalPadding = _getHorizontalPadding(context);
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const SizedBox(height: 60),
            Icon(
              Icons.search_off,
              size: 64,
              color: Colors.white.withOpacity(0.3),
            ),
            const SizedBox(height: 16),
            Text(
              'No artifacts found',
              style: TextStyle(
                color: Colors.white.withOpacity(0.6),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'Try searching with different keywords',
              style: TextStyle(
                color: Colors.white.withOpacity(0.4),
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 60),
          ],
        ),
      ),
    );
  }

  Widget _buildArtifactCard(ArtifactItem artifact, int index) {
    final isLargeScreen = MediaQuery.of(context).size.width > 600;
    
    return GestureDetector(
      onTap: () {
        HapticFeedback.mediumImpact();
        _showArtifactViewer(artifact, index);
      },
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              Expanded(
                flex: 3,
                child: artifact.isNetworkSource
                    ? Image.network(
                        artifact.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFF4CAF50),
                                  Color(0xFF388E3C),
                                ],
                              ),
                            ),
                            child: Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: isLargeScreen ? 50 : 40,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            color: const Color(0xFF2A2A2A),
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF4CAF50)),
                                strokeWidth: 2,
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        artifact.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFF4CAF50),
                                  Color(0xFF388E3C),
                                ],
                              ),
                            ),
                            child: Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: isLargeScreen ? 50 : 40,
                              ),
                            ),
                          );
                        },
                      ),
              ),
              Container(
                padding: EdgeInsets.all(isLargeScreen ? 16 : 12),
                color: const Color(0xFF2A2A2A),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      artifact.name,
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: isLargeScreen ? 16 : 14,
                        fontWeight: FontWeight.bold,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 4),
                    Text(
                      artifact.description,
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: isLargeScreen ? 14 : 12,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showArtifactViewer(ArtifactItem artifact, int index) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => ArtifactViewerBottomSheet(
        artifacts: _filteredArtifacts,
        initialIndex: index,
        accentColor: const Color(0xFF4CAF50),
      ),
    );
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }
}

class ArtifactItem {
  final String? id;
  final String name;
  final String description;
  final String imagePath;
  final String? file;
  final bool isNetworkSource;

  ArtifactItem({
    this.id,
    required this.name,
    required this.description,
    required this.imagePath,
    this.file,
    this.isNetworkSource = false,
  });
}

class ArtifactViewerBottomSheet extends StatefulWidget {
  final List<ArtifactItem> artifacts;
  final int initialIndex;
  final Color accentColor;

  const ArtifactViewerBottomSheet({
    super.key,
    required this.artifacts,
    required this.initialIndex,
    required this.accentColor,
  });

  @override
  State<ArtifactViewerBottomSheet> createState() => _ArtifactViewerBottomSheetState();
}

class _ArtifactViewerBottomSheetState extends State<ArtifactViewerBottomSheet> {
  late PageController _pageController;
  late int _currentIndex;

  @override
  void initState() {
    super.initState();
    _currentIndex = widget.initialIndex;
    _pageController = PageController(initialPage: widget.initialIndex);
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;
    final screenHeight = MediaQuery.of(context).size.height;
    final isLargeScreen = MediaQuery.of(context).size.width > 600;
    
    return Container(
      height: screenHeight * (isLargeScreen ? 0.85 : 0.9),
      decoration: const BoxDecoration(
        color: Color(0xFF1a1a1a),
        borderRadius: BorderRadius.vertical(
          top: Radius.circular(20),
        ),
      ),
      child: Column(
        children: [
          _buildHandle(),
          _buildHeader(),
          Expanded(
            child: PageView.builder(
              controller: _pageController,
              onPageChanged: (index) {
                setState(() {
                  _currentIndex = index;
                });
                HapticFeedback.selectionClick();
              },
              itemCount: widget.artifacts.length,
              itemBuilder: (context, index) {
                return _buildArtifactCard(widget.artifacts[index]);
              },
            ),
          ),
          _buildPageIndicator(),
          SizedBox(height: 20 + keyboardHeight * 0.1),
        ],
      ),
    );
  }

  Widget _buildHandle() {
    return Container(
      margin: const EdgeInsets.only(top: 12, bottom: 8),
      width: 40,
      height: 4,
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.3),
        borderRadius: BorderRadius.circular(2),
      ),
    );
  }

  Widget _buildHeader() {
    final isLargeScreen = MediaQuery.of(context).size.width > 600;
    final horizontalPadding = isLargeScreen ? 32.0 : 20.0;
    
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding, vertical: 10),
      child: Row(
        children: [
          Text(
            'Artifact Details',
            style: TextStyle(
              color: Colors.white,
              fontSize: isLargeScreen ? 22 : 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.pop(context),
            icon: Icon(
              Icons.close,
              color: Colors.white,
              size: isLargeScreen ? 28 : 24,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildArtifactCard(ArtifactItem artifact) {
    final isLargeScreen = MediaQuery.of(context).size.width > 600;
    final horizontalPadding = isLargeScreen ? 32.0 : 20.0;
    final imageHeight = MediaQuery.of(context).size.height * (isLargeScreen ? 0.4 : 0.3);
    
    return SingleChildScrollView(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
      child: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 800),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              GestureDetector(
                onTap: () => _showFullScreenImage(artifact),
                child: Container(
                  height: imageHeight,
                  width: double.infinity,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(16),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.4),
                        blurRadius: 8,
                        offset: const Offset(0, 4),
                      ),
                    ],
                  ),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(16),
                    child: Stack(
                      children: [
                        artifact.isNetworkSource
                            ? Image.network(
                                artifact.imagePath,
                                fit: BoxFit.cover,
                                width: double.infinity,
                                height: double.infinity,
                                errorBuilder: (context, error, stackTrace) {
                                  return Container(
                                    decoration: BoxDecoration(
                                      gradient: LinearGradient(
                                        begin: Alignment.topLeft,
                                        end: Alignment.bottomRight,
                                        colors: [
                                          widget.accentColor.withOpacity(0.7),
                                          widget.accentColor,
                                        ],
                                      ),
                                    ),
                                    child: const Center(
                                      child: Icon(
                                        Icons.museum,
                                        color: Colors.white,
                                        size: 60,
                                      ),
                                    ),
                                  );
                                },
                                loadingBuilder: (context, child, loadingProgress) {
                                  if (loadingProgress == null) return child;
                                  return Container(
                                    color: const Color(0xFF2A2A2A),
                                    child: const Center(
                                      child: CircularProgressIndicator(
                                        valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF4CAF50)),
                                      ),
                                    ),
                                  );
                                },
                              )
                            : Image.asset(
                                artifact.imagePath,
                                fit: BoxFit.cover,
                                width: double.infinity,
                                height: double.infinity,
                                errorBuilder: (context, error, stackTrace) {
                                  return Container(
                                    decoration: BoxDecoration(
                                      gradient: LinearGradient(
                                        begin: Alignment.topLeft,
                                        end: Alignment.bottomRight,
                                        colors: [
                                          widget.accentColor.withOpacity(0.7),
                                          widget.accentColor,
                                        ],
                                      ),
                                    ),
                                    child: const Center(
                                      child: Icon(
                                        Icons.museum,
                                        color: Colors.white,
                                        size: 60,
                                      ),
                                    ),
                                  );
                                },
                              ),
                        Positioned(
                          top: 8,
                          right: 8,
                          child: Container(
                            padding: const EdgeInsets.all(6),
                            decoration: BoxDecoration(
                              color: Colors.black.withOpacity(0.6),
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Icon(
                              Icons.fullscreen,
                              color: Colors.white,
                              size: isLargeScreen ? 20 : 16,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 16),
              Container(
                width: double.infinity,
                padding: EdgeInsets.all(isLargeScreen ? 20 : 16),
                decoration: BoxDecoration(
                  color: const Color(0xFF2A2A2A),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      artifact.name,
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: isLargeScreen ? 20 : 16,
                        fontWeight: FontWeight.w600,
                        height: 1.4,
                      ),
                    ),
                    const SizedBox(height: 12),
                    Text(
                      artifact.description,
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.9),
                        fontSize: isLargeScreen ? 16 : 14,
                        height: 1.5,
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(height: 30 + MediaQuery.of(context).viewInsets.bottom * 0.1),
            ],
          ),
        ),
      ),
    );
  }

  void _showFullScreenImage(ArtifactItem artifact) {
    Navigator.of(context).push(
      PageRouteBuilder(
        opaque: false,
        barrierColor: Colors.black,
        pageBuilder: (BuildContext context, _, __) {
          return FullScreenImageViewer(
            artifact: artifact,
            accentColor: widget.accentColor,
          );
        },
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
      ),
    );
  }

  Widget _buildPageIndicator() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: List.generate(
        widget.artifacts.length,
        (index) => Container(
          margin: const EdgeInsets.symmetric(horizontal: 4),
          width: 8,
          height: 8,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: index == _currentIndex
                ? widget.accentColor
                : Colors.white.withOpacity(0.3),
          ),
        ),
      ),
    );
  }
}

class FullScreenImageViewer extends StatefulWidget {
  final ArtifactItem artifact;
  final Color accentColor;

  const FullScreenImageViewer({
    super.key,
    required this.artifact,
    required this.accentColor,
  });

  @override
  State<FullScreenImageViewer> createState() => _FullScreenImageViewerState();
}

class _FullScreenImageViewerState extends State<FullScreenImageViewer> {
  bool _showControls = true;

  @override
  void initState() {
    super.initState();
    _hideControlsAfterDelay();
  }

  void _hideControlsAfterDelay() {
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        setState(() {
          _showControls = false;
        });
      }
    });
  }

  void _toggleControls() {
    setState(() {
      _showControls = !_showControls;
    });
    if (_showControls) {
      _hideControlsAfterDelay();
    }
  }

  @override
  Widget build(BuildContext context) {
    final isLargeScreen = MediaQuery.of(context).size.width > 600;
    
    return Scaffold(
      backgroundColor: Colors.black,
      body: GestureDetector(
        onTap: _toggleControls,
        child: Stack(
          children: [
            Center(
              child: InteractiveViewer(
                panEnabled: true,
                boundaryMargin: const EdgeInsets.all(20),
                minScale: 0.5,
                maxScale: 4.0,
                child: widget.artifact.isNetworkSource
                    ? Image.network(
                        widget.artifact.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            color: Colors.black,
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF4CAF50)),
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        widget.artifact.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.museum,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                      ),
              ),
            ),
            AnimatedOpacity(
              opacity: _showControls ? 1.0 : 0.0,
              duration: const Duration(milliseconds: 300),
              child: SafeArea(
                child: Column(
                  children: [
                    Container(
                      width: double.infinity,
                      padding: EdgeInsets.symmetric(
                        horizontal: isLargeScreen ? 32 : 20,
                        vertical: isLargeScreen ? 20 : 16,
                      ),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Row(
                        children: [
                          IconButton(
                            onPressed: () => Navigator.pop(context),
                            icon: Icon(
                              Icons.close,
                              color: Colors.white,
                              size: isLargeScreen ? 32 : 28,
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  widget.artifact.name,
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: isLargeScreen ? 22 : 18,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                Text(
                                  'Mansaka Artifact',
                                  style: TextStyle(
                                    color: widget.accentColor,
                                    fontSize: isLargeScreen ? 16 : 14,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                    const Spacer(),
                    Container(
                      width: double.infinity,
                      padding: EdgeInsets.all(isLargeScreen ? 32 : 20),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.bottomCenter,
                          end: Alignment.topCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.center,
                        children: [
                          Text(
                            'Tap to zoom  Pinch to scale  Drag to pan',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.7),
                              fontSize: isLargeScreen ? 14 : 12,
                            ),
                            textAlign: TextAlign.center,
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mansaka_category_screens\mansaka_event_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

class MansakaEventScreen extends StatefulWidget {
  const MansakaEventScreen({super.key});

  @override
  State<MansakaEventScreen> createState() => _MansakaEventScreenState();
}

class _MansakaEventScreenState extends State<MansakaEventScreen> {
  final TextEditingController _searchController = TextEditingController();
  String _searchQuery = '';

  // API and loading state
  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<EventItem> _allEvents = [];
  bool _isLoading = true;
  String? _errorMessage;

  List<EventItem> get _filteredEvents {
    if (_searchQuery.isEmpty) {
      return _allEvents;
    }
    return _allEvents.where((event) {
      return event.name.toLowerCase().contains(_searchQuery.toLowerCase()) ||
             event.description.toLowerCase().contains(_searchQuery.toLowerCase()) ||
             event.location.toLowerCase().contains(_searchQuery.toLowerCase());
    }).toList();
  }

  @override
  void initState() {
    super.initState();
    _fetchEvents();
  }

  Future<void> _fetchEvents() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching Mansaka events from: $_baseUrl');
      
      const String apiUrl = '$_baseUrl?tribe=mansaka&category=event';
      debugPrint('API URL: $apiUrl');

      final response = await http.get(
        Uri.parse(apiUrl),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      ).timeout(const Duration(seconds: 15));
      
      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');
      
      if (response.statusCode != 200) {
        throw Exception('API returned status code: ${response.statusCode}');
      }

      final Map<String, dynamic> jsonData = json.decode(response.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      if (!jsonData.containsKey('data')) {
        throw Exception('API response missing "data" field');
      }

      final dynamic rawData = jsonData['data'];
      List<dynamic> contentItems = [];
      
      if (rawData is List) {
        contentItems = rawData;
      } else if (rawData is Map) {
        contentItems = [rawData];
      } else {
        throw Exception('Unexpected data format in API response');
      }

      debugPrint('Found ${contentItems.length} content items');

      final List<EventItem> events = [];

      for (var item in contentItems) {
        if (item == null || item is! Map<String, dynamic>) {
          debugPrint('Skipping invalid item: $item');
          continue;
        }
        
        debugPrint('Processing item: ${item.toString()}');
        
        final dynamic id = item['id'];
        final dynamic userId = item['user_id'];
        final String? title = item['title']?.toString();
        final String? category = item['category']?.toString();
        final String? tribe = item['tribe']?.toString();
        final String? description = item['description']?.toString();
        final String? file = item['file']?.toString();
        final dynamic isArchived = item['is_archived'];
        final String? time = item['time']?.toString();
        
        if (id == null || 
            userId == null || 
            title == null || title.isEmpty ||
            category == null || category.isEmpty ||
            tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty ||
            isArchived == null ||
            time == null || time.isEmpty) {
          debugPrint('Skipping item with missing required fields');
          continue;
        }
        
        if (tribe.toLowerCase() != 'mansaka') {
          debugPrint('Skipping non-Mansaka item: $tribe');
          continue;
        }

        if (isArchived != 0) {
          debugPrint('Skipping archived item: $title');
          continue;
        }

        if (category.toLowerCase() != 'event' && !_isImageContent(file)) {
          debugPrint('Skipping non-event content: $file (category: $category)');
          continue;
        }

        final event = EventItem(
          id: id.toString(),
          name: title,
          description: description ?? 'No description available',
          imagePath: '$_uploadsBaseUrl$file',
          file: file,
          location: 'Davao Region, Philippines',
          date: _formatDate(time),
          isNetworkSource: true,
        );
        
        debugPrint(' Added event: $title (ID: $id, Category: $category)');
        events.add(event);
      }

      debugPrint('Final event count: ${events.length}');

      setState(() {
        _allEvents = events;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching events: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load events: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  bool _isImageContent(String filename) {
    final String lowerFilename = filename.toLowerCase();
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    return imageExtensions.any((ext) => lowerFilename.endsWith(ext));
  }

  String _formatDate(String timeString) {
    try {
      final DateTime dateTime = DateTime.parse(timeString);
      final months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                     'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return '${months[dateTime.month - 1]} ${dateTime.day}, ${dateTime.year}';
    } catch (e) {
      return timeString;
    }
  }

  Future<void> _refreshEvents() async {
    await _fetchEvents();
  }

  // Responsive helper methods
  int _getCrossAxisCount(double width) {
    if (width >= 1200) return 4;
    if (width >= 900) return 3;
    if (width >= 600) return 2;
    return 2;
  }

  double _getHorizontalPadding(double width) {
    if (width >= 1200) return 40;
    if (width >= 900) return 32;
    if (width >= 600) return 24;
    return 20;
  }

  double _getFeaturedImageHeight(double width) {
    if (width >= 1200) return 300;
    if (width >= 900) return 250;
    if (width >= 600) return 220;
    return 200;
  }

  double _getHeaderFontSize(double width) {
    if (width >= 900) return 24;
    if (width >= 600) return 22;
    return 20;
  }

  double _getDescriptionFontSize(double width) {
    if (width >= 900) return 18;
    if (width >= 600) return 17;
    return 16;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              _buildHeader(),
              Expanded(
                child: _isLoading 
                    ? _buildLoadingState()
                    : _errorMessage != null 
                        ? _buildErrorState()
                        : _allEvents.isEmpty
                            ? _buildEmptyState()
                            : _buildContent(),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildLoadingState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const CircularProgressIndicator(
            valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFB19CD9)),
          ),
          const SizedBox(height: 16),
          Text(
            'Loading Mansaka events...',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 14,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildErrorState() {
    return Center(
      child: Padding(
        padding: EdgeInsets.symmetric(
          horizontal: _getHorizontalPadding(MediaQuery.of(context).size.width),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            const SizedBox(height: 16),
            Text(
              'Failed to load events',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32),
              child: Text(
                _errorMessage!,
                style: TextStyle(
                  color: Colors.white.withOpacity(0.5),
                  fontSize: 14,
                ),
                textAlign: TextAlign.center,
              ),
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: _refreshEvents,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFFB19CD9),
                foregroundColor: Colors.white,
              ),
              child: const Text('Retry'),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.event_outlined,
            size: 64,
            color: Colors.white.withOpacity(0.5),
          ),
          const SizedBox(height: 16),
          Text(
            'No Mansaka events available',
            style: TextStyle(
              color: Colors.white.withOpacity(0.7),
              fontSize: 18,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Check back later for new events',
            style: TextStyle(
              color: Colors.white.withOpacity(0.5),
              fontSize: 14,
            ),
          ),
          const SizedBox(height: 24),
          ElevatedButton(
            onPressed: _refreshEvents,
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFFB19CD9),
              foregroundColor: Colors.white,
            ),
            child: const Text('Refresh'),
          ),
        ],
      ),
    );
  }

  Widget _buildContent() {
    final width = MediaQuery.of(context).size.width;
    final horizontalPadding = _getHorizontalPadding(width);

    return RefreshIndicator(
      onRefresh: _refreshEvents,
      color: const Color(0xFFB19CD9),
      child: LayoutBuilder(
        builder: (context, constraints) {
          // Center content for large screens
          final maxWidth = constraints.maxWidth > 1400 ? 1400.0 : constraints.maxWidth;
          
          return Center(
            child: Container(
              constraints: BoxConstraints(maxWidth: maxWidth),
              child: SingleChildScrollView(
                physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
                keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildSearchBar(horizontalPadding),
                    const SizedBox(height: 20),
                    _buildFeaturedImage(horizontalPadding, width),
                    const SizedBox(height: 24),
                    _buildDescription(horizontalPadding, width),
                    const SizedBox(height: 32),
                    _buildBrowseSection(horizontalPadding),
                    const SizedBox(height: 20),
                    _buildEventsGrid(horizontalPadding, width),
                    SizedBox(height: 40 + MediaQuery.of(context).viewInsets.bottom),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildHeader() {
    final width = MediaQuery.of(context).size.width;
    final horizontalPadding = _getHorizontalPadding(width);
    final fontSize = _getHeaderFontSize(width);

    return Padding(
      padding: EdgeInsets.all(horizontalPadding),
      child: Row(
        children: [
          Container(
            decoration: BoxDecoration(
              color: Colors.black.withOpacity(0.3),
              borderRadius: BorderRadius.circular(12),
            ),
            child: IconButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                Navigator.pop(context);
              },
              icon: const Icon(
                Icons.arrow_back_ios,
                color: Colors.white,
                size: 20,
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Text(
              'MANSAKA EVENTS',
              style: TextStyle(
                color: Colors.white,
                fontSize: fontSize,
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchBar(double horizontalPadding) {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Container(
        decoration: BoxDecoration(
          color: const Color(0xFF2A2A2A),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: const Color(0xFFB19CD9).withOpacity(0.3),
            width: 1,
          ),
        ),
        child: TextField(
          controller: _searchController,
          onChanged: (value) {
            setState(() {
              _searchQuery = value;
            });
          },
          style: const TextStyle(color: Colors.white),
          decoration: InputDecoration(
            hintText: 'Search events',
            hintStyle: TextStyle(
              color: Colors.white.withOpacity(0.6),
              fontSize: 16,
            ),
            prefixIcon: Icon(
              Icons.search,
              color: Colors.white.withOpacity(0.6),
            ),
            suffixIcon: _searchQuery.isNotEmpty
                ? IconButton(
                    onPressed: () {
                      setState(() {
                        _searchController.clear();
                        _searchQuery = '';
                      });
                    },
                    icon: Icon(
                      Icons.clear,
                      color: Colors.white.withOpacity(0.6),
                    ),
                  )
                : null,
            border: InputBorder.none,
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 16,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildFeaturedImage(double horizontalPadding, double width) {
    final height = _getFeaturedImageHeight(width);

    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Container(
        height: height,
        width: double.infinity,
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Image.asset(
            'assets/images/mansaka_eve.jpg',
            fit: BoxFit.cover,
            errorBuilder: (context, error, stackTrace) {
              return Container(
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      Color(0xFFB19CD9),
                      Color(0xFF5D4E75),
                      Color(0xFF3F325A),
                    ],
                  ),
                ),
                child: const Center(
                  child: Icon(
                    Icons.event,
                    color: Colors.white,
                    size: 60,
                  ),
                ),
              );
            },
          ),
        ),
      ),
    );
  }

  Widget _buildDescription(double horizontalPadding, double width) {
    final fontSize = _getDescriptionFontSize(width);

    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Browse through a collection of historical and contemporary photographs showcasing Mansaka events, ceremonies, and cultural celebrations that preserve their rich heritage.',
            style: TextStyle(
              color: Colors.white.withOpacity(0.9),
              fontSize: fontSize,
              height: 1.6,
              letterSpacing: 0.5,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBrowseSection(double horizontalPadding) {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Text(
        'Browse events (${_filteredEvents.length})',
        style: const TextStyle(
          color: Colors.white,
          fontSize: 20,
          fontWeight: FontWeight.bold,
        ),
      ),
    );
  }

  Widget _buildEventsGrid(double horizontalPadding, double width) {
    if (_filteredEvents.isEmpty) {
      return _buildNoResults(horizontalPadding);
    }

    final crossAxisCount = _getCrossAxisCount(width);
    final spacing = width >= 900 ? 20.0 : 16.0;
    final childAspectRatio = width >= 600 ? 0.9 : 0.85;

    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: GridView.builder(
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: crossAxisCount,
          crossAxisSpacing: spacing,
          mainAxisSpacing: spacing,
          childAspectRatio: childAspectRatio,
        ),
        itemCount: _filteredEvents.length,
        itemBuilder: (context, index) {
          return _buildEventCard(_filteredEvents[index], index);
        },
      ),
    );
  }

  Widget _buildNoResults(double horizontalPadding) {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const SizedBox(height: 60),
            Icon(
              Icons.search_off,
              size: 64,
              color: Colors.white.withOpacity(0.3),
            ),
            const SizedBox(height: 16),
            Text(
              'No events found',
              style: TextStyle(
                color: Colors.white.withOpacity(0.6),
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'Try searching with different keywords',
              style: TextStyle(
                color: Colors.white.withOpacity(0.4),
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 60),
          ],
        ),
      ),
    );
  }

  Widget _buildEventCard(EventItem event, int index) {
    return GestureDetector(
      onTap: () {
        HapticFeedback.mediumImpact();
        _showEventViewer(event, index);
      },
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.4),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              Expanded(
                flex: 3,
                child: event.isNetworkSource
                    ? Image.network(
                        event.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFFB19CD9),
                                  Color(0xFF5D4E75),
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: 40,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            color: const Color(0xFF2A2A2A),
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFB19CD9)),
                                strokeWidth: 2,
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        event.imagePath,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            decoration: const BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Color(0xFFB19CD9),
                                  Color(0xFF5D4E75),
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: 40,
                              ),
                            ),
                          );
                        },
                      ),
              ),
              Container(
                padding: const EdgeInsets.all(12),
                color: const Color(0xFF2A2A2A),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      event.name,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 4),
                    Text(
                      event.description,
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: 12,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showEventViewer(EventItem event, int index) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => EventViewerBottomSheet(
        events: _filteredEvents,
        initialIndex: index,
        accentColor: const Color(0xFFB19CD9),
      ),
    );
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }
}

class EventItem {
  final String? id;
  final String name;
  final String description;
  final String imagePath;
  final String? file;
  final String location;
  final String date;
  final bool isNetworkSource;

  EventItem({
    this.id,
    required this.name,
    required this.description,
    required this.imagePath,
    this.file,
    required this.location,
    required this.date,
    this.isNetworkSource = false,
  });
}

class EventViewerBottomSheet extends StatefulWidget {
  final List<EventItem> events;
  final int initialIndex;
  final Color accentColor;

  const EventViewerBottomSheet({
    super.key,
    required this.events,
    required this.initialIndex,
    required this.accentColor,
  });

  @override
  State<EventViewerBottomSheet> createState() => _EventViewerBottomSheetState();
}

class _EventViewerBottomSheetState extends State<EventViewerBottomSheet> {
  late PageController _pageController;
  late int _currentIndex;

  @override
  void initState() {
    super.initState();
    _currentIndex = widget.initialIndex;
    _pageController = PageController(initialPage: widget.initialIndex);
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;
    final screenWidth = MediaQuery.of(context).size.width;
    final isTablet = screenWidth >= 600;
    final maxWidth = screenWidth > 800 ? 800.0 : screenWidth;
    
    return Center(
      child: Container(
        constraints: BoxConstraints(maxWidth: maxWidth),
        decoration: const BoxDecoration(
          color: Color(0xFF1a1a1a),
          borderRadius: BorderRadius.vertical(
            top: Radius.circular(20),
          ),
        ),
        child: Column(
          children: [
            _buildHandle(),
            _buildHeader(isTablet),
            Expanded(
              child: PageView.builder(
                controller: _pageController,
                onPageChanged: (index) {
                  setState(() {
                    _currentIndex = index;
                  });
                  HapticFeedback.selectionClick();
                },
                itemCount: widget.events.length,
                itemBuilder: (context, index) {
                  return _buildEventCard(widget.events[index], isTablet);
                },
              ),
            ),
            _buildPageIndicator(),
            SizedBox(height: 20 + keyboardHeight * 0.1),
          ],
        ),
      ),
    );
  }

  Widget _buildHandle() {
    return Container(
      margin: const EdgeInsets.only(top: 12, bottom: 8),
      width: 40,
      height: 4,
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.3),
        borderRadius: BorderRadius.circular(2),
      ),
    );
  }

  Widget _buildHeader(bool isTablet) {
    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: isTablet ? 32 : 20,
        vertical: 10,
      ),
      child: Row(
        children: [
          Text(
            'Event Details',
            style: TextStyle(
              color: Colors.white,
              fontSize: isTablet ? 20 : 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.pop(context),
            icon: const Icon(
              Icons.close,
              color: Colors.white,
              size: 24,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEventCard(EventItem event, bool isTablet) {
    final horizontalPadding = isTablet ? 32.0 : 20.0;
    final imageHeight = isTablet ? 350.0 : 250.0;

    return SingleChildScrollView(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
      keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          GestureDetector(
            onTap: () => _showFullScreenImage(event),
            child: Container(
              height: imageHeight,
              width: double.infinity,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.4),
                    blurRadius: 8,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(16),
                child: Stack(
                  children: [
                    event.isNetworkSource
                        ? Image.network(
                            event.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: const Center(
                                  child: Icon(
                                    Icons.event,
                                    color: Colors.white,
                                    size: 60,
                                  ),
                                ),
                              );
                            },
                            loadingBuilder: (context, child, loadingProgress) {
                              if (loadingProgress == null) return child;
                              return Container(
                                color: const Color(0xFF2A2A2A),
                                child: const Center(
                                  child: CircularProgressIndicator(
                                    valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFB19CD9)),
                                  ),
                                ),
                              );
                            },
                          )
                        : Image.asset(
                            event.imagePath,
                            fit: BoxFit.cover,
                            width: double.infinity,
                            height: double.infinity,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topLeft,
                                    end: Alignment.bottomRight,
                                    colors: [
                                      widget.accentColor.withOpacity(0.7),
                                      widget.accentColor,
                                    ],
                                  ),
                                ),
                                child: const Center(
                                  child: Icon(
                                    Icons.event,
                                    color: Colors.white,
                                    size: 60,
                                  ),
                                ),
                              );
                            },
                          ),
                    Positioned(
                      top: 8,
                      right: 8,
                      child: Container(
                        padding: const EdgeInsets.all(6),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.6),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: const Icon(
                          Icons.fullscreen,
                          color: Colors.white,
                          size: 16,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: EdgeInsets.all(isTablet ? 20 : 16),
            decoration: BoxDecoration(
              color: const Color(0xFF2A2A2A),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  event.name,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: isTablet ? 18 : 16,
                    fontWeight: FontWeight.w600,
                    height: 1.4,
                  ),
                ),
                const SizedBox(height: 12),
                Text(
                  event.description,
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.9),
                    fontSize: isTablet ? 16 : 14,
                    height: 1.5,
                  ),
                ),
              ],
            ),
          ),
          SizedBox(height: 30 + MediaQuery.of(context).viewInsets.bottom * 0.1),
        ],
      ),
    );
  }

  void _showFullScreenImage(EventItem event) {
    Navigator.of(context).push(
      PageRouteBuilder(
        opaque: false,
        barrierColor: Colors.black,
        pageBuilder: (BuildContext context, _, __) {
          return FullScreenImageViewer(
            event: event,
            accentColor: widget.accentColor,
          );
        },
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
      ),
    );
  }

  Widget _buildPageIndicator() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: List.generate(
        widget.events.length,
        (index) => Container(
          margin: const EdgeInsets.symmetric(horizontal: 4),
          width: 8,
          height: 8,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: index == _currentIndex
                ? widget.accentColor
                : Colors.white.withOpacity(0.3),
          ),
        ),
      ),
    );
  }
}

class FullScreenImageViewer extends StatefulWidget {
  final EventItem event;
  final Color accentColor;

  const FullScreenImageViewer({
    super.key,
    required this.event,
    required this.accentColor,
  });

  @override
  State<FullScreenImageViewer> createState() => _FullScreenImageViewerState();
}

class _FullScreenImageViewerState extends State<FullScreenImageViewer> {
  bool _showControls = true;

  @override
  void initState() {
    super.initState();
    _hideControlsAfterDelay();
  }

  void _hideControlsAfterDelay() {
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        setState(() {
          _showControls = false;
        });
      }
    });
  }

  void _toggleControls() {
    setState(() {
      _showControls = !_showControls;
    });
    if (_showControls) {
      _hideControlsAfterDelay();
    }
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final isTablet = screenWidth >= 600;

    return Scaffold(
      backgroundColor: Colors.black,
      body: GestureDetector(
        onTap: _toggleControls,
        child: Stack(
          children: [
            Center(
              child: InteractiveViewer(
                panEnabled: true,
                boundaryMargin: const EdgeInsets.all(20),
                minScale: 0.5,
                maxScale: 4.0,
                child: widget.event.isNetworkSource
                    ? Image.network(
                        widget.event.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            color: Colors.black,
                            child: const Center(
                              child: CircularProgressIndicator(
                                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFB19CD9)),
                              ),
                            ),
                          );
                        },
                      )
                    : Image.asset(
                        widget.event.imagePath,
                        fit: BoxFit.contain,
                        errorBuilder: (context, error, stackTrace) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            height: MediaQuery.of(context).size.height * 0.7,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  widget.accentColor.withOpacity(0.7),
                                  widget.accentColor,
                                ],
                              ),
                            ),
                            child: const Center(
                              child: Icon(
                                Icons.event,
                                color: Colors.white,
                                size: 100,
                              ),
                            ),
                          );
                        },
                      ),
              ),
            ),
            AnimatedOpacity(
              opacity: _showControls ? 1.0 : 0.0,
              duration: const Duration(milliseconds: 300),
              child: SafeArea(
                child: Column(
                  children: [
                    Container(
                      width: double.infinity,
                      padding: EdgeInsets.symmetric(
                        horizontal: isTablet ? 32 : 20,
                        vertical: 16,
                      ),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Row(
                        children: [
                          IconButton(
                            onPressed: () => Navigator.pop(context),
                            icon: const Icon(
                              Icons.close,
                              color: Colors.white,
                              size: 28,
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  widget.event.name,
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: isTablet ? 20 : 18,
                                    fontWeight: FontWeight.bold,
                                  ),
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                ),
                                Text(
                                  'Mansaka Event',
                                  style: TextStyle(
                                    color: widget.accentColor,
                                    fontSize: isTablet ? 16 : 14,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                    const Spacer(),
                    Container(
                      width: double.infinity,
                      padding: EdgeInsets.all(isTablet ? 24 : 20),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.bottomCenter,
                          end: Alignment.topCenter,
                          colors: [
                            Colors.black.withOpacity(0.8),
                            Colors.transparent,
                          ],
                        ),
                      ),
                      child: Text(
                        'Tap to zoom  Pinch to scale  Drag to pan',
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: isTablet ? 14 : 12,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mansaka_category_screens\mansaka_music_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:audioplayers/audioplayers.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';

class MansakaMusicScreen extends StatefulWidget {
  const MansakaMusicScreen({super.key});

  @override
  State<MansakaMusicScreen> createState() => _MansakaMusicScreenState();
}

class _MansakaMusicScreenState extends State<MansakaMusicScreen> {
  String _searchQuery = '';
  final TextEditingController _searchController = TextEditingController();
  final FocusNode _searchFocusNode = FocusNode();
  bool _isSearchFocused = false;
  
  final ScrollController _scrollController = ScrollController();
  bool _isHeaderVisible = true;
  double _lastScrollOffset = 0;

  final AudioPlayer _audioPlayer = AudioPlayer();
  MusicTrack? _currentTrack;
  bool _isPlaying = false;
  Duration _currentPosition = Duration.zero;
  Duration _totalDuration = Duration.zero;
  bool _isLoadingAudio = false;

  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<MusicTrack> _allTracks = [];
  bool _isLoading = true;
  String? _errorMessage;
  MusicTrack? _featuredTrack;

  Map<String, Duration> _durationCache = {};
  SharedPreferences? _prefs;
  final Set<String> _loadingDurations = {};

  List<MusicTrack> get _filteredTracks {
    if (_searchQuery.isEmpty) {
      return _allTracks;
    }
    
    return _allTracks.where((track) =>
        track.title.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        track.description.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        track.category.toLowerCase().contains(_searchQuery.toLowerCase())).toList();
  }

  // Responsive helpers
  EdgeInsets _getContentPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 800) return const EdgeInsets.symmetric(horizontal: 32);
    if (width >= 600) return const EdgeInsets.symmetric(horizontal: 24);
    return const EdgeInsets.symmetric(horizontal: 16);
  }

  double _getHeroHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    final height = MediaQuery.of(context).size.height;
    if (width >= 800) return height * 0.35;
    if (width >= 600) return 250;
    return 200;
  }

  double _getCardHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 800) return 110;
    if (width >= 600) return 100;
    return 90;
  }

  double _getPlayerHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width >= 600) return 140;
    return 120;
  }

  @override
  void initState() {
    super.initState();
    _initializePreferences();
    _setupAudioPlayer();
    _setupScrollController();
    _searchFocusNode.addListener(() {
      setState(() {
        _isSearchFocused = _searchFocusNode.hasFocus;
      });
    });
    _fetchMusicTracks();
  }

  Future<void> _initializePreferences() async {
    _prefs = await SharedPreferences.getInstance();
    _loadDurationCache();
  }

  void _loadDurationCache() {
    if (_prefs == null) return;
    
    final cacheJson = _prefs!.getString('mansaka_music_duration_cache');
    if (cacheJson != null) {
      try {
        final Map<String, dynamic> decoded = json.decode(cacheJson);
        _durationCache = decoded.map((key, value) => 
          MapEntry(key, Duration(milliseconds: value as int))
        );
        debugPrint('Loaded ${_durationCache.length} cached Mansaka durations');
      } catch (e) {
        debugPrint('Error loading duration cache: $e');
      }
    }
  }

  Future<void> _saveDurationCache() async {
    if (_prefs == null) return;
    
    try {
      final cacheJson = json.encode(
        _durationCache.map((key, value) => 
          MapEntry(key, value.inMilliseconds)
        )
      );
      await _prefs!.setString('mansaka_music_duration_cache', cacheJson);
      debugPrint('Saved ${_durationCache.length} Mansaka durations to cache');
    } catch (e) {
      debugPrint('Error saving duration cache: $e');
    }
  }

  Duration? _getCachedDuration(String trackId) {
    return _durationCache[trackId];
  }

  Future<void> _cacheDuration(String trackId, Duration duration) async {
    _durationCache[trackId] = duration;
    await _saveDurationCache();
  }

  Future<void> _loadTrackDuration(MusicTrack track) async {
    if (_durationCache.containsKey(track.id) || _loadingDurations.contains(track.id)) {
      return;
    }

    _loadingDurations.add(track.id);

    try {
      final tempPlayer = AudioPlayer();
      
      if (track.isNetworkSource) {
        await tempPlayer.setSourceUrl(track.audioPath);
      } else {
        await tempPlayer.setSource(AssetSource(track.audioPath));
      }

      Duration? duration;
      int attempts = 0;
      while (duration == null && attempts < 10) {
        duration = await tempPlayer.getDuration();
        if (duration == null) {
          await Future.delayed(const Duration(milliseconds: 200));
        }
        attempts++;
      }

      if (duration != null && duration.inMilliseconds > 0) {
        await _cacheDuration(track.id, duration);
        if (mounted) {
          setState(() {
            final index = _allTracks.indexWhere((t) => t.id == track.id);
            if (index != -1) {
              _allTracks[index] = track.copyWith(duration: duration);
            }
          });
        }
        debugPrint('Cached duration for ${track.title}: ${_formatDuration(duration)}');
      }

      await tempPlayer.dispose();
    } catch (e) {
      debugPrint('Error loading duration for ${track.title}: $e');
    } finally {
      _loadingDurations.remove(track.id);
    }
  }

  void _setupScrollController() {
    _scrollController.addListener(() {
      final currentOffset = _scrollController.offset;
      final isScrollingDown = currentOffset > _lastScrollOffset;
      final shouldHideHeader = isScrollingDown && currentOffset > 100;
      final shouldShowHeader = !isScrollingDown || currentOffset <= 50;

      if (_isHeaderVisible && shouldHideHeader && !_isSearchFocused) {
        setState(() {
          _isHeaderVisible = false;
        });
      } else if (!_isHeaderVisible && shouldShowHeader) {
        setState(() {
          _isHeaderVisible = true;
        });
      }

      _lastScrollOffset = currentOffset;
    });
  }

  void _setupAudioPlayer() {
    _audioPlayer.onPositionChanged.listen((position) {
      if (mounted) {
        setState(() {
          _currentPosition = position;
        });
      }
    });

    _audioPlayer.onDurationChanged.listen((duration) {
      if (mounted) {
        setState(() {
          _totalDuration = duration;
        });
      }
      
      if (_currentTrack != null && duration.inMilliseconds > 0) {
        _cacheDuration(_currentTrack!.id, duration);
      }
    });

    _audioPlayer.onPlayerStateChanged.listen((state) {
      if (mounted) {
        setState(() {
          _isPlaying = state == PlayerState.playing;
          _isLoadingAudio = state == PlayerState.playing && _currentPosition == Duration.zero;
        });
      }
    });

    _audioPlayer.onPlayerComplete.listen((_) {
      if (mounted) {
        setState(() {
          _isPlaying = false;
          _currentPosition = Duration.zero;
        });
      }
    });
  }

  Future<void> _fetchMusicTracks() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching Mansaka music tracks from: $_baseUrl');
      
      const String apiUrl = '$_baseUrl?tribe=mansaka';
      debugPrint('API URL: $apiUrl');

      final response = await http.get(
        Uri.parse(apiUrl),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      ).timeout(const Duration(seconds: 15));
      
      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');
      
      if (response.statusCode != 200) {
        throw Exception('API returned status code: ${response.statusCode}');
      }

      final Map<String, dynamic> jsonData = json.decode(response.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      if (!jsonData.containsKey('data')) {
        throw Exception('API response missing "data" field');
      }

      final dynamic rawData = jsonData['data'];
      List<dynamic> contentItems = [];
      
      if (rawData is List) {
        contentItems = rawData;
      } else if (rawData is Map) {
        contentItems = [rawData];
      } else {
        throw Exception('Unexpected data format in API response');
      }

      debugPrint('Found ${contentItems.length} content items');

      final List<MusicTrack> musicTracks = [];

      for (var item in contentItems) {
        if (item == null || item is! Map<String, dynamic>) {
          debugPrint('Skipping invalid item: $item');
          continue;
        }
        
        debugPrint('Processing item: ${item.toString()}');
        
        final dynamic id = item['id'];
        final dynamic userId = item['user_id'];
        final String? title = item['title']?.toString();
        final String? category = item['category']?.toString();
        final String? tribe = item['tribe']?.toString();
        final String? description = item['description']?.toString();
        final String? file = item['file']?.toString();
        final dynamic isArchived = item['is_archived'];
        final String? time = item['time']?.toString();
        
        if (id == null || 
            userId == null || 
            title == null || title.isEmpty ||
            category == null || category.isEmpty ||
            tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty ||
            isArchived == null ||
            time == null || time.isEmpty) {
          debugPrint('Skipping item with missing required fields');
          continue;
        }
        
        if (tribe.toLowerCase() != 'mansaka') {
          debugPrint('Skipping non-Mansaka item: $tribe');
          continue;
        }

        if (isArchived != 0) {
          debugPrint('Skipping archived item: $title');
          continue;
        }

        final fileType = _determineFileType(file);
        
        if (!_isAudioContent(file, category)) {
          debugPrint('Skipping non-audio content: $file (category: $category, type: $fileType)');
          continue;
        }

        final cachedDuration = _getCachedDuration(id.toString());

        final musicTrack = MusicTrack(
          id: id.toString(),
          title: title,
          description: description ?? 'No description available',
          category: _mapCategory(category),
          artist: _extractArtist(description, title),
          audioPath: '$_uploadsBaseUrl$file',
          file: file,
          fileType: fileType,
          isNetworkSource: true,
          duration: cachedDuration,
        );
        
        debugPrint(' Added music track: $title (ID: $id, Category: $category, Cached Duration: ${cachedDuration != null ? _formatDuration(cachedDuration) : 'Not cached'})');
        musicTracks.add(musicTrack);

        if (cachedDuration == null) {
          _loadTrackDuration(musicTrack);
        }
      }

      debugPrint('Final music track count: ${musicTracks.length}');

      setState(() {
        _allTracks = musicTracks;
        _featuredTrack = musicTracks.isNotEmpty ? musicTracks.first : null;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching music tracks: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load music tracks: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  bool _isAudioContent(String filename, String category) {
    final String lowerFilename = filename.toLowerCase();
    final String lowerCategory = category.toLowerCase();
    
    const audioExtensions = ['.mp3', '.wav', '.aac', '.ogg', '.m4a', '.flac'];
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv'];
    
    final hasAudioExtension = audioExtensions.any((ext) => lowerFilename.endsWith(ext));
    final hasVideoExtension = videoExtensions.any((ext) => lowerFilename.endsWith(ext));
    
    const musicCategories = ['audio', 'music', 'song', 'instrument', 'ceremony'];
    final isMusicCategory = musicCategories.any((cat) => lowerCategory.contains(cat));
    
    return hasAudioExtension || (hasVideoExtension && isMusicCategory);
  }

  FileType _determineFileType(String filename) {
    final String lowerFilename = filename.toLowerCase();
    
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv', '.flv', '.wmv'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const audioExtensions = ['.mp3', '.wav', '.aac', '.ogg', '.m4a', '.flac'];
    
    if (audioExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.audio;
    } else if (videoExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.video;
    } else if (imageExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.image;
    }
    
    return FileType.unknown;
  }

  String _mapCategory(String category) {
    switch (category.toLowerCase()) {
      case 'audio':
        return 'Traditional Music';
      case 'instrument':
        return 'Instrumental';
      case 'ceremony':
        return 'Ceremonial';
      case 'video':
        return 'Audio/Video';
      case 'music':
        return 'Music';
      case 'song':
        return 'Song';
      default:
        return category;
    }
  }

  String _extractArtist(String? description, String title) {
    if (description != null && description.isNotEmpty) {
      final RegExp artistPattern = RegExp(r'(?:by|artist|performed by|sung by)\s+([^,\.\-\n]+)', caseSensitive: false);
      final match = artistPattern.firstMatch(description);
      if (match != null && match.group(1) != null) {
        return match.group(1)!.trim();
      }
      
      if (description.length < 50 && 
          !description.toLowerCase().contains(RegExp(r'\b(the|a|an|and|or|but|in|on|at|to|for|of|with|by)\b'))) {
        return description.trim();
      }
    }
    
    final lowerTitle = title.toLowerCase();
    if (lowerTitle.contains(RegExp(r'\b(elder|traditional|ancestral|ancient)\b'))) {
      return 'Mansaka Elders';
    } else if (lowerTitle.contains(RegExp(r'\b(ritual|ceremony|ceremonial|sacred)\b'))) {
      return 'Tribal Ensemble';
    } else if (lowerTitle.contains(RegExp(r'\b(instrument|instrumental|music)\b'))) {
      return 'Mansaka Musicians';
    }
    
    return 'Mansaka Artist';
  }

  Future<void> _refreshMusicTracks() async {
    await _fetchMusicTracks();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              AnimatedContainer(
                duration: const Duration(milliseconds: 300),
                height: (_isHeaderVisible || _isSearchFocused) ? 80 : 0,
                child: (_isHeaderVisible || _isSearchFocused) ? _buildHeader(context) : const SizedBox.shrink(),
              ),
              
              Expanded(
                child: _isSearchFocused 
                    ? _buildSearchResults()
                    : _buildMainContent(),
              ),
              
              if (_currentTrack != null) _buildInlineMusicPlayer(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeader(BuildContext context) {
    final padding = _getContentPadding(context);
    final width = MediaQuery.of(context).size.width;

    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: padding.horizontal / 2,
        vertical: 16,
      ),
      child: Row(
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused && width < 600 ? 0 : 48,
            child: _isSearchFocused && width < 600
                ? const SizedBox.shrink()
                : Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: const Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ),
          ),
          
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused && width < 600 ? 0 : 16,
          ),
          
          Expanded(
            child: Container(
              height: 48,
              constraints: const BoxConstraints(maxWidth: 600),
              decoration: BoxDecoration(
                color: const Color(0xFF2A2A2A),
                borderRadius: BorderRadius.circular(24),
                border: Border.all(
                  color: _isSearchFocused 
                      ? const Color(0xFFB19CD9) 
                      : const Color(0xFFB19CD9).withOpacity(0.3),
                  width: _isSearchFocused ? 2 : 1,
                ),
              ),
              child: TextField(
                controller: _searchController,
                focusNode: _searchFocusNode,
                style: const TextStyle(color: Colors.white),
                scrollPhysics: const BouncingScrollPhysics(),
                decoration: InputDecoration(
                  hintText: 'Search music tracks...',
                  hintStyle: TextStyle(
                    color: Colors.white.withOpacity(0.6),
                    fontSize: 14,
                  ),
                  prefixIcon: Icon(
                    Icons.search,
                    color: _isSearchFocused 
                        ? const Color(0xFFB19CD9)
                        : Colors.white.withOpacity(0.6),
                  ),
                  suffixIcon: _searchQuery.isNotEmpty
                      ? IconButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {
                              _searchQuery = '';
                            });
                          },
                          icon: Icon(
                            Icons.clear,
                            color: Colors.white.withOpacity(0.6),
                          ),
                        )
                      : null,
                  border: InputBorder.none,
                  contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                ),
                onChanged: (value) {
                  setState(() {
                    _searchQuery = value;
                  });
                },
              ),
            ),
          ),
          
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 80 : 0,
            child: _isSearchFocused
                ? TextButton(
                    onPressed: () {
                      _searchController.clear();
                      _searchFocusNode.unfocus();
                      setState(() {
                        _searchQuery = '';
                        _isHeaderVisible = true;
                      });
                    },
                    child: const Text(
                      'Cancel',
                      style: TextStyle(
                        color: Color(0xFFB19CD9),
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  )
                : const SizedBox.shrink(),
          ),
        ],
      ),
    );
  }

  Widget _buildMainContent() {
    if (_isLoading) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFB19CD9)),
            ),
            const SizedBox(height: 16),
            Text(
              'Loading Mansaka music tracks...',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: 14,
              ),
            ),
          ],
        ),
      );
    }

    if (_errorMessage != null) {
      final padding = _getContentPadding(context);
      return Center(
        child: Padding(
          padding: padding,
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Colors.white.withOpacity(0.5),
              ),
              const SizedBox(height: 16),
              Text(
                'Failed to load music tracks',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.7),
                  fontSize: 18,
                  fontWeight: FontWeight.w500,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                _errorMessage!,
                style: TextStyle(
                  color: Colors.white.withOpacity(0.5),
                  fontSize: 14,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: _refreshMusicTracks,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFFB19CD9),
                  foregroundColor: Colors.white,
                ),
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      );
    }

    if (_allTracks.isEmpty) {
      final padding = _getContentPadding(context);
      return Center(
        child: Padding(
          padding: padding,
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                Icons.music_note_outlined,
                size: 64,
                color: Colors.white.withOpacity(0.5),
              ),
              const SizedBox(height: 16),
              Text(
                'No Mansaka music tracks available',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.7),
                  fontSize: 18,
                  fontWeight: FontWeight.w500,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                'Check back later for new music content',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.5),
                  fontSize: 14,
                ),
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: _refreshMusicTracks,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFFB19CD9),
                  foregroundColor: Colors.white,
                ),
                child: const Text('Refresh'),
              ),
            ],
          ),
        ),
      );
    }

    return RefreshIndicator(
      onRefresh: _refreshMusicTracks,
      color: const Color(0xFFB19CD9),
      child: CustomScrollView(
        controller: _scrollController,
        physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
        slivers: [
          SliverToBoxAdapter(
            child: _buildHeroSection(),
          ),
          SliverList(
            delegate: SliverChildBuilderDelegate(
              (context, index) {
                final track = _filteredTracks[index];
                return _buildMusicCard(track);
              },
              childCount: _filteredTracks.length,
            ),
          ),
          SliverToBoxAdapter(
            child: SizedBox(height: _currentTrack != null ? _getPlayerHeight(context) + 20 : 20),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchResults() {
    final padding = _getContentPadding(context);
    
    return Column(
      children: [
        if (_searchQuery.isNotEmpty)
          Padding(
            padding: EdgeInsets.symmetric(
              horizontal: padding.horizontal / 2,
              vertical: 8,
            ),
            child: Row(
              children: [
                Text(
                  '${_filteredTracks.length} result${_filteredTracks.length == 1 ? '' : 's'} for "$_searchQuery"',
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.7),
                    fontSize: 14,
                  ),
                ),
              ],
            ),
          ),
        
        Expanded(
          child: _searchQuery.isEmpty
              ? Center(
                  child: Text(
                    'Start typing to search...',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.5),
                      fontSize: 16,
                    ),
                  ),
                )
              : _filteredTracks.isEmpty
                  ? Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            Icons.search_off,
                            size: 48,
                            color: Colors.white.withOpacity(0.3),
                          ),
                          const SizedBox(height: 16),
                          Text(
                            'No tracks found',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.5),
                              fontSize: 18,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Text(
                            'Try different keywords',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.3),
                              fontSize: 14,
                            ),
                          ),
                        ],
                      ),
                    )
                  : ListView.builder(
                      physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
                      padding: EdgeInsets.only(
                        bottom: MediaQuery.of(context).viewInsets.bottom + (_currentTrack != null ? _getPlayerHeight(context) + 20 : 20),
                      ),
                      itemCount: _filteredTracks.length,
                      itemBuilder: (context, index) {
                        final track = _filteredTracks[index];
                        return _buildMusicCard(track);
                      },
                    ),
        ),
      ],
    );
  }

  Widget _buildHeroSection() {
    final height = _getHeroHeight(context);
    final padding = _getContentPadding(context);
    final width = MediaQuery.of(context).size.width;

    return Container(
      margin: EdgeInsets.fromLTRB(
        padding.horizontal / 2,
        16,
        padding.horizontal / 2,
        16,
      ),
      height: height,
      constraints: const BoxConstraints(maxWidth: 1200),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.4),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: Stack(
          children: [
            // Background Image
            Image.asset(
              'assets/images/music_mansa.jpg',
              fit: BoxFit.cover,
              width: double.infinity,
              height: double.infinity,
              errorBuilder: (context, error, stackTrace) {
                return Container(
                  decoration: const BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color(0xFFB19CD9),
                        Color(0xFF9B59B6),
                        Color(0xFF8E44AD),
                      ],
                    ),
                  ),
                );
              },
            ),
            
            // Gradient Overlay
            Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  colors: [
                    Colors.black.withOpacity(0.1),
                    Colors.black.withOpacity(0.7),
                  ],
                ),
              ),
            ),
            
            // Text Content
            Positioned(
              bottom: 0,
              left: 0,
              right: 0,
              child: Container(
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                    colors: [
                      Colors.transparent,
                      Colors.black.withOpacity(0.8),
                    ],
                  ),
                ),
                padding: EdgeInsets.all(width >= 600 ? 24 : 20),
                child: Container(
                  padding: EdgeInsets.all(width >= 600 ? 20 : 16),
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  child: Text(
                    'Immerse yourself in the mystical musical world of the Mansaka people. From healing chants to ceremonial dances, discover the spiritual depths of their ancestral melodies.',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.95),
                      fontSize: width >= 600 ? 16 : 14,
                      height: 1.4,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMusicCard(MusicTrack track) {
    final isCurrentTrack = _currentTrack?.id == track.id;
    final hasDuration = track.duration != null;
    final isLoadingDuration = _loadingDurations.contains(track.id);
    final width = MediaQuery.of(context).size.width;
    final padding = _getContentPadding(context);
    final cardHeight = _getCardHeight(context);
    
    final titleFontSize = width >= 800 ? 17.0 : width >= 600 ? 16.0 : 16.0;
    final descriptionFontSize = width >= 800 ? 15.0 : width >= 600 ? 14.0 : 14.0;
    final categoryFontSize = width >= 800 ? 13.0 : 12.0;
    final buttonSize = width >= 800 ? 48.0 : width >= 600 ? 44.0 : 40.0;
    final iconSize = width >= 800 ? 28.0 : width >= 600 ? 26.0 : 24.0;
    
    return Container(
      margin: EdgeInsets.symmetric(
        horizontal: padding.horizontal / 2,
        vertical: 6,
      ),
      constraints: const BoxConstraints(maxWidth: 1000),
      decoration: BoxDecoration(
        color: isCurrentTrack 
            ? const Color(0xFFB19CD9).withOpacity(0.1)
            : const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: isCurrentTrack 
              ? const Color(0xFFB19CD9)
              : const Color(0xFFB19CD9).withOpacity(0.2),
          width: isCurrentTrack ? 2 : 1,
        ),
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          borderRadius: BorderRadius.circular(12),
          onTap: () {
            HapticFeedback.mediumImpact();
            _togglePlayPause(track);
          },
          child: Padding(
            padding: EdgeInsets.all(width >= 600 ? 14 : 12),
            child: Row(
              children: [
                Container(
                  width: 60,
                  height: 60,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(8),
                    color: const Color(0xFFB19CD9).withOpacity(0.2),
                  ),
                  child: const Icon(
                    Icons.music_note,
                    color: Color(0xFFB19CD9),
                    size: 30,
                  ),
                ),
                
                SizedBox(width: width >= 600 ? 18 : 16),
                
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        track.title,
                        style: TextStyle(
                          color: isCurrentTrack 
                              ? const Color(0xFFB19CD9)
                              : Colors.white,
                          fontSize: titleFontSize,
                          fontWeight: FontWeight.bold,
                          height: 1.3,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                      const SizedBox(height: 4),
                      Text(
                        track.description,
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: descriptionFontSize,
                          height: 1.3,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                      const SizedBox(height: 6),
                      Wrap(
                        spacing: 8,
                        runSpacing: 4,
                        crossAxisAlignment: WrapCrossAlignment.center,
                        children: [
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                            decoration: BoxDecoration(
                              color: const Color(0xFFB19CD9).withOpacity(0.2),
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Text(
                              track.category,
                              style: TextStyle(
                                color: const Color(0xFFB19CD9),
                                fontSize: categoryFontSize,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ),
                          if (width >= 600)
                            Flexible(
                              child: Text(
                                ' ${track.artist}',
                                style: TextStyle(
                                  color: Colors.white.withOpacity(0.5),
                                  fontSize: categoryFontSize,
                                ),
                                overflow: TextOverflow.ellipsis,
                              ),
                            ),
                          if (hasDuration)
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                              decoration: BoxDecoration(
                                color: Colors.black.withOpacity(0.3),
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Icon(
                                    Icons.access_time,
                                    size: 10,
                                    color: Colors.white.withOpacity(0.6),
                                  ),
                                  const SizedBox(width: 4),
                                  Text(
                                    _formatDuration(track.duration!),
                                    style: TextStyle(
                                      color: Colors.white.withOpacity(0.6),
                                      fontSize: 11,
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                ],
                              ),
                            )
                          else if (isLoadingDuration)
                            const SizedBox(
                              width: 12,
                              height: 12,
                              child: CircularProgressIndicator(
                                strokeWidth: 1.5,
                                valueColor: AlwaysStoppedAnimation<Color>(
                                  Colors.white54,
                                ),
                              ),
                            ),
                        ],
                      ),
                    ],
                  ),
                ),
                
                SizedBox(width: width >= 600 ? 12 : 8),
                
                GestureDetector(
                  onTap: () {
                    HapticFeedback.mediumImpact();
                    _togglePlayPause(track);
                  },
                  child: Container(
                    width: buttonSize,
                    height: buttonSize,
                    decoration: BoxDecoration(
                      color: const Color(0xFFB19CD9),
                      borderRadius: BorderRadius.circular(buttonSize / 2),
                    ),
                    child: Center(
                      child: _isLoadingAudio && isCurrentTrack
                          ? SizedBox(
                              width: iconSize * 0.75,
                              height: iconSize * 0.75,
                              child: const CircularProgressIndicator(
                                strokeWidth: 2,
                                valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                              ),
                            )
                          : Icon(
                              isCurrentTrack && _isPlaying 
                                  ? Icons.pause
                                  : Icons.play_arrow,
                              color: Colors.white,
                              size: iconSize,
                            ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildInlineMusicPlayer() {
    final width = MediaQuery.of(context).size.width;
    final playerHeight = _getPlayerHeight(context);
    final isTablet = width >= 600;
    final isDesktop = width >= 800;
    
    final titleFontSize = isDesktop ? 16.0 : isTablet ? 15.0 : 14.0;
    final artistFontSize = isDesktop ? 14.0 : isTablet ? 13.0 : 12.0;
    final iconSize = isDesktop ? 22.0 : isTablet ? 21.0 : 20.0;
    final playButtonSize = isDesktop ? 44.0 : isTablet ? 42.0 : 40.0;
    
    return Container(
      padding: EdgeInsets.all(isDesktop ? 20 : isTablet ? 18 : 16),
      decoration: const BoxDecoration(
        color: Color(0xFF1F1F1F),
        border: Border(
          top: BorderSide(
            color: Color(0xFFB19CD9),
            width: 2,
          ),
        ),
      ),
      child: ConstrainedBox(
        constraints: const BoxConstraints(maxWidth: 1200),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Row(
              children: [
                Container(
                  width: 50,
                  height: 50,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(8),
                    color: const Color(0xFFB19CD9).withOpacity(0.2),
                  ),
                  child: const Icon(
                    Icons.music_note,
                    color: Color(0xFFB19CD9),
                    size: 25,
                  ),
                ),
                
                SizedBox(width: isDesktop ? 16 : 12),
                
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        _currentTrack!.title,
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: titleFontSize,
                          fontWeight: FontWeight.bold,
                          height: 1.3,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                      const SizedBox(height: 2),
                      Text(
                        _currentTrack!.artist,
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: artistFontSize,
                          height: 1.2,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ),
                ),
                
                if (isTablet) ...[
                  IconButton(
                    onPressed: () {
                      _seekTo(Duration(seconds: (_currentPosition.inSeconds - 10).clamp(0, _totalDuration.inSeconds)));
                    },
                    icon: Icon(Icons.replay_10, color: Colors.white, size: iconSize),
                  ),
                ],
                
                IconButton(
                  onPressed: () => _togglePlayPause(_currentTrack!),
                  icon: Container(
                    width: playButtonSize,
                    height: playButtonSize,
                    padding: const EdgeInsets.all(8),
                    decoration: const BoxDecoration(
                      color: Color(0xFFB19CD9),
                      shape: BoxShape.circle,
                    ),
                    child: Icon(
                      _isPlaying ? Icons.pause : Icons.play_arrow,
                      color: Colors.white,
                      size: iconSize,
                    ),
                  ),
                ),
                
                if (isTablet) ...[
                  IconButton(
                    onPressed: () {
                      _seekTo(Duration(seconds: (_currentPosition.inSeconds + 30).clamp(0, _totalDuration.inSeconds)));
                    },
                    icon: Icon(Icons.forward_30, color: Colors.white, size: iconSize),
                  ),
                ],
                
                IconButton(
                  onPressed: () {
                    HapticFeedback.lightImpact();
                    _closeMusicPlayer();
                  },
                  icon: Container(
                    padding: const EdgeInsets.all(4),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.1),
                      shape: BoxShape.circle,
                    ),
                    child: Icon(
                      Icons.close,
                      color: Colors.white,
                      size: isDesktop ? 18 : 16,
                    ),
                  ),
                ),
              ],
            ),
            
            SizedBox(height: isDesktop ? 12 : 8),
            
            Column(
              children: [
                SliderTheme(
                  data: SliderTheme.of(context).copyWith(
                    activeTrackColor: const Color(0xFFB19CD9),
                    inactiveTrackColor: const Color(0xFFB19CD9).withOpacity(0.3),
                    thumbColor: const Color(0xFFB19CD9),
                    overlayColor: const Color(0xFFB19CD9).withOpacity(0.3),
                    trackHeight: isDesktop ? 5 : 4,
                    thumbShape: RoundSliderThumbShape(
                      enabledThumbRadius: isDesktop ? 7 : 6,
                    ),
                  ),
                  child: Slider(
                    value: _totalDuration.inMilliseconds > 0 
                        ? _currentPosition.inMilliseconds / _totalDuration.inMilliseconds
                        : 0.0,
                    onChanged: (value) {
                      final position = Duration(
                        milliseconds: (value * _totalDuration.inMilliseconds).round(),
                      );
                      _seekTo(position);
                    },
                  ),
                ),
                
                Padding(
                  padding: EdgeInsets.symmetric(horizontal: isDesktop ? 18 : 16),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        _formatDuration(_currentPosition),
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: isDesktop ? 13 : 12,
                        ),
                      ),
                      Text(
                        _formatDuration(_totalDuration),
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.7),
                          fontSize: isDesktop ? 13 : 12,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Future<void> _togglePlayPause(MusicTrack track) async {
    try {
      if (_currentTrack?.id != track.id) {
        setState(() {
          _currentTrack = track;
          _isLoadingAudio = true;
        });
        
        await _audioPlayer.stop();
        
        if (track.isNetworkSource) {
          await _audioPlayer.play(UrlSource(track.audioPath));
        } else {
          await _audioPlayer.play(AssetSource(track.audioPath));
        }
      } else {
        if (_isPlaying) {
          await _audioPlayer.pause();
        } else {
          await _audioPlayer.resume();
        }
      }
    } catch (e) {
      debugPrint('Error playing audio: $e');
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Unable to play audio: ${track.title}'),
            backgroundColor: Colors.red,
            action: SnackBarAction(
              label: 'Retry',
              textColor: Colors.white,
              onPressed: () => _togglePlayPause(track),
            ),
          ),
        );
      }
      
      setState(() {
        _isLoadingAudio = false;
      });
    }
  }

  Future<void> _seekTo(Duration position) async {
    await _audioPlayer.seek(position);
  }

  String _formatDuration(Duration duration) {
    String twoDigits(int n) => n.toString().padLeft(2, '0');
    String twoDigitMinutes = twoDigits(duration.inMinutes.remainder(60));
    String twoDigitSeconds = twoDigits(duration.inSeconds.remainder(60));
    
    if (duration.inHours > 0) {
      return "${twoDigits(duration.inHours)}:$twoDigitMinutes:$twoDigitSeconds";
    } else {
      return "$twoDigitMinutes:$twoDigitSeconds";
    }
  }

  void _closeMusicPlayer() async {
    await _audioPlayer.stop();
    setState(() {
      _currentTrack = null;
      _isPlaying = false;
      _currentPosition = Duration.zero;
      _totalDuration = Duration.zero;
      _isLoadingAudio = false;
    });
  }

  @override
  void dispose() {
    _searchController.dispose();
    _searchFocusNode.dispose();
    _scrollController.dispose();
    _audioPlayer.dispose();
    super.dispose();
  }
}

enum FileType {
  video,
  audio,
  image,
  unknown,
}

class MusicTrack {
  final String id;
  final String title;
  final String description;
  final String category;
  final String artist;
  final String audioPath;
  final String file;
  final FileType fileType;
  final bool isNetworkSource;
  final Duration? duration;

  MusicTrack({
    required this.id,
    required this.title,
    required this.description,
    required this.category,
    required this.artist,
    required this.audioPath,
    required this.file,
    required this.fileType,
    this.isNetworkSource = false,
    this.duration,
  });

  MusicTrack copyWith({
    String? id,
    String? title,
    String? description,
    String? category,
    String? artist,
    String? audioPath,
    String? file,
    FileType? fileType,
    bool? isNetworkSource,
    Duration? duration,
  }) {
    return MusicTrack(
      id: id ?? this.id,
      title: title ?? this.title,
      description: description ?? this.description,
      category: category ?? this.category,
      artist: artist ?? this.artist,
      audioPath: audioPath ?? this.audioPath,
      file: file ?? this.file,
      fileType: fileType ?? this.fileType,
      isNetworkSource: isNetworkSource ?? this.isNetworkSource,
      duration: duration ?? this.duration,
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\mansaka_category_screens\mansaka_video_screen.dart
======================================

// lib/screen/mansaka_category_screens/mansaka_video_screen.dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:io';
import 'package:video_player/video_player.dart';
import 'package:video_thumbnail/video_thumbnail.dart';
import 'package:path_provider/path_provider.dart';
import 'package:visibility_detector/visibility_detector.dart';
import '../shared/video_player_screen.dart';
import '../../utils/video_metadata_cache.dart';

class MansakaVideoScreen extends StatefulWidget {
  const MansakaVideoScreen({super.key});

  @override
  State<MansakaVideoScreen> createState() => _MansakaVideoScreenState();
}

class _MansakaVideoScreenState extends State<MansakaVideoScreen> {
  String _searchQuery = '';
  final TextEditingController _searchController = TextEditingController();
  final FocusNode _searchFocusNode = FocusNode();
  bool _isSearchFocused = false;
  
  final ScrollController _scrollController = ScrollController();
  bool _isHeaderVisible = true;
  double _lastScrollOffset = 0;

  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/content/';
  static const String _uploadsBaseUrl = 'https://huni-cms.ionvop.com/uploads/';
  List<VideoItem> _allVideos = [];
  bool _isLoading = true;
  String? _errorMessage;
  VideoItem? _featuredVideo;
  
  final Set<String> _loadingMetadata = {};

  List<VideoItem> get _filteredVideos {
    if (_searchQuery.isEmpty) {
      return _allVideos;
    }
    
    return _allVideos.where((video) =>
        video.title.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        video.description.toLowerCase().contains(_searchQuery.toLowerCase()) ||
        video.category.toLowerCase().contains(_searchQuery.toLowerCase())).toList();
  }

  // Enhanced responsive helper methods (combining best from both screens)
  int _getCrossAxisCount(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 4;
    if (width > 900) return 3;
    if (width > 600) return 2;
    return 2;
  }

  // ENHANCED: More flexible childAspectRatio from Kagan
  double _getChildAspectRatio(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    final crossAxisCount = _getCrossAxisCount(context);
    
    // Calculate available width per item
    final horizontalPadding = _getHorizontalPadding(context);
    final spacing = _getGridSpacing(context);
    final availableWidth = width - (horizontalPadding * 2) - (spacing * (crossAxisCount - 1));
    final itemWidth = availableWidth / crossAxisCount;
    
    // Dynamic height based on item width - generous for text content
    final itemHeight = itemWidth * 1.4; // Adjusted for better content fit
    
    return itemWidth / itemHeight;
  }

  // ENHANCED: More conservative padding from Kagan
  double _getHorizontalPadding(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return width * 0.025; // 2.5% of width
    if (width > 800) return width * 0.02; // 2% of width
    return width * 0.04; // 4% of width
  }

  // Responsive grid spacing
  double _getGridSpacing(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return 16;
    if (width > 800) return 12;
    return 10; // Reduced to save space on small screens
  }

  // ENHANCED: Featured video height from Kagan (percentage-based)
  double _getFeaturedVideoHeight(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final width = size.width;
    final height = size.height;
    final isLandscape = width > height;
    
    // Use percentage of screen height for better scaling
    if (width > 1200) return height * 0.35;
    if (width > 800) return height * 0.3;
    if (isLandscape) return height * 0.35;
    return height * 0.25;
  }

  double _getFontSize(BuildContext context, double baseSize) {
    final width = MediaQuery.of(context).size.width;
    if (width > 1200) return baseSize * 1.15;
    if (width > 800) return baseSize * 1.08;
    if (width < 360) return baseSize * 0.95; // Scale down on very small screens
    return baseSize;
  }

  // ENHANCED: Responsive header height from Kagan
  double _getHeaderHeight(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    if (width > 800) return 80;
    if (width < 360) return 65;
    return 72;
  }

  // ENHANCED: Responsive vertical spacing from Kagan
  double _getVerticalSpacing(BuildContext context, double baseSpacing) {
    final height = MediaQuery.of(context).size.height;
    if (height < 700) return baseSpacing * 0.75; // Reduce on short screens
    return baseSpacing;
  }

  @override
  void initState() {
    super.initState();
    _setupScrollController();
    _searchFocusNode.addListener(() {
      setState(() {
        _isSearchFocused = _searchFocusNode.hasFocus;
      });
    });
    _fetchVideos();
  }

  void _setupScrollController() {
    _scrollController.addListener(() {
      final currentOffset = _scrollController.offset;
      final isScrollingDown = currentOffset > _lastScrollOffset;
      final shouldHideHeader = isScrollingDown && currentOffset > 100;
      final shouldShowHeader = !isScrollingDown || currentOffset <= 50;

      if (_isHeaderVisible && shouldHideHeader && !_isSearchFocused) {
        setState(() {
          _isHeaderVisible = false;
        });
      } else if (!_isHeaderVisible && shouldShowHeader) {
        setState(() {
          _isHeaderVisible = true;
        });
      }

      _lastScrollOffset = currentOffset;
    });
  }

  Future<void> _fetchVideos() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      debugPrint('Fetching videos from: $_baseUrl');

      List<String> urls = [
        '${_baseUrl}category=video&tribe=mansaka',
        '$_baseUrl?category=video&tribe=mansaka',
        '$_baseUrl?tribe=mansaka',
        _baseUrl,
      ];

      http.Response? successResponse;
      
      for (String url in urls) {
        try {
          debugPrint('Trying URL: $url');
          final response = await http.get(
            Uri.parse(url),
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
            },
          ).timeout(const Duration(seconds: 15));
          
          if (response.statusCode == 200) {
            successResponse = response;
            break;
          }
        } catch (e) {
          debugPrint('Error with URL $url: $e');
          continue;
        }
      }

      if (successResponse == null) {
        throw Exception('All API endpoints failed to respond');
      }

      final Map<String, dynamic> jsonData = json.decode(successResponse.body);
      
      if (jsonData.containsKey('error')) {
        throw Exception(jsonData['error']);
      }

      dynamic videoDataRaw = jsonData['data'];
      List<dynamic> videoData = [];
      
      if (videoDataRaw is List) {
        videoData = videoDataRaw;
      } else if (videoDataRaw != null) {
        videoData = [videoDataRaw];
      }

      final List<VideoItem> fetchedVideos = [];

      for (var item in videoData) {
        if (item == null) continue;
        
        final id = item['id'];
        final userId = item['user_id'];
        final title = item['title']?.toString();
        final category = item['category']?.toString();
        final tribe = item['tribe']?.toString();
        final description = item['description']?.toString();
        final file = item['file']?.toString();
        final isArchived = item['is_archived'];
        final time = item['time']?.toString();
        
        if (id == null || userId == null || title == null || title.isEmpty ||
            category == null || category.isEmpty || tribe == null || tribe.isEmpty ||
            file == null || file.isEmpty || isArchived == null || time == null) {
          continue;
        }
        
        if (tribe.toLowerCase() != 'mansaka') {
          continue;
        }

        if (isArchived != 0) {
          continue;
        }

        final fileType = _determineFileType(file);
        final videoUrl = '$_uploadsBaseUrl$file';
        
        final cachedDuration = await VideoMetadataCache.getDuration(id.toString());
        final cachedThumbnail = await VideoMetadataCache.getThumbnail(id.toString());

        final videoItem = VideoItem(
          id: id.toString(),
          title: title,
          thumbnail: cachedThumbnail ?? _buildThumbnailUrl(file),
          duration: cachedDuration ?? '--:--',
          description: description ?? 'No description available',
          category: _mapCategory(category),
          file: file,
          fileType: fileType,
          videoUrl: videoUrl,
        );
        
        debugPrint(' Valid item added: $title (Cached: duration=${cachedDuration != null}, thumbnail=${cachedThumbnail != null})');
        fetchedVideos.add(videoItem);
      }

      setState(() {
        _allVideos = fetchedVideos;
        _featuredVideo = fetchedVideos.isNotEmpty ? fetchedVideos.first : null;
        _isLoading = false;
      });

    } catch (e, stackTrace) {
      debugPrint('Error fetching videos: $e');
      debugPrint('Stack trace: $stackTrace');
      setState(() {
        _errorMessage = 'Failed to load videos: ${e.toString().replaceAll('Exception: ', '')}';
        _isLoading = false;
      });
    }
  }

  Future<void> _loadVideoMetadata(VideoItem video) async {
    if (video.fileType != FileType.video || 
        video.duration != '--:--' || 
        _loadingMetadata.contains(video.id)) {
      return;
    }
    
    _loadingMetadata.add(video.id);
    
    VideoPlayerController? tempController;
    try {
      debugPrint(' Loading metadata for: ${video.title}');
      
      tempController = VideoPlayerController.networkUrl(
        Uri.parse(video.videoUrl),
        videoPlayerOptions: VideoPlayerOptions(mixWithOthers: true),
      );
      
      await tempController.initialize().timeout(
        const Duration(seconds: 15),
        onTimeout: () {
          throw Exception('Timeout loading video metadata');
        },
      );
      
      if (tempController.value.duration.inSeconds > 0) {
        final minutes = tempController.value.duration.inMinutes;
        final seconds = tempController.value.duration.inSeconds % 60;
        final duration = '${minutes.toString().padLeft(2, '0')}:${seconds.toString().padLeft(2, '0')}';
        
        await VideoMetadataCache.saveDuration(video.id, duration);
        
        if (mounted) {
          setState(() {
            video.duration = duration;
          });
        }
        debugPrint(' Duration loaded and cached for ${video.title}: $duration');
      }
      
      try {
        final thumbnailDir = await getApplicationDocumentsDirectory();
        final thumbnailPath = await VideoThumbnail.thumbnailFile(
          video: video.videoUrl,
          thumbnailPath: '${thumbnailDir.path}/thumbnails',
          imageFormat: ImageFormat.JPEG,
          maxWidth: 320,
          quality: 75,
          timeMs: 1000,
        );
        
        if (thumbnailPath != null && await File(thumbnailPath).exists()) {
          await VideoMetadataCache.saveThumbnail(video.id, thumbnailPath);
          
          if (mounted) {
            setState(() {
              video.thumbnail = thumbnailPath;
            });
          }
          debugPrint(' Thumbnail generated and cached for ${video.title}');
        }
      } catch (e) {
        debugPrint(' Error generating thumbnail for ${video.title}: $e');
      }
      
    } catch (e) {
      debugPrint(' Error loading metadata for ${video.title}: $e');
      if (mounted) {
        setState(() {
          video.duration = 'N/A';
        });
      }
    } finally {
      tempController?.dispose();
      _loadingMetadata.remove(video.id);
    }
  }

  String _buildThumbnailUrl(String? filename) {
    if (filename == null || filename.isEmpty) {
      return 'assets/videos/thumbnails/default_thumbnail.jpg';
    }
    
    final String lowerFilename = filename.toLowerCase();
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv', '.flv', '.wmv'];
    bool isVideoFile = videoExtensions.any((ext) => lowerFilename.endsWith(ext));
    
    if (isVideoFile) {
      return 'assets/videos/thumbnails/default_thumbnail.jpg';
    }
    
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    bool isImageFile = imageExtensions.any((ext) => lowerFilename.endsWith(ext));
    
    if (isImageFile) {
      return '$_uploadsBaseUrl$filename';
    }
    
    return 'assets/videos/thumbnails/default_thumbnail.jpg';
  }

  FileType _determineFileType(String? filename) {
    if (filename == null || filename.isEmpty) {
      return FileType.unknown;
    }
    
    final String lowerFilename = filename.toLowerCase();
    const videoExtensions = ['.mp4', '.mov', '.avi', '.webm', '.m4v', '.mkv', '.flv', '.wmv'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const audioExtensions = ['.mp3', '.wav', '.aac', '.ogg', '.m4a'];
    
    if (videoExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.video;
    } else if (imageExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.image;
    } else if (audioExtensions.any((ext) => lowerFilename.endsWith(ext))) {
      return FileType.audio;
    }
    
    return FileType.unknown;
  }

  String _mapCategory(String? category) {
    switch (category?.toLowerCase()) {
      case 'video':
        return 'Video';
      case 'artifact':
        return 'Cultural Artifact';
      case 'instrument':
        return 'Traditional Instrument';
      case 'audio':
        return 'Audio Recording';
      case 'image':
        return 'Image';
      default:
        return 'Media';
    }
  }

  Future<void> _refreshVideos() async {
    await _fetchVideos();
  }

  @override
  void dispose() {
    _loadingMetadata.clear();
    _searchController.dispose();
    _searchFocusNode.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final horizontalPadding = _getHorizontalPadding(context);
    final headerHeight = _getHeaderHeight(context);
    
    return Scaffold(
      resizeToAvoidBottomInset: true,
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),
              Color(0xFF0d0d0d),
              Colors.black,
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // FIXED: Dynamic header height from Kagan
              AnimatedContainer(
                duration: const Duration(milliseconds: 300),
                height: (_isHeaderVisible || _isSearchFocused) ? headerHeight : 0,
                child: (_isHeaderVisible || _isSearchFocused) 
                    ? _buildHeader(context, horizontalPadding) 
                    : const SizedBox.shrink(),
              ),
              Expanded(
                child: _isSearchFocused 
                    ? _buildSearchResults(horizontalPadding)
                    : _buildMainContent(horizontalPadding),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeader(BuildContext context, double horizontalPadding) {
    final verticalPadding = _getVerticalSpacing(context, 12);
    
    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: horizontalPadding, 
        vertical: verticalPadding
      ),
      child: Row(
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 0 : 48,
            child: _isSearchFocused 
                ? const SizedBox.shrink()
                : Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: IconButton(
                      onPressed: () {
                        HapticFeedback.lightImpact();
                        Navigator.pop(context);
                      },
                      icon: const Icon(
                        Icons.arrow_back_ios,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ),
          ),
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 0 : 12,
          ),
          Expanded(
            child: Container(
              height: 48,
              decoration: BoxDecoration(
                color: const Color(0xFF2A2A2A),
                borderRadius: BorderRadius.circular(24),
                border: Border.all(
                  color: _isSearchFocused 
                      ? const Color(0xFFB19CD9) 
                      : const Color(0xFFB19CD9).withOpacity(0.3),
                  width: _isSearchFocused ? 2 : 1,
                ),
              ),
              child: TextField(
                controller: _searchController,
                focusNode: _searchFocusNode,
                style: TextStyle(
                  color: Colors.white,
                  fontSize: _getFontSize(context, 14),
                ),
                scrollPhysics: const BouncingScrollPhysics(),
                decoration: InputDecoration(
                  hintText: 'Search videos...',
                  hintStyle: TextStyle(
                    color: Colors.white.withOpacity(0.6),
                    fontSize: _getFontSize(context, 14),
                  ),
                  prefixIcon: Icon(
                    Icons.search,
                    color: _isSearchFocused 
                        ? const Color(0xFFB19CD9)
                        : Colors.white.withOpacity(0.6),
                  ),
                  suffixIcon: _searchQuery.isNotEmpty
                      ? IconButton(
                          onPressed: () {
                            _searchController.clear();
                            setState(() {
                              _searchQuery = '';
                            });
                          },
                          icon: Icon(
                            Icons.clear,
                            color: Colors.white.withOpacity(0.6),
                          ),
                        )
                      : null,
                  border: InputBorder.none,
                  contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                ),
                onChanged: (value) {
                  setState(() {
                    _searchQuery = value;
                  });
                },
              ),
            ),
          ),
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: _isSearchFocused ? 80 : 0,
            child: _isSearchFocused
                ? TextButton(
                    onPressed: () {
                      _searchController.clear();
                      _searchFocusNode.unfocus();
                      setState(() {
                        _searchQuery = '';
                        _isHeaderVisible = true;
                      });
                    },
                    child: Text(
                      'Cancel',
                      style: TextStyle(
                        color: const Color(0xFFB19CD9),
                        fontWeight: FontWeight.w500,
                        fontSize: _getFontSize(context, 14),
                      ),
                    ),
                  )
                : const SizedBox.shrink(),
          ),
        ],
      ),
    );
  }

  Widget _buildMainContent(double horizontalPadding) {
    if (_isLoading) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          mainAxisSize: MainAxisSize.min,
          children: [
            const CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFB19CD9)),
            ),
            SizedBox(height: _getVerticalSpacing(context, 16)),
            Text(
              'Loading Mansaka videos...',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: _getFontSize(context, 14),
              ),
            ),
          ],
        ),
      );
    }

    if (_errorMessage != null) {
      return Center(
        child: Padding(
          padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                Icons.error_outline,
                size: 64,
                color: Colors.white.withOpacity(0.5),
              ),
              SizedBox(height: _getVerticalSpacing(context, 16)),
              Text(
                'Failed to load videos',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.7),
                  fontSize: _getFontSize(context, 18),
                  fontWeight: FontWeight.w500,
                ),
              ),
              SizedBox(height: _getVerticalSpacing(context, 8)),
              Padding(
                padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
                child: Text(
                  _errorMessage!,
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.5),
                    fontSize: _getFontSize(context, 14),
                  ),
                  textAlign: TextAlign.center,
                ),
              ),
              SizedBox(height: _getVerticalSpacing(context, 24)),
              ElevatedButton(
                onPressed: _refreshVideos,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFFB19CD9),
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(
                    horizontal: horizontalPadding,
                    vertical: _getVerticalSpacing(context, 12),
                  ),
                ),
                child: Text(
                  'Retry',
                  style: TextStyle(fontSize: _getFontSize(context, 14)),
                ),
              ),
            ],
          ),
        ),
      );
    }

    if (_allVideos.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              Icons.video_library_outlined,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            SizedBox(height: _getVerticalSpacing(context, 16)),
            Text(
              'No Mansaka videos available',
              style: TextStyle(
                color: Colors.white.withOpacity(0.7),
                fontSize: _getFontSize(context, 18),
                fontWeight: FontWeight.w500,
              ),
            ),
            SizedBox(height: _getVerticalSpacing(context, 8)),
            Text(
              'Check back later for new content',
              style: TextStyle(
                color: Colors.white.withOpacity(0.5),
                fontSize: _getFontSize(context, 14),
              ),
            ),
            SizedBox(height: _getVerticalSpacing(context, 24)),
            ElevatedButton(
              onPressed: _refreshVideos,
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFFB19CD9),
                foregroundColor: Colors.white,
                padding: EdgeInsets.symmetric(
                  horizontal: horizontalPadding,
                  vertical: _getVerticalSpacing(context, 12),
                ),
              ),
              child: Text(
                'Refresh',
                style: TextStyle(fontSize: _getFontSize(context, 14)),
              ),
            ),
          ],
        ),
      );
    }

    final gridSpacing = _getGridSpacing(context);

    return RefreshIndicator(
      onRefresh: _refreshVideos,
      color: const Color(0xFFB19CD9),
      child: CustomScrollView(
        controller: _scrollController,
        physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
        slivers: [
          if (_featuredVideo != null)
            SliverToBoxAdapter(
              child: _buildFeaturedVideo(horizontalPadding),
            ),
          SliverToBoxAdapter(
            child: _buildBrowseSection(horizontalPadding),
          ),
          SliverPadding(
            padding: EdgeInsets.symmetric(horizontal: horizontalPadding),
            sliver: SliverGrid(
              gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: _getCrossAxisCount(context),
                childAspectRatio: _getChildAspectRatio(context),
                crossAxisSpacing: gridSpacing,
                mainAxisSpacing: gridSpacing,
              ),
              delegate: SliverChildBuilderDelegate(
                (context, index) {
                  final video = _allVideos[index];
                  return _buildVideoCard(video);
                },
                childCount: _allVideos.length,
              ),
            ),
          ),
          SliverToBoxAdapter(
            child: SizedBox(height: _getVerticalSpacing(context, 20)),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchResults(double horizontalPadding) {
    final gridSpacing = _getGridSpacing(context);
    
    return Column(
      children: [
        if (_searchQuery.isNotEmpty)
          Padding(
            padding: EdgeInsets.symmetric(
              horizontal: horizontalPadding, 
              vertical: _getVerticalSpacing(context, 8)
            ),
            child: Row(
              children: [
                Flexible(
                  child: Text(
                    '${_filteredVideos.length} result${_filteredVideos.length == 1 ? '' : 's'} for "$_searchQuery"',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.7),
                      fontSize: _getFontSize(context, 14),
                    ),
                    overflow: TextOverflow.ellipsis,
                  ),
                ),
              ],
            ),
          ),
        Expanded(
          child: _searchQuery.isEmpty
              ? Center(
                  child: Text(
                    'Start typing to search...',
                    style: TextStyle(
                      color: Colors.white.withOpacity(0.5),
                      fontSize: _getFontSize(context, 16),
                    ),
                  ),
                )
              : _filteredVideos.isEmpty
                  ? Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(
                            Icons.search_off,
                            size: 48,
                            color: Colors.white.withOpacity(0.3),
                          ),
                          SizedBox(height: _getVerticalSpacing(context, 16)),
                          Text(
                            'No videos found',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.5),
                              fontSize: _getFontSize(context, 18),
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          SizedBox(height: _getVerticalSpacing(context, 8)),
                          Text(
                            'Try different keywords',
                            style: TextStyle(
                              color: Colors.white.withOpacity(0.3),
                              fontSize: _getFontSize(context, 14),
                            ),
                          ),
                        ],
                      ),
                    )
                  : GridView.builder(
                      physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
                      padding: EdgeInsets.only(
                        left: horizontalPadding,
                        right: horizontalPadding,
                        bottom: MediaQuery.of(context).viewInsets.bottom + 20,
                      ),
                      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                        crossAxisCount: _getCrossAxisCount(context),
                        childAspectRatio: _getChildAspectRatio(context),
                        crossAxisSpacing: gridSpacing,
                        mainAxisSpacing: gridSpacing,
                      ),
                      itemCount: _filteredVideos.length,
                      itemBuilder: (context, index) {
                        final video = _filteredVideos[index];
                        return _buildVideoCard(video);
                      },
                    ),
        ),
      ],
    );
  }

  // ENHANCED: Using Kagan's fixed height approach instead of AspectRatio
  Widget _buildFeaturedVideo(double horizontalPadding) {
    if (_featuredVideo == null) return const SizedBox.shrink();

    final featuredHeight = _getFeaturedVideoHeight(context);
    final cardPadding = horizontalPadding * 0.75; // Proportional padding

    return Container(
      margin: EdgeInsets.all(cardPadding),
      height: featuredHeight,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.4),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: () {
              HapticFeedback.mediumImpact();
              _playVideo(_featuredVideo!);
            },
            child: Stack(
              children: [
                Container(
                  width: double.infinity,
                  height: double.infinity,
                  decoration: const BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color(0xFFB19CD9),
                        Color(0xFF8B6DB0),
                      ],
                    ),
                  ),
                  child: _buildThumbnailImage(_featuredVideo!),
                ),
                Container(
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topCenter,
                      end: Alignment.bottomCenter,
                      colors: [
                        Colors.transparent,
                        Colors.black.withOpacity(0.7),
                      ],
                    ),
                  ),
                ),
                Positioned(
                  bottom: cardPadding,
                  left: cardPadding,
                  right: cardPadding,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        'Featured: ${_featuredVideo!.title}',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: _getFontSize(context, 18),
                          fontWeight: FontWeight.bold,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                      SizedBox(height: _getVerticalSpacing(context, 4)),
                      Text(
                        _featuredVideo!.description,
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.8),
                          fontSize: _getFontSize(context, 14),
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ),
                ),
                Center(
                  child: Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.5),
                      borderRadius: BorderRadius.circular(50),
                    ),
                    child: const Icon(
                      Icons.play_arrow,
                      color: Colors.white,
                      size: 40,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildBrowseSection(double horizontalPadding) {
    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: horizontalPadding, 
        vertical: _getVerticalSpacing(context, 12)
      ),
      child: Row(
        children: [
          const Icon(
            Icons.video_library,
            color: Color(0xFFB19CD9),
            size: 20,
          ),
          SizedBox(width: _getVerticalSpacing(context, 8)),
          Flexible(
            child: Text(
              'Browse Mansaka videos',
              style: TextStyle(
                color: const Color(0xFFB19CD9),
                fontSize: _getFontSize(context, 16),
                fontWeight: FontWeight.bold,
                letterSpacing: 1,
              ),
              overflow: TextOverflow.ellipsis,
            ),
          ),
        ],
      ),
    );
  }

  // ENHANCED: Complete Kagan-style video card with proper layout
  Widget _buildVideoCard(VideoItem video) {
    return VisibilityDetector(
      key: Key('video_${video.id}'),
      onVisibilityChanged: (info) {
        if (info.visibleFraction > 0.1 && video.duration == '--:--') {
          _loadVideoMetadata(video);
        }
      },
      child: LayoutBuilder(
        builder: (context, constraints) {
          // Calculate heights dynamically based on available space
          final cardWidth = constraints.maxWidth;
          final cardHeight = constraints.maxHeight;
          
          // Image should take 60% of card height
          final imageHeight = cardHeight * 0.6;
          // Info section takes remaining 40%
          final infoHeight = cardHeight * 0.4;
          
          return Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.3),
                  blurRadius: 6,
                  offset: const Offset(0, 3),
                ),
              ],
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: Material(
                color: Colors.transparent,
                child: InkWell(
                  onTap: () {
                    HapticFeedback.mediumImpact();
                    _playVideo(video);
                  },
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // FIXED: Use SizedBox with explicit height instead of Expanded
                      SizedBox(
                        height: imageHeight,
                        width: double.infinity,
                        child: Stack(
                          children: [
                            Container(
                              width: double.infinity,
                              height: double.infinity,
                              decoration: const BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.topLeft,
                                  end: Alignment.bottomRight,
                                  colors: [
                                    Color(0xFFB19CD9),
                                    Color(0xFF8B6DB0),
                                  ],
                                ),
                              ),
                              child: _buildThumbnailImage(video),
                            ),
                            Positioned(
                              top: 6,
                              right: 6,
                              child: Container(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 6,
                                  vertical: 2,
                                ),
                                decoration: BoxDecoration(
                                  color: Colors.black.withOpacity(0.7),
                                  borderRadius: BorderRadius.circular(4),
                                ),
                                child: Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    if (video.duration == '--:--' && _loadingMetadata.contains(video.id))
                                      const Padding(
                                        padding: EdgeInsets.only(right: 4),
                                        child: SizedBox(
                                          width: 8,
                                          height: 8,
                                          child: CircularProgressIndicator(
                                            strokeWidth: 1.5,
                                            valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                                          ),
                                        ),
                                      ),
                                    Text(
                                      video.duration,
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: _getFontSize(context, 10),
                                        fontWeight: FontWeight.w500,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                            Center(
                              child: Container(
                                padding: EdgeInsets.all(cardWidth * 0.08), // Proportional padding
                                decoration: BoxDecoration(
                                  color: Colors.black.withOpacity(0.5),
                                  borderRadius: BorderRadius.circular(30),
                                ),
                                child: Icon(
                                  video.fileType == FileType.video 
                                      ? Icons.play_arrow
                                      : video.fileType == FileType.audio
                                          ? Icons.music_note
                                          : Icons.image,
                                  color: Colors.white,
                                  size: cardWidth * 0.15, // Proportional icon size
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      // FIXED: Use SizedBox with explicit height - NO Flexible/Expanded
                      SizedBox(
                        height: infoHeight,
                        width: double.infinity,
                        child: Container(
                          padding: EdgeInsets.all(cardWidth * 0.035), // Reduced padding
                          color: const Color(0xFF2A2A2A),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              // FIXED: Removed Flexible wrappers - direct Text with constraints
                              Text(
                                video.title,
                                style: TextStyle(
                                  color: Colors.white,
                                  fontSize: _getFontSize(context, 12),
                                  fontWeight: FontWeight.w600,
                                  height: 1.2,
                                ),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                              SizedBox(height: cardHeight * 0.005),
                              Text(
                                video.description,
                                style: TextStyle(
                                  color: Colors.white.withOpacity(0.6),
                                  fontSize: _getFontSize(context, 10),
                                  height: 1.2,
                                ),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                              // FIXED: Spacer pushes category to bottom naturally
                              const Spacer(),
                              Container(
                                padding: EdgeInsets.symmetric(
                                  horizontal: cardWidth * 0.02,
                                  vertical: cardHeight * 0.006,
                                ),
                                decoration: BoxDecoration(
                                  color: const Color(0xFFB19CD9).withOpacity(0.2),
                                  borderRadius: BorderRadius.circular(6),
                                ),
                                child: Text(
                                  video.category,
                                  style: TextStyle(
                                    color: const Color(0xFFB19CD9),
                                    fontSize: _getFontSize(context, 9),
                                    fontWeight: FontWeight.w500,
                                  ),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildThumbnailImage(VideoItem video) {
    if (video.thumbnail.startsWith('/data') || video.thumbnail.startsWith('/storage')) {
      return Image.file(
        File(video.thumbnail),
        fit: BoxFit.cover,
        errorBuilder: (context, error, stackTrace) {
          return const Center(
            child: Icon(
              Icons.play_circle_outline,
              color: Colors.white,
              size: 40,
            ),
          );
        },
      );
    }
    
    if (video.thumbnail.startsWith('http')) {
      return Image.network(
        video.thumbnail,
        fit: BoxFit.cover,
        errorBuilder: (context, error, stackTrace) {
          return const Center(
            child: Icon(
              Icons.play_circle_outline,
              color: Colors.white,
              size: 40,
            ),
          );
        },
        loadingBuilder: (context, child, loadingProgress) {
          if (loadingProgress == null) return child;
          return const Center(
            child: CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
            ),
          );
        },
      );
    }
    
    return Image.asset(
      video.thumbnail,
      fit: BoxFit.cover,
      errorBuilder: (context, error, stackTrace) {
        return const Center(
          child: Icon(
            Icons.play_circle_outline,
            color: Colors.white,
            size: 40,
          ),
        );
      },
    );
  }

  void _playVideo(VideoItem video) {
    if (video.file.isEmpty || video.fileType != FileType.video) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            video.fileType == FileType.audio 
                ? 'This is an audio file. Audio player not implemented yet.'
                : video.fileType == FileType.image
                    ? 'This is an image file, not a video.'
                    : 'Cannot play this file type.',
          ),
          backgroundColor: const Color(0xFFB19CD9),
        ),
      );
      return;
    }

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => VideoPlayerScreen(
          videoTitle: video.title,
          videoDescription: video.description,
          thumbnailPath: video.thumbnail,
          duration: video.duration,
          accentColor: const Color(0xFFB19CD9),
          tribalName: 'Mansaka',
          videoUrl: video.videoUrl,
        ),
      ),
    );
  }
}

enum FileType {
  video,
  audio,
  image,
  unknown,
}

class VideoItem {
  final String id;
  final String title;
  String thumbnail;
  String duration;
  final String description;
  final String category;
  final String file;
  final FileType fileType;
  final String videoUrl;

  VideoItem({
    required this.id,
    required this.title,
    required this.thumbnail,
    required this.duration,
    required this.description,
    required this.category,
    required this.file,
    required this.fileType,
    required this.videoUrl,
  });
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\screen\shared\video_player_screen.dart
======================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:video_player/video_player.dart';

class VideoPlayerScreen extends StatefulWidget {
  final String videoTitle;
  final String videoDescription;
  final String thumbnailPath;
  final String duration;
  final Color accentColor;
  final String tribalName;
  final String? videoUrl;

  const VideoPlayerScreen({
    super.key,
    required this.videoTitle,
    required this.videoDescription,
    required this.thumbnailPath,
    required this.duration,
    required this.accentColor,
    required this.tribalName,
    this.videoUrl,
  });

  @override
  State<VideoPlayerScreen> createState() => _VideoPlayerScreenState();
}

class _VideoPlayerScreenState extends State<VideoPlayerScreen>
    with TickerProviderStateMixin {
  VideoPlayerController? _videoController;
  bool _showControls = true;
  bool _isVideoInitialized = false;
  bool _isVideoLoading = true;
  bool _isBuffering = false;
  String? _errorMessage;
  
  late AnimationController _controlsAnimationController;
  late Animation<double> _controlsOpacity;

  @override
  void initState() {
    super.initState();
    _controlsAnimationController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _controlsOpacity = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _controlsAnimationController, curve: Curves.easeInOut),
    );
    _controlsAnimationController.forward();
    
    _initializeVideo();
    _hideControlsAfterDelay();
  }

  Future<void> _initializeVideo() async {
    if (widget.videoUrl == null || widget.videoUrl!.isEmpty) {
      setState(() {
        _isVideoLoading = false;
        _errorMessage = 'No video URL provided';
      });
      debugPrint('ERROR: No video URL provided');
      return;
    }

    try {
      setState(() {
        _isVideoLoading = true;
        _errorMessage = null;
      });

      debugPrint('Initializing video: ${widget.videoUrl}');

      _videoController = VideoPlayerController.networkUrl(
        Uri.parse(widget.videoUrl!),
      );

      _videoController!.addListener(_videoListener);
      await _videoController!.initialize();
      
      debugPrint('Video initialized successfully');
      debugPrint('Video duration: ${_videoController!.value.duration}');
      debugPrint('Video size: ${_videoController!.value.size}');
      
      if (mounted) {
        setState(() {
          _isVideoInitialized = true;
          _isVideoLoading = false;
        });
      }

    } catch (e, stackTrace) {
      debugPrint('Error initializing video: $e');
      debugPrint('Stack trace: $stackTrace');
      
      if (mounted) {
        setState(() {
          _isVideoLoading = false;
          _errorMessage = 'Failed to load video: ${e.toString()}';
        });
      }
    }
  }

  void _videoListener() {
    if (!mounted || _videoController == null) return;

    final bool wasBuffering = _isBuffering;
    final bool isCurrentlyBuffering = _videoController!.value.isBuffering;
    
    setState(() {
      _isBuffering = isCurrentlyBuffering;
    });

    if (wasBuffering != isCurrentlyBuffering) {
      if (isCurrentlyBuffering) {
        _showControlsTemporarily();
      }
    }
    
    if (_videoController!.value.isPlaying && 
        !_isBuffering && 
        _showControls) {
      _hideControlsAfterDelay();
    }

    if (_videoController!.value.position >= _videoController!.value.duration) {
      _showControlsTemporarily();
    }
  }

  @override
  void dispose() {
    _videoController?.removeListener(_videoListener);
    _videoController?.dispose();
    _controlsAnimationController.dispose();
    super.dispose();
  }

  void _hideControlsAfterDelay() {
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted && 
          _videoController?.value.isPlaying == true && 
          !_isBuffering) {
        _hideControls();
      }
    });
  }

  void _showControlsTemporarily() {
    if (mounted) {
      setState(() {
        _showControls = true;
      });
      _controlsAnimationController.forward();
      if (_videoController?.value.isPlaying == true && !_isBuffering) {
        _hideControlsAfterDelay();
      }
    }
  }

  void _hideControls() {
    _controlsAnimationController.reverse().then((_) {
      if (mounted) {
        setState(() {
          _showControls = false;
        });
      }
    });
  }

  void _togglePlayPause() {
    if (_videoController == null || !_isVideoInitialized) return;
    
    HapticFeedback.mediumImpact();
    
    setState(() {
      if (_videoController!.value.isPlaying) {
        _videoController!.pause();
      } else {
        _videoController!.play();
      }
    });
    
    _showControlsTemporarily();
  }

  void _seekTo(Duration position) {
    if (_videoController != null && _isVideoInitialized) {
      final duration = _videoController!.value.duration;
      final clampedPosition = position < Duration.zero 
          ? Duration.zero 
          : position > duration 
              ? duration 
              : position;
              
      _videoController!.seekTo(clampedPosition);
      _showControlsTemporarily();
    }
  }

  void _skipBackward() {
    if (_videoController == null || !_isVideoInitialized) return;
    
    HapticFeedback.lightImpact();
    final currentPosition = _videoController!.value.position;
    final newPosition = currentPosition - const Duration(seconds: 10);
    _seekTo(newPosition);
  }

  void _skipForward() {
    if (_videoController == null || !_isVideoInitialized) return;
    
    HapticFeedback.lightImpact();
    final currentPosition = _videoController!.value.position;
    final newPosition = currentPosition + const Duration(seconds: 10);
    _seekTo(newPosition);
  }

  String _formatDuration(Duration duration) {
    final hours = duration.inHours;
    final minutes = duration.inMinutes.remainder(60);
    final seconds = duration.inSeconds.remainder(60);
    
    if (hours > 0) {
      return '${hours.toString().padLeft(2, '0')}:${minutes.toString().padLeft(2, '0')}:${seconds.toString().padLeft(2, '0')}';
    } else {
      return '${minutes.toString().padLeft(2, '0')}:${seconds.toString().padLeft(2, '0')}';
    }
  }

  Widget _buildVideoPlayer(double screenWidth, double screenHeight) {
    if (_isVideoLoading) {
      return Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              widget.accentColor.withOpacity(0.8),
              widget.accentColor,
            ],
          ),
        ),
        child: Center(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              SizedBox(
                width: (screenWidth * 0.1).clamp(35.0, 60.0),
                height: (screenWidth * 0.1).clamp(35.0, 60.0),
                child: const CircularProgressIndicator(
                  valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                  strokeWidth: 3,
                ),
              ),
              SizedBox(height: (screenHeight * 0.025).clamp(12.0, 24.0)),
              Text(
                'Loading video...',
                style: TextStyle(
                  color: Colors.white,
                  fontSize: (screenWidth * 0.04).clamp(14.0, 20.0),
                ),
              ),
            ],
          ),
        ),
      );
    }

    if (_errorMessage != null) {
      return Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              widget.accentColor.withOpacity(0.8),
              widget.accentColor,
            ],
          ),
        ),
        child: Center(
          child: Padding(
            padding: EdgeInsets.symmetric(
              horizontal: (screenWidth * 0.05).clamp(16.0, 32.0),
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  Icons.error_outline,
                  color: Colors.white,
                  size: (screenWidth * 0.15).clamp(50.0, 80.0),
                ),
                SizedBox(height: (screenHeight * 0.03).clamp(16.0, 24.0)),
                Text(
                  'Failed to load video',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: (screenWidth * 0.045).clamp(16.0, 22.0),
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: (screenHeight * 0.015).clamp(8.0, 12.0)),
                Text(
                  _errorMessage!,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                  ),
                  textAlign: TextAlign.center,
                  maxLines: 3,
                  overflow: TextOverflow.ellipsis,
                ),
                SizedBox(height: (screenHeight * 0.015).clamp(8.0, 12.0)),
                Text(
                  'URL: ${widget.videoUrl ?? 'No URL'}',
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.7),
                    fontSize: (screenWidth * 0.03).clamp(10.0, 14.0),
                  ),
                  textAlign: TextAlign.center,
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
                SizedBox(height: (screenHeight * 0.04).clamp(24.0, 32.0)),
                ElevatedButton(
                  onPressed: () {
                    setState(() {
                      _isVideoLoading = true;
                      _errorMessage = null;
                    });
                    _initializeVideo();
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.white,
                    foregroundColor: widget.accentColor,
                    padding: EdgeInsets.symmetric(
                      horizontal: (screenWidth * 0.06).clamp(20.0, 32.0),
                      vertical: (screenHeight * 0.015).clamp(10.0, 16.0),
                    ),
                  ),
                  child: Text(
                    'Retry',
                    style: TextStyle(
                      fontSize: (screenWidth * 0.035).clamp(12.0, 16.0),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      );
    }

    if (!_isVideoInitialized || _videoController == null) {
      return Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              widget.accentColor.withOpacity(0.8),
              widget.accentColor,
            ],
          ),
        ),
        child: widget.thumbnailPath.startsWith('http')
            ? Image.network(
                widget.thumbnailPath,
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Center(
                    child: Icon(
                      Icons.videocam,
                      color: Colors.white,
                      size: (screenWidth * 0.15).clamp(50.0, 80.0),
                    ),
                  );
                },
              )
            : Image.asset(
                widget.thumbnailPath,
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Center(
                    child: Icon(
                      Icons.videocam,
                      color: Colors.white,
                      size: (screenWidth * 0.15).clamp(50.0, 80.0),
                    ),
                  );
                },
              ),
      );
    }

    return Stack(
      children: [
        SizedBox.expand(
          child: FittedBox(
            fit: BoxFit.contain,
            child: SizedBox(
              width: _videoController!.value.size.width,
              height: _videoController!.value.size.height,
              child: VideoPlayer(_videoController!),
            ),
          ),
        ),
        
        if (_isBuffering)
          Center(
            child: SizedBox(
              width: (screenWidth * 0.1).clamp(35.0, 60.0),
              height: (screenWidth * 0.1).clamp(35.0, 60.0),
              child: const CircularProgressIndicator(
                valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                strokeWidth: 3,
              ),
            ),
          ),
        
        if (!_videoController!.value.isPlaying && !_isBuffering && _showControls)
          Center(
            child: GestureDetector(
              onTap: _togglePlayPause,
              child: Container(
                padding: EdgeInsets.all((screenWidth * 0.06).clamp(20.0, 30.0)),
                decoration: BoxDecoration(
                  color: Colors.black.withOpacity(0.7),
                  shape: BoxShape.circle,
                ),
                child: Icon(
                  Icons.play_arrow,
                  color: widget.accentColor,
                  size: (screenWidth * 0.12).clamp(40.0, 60.0),
                ),
              ),
            ),
          ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    return Scaffold(
      backgroundColor: Colors.black,
      body: SafeArea(
        child: GestureDetector(
          onTap: _showControlsTemporarily,
          child: LayoutBuilder(
            builder: (context, constraints) {
              return Stack(
                children: [
                  Center(
                    child: Container(
                      constraints: BoxConstraints(
                        maxWidth: constraints.maxWidth,
                        maxHeight: constraints.maxHeight,
                      ),
                      child: AspectRatio(
                        aspectRatio: _isVideoInitialized && _videoController != null
                            ? _videoController!.value.aspectRatio
                            : 16 / 9,
                        child: Container(
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(
                              (screenWidth * 0.03).clamp(10.0, 16.0),
                            ),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.5),
                                blurRadius: (screenWidth * 0.05).clamp(15.0, 30.0),
                                offset: Offset(
                                  0,
                                  (screenHeight * 0.015).clamp(8.0, 15.0),
                                ),
                              ),
                            ],
                          ),
                          child: ClipRRect(
                            borderRadius: BorderRadius.circular(
                              (screenWidth * 0.03).clamp(10.0, 16.0),
                            ),
                            child: _buildVideoPlayer(screenWidth, screenHeight),
                          ),
                        ),
                      ),
                    ),
                  ),
                  
                  if (_showControls)
                    AnimatedBuilder(
                      animation: _controlsOpacity,
                      builder: (context, child) {
                        return Opacity(
                          opacity: _controlsOpacity.value,
                          child: Container(
                            padding: EdgeInsets.all(
                              (screenWidth * 0.05).clamp(16.0, 24.0),
                            ),
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topCenter,
                                end: Alignment.bottomCenter,
                                colors: [
                                  Colors.black.withOpacity(0.8),
                                  Colors.transparent,
                                ],
                              ),
                            ),
                            child: Row(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Container(
                                  decoration: BoxDecoration(
                                    color: Colors.black.withOpacity(0.5),
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: IconButton(
                                    onPressed: () {
                                      HapticFeedback.lightImpact();
                                      Navigator.pop(context);
                                    },
                                    icon: Icon(
                                      Icons.arrow_back_ios,
                                      color: Colors.white,
                                      size: (screenWidth * 0.05).clamp(18.0, 24.0),
                                    ),
                                  ),
                                ),
                                SizedBox(width: (screenWidth * 0.03).clamp(10.0, 16.0)),
                                Expanded(
                                  child: Column(
                                    mainAxisSize: MainAxisSize.min,
                                    crossAxisAlignment: CrossAxisAlignment.center,
                                    children: [
                                      FittedBox(
                                        fit: BoxFit.scaleDown,
                                        alignment: Alignment.center,
                                        child: Text(
                                          widget.tribalName.toUpperCase(),
                                          style: TextStyle(
                                            color: widget.accentColor,
                                            fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                                            fontWeight: FontWeight.bold,
                                            letterSpacing: 1,
                                          ),
                                        ),
                                      ),
                                      SizedBox(height: (screenHeight * 0.008).clamp(4.0, 8.0)),
                                      Text(
                                        widget.videoTitle,
                                        style: TextStyle(
                                          color: Colors.white,
                                          fontSize: (screenWidth * 0.04).clamp(14.0, 18.0),
                                          fontWeight: FontWeight.bold,
                                          height: 1.3,
                                        ),
                                        maxLines: 2,
                                        overflow: TextOverflow.ellipsis,
                                        textAlign: TextAlign.center,
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),
                        );
                      },
                    ),
                  
                  if (_showControls && _isVideoInitialized && _videoController != null)
                    Positioned(
                      bottom: 0,
                      left: 0,
                      right: 0,
                      child: AnimatedBuilder(
                        animation: _controlsOpacity,
                        builder: (context, child) {
                          return Opacity(
                            opacity: _controlsOpacity.value,
                            child: Container(
                              padding: EdgeInsets.all(
                                (screenWidth * 0.05).clamp(16.0, 24.0),
                              ),
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  begin: Alignment.bottomCenter,
                                  end: Alignment.topCenter,
                                  colors: [
                                    Colors.black.withOpacity(0.9),
                                    Colors.transparent,
                                  ],
                                ),
                              ),
                              child: Column(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Row(
                                    children: [
                                      Text(
                                        _formatDuration(_videoController!.value.position),
                                        style: TextStyle(
                                          color: Colors.white,
                                          fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                                          fontWeight: FontWeight.w500,
                                        ),
                                      ),
                                      SizedBox(width: (screenWidth * 0.03).clamp(10.0, 16.0)),
                                      Expanded(
                                        child: SliderTheme(
                                          data: SliderTheme.of(context).copyWith(
                                            activeTrackColor: widget.accentColor,
                                            inactiveTrackColor: Colors.white.withOpacity(0.3),
                                            thumbColor: widget.accentColor,
                                            thumbShape: RoundSliderThumbShape(
                                              enabledThumbRadius: (screenWidth * 0.015).clamp(5.0, 8.0),
                                            ),
                                            trackHeight: (screenWidth * 0.008).clamp(3.0, 4.0),
                                            overlayShape: RoundSliderOverlayShape(
                                              overlayRadius: (screenWidth * 0.03).clamp(10.0, 16.0),
                                            ),
                                          ),
                                          child: Slider(
                                            value: _videoController!.value.position.inMilliseconds.toDouble(),
                                            max: _videoController!.value.duration.inMilliseconds.toDouble(),
                                            onChanged: (value) {
                                              _seekTo(Duration(milliseconds: value.toInt()));
                                            },
                                            onChangeStart: (value) {
                                              if (_videoController!.value.isPlaying) {
                                                _videoController!.pause();
                                              }
                                            },
                                            onChangeEnd: (value) {
                                              _videoController!.play();
                                            },
                                          ),
                                        ),
                                      ),
                                      SizedBox(width: (screenWidth * 0.03).clamp(10.0, 16.0)),
                                      Text(
                                        _formatDuration(_videoController!.value.duration),
                                        style: TextStyle(
                                          color: Colors.white,
                                          fontSize: (screenWidth * 0.03).clamp(11.0, 14.0),
                                          fontWeight: FontWeight.w500,
                                        ),
                                      ),
                                    ],
                                  ),
                                  SizedBox(height: (screenHeight * 0.025).clamp(12.0, 24.0)),
                                  Row(
                                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                                    children: [
                                      _buildControlButton(
                                        icon: Icons.replay_10,
                                        onTap: _skipBackward,
                                        screenWidth: screenWidth,
                                        screenHeight: screenHeight,
                                      ),
                                      _buildControlButton(
                                        icon: _videoController!.value.isPlaying 
                                            ? Icons.pause 
                                            : Icons.play_arrow,
                                        onTap: _togglePlayPause,
                                        isMainButton: true,
                                        screenWidth: screenWidth,
                                        screenHeight: screenHeight,
                                      ),
                                      _buildControlButton(
                                        icon: Icons.forward_10,
                                        onTap: _skipForward,
                                        screenWidth: screenWidth,
                                        screenHeight: screenHeight,
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            ),
                          );
                        },
                      ),
                    ),
                ],
              );
            },
          ),
        ),
      ),
    );
  }

  Widget _buildControlButton({
    required IconData icon,
    required VoidCallback onTap,
    required double screenWidth,
    required double screenHeight,
    bool isMainButton = false,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: EdgeInsets.all(
          isMainButton 
            ? (screenWidth * 0.04).clamp(14.0, 20.0)
            : (screenWidth * 0.03).clamp(10.0, 16.0),
        ),
        decoration: BoxDecoration(
          color: isMainButton 
            ? widget.accentColor.withOpacity(0.2)
            : Colors.black.withOpacity(0.5),
          shape: BoxShape.circle,
          border: isMainButton
            ? Border.all(
                color: widget.accentColor, 
                width: (screenWidth * 0.006).clamp(2.0, 3.0),
              )
            : null,
        ),
        child: Icon(
          icon,
          color: isMainButton ? widget.accentColor : Colors.white,
          size: isMainButton 
            ? (screenWidth * 0.08).clamp(28.0, 40.0)
            : (screenWidth * 0.06).clamp(20.0, 28.0),
        ),
      ),
    );
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\services\audio_service.dart
======================================

import 'package:flutter/services.dart';
import 'package:audioplayers/audioplayers.dart';

class AudioService {
  late AudioPlayer _audioPlayer;
  String? _currentlyPlaying;
  bool _isPlaying = false;
  bool _isInitialized = false;

  String? get currentlyPlaying => _currentlyPlaying;
  bool get isPlaying => _isPlaying;
  bool get isInitialized => _isInitialized;

  Future<void> initialize() async {
    try {
      _audioPlayer = AudioPlayer();
      
      // Listen to player state changes
      _audioPlayer.onPlayerStateChanged.listen((PlayerState state) {
        _isPlaying = state == PlayerState.playing;
        
        if (state == PlayerState.completed || state == PlayerState.stopped) {
          _currentlyPlaying = null;
          _isPlaying = false;
        }
      });

      // Listen to player complete events
      _audioPlayer.onPlayerComplete.listen((_) {
        _currentlyPlaying = null;
        _isPlaying = false;
      });

      _isInitialized = true;
      print('AudioService initialized successfully');
    } catch (e) {
      print('Error initializing AudioService: $e');
      _isInitialized = false;
    }
  }

  // Play local audio file from assets
  Future<bool> playLocalAudio({
    required String audioPath,
    required String phraseKey,
  }) async {
    try {
      if (!_isInitialized) {
        print('AudioService not initialized');
        return false;
      }

      // Stop any currently playing audio
      await stopAudio();

      // Check if the audio file exists in assets
      if (!await _audioFileExists(audioPath)) {
        print('Audio file not found: $audioPath');
        return false;
      }

      // FIX 1: Handle the asset path correctly
      // Remove 'assets/' prefix for AssetSource since audioplayers expects relative path from assets
      String assetPath = audioPath;
      if (assetPath.startsWith('assets/')) {
        assetPath = assetPath.substring(7); // Remove 'assets/' prefix
      }

      // Play the audio file
      await _audioPlayer.play(AssetSource(assetPath));
      
      _currentlyPlaying = phraseKey;
      _isPlaying = true;
      
      print('Playing local audio: $assetPath for phrase: $phraseKey');
      return true;
      
    } catch (e) {
      print('Error playing local audio: $e');
      print('Attempted path: $audioPath');
      _currentlyPlaying = null;
      _isPlaying = false;
      return false;
    }
  }

  // FIX 2: Improved asset existence check with better error handling
  Future<bool> _audioFileExists(String audioPath) async {
    try {
      final ByteData data = await rootBundle.load(audioPath);
      print('Audio file found: $audioPath (${data.lengthInBytes} bytes)');
      return true;
    } catch (e) {
      print('Audio file check failed for: $audioPath - Error: $e');
      
      // FIX 3: Try alternative path formats if first attempt fails
      if (audioPath.startsWith('assets/')) {
        // Try without 'assets/' prefix
        try {
          final String altPath = audioPath.substring(7);
          await rootBundle.load(altPath);
          print('Audio file found with alternative path: $altPath');
          return true;
        } catch (e2) {
          print('Alternative path also failed: altPath - Error: $e2');
        }
      } else {
        // Try with 'assets/' prefix
        try {
          final String altPath = 'assets/$audioPath';
          await rootBundle.load(altPath);
          print('Audio file found with assets prefix: $altPath');
          return true;
        } catch (e2) {
          print('Assets prefix path also failed: assets/$audioPath - Error: $e2');
        }
      }
      
      return false;
    }
  }

  // FIX 4: Improved stop method with better state handling
  Future<void> stopAudio() async {
    try {
      // Check current state before attempting to stop
      final currentState = _audioPlayer.state;
      print('Current player state before stop: $currentState');
      
      if (currentState == PlayerState.playing || 
          currentState == PlayerState.paused) {
        await _audioPlayer.stop();
        print('Audio stopped successfully');
      }
      
      _currentlyPlaying = null;
      _isPlaying = false;
    } catch (e) {
      print('Error stopping audio: $e');
      // Force reset state even if stop fails
      _currentlyPlaying = null;
      _isPlaying = false;
    }
  }

  // Pause currently playing audio
  Future<void> pauseAudio() async {
    try {
      if (_audioPlayer.state == PlayerState.playing) {
        await _audioPlayer.pause();
        _isPlaying = false;
        print('Audio paused');
      }
    } catch (e) {
      print('Error pausing audio: $e');
    }
  }

  // Resume paused audio
  Future<void> resumeAudio() async {
    try {
      if (_audioPlayer.state == PlayerState.paused) {
        await _audioPlayer.resume();
        _isPlaying = true;
        print('Audio resumed');
      }
    } catch (e) {
      print('Error resuming audio: $e');
    }
  }

  // Set volume (0.0 to 1.0)
  Future<void> setVolume(double volume) async {
    try {
      await _audioPlayer.setVolume(volume.clamp(0.0, 1.0));
    } catch (e) {
      print('Error setting volume: $e');
    }
  }

  // Get current audio position
  Future<Duration> getCurrentPosition() async {
    try {
      return await _audioPlayer.getCurrentPosition() ?? Duration.zero;
    } catch (e) {
      print('Error getting current position: $e');
      return Duration.zero;
    }
  }

  // Get total audio duration
  Future<Duration> getDuration() async {
    try {
      return await _audioPlayer.getDuration() ?? Duration.zero;
    } catch (e) {
      print('Error getting duration: $e');
      return Duration.zero;
    }
  }

  // Seek to specific position
  Future<void> seekTo(Duration position) async {
    try {
      await _audioPlayer.seek(position);
    } catch (e) {
      print('Error seeking to position: $e');
    }
  }

  // FIX 5: Enhanced preload with detailed logging
  Future<void> preloadAudioFiles(List<String> audioPaths) async {
    print('Preloading ${audioPaths.length} audio files...');
    int foundCount = 0;
    int missingCount = 0;
    
    try {
      for (String audioPath in audioPaths) {
        if (await _audioFileExists(audioPath)) {
          foundCount++;
          print(' Audio file verified: $audioPath');
        } else {
          missingCount++;
          print(' Audio file missing: $audioPath');
        }
      }
      
      print('Preload summary: $foundCount found, $missingCount missing');
    } catch (e) {
      print('Error preloading audio files: $e');
    }
  }

  // FIX 6: Debug method to list all available assets
  Future<List<String>> debugListAssets() async {
    List<String> availableAssets = [];
    
    try {
      // This is a basic implementation - you might need to manually list expected files
      // since Flutter doesn't provide a direct way to list all assets at runtime
      print('Debug: Checking asset availability...');
      
      // You can expand this list with all your expected audio files
      List<String> expectedFiles = [
        'assets/audio/signature_mabuhay_og_madayaw.mp3',
        'assets/audio/english/greetings_hello_english.mp3',
        'assets/audio/english/basic_thankyou_english.mp3',
        // Add more files as needed
      ];
      
      for (String file in expectedFiles) {
        if (await _audioFileExists(file)) {
          availableAssets.add(file);
        }
      }
      
    } catch (e) {
      print('Error listing assets: $e');
    }
    
    return availableAssets;
  }

  // Get list of available audio files
  Future<List<String>> getAvailableAudioFiles(List<String> expectedFiles) async {
    List<String> availableFiles = [];
    
    for (String filePath in expectedFiles) {
      if (await _audioFileExists(filePath)) {
        availableFiles.add(filePath);
      }
    }
    
    print('Available files: ${availableFiles.length}/${expectedFiles.length}');
    return availableFiles;
  }

  // Check audio system health
  Future<Map<String, dynamic>> getAudioSystemStatus() async {
    return {
      'isInitialized': _isInitialized,
      'isPlaying': _isPlaying,
      'currentlyPlaying': _currentlyPlaying,
      'playerState': _audioPlayer.state.toString(),
      'timestamp': DateTime.now().toString(),
    };
  }

  void dispose() {
    try {
      _audioPlayer.dispose();
      _currentlyPlaying = null;
      _isPlaying = false;
      _isInitialized = false;
      print('AudioService disposed');
    } catch (e) {
      print('Error disposing AudioService: $e');
    }
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\services\content_api_service.dart
======================================

import 'dart:convert';
import 'package:http/http.dart' as http;

class ContentApiService {
  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/';
  
  // Fetch all content with optional filters
  static Future<List<Map<String, dynamic>>> fetchContent({
    String? category,
    String? tribe,
    String? type,
  }) async {
    final queryParams = <String, String>{};
    
    if (category != null) queryParams['category'] = category;
    if (tribe != null) queryParams['tribe'] = tribe;
    if (type != null) queryParams['type'] = type;
    
    final uri = Uri.parse(_baseUrl).replace(queryParameters: queryParams);
    
    try {
      final response = await http.get(
        uri,
        headers: {
          'Content-Type': 'application/json',
        },
      );
      
      if (response.statusCode == 200) {
        final jsonData = json.decode(response.body);
        return List<Map<String, dynamic>>.from(jsonData['data'] ?? []);
      } else {
        throw Exception('Failed to load content: HTTP ${response.statusCode}');
      }
    } catch (e) {
      throw Exception('Network error: $e');
    }
  }
  
  // Fetch single content item by ID
  static Future<Map<String, dynamic>?> fetchContentById(String id) async {
    final uri = Uri.parse(_baseUrl).replace(queryParameters: {'id': id});
    
    try {
      final response = await http.get(
        uri,
        headers: {
          'Content-Type': 'application/json',
        },
      );
      
      if (response.statusCode == 200) {
        final jsonData = json.decode(response.body);
        return jsonData['data'];
      } else if (response.statusCode == 404) {
        return null;
      } else {
        throw Exception('Failed to load content: HTTP ${response.statusCode}');
      }
    } catch (e) {
      throw Exception('Network error: $e');
    }
  }
  
  // Get content by category (convenience method)
  static Future<List<Map<String, dynamic>>> fetchByCategory(String category) {
    return fetchContent(category: category);
  }
  
  // Get content by tribe (convenience method)
  static Future<List<Map<String, dynamic>>> fetchByTribe(String tribe) {
    return fetchContent(tribe: tribe);
  }
  
  // Get content by type (convenience method)
  static Future<List<Map<String, dynamic>>> fetchByType(String type) {
    return fetchContent(type: type);
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\services\video_api_service.dart
======================================

import 'dart:convert';
import 'package:http/http.dart' as http;

/// Generic API response wrapper that matches your existing code structure
class ApiResponse<T> {
  final bool isSuccess;
  final T? data;
  final String? error;
  final String? errorMessage;
  final int? statusCode;

  ApiResponse({
    required this.isSuccess,
    this.data,
    this.error,
    this.errorMessage,
    this.statusCode,
  });

  factory ApiResponse.success(T data) {
    return ApiResponse<T>(
      isSuccess: true,
      data: data,
    );
  }

  factory ApiResponse.error(String message, [int? statusCode]) {
    return ApiResponse<T>(
      isSuccess: false,
      error: message,
      errorMessage: message,
      statusCode: statusCode,
    );
  }
}

/// Video item model that matches your existing VideoItem structure
class VideoItem {
  final String id;
  final String title;
  final String thumbnailUrl;
  final String duration;
  final String videoUrl;
  final String description;
  final String category;
  final String tribe;
  final String type;
  final DateTime? createdAt;
  final DateTime? updatedAt;

  VideoItem({
    required this.id,
    required this.title,
    required this.thumbnailUrl,
    required this.duration,
    required this.videoUrl,
    required this.description,
    required this.category,
    required this.tribe,
    required this.type,
    this.createdAt,
    this.updatedAt,
  });

  factory VideoItem.fromJson(Map<String, dynamic> json) {
    return VideoItem(
      id: json['id']?.toString() ?? '',
      title: json['title'] ?? 'Untitled Video',
      thumbnailUrl: _buildThumbnailUrl(json['file']),
      duration: json['duration'] ?? '--:--',
      videoUrl: _buildVideoUrl(json['file']),
      description: json['description'] ?? '',
      category: json['category'] ?? 'Other',
      tribe: json['tribe'] ?? '',
      type: json['type'] ?? 'video',
      createdAt: _parseDateTime(json['created_at']),
      updatedAt: _parseDateTime(json['updated_at']),
    );
  }

  /// Build thumbnail URL from file path
  static String _buildThumbnailUrl(String? filePath) {
    if (filePath == null || filePath.isEmpty) return '';
    if (filePath.startsWith('http')) return filePath;
    
    // Generate thumbnail path - you might need to adjust this based on your server setup
    final fileName = filePath.split('/').last;
    final nameWithoutExt = fileName.split('.').first;
    return 'https://huni-cms.ionvop.com/uploads/thumbnails/${nameWithoutExt}_thumb.jpg';
  }

  /// Build video URL from file path
  static String _buildVideoUrl(String? filePath) {
    if (filePath == null || filePath.isEmpty) return '';
    if (filePath.startsWith('http')) return filePath;
    return 'https://huni-cms.ionvop.com/uploads/$filePath';
  }

  /// Parse datetime from various formats
  static DateTime? _parseDateTime(dynamic dateValue) {
    if (dateValue == null) return null;
    
    if (dateValue is String) {
      try {
        return DateTime.parse(dateValue);
      } catch (e) {
        try {
          return DateTime.parse(dateValue.replaceAll(' ', 'T'));
        } catch (e) {
          return null;
        }
      }
    } else if (dateValue is int) {
      return DateTime.fromMillisecondsSinceEpoch(dateValue * 1000);
    }
    
    return null;
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'title': title,
      'thumbnail_url': thumbnailUrl,
      'video_url': videoUrl,
      'duration': duration,
      'description': description,
      'category': category,
      'tribe': tribe,
      'type': type,
      'created_at': createdAt?.toIso8601String(),
      'updated_at': updatedAt?.toIso8601String(),
    };
  }
}

/// Main API service class for interacting with your PHP API
class VideoApiService {
  static const String _baseUrl = 'https://huni-cms.ionvop.com/api/';
  static const Duration _timeout = Duration(seconds: 30);

  /// Fetch videos from the PHP API with optional filters
  static Future<ApiResponse<List<VideoItem>>> fetchVideos({
    String? tribe,
    String? category,
    String? type = 'video',
    int? limit,
    int? offset,
  }) async {
    try {
      final queryParams = <String, String>{};
      
      // Use the exact parameter names your PHP API expects
      if (tribe != null) queryParams['tribe'] = tribe;
      if (category != null && category != 'All') queryParams['category'] = category;
      if (type != null) queryParams['type'] = type;
      if (limit != null) queryParams['limit'] = limit.toString();
      if (offset != null) queryParams['offset'] = offset.toString();

      final uri = Uri.parse(_baseUrl).replace(queryParameters: queryParams);
      
      print('VideoApiService: Making request to: $uri'); // Debug log

      final response = await http.get(
        uri,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
      ).timeout(_timeout);

      print('VideoApiService: Response status: ${response.statusCode}'); // Debug log
      print('VideoApiService: Response body: ${response.body}'); // Debug log

      if (response.statusCode == 200) {
        final jsonData = json.decode(response.body);
        
        // Your PHP API returns {"data": [...]} format
        final List<dynamic> dataList = jsonData['data'] ?? [];
        
        final videos = dataList
            .map((item) {
              try {
                return VideoItem.fromJson(item as Map<String, dynamic>);
              } catch (e) {
                print('VideoApiService: Error parsing video item: $e');
                return null;
              }
            })
            .where((video) => video != null)
            .cast<VideoItem>()
            .toList();

        return ApiResponse.success(videos);

      } else if (response.statusCode == 404) {
        return ApiResponse.success([]); // No videos found
      } else {
        String errorMessage = 'Server error: ${response.statusCode}';
        
        try {
          final errorData = json.decode(response.body);
          if (errorData is Map<String, dynamic> && errorData.containsKey('error')) {
            errorMessage = errorData['error'];
          }
        } catch (e) {
          // Use default error message if JSON parsing fails
        }
        
        return ApiResponse.error(errorMessage, response.statusCode);
      }

    } on http.ClientException catch (e) {
      return ApiResponse.error('Network error: ${e.message}');
    } on FormatException catch (e) {
      return ApiResponse.error('Invalid JSON response: ${e.message}');
    } catch (e) {
      return ApiResponse.error('Unexpected error: ${e.toString()}');
    }
  }

  /// Fetch a specific video by ID
  static Future<ApiResponse<VideoItem?>> fetchVideoById(String videoId) async {
    try {
      final uri = Uri.parse(_baseUrl).replace(queryParameters: {'id': videoId});
      
      print('VideoApiService: Fetching video by ID: $uri'); // Debug log
      
      final response = await http.get(
        uri,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
      ).timeout(_timeout);

      if (response.statusCode == 200) {
        final jsonData = json.decode(response.body);
        final data = jsonData['data'];
        
        if (data != null) {
          final video = VideoItem.fromJson(data);
          return ApiResponse.success(video);
        } else {
          return ApiResponse.success(null);
        }
      } else if (response.statusCode == 404) {
        return ApiResponse.success(null);
      } else {
        return ApiResponse.error(
          'Server error: ${response.statusCode}',
          response.statusCode,
        );
      }

    } catch (e) {
      return ApiResponse.error('Failed to fetch video: ${e.toString()}');
    }
  }

  /// Fetch available categories from the API
  static Future<ApiResponse<List<String>>> fetchCategories({
    String? tribe,
  }) async {
    try {
      final queryParams = <String, String>{};
      if (tribe != null) queryParams['tribe'] = tribe;

      final uri = Uri.parse(_baseUrl).replace(queryParameters: queryParams);
      
      print('VideoApiService: Fetching categories: $uri'); // Debug log

      final response = await http.get(
        uri,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
      ).timeout(_timeout);

      if (response.statusCode == 200) {
        final jsonData = json.decode(response.body);
        final List<dynamic> dataList = jsonData['data'] ?? [];
        
        // Extract unique categories from the data
        final categories = <String>{'All'};
        for (var item in dataList) {
          final category = item['category']?.toString();
          if (category != null && category.isNotEmpty) {
            categories.add(category);
          }
        }

        final categoryList = categories.toList();
        print('VideoApiService: Found categories: $categoryList'); // Debug log
        
        return ApiResponse.success(categoryList);

      } else {
        // Return default categories if API fails
        final defaultCategories = ['All', 'Dance', 'Ceremony', 'Lifestyle', 'Music', 'Crafts'];
        print('VideoApiService: Using default categories due to API error'); // Debug log
        return ApiResponse.success(defaultCategories);
      }

    } catch (e) {
      // Return default categories if there's an error
      final defaultCategories = ['All', 'Dance', 'Ceremony', 'Lifestyle', 'Music', 'Crafts'];
      print('VideoApiService: Using default categories due to error: $e'); // Debug log
      return ApiResponse.success(defaultCategories);
    }
  }

  /// Search videos with a query string
  static Future<ApiResponse<List<VideoItem>>> searchVideos({
    required String query,
    String? tribe,
    String? category,
    String? type = 'video',
  }) async {
    try {
      // First fetch all videos with filters, then search locally
      // Since your PHP API doesn't have search functionality yet
      final videosResponse = await fetchVideos(
        tribe: tribe,
        category: category,
        type: type,
      );
      
      if (!videosResponse.isSuccess || videosResponse.data == null) {
        return ApiResponse.error(videosResponse.error ?? 'Failed to fetch videos for search');
      }
      
      final allVideos = videosResponse.data!;
      final searchQuery = query.toLowerCase();
      
      // Filter videos based on search query
      final filteredVideos = allVideos.where((video) {
        return video.title.toLowerCase().contains(searchQuery) ||
               video.description.toLowerCase().contains(searchQuery) ||
               video.category.toLowerCase().contains(searchQuery);
      }).toList();
      
      print('VideoApiService: Search for "$query" found ${filteredVideos.length} results'); // Debug log
      
      return ApiResponse.success(filteredVideos);
      
    } catch (e) {
      return ApiResponse.error('Search error: ${e.toString()}');
    }
  }

  /// Fetch all content types (not just videos) - useful for future features
  static Future<ApiResponse<List<Map<String, dynamic>>>> fetchAllContent({
    String? category,
    String? tribe,
    String? type,
  }) async {
    try {
      final queryParams = <String, String>{};
      
      if (category != null && category != 'All') queryParams['category'] = category;
      if (tribe != null) queryParams['tribe'] = tribe;
      if (type != null) queryParams['type'] = type;
      
      final uri = Uri.parse(_baseUrl).replace(queryParameters: queryParams);
      
      final response = await http.get(
        uri,
        headers: {'Content-Type': 'application/json'},
      ).timeout(_timeout);
      
      if (response.statusCode == 200) {
        final jsonData = json.decode(response.body);
        final List<dynamic> dataList = jsonData['data'] ?? [];
        
        final content = dataList
            .map((item) => Map<String, dynamic>.from(item))
            .toList();
        
        return ApiResponse.success(content);
      } else {
        return ApiResponse.error('HTTP Error: ${response.statusCode}', response.statusCode);
      }
    } catch (e) {
      return ApiResponse.error('Network error: ${e.toString()}');
    }
  }

  /// Get content statistics - useful for dashboard/analytics
  static Future<ApiResponse<Map<String, int>>> getContentStats({
    String? tribe,
  }) async {
    try {
      final contentResponse = await fetchAllContent(tribe: tribe);
      
      if (!contentResponse.isSuccess || contentResponse.data == null) {
        return ApiResponse.error('Failed to fetch content for stats');
      }
      
      final content = contentResponse.data!;
      final stats = <String, int>{};
      
      // Count by type
      for (var item in content) {
        final type = item['type']?.toString() ?? 'unknown';
        stats[type] = (stats[type] ?? 0) + 1;
      }
      
      // Add total count
      stats['total'] = content.length;
      
      return ApiResponse.success(stats);
      
    } catch (e) {
      return ApiResponse.error('Stats error: ${e.toString()}');
    }
  }
}

======================================
FILE: C:\Users\Ram\Desktop\Huni Remastered\lib\utils\video_metadata_cache.dart
======================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:io';
import 'dart:convert';

class VideoMetadataCache {
  static const String _durationCacheKey = 'video_durations_cache';
  static const String _thumbnailCacheKey = 'video_thumbnails_cache';
  
  static final Map<String, String> _durationMemoryCache = {};
  static final Map<String, String> _thumbnailMemoryCache = {};
  
  static Future<void> saveDuration(String videoId, String duration) async {
    _durationMemoryCache[videoId] = duration;
    
    final prefs = await SharedPreferences.getInstance();
    final cache = _getDurationCache(prefs);
    cache[videoId] = duration;
    await prefs.setString(_durationCacheKey, json.encode(cache));
  }
  
  static Future<void> saveThumbnail(String videoId, String thumbnailPath) async {
    _thumbnailMemoryCache[videoId] = thumbnailPath;
    
    final prefs = await SharedPreferences.getInstance();
    final cache = _getThumbnailCache(prefs);
    cache[videoId] = thumbnailPath;
    await prefs.setString(_thumbnailCacheKey, json.encode(cache));
  }
  
  static Future<String?> getDuration(String videoId) async {
    if (_durationMemoryCache.containsKey(videoId)) {
      return _durationMemoryCache[videoId];
    }
    
    final prefs = await SharedPreferences.getInstance();
    final cache = _getDurationCache(prefs);
    final duration = cache[videoId];
    
    if (duration != null) {
      _durationMemoryCache[videoId] = duration;
    }
    
    return duration;
  }
  
  static Future<String?> getThumbnail(String videoId) async {
    if (_thumbnailMemoryCache.containsKey(videoId)) {
      final path = _thumbnailMemoryCache[videoId]!;
      if (await File(path).exists()) {
        return path;
      } else {
        _thumbnailMemoryCache.remove(videoId);
      }
    }
    
    final prefs = await SharedPreferences.getInstance();
    final cache = _getThumbnailCache(prefs);
    final thumbnailPath = cache[videoId];
    
    if (thumbnailPath != null && await File(thumbnailPath).exists()) {
      _thumbnailMemoryCache[videoId] = thumbnailPath;
      return thumbnailPath;
    }
    
    return null;
  }
  
  static Future<void> clearCache() async {
    _durationMemoryCache.clear();
    _thumbnailMemoryCache.clear();
    
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_durationCacheKey);
    await prefs.remove(_thumbnailCacheKey);
  }
  
  static Map<String, String> _getDurationCache(SharedPreferences prefs) {
    final cacheString = prefs.getString(_durationCacheKey);
    if (cacheString == null) return {};
    
    try {
      final decoded = json.decode(cacheString) as Map<String, dynamic>;
      return decoded.map((key, value) => MapEntry(key, value.toString()));
    } catch (e) {
      return {};
    }
  }
  
  static Map<String, String> _getThumbnailCache(SharedPreferences prefs) {
    final cacheString = prefs.getString(_thumbnailCacheKey);
    if (cacheString == null) return {};
    
    try {
      final decoded = json.decode(cacheString) as Map<String, dynamic>;
      return decoded.map((key, value) => MapEntry(key, value.toString()));
    } catch (e) {
      return {};
    }
  }
}
